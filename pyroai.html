
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PyroAI v2.5 - Enhanced AI Chat</title>
    <meta name="description" content="PyroAI v2.5 - Next-level AI chat by PyroLLC. Intelligent conversations, website previews, JS execution, memory, custom models, and secure storage.">
    <meta name="keywords" content="PyroAI, PyroLLC, PyroALW, AI chat, artificial intelligence, chatbot, machine learning, gemini, ollama, secure chat, premium AI, javascript execution, ai memory">
    <meta name="author" content="PyroLLC">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="PyroAI v2.5 - Enhanced AI Chat">
    <meta property="og:description" content="Experience advanced AI chat with PyroAI v2.5. Featuring enhanced memory, custom Ollama models, secure local storage, and updated Gemini models.">
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/134533935?v=4">
    <meta property="og:url" content="https://pyrollc.com.tr"> <!-- Update if URL changes -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PyroAI v2.5 - Enhanced AI Chat">
    <meta name="twitter:description" content="Advanced AI chat with memory, JS execution, website previews, custom models, and secure storage.">
    <link rel="canonical" href="https://pyrollc.com.tr"> <!-- Update if URL changes -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <!-- Updated Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"> <!-- Consistent Dark Code Theme -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script> <!-- Updated SortableJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <!-- Basic Crypto library for local storage obfuscation (replace with stronger if needed) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #8B5CF6; /* Slightly different Purple */
            --primary-color-hover: #A78BFA; /* Lighter Purple */
            --secondary-color: #10B981; /* Emerald */
            --background-color: #F9FAFB; /* Very Light Gray */
            --text-color: #1F2937; /* Dark Gray */
            --light-gray: #E5E7EB;
            --medium-gray: #D1D5DB;
            --dark-gray: #6B7280;
            --darker-gray: #374151;
            --code-bg: #F3F4F6; /* Slightly darker than background */
            --shadow-light: rgba(0, 0, 0, 0.06);
            --accent-color: #FBBF24; /* Amber */
            --danger-color: #EF4444; /* Red */
            --info-color: #3B82F6; /* Blue */

            /* Light theme */
            --background-light: var(--background-color);
            --text-light: var(--text-color);
            --sidebar-light: #FFFFFF;
            --message-user-light: var(--primary-color);
            --message-ai-light: #FFFFFF;
            --message-user-text-light: white;
            --message-ai-text-light: var(--text-color);
            --pinned-background-light: #FEF3C7; /* Light Yellow */
            --pinned-border-light: var(--accent-color);
            --memory-msg-bg-light: #E0E7FF; /* Light Indigo */
            --memory-msg-text-light: #3730A3; /* Dark Indigo */
            --memory-msg-border-light: #A5B4FC; /* Lighter Indigo */
            --code-header-bg-light: #E5E7EB;
            --code-header-text-light: var(--darker-gray);

            /* Dark Theme */
            --background-dark: #111827; /* Very Dark Blue/Gray */
            --text-dark: #E5E7EB; /* Light Gray */
            --sidebar-dark: #1F2937; /* Dark Gray/Blue */
            --message-user-dark: #7C3AED; /* Keep user bubble distinct */
            --message-ai-dark: #374151; /* Darker Gray/Blue */
            --message-user-text-dark: white;
            --message-ai-text-dark: var(--text-dark);
            --code-bg-dark: #2d2d2d; /* Atom One Dark bg */
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --pinned-background-dark: #3730A3; /* Indigo */
            --pinned-border-dark: #A5B4FC; /* Light Indigo */
            --memory-msg-bg-dark: #312E81; /* Darker Indigo */
            --memory-msg-text-dark: #C7D2FE; /* Lighter Indigo */
            --memory-msg-border-dark: #6366F1; /* Indigo */
            --code-header-bg-dark: #4B5563;
            --code-header-text-dark: var(--text-dark);

            --toast-success-bg: #ECFDF5;
            --toast-success-text: #065F46;
            --toast-success-border: #10B981;
            --toast-error-bg: #FEF2F2;
            --toast-error-text: #991B1B;
            --toast-error-border: #EF4444;
            --toast-info-bg: #EFF6FF;
            --toast-info-text: #1E40AF;
            --toast-info-border: #3B82F6;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 16px; /* Base font size */
        }

        .app-container {
            display: flex;
            height: 100vh; /* Use 100% viewport height */
            overflow: hidden;
            /* Removed border-radius and margin for edge-to-edge look */
            /* box-shadow: 0 8px 25px -5px var(--shadow-light), 0 5px 10px -6px var(--shadow-light); */
            background-color: var(--background-light); /* Explicit background */
        }
        /* @media (max-width: 768px) { */
            /* Mobile already edge-to-edge */
        /* } */

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-light);
            border-right: 1px solid var(--light-gray);
            transition: width 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; /* Added shadow transition */
            z-index: 40; /* Above chat area but below modals */
            /* box-shadow: 2px 0 5px -2px var(--shadow-light); */ /* Removed default shadow */
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Prevent shrinking */
            overflow-y: hidden; /* Let content scroll */
            overflow-x: hidden;
        }
        .sidebar-content-wrapper { /* New wrapper for scroll */
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Collapsed State (Desktop) */
        .sidebar-closed { width: 80px; box-shadow: none; }
        .sidebar-closed .sidebar-title,
        .sidebar-closed .sidebar-content span, /* Hide text spans */
        .sidebar-closed .sidebar-footer span,
        .sidebar-closed #search-conversations,
        .sidebar-closed .conversation-title,
        .sidebar-closed .conversation-actions,
        .sidebar-closed .user-profile span:not(#premium-user-badge),
        .sidebar-closed #new-conversation span,
        .sidebar-closed #premium-button span,
        .sidebar-closed #suggestions-button span,
        .sidebar-closed #open-settings span,
        .sidebar-closed .sidebar-actions span { display: none; }
        .sidebar-closed .sidebar-header,
        .sidebar-closed .sidebar-footer,
        .sidebar-closed .sidebar-actions { padding-left: 1rem; padding-right: 1rem; justify-content: center; }
        .sidebar-closed .sidebar-content h2 i { margin-right: 0; }
        .sidebar-closed .sidebar-content h2 { justify-content: center; }
        .sidebar-closed .conversation-item { justify-content: center; }
        .sidebar-closed #toggle-sidebar-desktop i { transform: rotate(180deg); }

        /* Mobile Sidebar Collapse (translateX) */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; height: 100%; z-index: 50; transform: translateX(-100%); width: 280px; /* Consistent mobile width */ box-shadow: 4px 0 15px rgba(0,0,0,0.2); border-right: 1px solid var(--light-gray); /* Add border for mobile */
            }
            .sidebar.active { transform: translateX(0); }
            /* Reset desktop collapse styles for mobile */
            .sidebar-closed, .sidebar { width: 280px; }
            .sidebar-closed .sidebar-title,
            .sidebar-closed .sidebar-content span,
            .sidebar-closed .sidebar-footer span,
            .sidebar-closed #search-conversations,
            .sidebar-closed .conversation-title,
            .sidebar-closed .conversation-actions,
            .sidebar-closed .user-profile span:not(#premium-user-badge),
            .sidebar-closed #new-conversation span,
            .sidebar-closed #premium-button span,
            .sidebar-closed #suggestions-button span,
            .sidebar-closed #open-settings span,
            .sidebar-closed .sidebar-actions span { display: inline-block; }
            .sidebar-closed .sidebar-header,
            .sidebar-closed .sidebar-footer,
            .sidebar-closed .sidebar-actions { padding: 1.75rem; justify-content: space-between; }
            .sidebar-closed .sidebar-content h2 i { margin-right: 0.75rem; }
            .sidebar-closed .sidebar-content h2 { justify-content: flex-start; }
            .sidebar-closed .conversation-item { justify-content: space-between; }
            .sidebar-closed #toggle-sidebar-desktop { display: none; }
            #mobile-sidebar-toggle { display: block; }
            #toggle-sidebar { display: block; }
        }

        .sidebar-header { padding: 1.75rem; border-bottom: 1px solid var(--light-gray); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .sidebar-logo-area { display: flex; align-items: center; }
        .sidebar-title { font-size: 1.5rem; font-weight: 700; color: var(--text-color); letter-spacing: -0.025em; margin-left: 0.5rem; }
        #toggle-sidebar-desktop, #toggle-sidebar { color: var(--dark-gray); background: none; border: none; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease; cursor: pointer; }
        #toggle-sidebar-desktop:hover, #toggle-sidebar:hover { background-color: var(--light-gray); color: var(--primary-color); }
        #toggle-sidebar { display: none; } /* Mobile toggle (in sidebar header) hidden by default */

        .sidebar-content { padding: 1.25rem 1.75rem; }
        .sidebar-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--light-gray); text-align: center; margin-top: auto; flex-shrink: 0; }

        /* Sidebar action buttons (Import/Export) */
        .sidebar-actions {
            padding: 0.5rem 1.75rem 1.25rem; /* Padding above footer */
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            border-top: 1px solid var(--light-gray);
            margin-top: auto; /* Pushes it to the bottom */
        }
        .sidebar-action-button {
            flex: 1; /* Equal width */
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            background-color: var(--sidebar-light);
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .sidebar-action-button:hover {
            background-color: var(--light-gray); color: var(--text-color); border-color: var(--dark-gray); transform: translateY(-1px); box-shadow: 0 1px 3px var(--shadow-light);
        }

        .conversation-list { padding-top: 0.5rem; }
        .conversation-item { padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.75rem; cursor: pointer; transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease; display: flex; justify-content: space-between; align-items: center; overflow: hidden; border: 1px solid transparent; /* For active state border */ }
        .conversation-item:hover { background-color: var(--light-gray); transform: translateX(3px); box-shadow: 2px 2px 5px var(--shadow-light); }
        .conversation-item.active { background-color: var(--primary-color); color: white; box-shadow: 0 3px 8px -2px rgba(139, 92, 246, 0.5); transform: translateX(3px); border-color: var(--primary-color-hover); }
        .conversation-item.active:hover { background-color: var(--primary-color-hover); }
        .conversation-item.active .text-gray-700, .conversation-item.active .dark-gray { color: white !important; }
        .conversation-item.active .conversation-title { color: white !important; }
        .conversation-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 0.5rem; font-size: 0.95rem; }
        .conversation-actions { display: flex; gap: 0.3rem; }
        .conversation-actions button, .conversation-actions-mobile-button { padding: 0.5rem; background: none; border: none; color: var(--dark-gray); cursor: pointer; opacity: 0.8; transition: all 0.2s ease; border-radius: 0.3rem; }
        .conversation-actions button:hover, .conversation-actions-mobile-button:hover { opacity: 1; background-color: rgba(0,0,0,0.05); color: var(--primary-color); transform: scale(1.1); }
        .conversation-item.active .conversation-actions button { color: white; opacity: 0.9; }
        .conversation-item.active .conversation-actions button:hover { background-color: rgba(255,255,255,0.2); }
        /* Mobile dropdown styles */
        .conversation-actions-mobile-dropdown { position: relative; }
        .conversation-actions-dropdown-content { display: none; position: absolute; right: 0; background-color: var(--sidebar-light); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.15); z-index: 1; border-radius: 0.5rem; padding: 0.5rem 0; margin-top: 0.2rem; border: 1px solid var(--light-gray); }
        .conversation-actions-dropdown-content.show { display: block; }
        .conversation-actions-dropdown-content button { display: block; width: 100%; padding: 0.7rem 1.2rem; text-align: left; clear: both; white-space: nowrap; font-size: 0.9rem; }
        .conversation-actions-dropdown-content button:hover { background-color: var(--light-gray); }
        .conversation-actions-dropdown-content button i { margin-right: 0.75rem; width: 1em; text-align: center; opacity: 0.8; }

        /* --- Chat Area --- */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--background-light); overflow: hidden; /* Prevent chat area itself from scrolling */ }
        .chat-header { padding: 1.5rem 1.75rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; min-height: 70px; position: relative; z-index: 10; background-color: var(--sidebar-light); /* Match sidebar bg */}
        .chat-title { font-size: 1.3rem; /* Slightly smaller */ font-weight: 600; color: var(--text-color); letter-spacing: -0.02em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
        #mobile-sidebar-toggle { display: none; color: var(--dark-gray); background: none; border: none; padding: 0.5rem; border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease; cursor: pointer; margin-right: 0.5rem; }
        #mobile-sidebar-toggle:hover { background-color: var(--light-gray); color: var(--primary-color); }

        /* Chat Messages */
        .chat-messages-container { flex-grow: 1; padding: 1.75rem; overflow-y: auto; scroll-behavior: smooth; padding-bottom: 1rem; background-color: var(--background-light); /* Ensure chat bg */}
        .message-wrapper { margin-bottom: 1.25rem; display: flex; flex-direction: column; max-width: 90%; }
        .message-wrapper.user-message-wrapper { align-self: flex-end; max-width: 85%; }
        .message-wrapper.ai-message-wrapper { align-self: flex-start; max-width: 85%; }
        .message-wrapper.system-message-wrapper { /* For Memory/Assistant switch */
            align-self: center; width: 100%; max-width: 70%; margin-top: 0.5rem; margin-bottom: 0.5rem;
        }
        .message { padding: 0.9rem 1.4rem; border-radius: 1.25rem; word-wrap: break-word; box-shadow: 0 2px 5px 0 var(--shadow-light), 0 1px 2px 0 var(--shadow-light); animation: fadeInUp 0.4s ease-out; position: relative; transition: box-shadow 0.25s ease; user-select: text; line-height: 1.5; width: fit-content; min-width: 40px; max-width: 100%; }
        .message-wrapper.user-message-wrapper .message { margin-left: auto; }
        .message-wrapper.ai-message-wrapper .message { margin-right: auto; }
        .message:hover { box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light); }
        .message.user-message { background-color: var(--message-user-light); color: var(--message-user-text-light); border-bottom-right-radius: 0.5rem; }
        .message.ai-message { background-color: var(--message-ai-light); color: var(--message-ai-text-light); border-bottom-left-radius: 0.5rem; }
        .message.imageGen-message, .message.websiteCode-message, .message.processJsResult-message { background-color: var(--message-ai-light); color: var(--message-ai-text-light); border-bottom-left-radius: 0.5rem; border: 1px solid var(--light-gray); overflow: hidden; }
        .message.websiteCode-message, .message.processJsResult-message { padding: 0; /* Remove padding for containers */ }
        .message-content { font-size: 1rem; }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        .message-content p { margin-bottom: 0.75em; }
        .message-content ul, .message-content ol { margin-left: 1.5em; margin-bottom: 0.75em; }
        .message-content li { margin-bottom: 0.25em; }
        .message-content blockquote { border-left: 4px solid var(--medium-gray); padding-left: 1em; margin-left: 0; margin-bottom: 0.75em; color: var(--dark-gray); font-style: italic; background-color: rgba(128,128,128,0.05); border-radius: 0 0.5rem 0.5rem 0; }
        .message-content a { color: var(--primary-color); text-decoration: underline; }
        body.dark .message-content a { color: var(--primary-color-hover); }
        body.dark .message-content blockquote { background-color: rgba(200,200,200,0.08); border-left-color: var(--dark-gray); color: var(--darker-gray); }

        /* Code Block Styling */
        pre { position: relative; margin-bottom: 1em; }
        code.hljs { /* Styles applied globally by highlight.js CSS */
             background: var(--code-bg); /* Light theme code bg */
             color: var(--text-color);
             border-radius: 0.6rem; padding: 1rem; overflow-x: auto; font-size: 0.9rem; line-height: 1.4; display: block; border: 1px solid var(--light-gray);
         }
        body.dark code.hljs { background: var(--code-bg-dark); color: #abb2bf; border-color: var(--medium-gray); } /* Dark theme code bg/text */
        .copy-code-button { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.3rem; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; font-size: 0.8rem; z-index: 1; }
        pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background-color: rgba(0, 0, 0, 0.7); }

        /* Website Preview */
        .website-preview-area-chat { border-radius: 1.25rem; border-top-left-radius: 0; border-top-right-radius: 0; overflow: hidden; background-color: var(--code-bg); }
        .website-preview-header-chat { background-color: var(--code-header-bg-light); padding: 0.6rem 1rem; font-size: 0.8rem; color: var(--code-header-text-light); border-bottom: 1px solid var(--medium-gray); display: flex; justify-content: space-between; align-items: center; }
        body.dark .website-preview-header-chat { background-color: var(--code-header-bg-dark); color: var(--code-header-text-dark); border-bottom-color: #6B7280;}
        .website-preview-header-chat .title { font-weight: 500; }
        .website-preview-header-chat .actions button { background: none; border: none; color: var(--code-header-text-light); cursor: pointer; opacity: 0.8; transition: opacity 0.2s ease, transform 0.2s ease; padding: 0.3rem; margin-left: 0.5rem; font-size: 0.9rem; }
        body.dark .website-preview-header-chat .actions button { color: var(--code-header-text-dark); }
        .website-preview-header-chat .actions button:hover { opacity: 1; transform: scale(1.15); }
        .website-preview-iframe { width: 100%; height: 350px; border: none; display: block; background-color: #fff; }

        /* JS Result Preview */
        .process-js-result-header { background-color: var(--code-header-bg-light); padding: 0.6rem 1rem; font-size: 0.8rem; color: var(--code-header-text-light); border-bottom: 1px solid var(--medium-gray); display: flex; justify-content: space-between; align-items: center;}
        body.dark .process-js-result-header { background-color: var(--code-header-bg-dark); color: var(--code-header-text-dark); border-bottom-color: #6B7280;}
        .process-js-result-content { padding: 0.8rem 1.2rem; }
        .process-js-result-content pre { margin-top: 0.5rem; margin-bottom: 0.5rem; /* Reduce margin inside */}
         .process-js-code-display { /* Style for showing executed code */
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--dark-gray);
            background-color: var(--code-bg);
            padding: 0.5rem 0.8rem;
            border-radius: 0.3rem;
            margin-bottom: 0.75rem;
            overflow-x: auto;
            white-space: pre;
            border: 1px solid var(--light-gray);
         }
         body.dark .process-js-code-display { background-color: var(--code-bg-dark); color: var(--dark-gray); border-color: var(--medium-gray); }

        /* Memory/System Messages */
        .message.memoryUpdate-message {
            background-color: var(--memory-msg-bg-light); color: var(--memory-msg-text-light); border: 1px dashed var(--memory-msg-border-light); /* Dashed border */ padding: 0.6rem 1.1rem; border-radius: 0.75rem; font-size: 0.85rem; text-align: center; box-shadow: none; animation: fadeIn 0.4s ease-out; width: auto; /* Allow centering */ align-self: center; /* Center in wrapper */ margin: 0 auto; /* Center horizontally */ opacity: 0.9;
        }
        body.dark .message.memoryUpdate-message { background-color: var(--memory-msg-bg-dark); color: var(--memory-msg-text-dark); border-color: var(--memory-msg-border-dark); }
        .message.memoryUpdate-message i { margin-right: 0.5rem; opacity: 0.8; }

        /* Other Message Attachments */
        .message-file { display: block; margin-top: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background-color: var(--code-bg); color: var(--text-color); text-decoration: none; transition: background-color 0.3s ease; border: 1px solid var(--medium-gray); display: flex; align-items: center; gap: 0.5rem; }
        .message-file:hover { background-color: var(--light-gray); }
        .message-image { max-width: 100%; height: auto; border-radius: 0.75rem; margin-top: 0.75rem; box-shadow: 0 2px 4px 0 var(--shadow-light); }
        .message-time { font-size: 0.75rem; color: var(--dark-gray); margin-top: 0.5rem; align-self: flex-end; opacity: 0.8; }
        .message-wrapper.user-message-wrapper .message-time { align-self: flex-end; text-align: right; }
        .message-wrapper.ai-message-wrapper .message-time { align-self: flex-start; text-align: left; }
        body.dark .message-wrapper.user-message-wrapper .message-time { color: #9CA3AF; }
        body.dark .message-wrapper.ai-message-wrapper .message-time { color: #9CA3AF; }

        /* Desktop Hover Actions */
        .message-actions { position: absolute; top: -12px; right: 10px; display: none; gap: 0.5rem; background-color: var(--sidebar-light); padding: 0.2rem 0.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(5px); z-index: 2; border: 1px solid var(--light-gray); }
        @media (min-width: 769px) { .message-wrapper:hover .message-actions { display: flex; opacity: 1; transform: translateY(0); } }
        .message-action-button { background: none; border: none; color: var(--dark-gray); cursor: pointer; opacity: 0.7; padding: 0.3rem; border-radius: 50%; transition: all 0.2s ease; font-size: 0.8rem; }
        .message-action-button:hover { opacity: 1; background-color: var(--light-gray); color: var(--primary-color); transform: scale(1.1); }
        body.dark .message-actions { background-color: var(--sidebar-dark); border-color: var(--medium-gray);}
        body.dark .message-action-button:hover { background-color: var(--message-ai-dark); }

        /* Context Menu */
        #message-context-menu { position: fixed; z-index: 55; background-color: var(--sidebar-light); border-radius: 0.6rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 0.5rem 0; min-width: 160px; display: none; border: 1px solid var(--light-gray); }
        #message-context-menu button { display: block; width: 100%; padding: 0.7rem 1.2rem; text-align: left; background: none; border: none; color: var(--text-color); transition: background-color 0.2s ease; cursor: pointer; font-size: 0.9rem; }
        #message-context-menu button:hover { background-color: var(--light-gray); }
        #message-context-menu i { margin-right: 0.75rem; width: 1em; text-align: center; }
        body.dark #message-context-menu { background-color: var(--sidebar-dark); border-color: var(--medium-gray);}
        body.dark #message-context-menu button { color: var(--text-dark); }
        body.dark #message-context-menu button:hover { background-color: var(--message-ai-dark); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicators */
        .typing-indicator { display: flex; align-items: center; justify-content: flex-start; padding: 0.9rem 1.4rem; border-radius: 1.25rem; background-color: var(--message-ai-light); color: var(--message-ai-text-light); width: fit-content; margin: 0.5rem 0 1.25rem 0; box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light); animation: pulse-shadow 1.5s infinite ease-in-out; align-self: flex-start; }
        .typing-indicator span, .generating-dot { display: inline-block; margin-left: 4px; width: 8px; height: 8px; border-radius: 50%; background-color: var(--dark-gray); opacity: 0.7; animation: typingDots 1.4s infinite ease-in-out; }
        .generating-text { margin-right: 6px; font-size: 0.95rem; }
        .typing-indicator span:nth-child(2), .generating-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3), .generating-dot:nth-child(3) { animation-delay: 0.4s; }
        .typing-indicator i { margin-right: 0.6rem; opacity: 0.8; }
        body.dark .typing-indicator { background-color: var(--message-ai-dark); color: var(--message-ai-text-dark); }
        body.dark .typing-indicator span, body.dark .generating-dot { background-color: #9CA3AF; }


        @keyframes pulse-shadow { 0%, 100% { box-shadow: 0 2px 5px 0 var(--shadow-light), 0 1px 2px 0 var(--shadow-light); } 50% { box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light); } }
        @keyframes typingDots { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        /* --- Input Area --- */
        .chat-input-area { padding: 1.25rem 1.75rem; background-color: var(--sidebar-light); border-top: 1px solid var(--light-gray); display: flex; flex-direction: column; /* Stack starters and input wrapper */ align-items: stretch; gap: 0.75rem; box-shadow: 0 -2px 5px var(--shadow-light); position: relative; z-index: 30; flex-shrink: 0; }

        /* Styles when conversation is active (not empty) */
        .chat-input-area:not(.conversation-empty) { padding-top: 0.75rem; padding-bottom: 0.75rem; }

        /* Starter Messages Area */
        #starter-messages-container { display: none; padding-bottom: 0.5rem; /* Space below starters */ }
        .chat-input-area.conversation-empty #starter-messages-container { display: block; animation: fadeInUp 0.5s ease-out; }
        .starter-messages-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; color: var(--text-color); text-align: center; }
        .starter-messages-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjust min width */ gap: 0.75rem; }
        .starter-message-button { padding: 0.8rem 1.1rem; border-radius: 0.6rem; background-color: var(--light-gray); color: var(--text-color); border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 var(--shadow-light); text-align: left; line-height: 1.4; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
        .starter-message-button:hover { background-color: var(--medium-gray); transform: translateY(-2px); box-shadow: 0 2px 4px 0 var(--shadow-light); }
        .starter-message-title { font-weight: 500; margin-bottom: 0.2rem; }
        .starter-message-desc { font-size: 0.8rem; color: var(--dark-gray); opacity: 0.9; }
        body.dark .starter-message-button { background-color: #374151; color: var(--text-dark); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.3); }
        body.dark .starter-message-button:hover { background-color: #4B5563; }
        body.dark .starter-message-desc { color: #9CA3AF; }


        /* Input Row (Wrapper for buttons and textarea) */
        .input-row { display: flex; align-items: flex-end; /* Align items to bottom */ gap: 0.75rem; width: 100%; }
        .image-preview-area { position: absolute; bottom: calc(100% + 0.5rem); /* Position above input area */ left: 1.75rem; background-color: var(--sidebar-light); padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 -2px 5px var(--shadow-light); z-index: 35; display: flex; align-items: flex-start; gap: 0.5rem; border: 1px solid var(--light-gray); }
        body.dark .image-preview-area { background-color: var(--sidebar-dark); border-color: var(--medium-gray);}
        .image-preview { max-height: 60px; border-radius: 0.3rem; box-shadow: 0 1px 3px 0 var(--shadow-light); }
        .remove-image-btn { background-color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2); color: var(--dark-gray); font-size: 0.8rem; line-height: 1; transition: all 0.2s ease; margin-top: -5px; margin-right: -5px; }
        .remove-image-btn:hover { background-color: var(--light-gray); transform: scale(1.1); color: var(--primary-color); }

        /* Input field */
        .chat-input { flex-grow: 1; padding: 0.9rem 1.4rem; border: 1px solid var(--medium-gray); border-radius: 0.75rem; font-size: 1rem; line-height: 1.5rem; outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; box-shadow: inset 0 1px 2px 0 var(--shadow-light); background-color: var(--background-light); color: var(--text-color); resize: none; min-height: 48px; max-height: 150px; overflow-y: auto; }
        .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2), inset 0 1px 2px 0 var(--shadow-light); }
        /* Action Buttons */
        .input-action-button { padding: 0.75rem; width: 48px; height: 48px; border-radius: 0.75rem; background-color: var(--primary-color); color: white; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s ease; box-shadow: 0 2px 4px 0 var(--shadow-light); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.1rem; }
        .input-action-button:hover { background-color: var(--primary-color-hover); transform: translateY(-2px); box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light); }
        .input-action-button:active { transform: translateY(0px) scale(0.98); }
        .input-action-button:disabled { background-color: var(--medium-gray); cursor: not-allowed; transform: none; box-shadow: 0 2px 4px 0 var(--shadow-light); opacity: 0.7; }
        .attach-button { background-color: var(--light-gray); color: var(--dark-gray); }
        .attach-button:hover { background-color: var(--medium-gray); color: var(--text-color); }
        .attach-button label { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        body.dark .attach-button { background-color: #374151; color: #9CA3AF; }
        body.dark .attach-button:hover { background-color: #4B5563; color: var(--text-dark); }

        /* --- Sidebar Buttons --- */
        #new-conversation, #premium-button, #suggestions-button, #open-settings { margin: 0.5rem 0; padding: 0.8rem 1.2rem; border-radius: 0.5rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-size: 0.95rem; font-weight: 500; transition: all 0.2s ease; border: 1px solid transparent; }
        #new-conversation { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #new-conversation:hover { background-color: var(--primary-color-hover); border-color: var(--primary-color-hover); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(139, 92, 246, 0.3); }
        #premium-button { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        #premium-button:hover { background-color: #F59E0B; border-color: #F59E0B; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(251, 191, 36, 0.3); }
        #suggestions-button, #open-settings { background-color: var(--sidebar-light); color: var(--dark-gray); border: 1px solid var(--medium-gray); }
        #suggestions-button:hover, #open-settings:hover { background-color: var(--light-gray); color: var(--text-color); border-color: var(--dark-gray); transform: translateY(-2px); box-shadow: 0 2px 5px var(--shadow-light); }
        body.dark #new-conversation:hover { box-shadow: 0 2px 5px rgba(139, 92, 246, 0.4); }
        body.dark #premium-button:hover { box-shadow: 0 2px 5px rgba(251, 191, 36, 0.4); }
        body.dark #suggestions-button, body.dark #open-settings { border-color: var(--medium-gray); color: var(--dark-gray);}
        body.dark #suggestions-button:hover, body.dark #open-settings:hover { background-color: #374151; color: var(--text-dark); border-color: #6B7280; box-shadow: 0 2px 5px var(--shadow-dark); }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--sidebar-light); border-radius: 0.8rem; padding: 2rem; max-width: 600px; width: 95%; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); transform: scale(0.95); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; overflow-y: auto; max-height: 90vh; border: 1px solid var(--light-gray); }
        .modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }
        .modal-header { font-size: 1.6rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-color); text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .modal-header i { color: var(--primary-color); }
        .modal-body { margin-bottom: 1.75rem; color: var(--text-color); line-height: 1.6; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; }
        .modal-btn { padding: 0.7rem 1.4rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 1px 3px 0 var(--shadow-light); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .modal-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px 0 var(--shadow-light); }
        .modal-btn:active { transform: translateY(0px) scale(0.98); }
        .modal-btn-primary { background-color: var(--primary-color); color: white; }
        .modal-btn-primary:hover { background-color: var(--primary-color-hover); }
        .modal-btn-secondary { background-color: var(--light-gray); color: var(--text-color); }
        .modal-btn-secondary:hover { background-color: var(--medium-gray); }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal-body .input-group { display: flex; align-items: center; border: 1px solid var(--medium-gray); border-radius: 0.5rem; overflow: hidden; background-color: var(--background-light); }
        .modal-body .input-group-icon { padding: 0.75rem; background-color: var(--light-gray); color: var(--dark-gray); }
        .modal-body .input-group input { border: none; padding: 0.75rem 1rem; flex-grow: 1; background: none; color: var(--text-light); }
        .modal-body .input-group input:focus { outline: none; box-shadow: none; }
        .modal-body input[type="text"], .modal-body input[type="number"], .modal-body input[type="date"], .modal-body input[type="email"], .modal-body input[type="password"], .modal-body select, .modal-body textarea { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--medium-gray); background-color: var(--background-light); color: var(--text-light); transition: border-color 0.2s ease, box-shadow 0.2s ease; margin-top: 0.25rem; }
        .modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        .modal-body textarea { min-height: 100px; resize: vertical; }
        body.dark .modal-content { background-color: #1F2937; border-color: var(--medium-gray); }
        body.dark .modal-overlay { background-color: rgba(0, 0, 0, 0.7); }
        body.dark .modal-body label { color: var(--text-dark); }
        body.dark .modal-body .input-group { border-color: #6B7280; background-color: #374151; }
        body.dark .modal-body .input-group-icon { background-color: #4B5563; color: #9CA3AF; }
        body.dark .modal-body .input-group input { color: var(--text-dark); }
        body.dark .modal-body input, body.dark .modal-body select, body.dark .modal-body textarea { background-color: #374151; border-color: #6B7280; color: var(--text-dark); }
        body.dark .modal-body input:focus, body.dark .modal-body select:focus, body.dark .modal-body textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3); }
        body.dark .modal-btn-secondary { background-color: #374151; color: var(--text-dark); }
        body.dark .modal-btn-secondary:hover { background-color: #4B5563; }


         /* --- Premium Ad Modal Table (Improved) --- */
        #premium-ad-modal table { width: 100%; border-collapse: separate; border-spacing: 0; }
        #premium-ad-modal th, #premium-ad-modal td { padding: 0.9rem 0.7rem; border-bottom: 1px solid var(--light-gray); text-align: center; font-size: 0.95rem; }
        #premium-ad-modal th { background-color: var(--light-gray); font-weight: 600; text-align: left; border-top: 1px solid var(--light-gray); }
        #premium-ad-modal th:first-child { border-top-left-radius: 0.5rem; }
        #premium-ad-modal th:last-child { border-top-right-radius: 0.5rem; }
        #premium-ad-modal th:not(:first-child) { text-align: center; }
        #premium-ad-modal tbody tr:last-child td { border-bottom: 1px solid var(--light-gray); } /* Keep bottom border consistent */
        #premium-ad-modal tbody tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        #premium-ad-modal tbody tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }
        #premium-ad-modal .premium-col { font-weight: 600; color: var(--primary-color); background-color: #F5F3FF; } /* Highlight premium col slightly */
        body.dark #premium-ad-modal th { background-color: var(--darker-gray); border-color: var(--medium-gray); }
        body.dark #premium-ad-modal td { border-color: var(--medium-gray); }
        body.dark #premium-ad-modal .premium-col { color: var(--primary-color-hover); background-color: rgba(167, 139, 250, 0.1); }
        #premium-ad-modal .fa-check { color: var(--secondary-color); }
        #premium-ad-modal .fa-times { color: var(--danger-color); }
        #premium-ad-modal .fa-infinity { color: var(--primary-color); font-size: 1.1em; }


        /* Dark Mode Specifics */
        body.dark {
            --background-color: var(--background-dark);
            --text-color: var(--text-dark);
            --light-gray: #374151; /* Darker Light Gray */
            --medium-gray: #4B5563; /* Darker Medium Gray */
            --dark-gray: #9CA3AF;   /* Lighter Dark Gray */
            --darker-gray: #D1D5DB; /* Lighter Darker Gray */
            --code-bg: var(--code-bg-dark);
            --shadow-light: var(--shadow-dark); /* Use dark shadow */
            --sidebar-light: var(--sidebar-dark);
            --message-user-light: var(--message-user-dark);
            --message-ai-light: var(--message-ai-dark);
            --message-user-text-light: var(--message-user-text-dark);
            --message-ai-text-light: var(--message-ai-text-dark);
            --pinned-background-light: var(--pinned-background-dark);
            --pinned-border-light: var(--pinned-border-dark);
            --memory-msg-bg-light: var(--memory-msg-bg-dark);
            --memory-msg-text-light: var(--memory-msg-text-dark);
            --memory-msg-border-light: var(--memory-msg-border-dark);
            --code-header-bg-light: var(--code-header-bg-dark);
            --code-header-text-light: var(--code-header-text-dark);

            --toast-success-bg: #064E3B; --toast-success-text: #A7F3D0;
            --toast-error-bg: #7F1D1D; --toast-error-text: #FECACA;
            --toast-info-bg: #1E3A8A; --toast-info-text: #BFDBFE;
        }
        body.dark .app-container { background-color: var(--background-dark); }
        body.dark .sidebar, body.dark .chat-input-area, body.dark .modal-content, body.dark .chat-header { border-color: var(--medium-gray); background-color: var(--sidebar-dark); }
        body.dark .chat-messages-container { background-color: var(--background-dark); }
        body.dark .chat-input-area { box-shadow: 0 -2px 5px var(--shadow-dark); }
        body.dark .chat-input { background-color: #4B5563; color: var(--text-dark); border-color: #6B7280; box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.2); }
        body.dark .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3), inset 0 1px 2px 0 rgba(0,0,0,0.2); }
        body.dark .conversation-item:hover { background-color: #374151; }
        body.dark .conversation-item.active { background-color: var(--primary-color); }
        body.dark .conversation-item.active:hover { background-color: var(--primary-color-hover); }
        body.dark .message.ai-message, body.dark .message.imageGen-message, body.dark .message.websiteCode-message, body.dark .message.processJsResult-message { background-color: var(--message-ai-dark); color: var(--message-ai-text-dark); border-color: var(--medium-gray); }
        body.dark .message-file { background-color: var(--code-bg-dark); color: var(--text-dark); border-color: var(--medium-gray); }
        body.dark .message-file:hover { background-color: var(--medium-gray); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--medium-gray); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--dark-gray); }
        body.dark ::-webkit-scrollbar-thumb { background-color: #4B5563; }
        body.dark ::-webkit-scrollbar-thumb:hover { background-color: #6B7280; }
        .sidebar-content-wrapper::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        body.dark .sidebar-content-wrapper::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }

        /* Pinned Conversation */
        .pinned-conversation { background-color: var(--pinned-background-light); border-left: 4px solid var(--pinned-border-light); }
        body.dark .pinned-conversation { background-color: var(--pinned-background-dark); border-left-color: var(--pinned-border-dark); color: var(--text-dark); }
        body.dark .pinned-conversation:hover { background-color: rgba(55, 48, 163, 0.8); }
        .pinned-conversation:hover { background-color: #FEF9C3; }
        .pinned-conversation.active { background-color: var(--primary-color) !important; color: white !important; border-left-color: var(--primary-color-hover) !important; }
        .pinned-conversation.active .conversation-title { color: white !important; }

        /* Premium Badge */
        .premium-badge { display: inline-flex; align-items: center; justify-content: center; padding: 0.15rem 0.5rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600; color: #422006; background-color: var(--accent-color); margin-left: 0.5rem; vertical-align: middle; line-height: 1; animation: pulse-badge 2.5s infinite ease-in-out; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.08); opacity: 1; } }

        /* Input Validation */
        input:invalid, textarea:invalid { border-color: var(--danger-color) !important; }
        input:focus:invalid, textarea:focus:invalid { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3) !important; }
        .error-message { color: var(--danger-color); font-size: 0.875rem; margin-top: 0.25rem; display: block; }
        .hidden { display: none !important; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
        .toast { background-color: #fff; color: var(--text-light); padding: 0.8rem 1.2rem; border-radius: 0.5rem; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); opacity: 0; min-width: 250px; max-width: 350px; border-left-width: 4px; border-style: solid; display: flex; align-items: center; gap: 0.5rem; animation: slideInUp 0.3s ease-out forwards, fadeOut 0.3s ease-in forwards 3.2s; }
        .toast i { font-size: 1.1rem; flex-shrink: 0; }
        .toast span { flex-grow: 1; }
        .toast.success { border-color: var(--toast-success-border); background-color: var(--toast-success-bg); color: var(--toast-success-text); }
        .toast.error { border-color: var(--toast-error-border); background-color: var(--toast-error-bg); color: var(--toast-error-text); }
        .toast.info { border-color: var(--toast-info-border); background-color: var(--toast-info-bg); color: var(--toast-info-text); }
        body.dark .toast { box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3); }
        body.dark .toast.success { background-color: var(--toast-success-bg); color: var(--toast-success-text); }
        body.dark .toast.error { background-color: var(--toast-error-bg); color: var(--toast-error-text); }
        body.dark .toast.info { background-color: var(--toast-info-bg); color: var(--toast-info-text); }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }


        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .app-container { margin: 0; border-radius: 0; }
            .chat-area { width: 100%; }
            .sidebar-header, .sidebar-footer, .sidebar-actions { padding: 1.2rem; }
            .sidebar-content { padding: 1rem; }
            .sidebar-title { font-size: 1.3rem; }
            #toggle-sidebar-desktop { display: none; }
            #mobile-sidebar-toggle { display: block; }
            #toggle-sidebar { display: block; }
            .chat-header { padding: 0.8rem; min-height: 60px; }
            .chat-title { font-size: 1.1rem; max-width: calc(100% - 120px); }
            .chat-messages-container { padding: 0.8rem; padding-bottom: 1rem; }
            .message { max-width: 90%; padding: 0.7rem 1rem; font-size: 0.95rem; }
            .message-wrapper { max-width: 95%; }
            .message-actions { display: none !important; } /* Hide hover actions on mobile */
            /* Sticky Input Area for Mobile */
            .chat-input-area { padding: 0.8rem; gap: 0.5rem; position: sticky; bottom: 0; left: 0; right: 0; z-index: 30; }
            .chat-input { padding: 0.7rem 1rem; font-size: 0.95rem; min-height: 42px; max-height: 120px; }
            .input-action-button { width: 42px; height: 42px; font-size: 1rem; }
            .image-preview-area { left: 0.8rem; bottom: calc(100% + 0.5rem); }
            .modal-content { width: 90%; padding: 1.2rem; }
            .modal-header { font-size: 1.3rem; margin-bottom: 1rem; }
            .starter-messages-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        }

        /* NProgress Bar Customization */
        #nprogress .bar { background: var(--primary-color) !important; height: 3px !important; z-index: 1031; position: absolute; top: 0; left: 0; }
        #nprogress .peg { box-shadow: 0 0 10px var(--primary-color), 0 0 5px var(--primary-color) !important; }
        #nprogress .spinner { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Message Context Menu -->
    <div id="message-context-menu" class="animate__animated animate__fadeIn animate__faster" style="display:none;">
        <button id="edit-context-button"><i class="fas fa-edit"></i> Edit</button>
        <button id="copy-context-button"><i class="fas fa-copy"></i> Copy</button>
        <button id="regenerate-context-button"><i class="fas fa-sync"></i> Regenerate</button>
        <button id="delete-context-button"><i class="fas fa-trash"></i> Delete</button>
    </div>

    <!-- Modals -->
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay" style="display: none;">
         <div class="modal-content animate__animated animate__fadeIn animate__faster">
            <h2 class="modal-header"><i class="fas fa-magic"></i> Welcome to <span class="font-extrabold text-primary-500">PyroAI v2.5</span>!</h2>
            <div class="modal-body">
                <p class="mb-4 text-lg">
                    Discover the enhanced capabilities of PyroAI v2.5! Before you dive in, please review and accept the terms:
                </p>
                <ul class="list-disc list-inside mb-4 space-y-2 text-sm bg-gray-100 dark:bg-gray-800 p-4 rounded-md border border-gray-200 dark:border-gray-700">
                    <li><span class="font-semibold">Beta Status:</span> This platform is actively developed. Report bugs via Feedback.</li>
                    <li><span class="font-semibold">Data Logging:</span> Conversations may be logged anonymously for improvement.</li>
                    <li><span class="font-semibold">Secure Storage:</span> Your chats and settings are stored locally using basic browser encryption (obfuscation). While this adds a layer of privacy, avoid extremely sensitive data.</li>
                    <li><span class="font-semibold">Data Sensitivity:</span> Do not share highly confidential personal information. PyroLLC is not liable for user-shared data.</li>
                    <li><span class="font-semibold">AI Capabilities:</span> Generate text, images (<code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">&lt;imageGen:"prompt"&gt;</code>), website previews (HTML/CSS), execute browser JS (<code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">&lt;processJS:"code"[, output:true]&gt;</code>), and utilize memory (<code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">&lt;Memory:"key:value"&gt;</code>).</li>
                    <li><span class="font-semibold">"As Is" Service:</span> Provided without explicit warranties.</li>
                    <li><span class="font-semibold">Agreement:</span> By clicking Accept, you agree to these terms.</li>
                </ul>
                <p class="text-center font-medium">Ready to explore the enhanced PyroAI?</p>
            </div>
            <div class="modal-footer">
                <button id="accept-terms" class="modal-btn modal-btn-primary w-full text-lg">
                    <i class="fas fa-check-circle"></i> Accept & Enter PyroAI
                </button>
            </div>
        </div>
    </div>

    <!-- Initial Setup Modal (Improved UI) -->
    <div id="initial-setup-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-user-cog"></i> Personalize Your PyroAI</h2>
            <div class="modal-body">
                <p class="mb-6 text-center text-gray-700 dark:text-gray-300">A few details to tailor your experience and secure your chats.</p>
                <div class="space-y-5">
                    <div class="input-group">
                        <span class="input-group-icon"><i class="fas fa-user w-4 text-center"></i></span>
                        <input type="text" id="setup-username" placeholder="Choose a username (3-20 chars)" required minlength="3" maxlength="20">
                    </div>
                    <p id="username-error" class="error-message hidden -mt-3 ml-2">Username must be 3-20 characters.</p>

                    <div class="input-group">
                         <span class="input-group-icon"><i class="fas fa-calendar-alt w-4 text-center"></i></span>
                        <input type="date" id="setup-dob" required class="text-gray-500 dark:text-gray-400"> <!-- Date inputs look different, apply styling -->
                    </div>
                    <p id="dob-error" class="error-message hidden -mt-3 ml-2">Date of birth required (must be 18+).</p>

                    <div class="input-group">
                         <span class="input-group-icon"><i class="fas fa-envelope w-4 text-center"></i></span>
                        <input type="email" id="setup-email" placeholder="Email Address (Optional)">
                    </div>
                     <p id="email-error" class="error-message hidden -mt-3 ml-2">Invalid email format.</p>

                    <div class="input-group">
                         <span class="input-group-icon"><i class="fas fa-lock w-4 text-center"></i></span>
                        <input type="password" id="setup-pin" placeholder="Create 4-digit PIN" required pattern="[0-9]{4}" inputmode="numeric" maxlength="4">
                    </div>
                    <p id="pin-error" class="error-message hidden -mt-3 ml-2">PIN must be exactly 4 digits.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="complete-setup" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-check-circle"></i> Complete Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Age Block Modal -->
    <div id="age-block-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-ban text-red-500"></i> Access Restricted</h2>
            <div class="modal-body text-center">
                <p class="mb-4 text-lg">You must be 18 years or older to use PyroAI.</p>
                <p>Access has been blocked based on the date of birth provided.</p>
            </div>
            <div class="modal-footer">
                <button id="close-age-block" class="modal-btn modal-btn-secondary w-full">
                    <i class="fas fa-times-circle"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Key Modal -->
    <div id="premium-key-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-crown text-yellow-500"></i> Activate Premium</h2>
            <div class="modal-body">
                <p class="mb-4 text-center">Enter your Premium Key to unlock all features and higher limits.</p>
                <div class="mb-4 input-group">
                     <span class="input-group-icon"><i class="fas fa-key w-4 text-center"></i></span>
                    <input type="text" id="premium-key-input" placeholder="Enter your premium key">
                </div>
                <div id="premium-key-status" class="error-message hidden text-center"><i class="fas fa-exclamation-triangle mr-1"></i> Invalid key. Please check and try again.</div>
            </div>
            <div class="modal-footer">
                <button id="cancel-premium-key" class="modal-btn modal-btn-secondary"><i class="fas fa-ban"></i> Cancel</button>
                <button id="activate-premium" class="modal-btn modal-btn-primary"><i class="fas fa-lock-open"></i> Activate</button>
            </div>
        </div>
    </div>

    <!-- Premium Ad Modal (Improved UI) -->
    <div id="premium-ad-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn max-w-3xl"> <!-- Wider modal -->
            <h2 class="modal-header"><i class="fas fa-rocket text-yellow-500"></i> Go Premium with PyroAI!</h2>
            <div class="modal-body">
                <p class="mb-6 text-lg text-center font-medium text-gray-700 dark:text-gray-300"> Unleash the full potential of AI! Upgrade for higher limits, advanced models, and exclusive features.</p>
                <div class="overflow-x-auto mb-6 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider">Feature</th>
                                <th class="px-3 py-3 text-center text-xs font-semibold uppercase tracking-wider">Free</th>
                                <th class="px-3 py-3 text-center text-xs font-semibold uppercase tracking-wider premium-col">Premium <i class="fas fa-star text-xs ml-1"></i></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                             <tr> <td class="px-3 py-3 text-sm font-medium">Core Features</td> <td class="px-3 py-3 text-sm text-center"></td> <td class="px-3 py-3 text-sm text-center premium-col"></td> </tr>
                            <tr> <td>Messages per Chat</td> <td class="text-center">15</td> <td class="text-center premium-col">40</td> </tr>
                            <tr> <td>Max Conversations</td> <td class="text-center">3</td> <td class="text-center premium-col"><i class="fas fa-infinity"></i></td> </tr>
                            <tr> <td>Daily Messages</td> <td class="text-center">25</td> <td class="text-center premium-col">150</td> </tr>
                            <tr> <td>Daily Images/Files</td> <td class="text-center">5</td> <td class="text-center premium-col">30</td> </tr>
                            <tr> <td>Message Characters</td> <td class="text-center">1,500</td> <td class="text-center premium-col">10,000</td> </tr>
                            <tr> <td class="px-3 py-3 text-sm font-medium">AI Models</td> <td class="px-3 py-3 text-sm text-center"></td> <td class="px-3 py-3 text-sm text-center premium-col"></td> </tr>
                            <tr> <td>Available Models</td> <td class="text-center">Flash Lite</td> <td class="text-center premium-col">Flash, Pro</td> </tr>
                            <tr> <td class="px-3 py-3 text-sm font-medium">Advanced Capabilities</td> <td class="px-3 py-3 text-sm text-center"></td> <td class="px-3 py-3 text-sm text-center premium-col"></td> </tr>
                            <tr> <td>Image Generation</td> <td class="text-center"><i class="fas fa-check"></i> (Limited)</td> <td class="text-center premium-col"><i class="fas fa-check"></i> (Enhanced)</td> </tr>
                            <tr> <td>Website Preview</td> <td class="text-center"><i class="fas fa-check"></i></td> <td class="text-center premium-col"><i class="fas fa-check"></i></td> </tr>
                            <tr> <td>JS Execution</td> <td class="text-center"><i class="fas fa-check"></i></td> <td class="text-center premium-col"><i class="fas fa-check"></i></td> </tr>
                            <tr> <td>Conversation Memory</td> <td class="text-center"><i class="fas fa-check"></i></td> <td class="text-center premium-col"><i class="fas fa-check"></i> (Enhanced Context)</td> </tr>
                             <tr> <td>Encrypted Storage</td> <td class="text-center"><i class="fas fa-check"></i></td> <td class="text-center premium-col"><i class="fas fa-check"></i></td> </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-sm text-center text-gray-600 dark:text-gray-400">Upgrade now for a smarter, faster, and unrestricted AI experience!</p>
            </div>
            <div class="modal-footer">
                <button id="close-premium-ad" class="modal-btn modal-btn-secondary"><i class="fas fa-times-circle"></i> Continue Free</button>
                <button id="go-premium-ad" class="modal-btn modal-btn-primary"><i class="fas fa-crown"></i> Go Premium</button>
            </div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestions-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-comment-dots text-info-500"></i> Suggestions & Feedback</h2>
            <div class="modal-body">
                <p class="mb-4 text-center">Your feedback helps us improve PyroAI! Share your thoughts, suggestions, or report issues.</p>
                <div class="mb-4">
                    <label for="suggestion-textarea" class="flex items-center"><i class="fas fa-pen-alt mr-2"></i> Your Feedback</label>
                    <textarea id="suggestion-textarea" rows="5" placeholder="Enter your feedback here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-suggestions" class="modal-btn modal-btn-secondary"><i class="fas fa-ban"></i> Cancel</button>
                <button id="suggestions-send" class="modal-btn modal-btn-primary"><i class="fas fa-paper-plane"></i> Send Feedback</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn max-w-2xl">
            <h2 class="modal-header"><i class="fas fa-cog"></i> Settings</h2>
            <div class="modal-body space-y-6">
                 <!-- Appearance -->
                 <fieldset class="border border-gray-300 dark:border-gray-600 p-4 rounded-md">
                     <legend class="text-sm font-medium px-2"><i class="fas fa-palette mr-1"></i> Appearance</legend>
                     <div class="flex items-center justify-between">
                        <label for="theme" class="mb-0">Theme</label>
                        <select id="theme" class="w-1/2">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                 </fieldset>

                 <!-- AI Configuration -->
                  <fieldset class="border border-gray-300 dark:border-gray-600 p-4 rounded-md">
                     <legend class="text-sm font-medium px-2"><i class="fas fa-brain mr-1"></i> AI Configuration</legend>
                     <div class="space-y-4">
                         <div class="flex items-center justify-between">
                            <label for="message-history-limit" class="mb-0">Message History Limit</label>
                            <input type="number" id="message-history-limit" value="50" min="10" max="100" class="w-1/2">
                        </div>
                         <div class="flex items-center justify-between">
                            <label for="ai-model" class="mb-0">Gemini API Model</label>
                            <select id="ai-model" class="w-1/2">
                                {/* Options loaded by JS */}
                            </select>
                        </div>
                         <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-right">Premium required for Pro model.</p>
                         <div class="flex items-center justify-between">
                             <label for="ai-assistant-mode" class="mb-0">Assistant Prompt Mode</label>
                             <select id="ai-assistant-mode" class="w-1/2">
                                <option value="auto">Auto-generate Prompt</option>
                                <option value="manual">Manual Prompt</option>
                             </select>
                        </div>
                     </div>
                  </fieldset>

                 <!-- Ollama Configuration -->
                <fieldset class="border border-gray-300 dark:border-gray-600 p-4 rounded-md">
                    <legend class="text-sm font-medium px-2"><i class="fas fa-server mr-1"></i> Local AI (Ollama)</legend>
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="ollama-enabled" class="mr-2 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <label for="ollama-enabled" class="font-medium flex items-center">Enable Ollama API</label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Use a self-hosted Ollama instance instead of Google Gemini.</p>
                     <div id="ollama-settings" class="space-y-4 hidden pl-4 border-l-2 border-gray-200 dark:border-gray-600 ml-2">
                         <div class="flex items-center justify-between">
                            <label for="ollama-api-url" class="mb-0">API URL</label>
                            <input type="text" id="ollama-api-url" placeholder="http://localhost:11434" class="w-2/3">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="ollama-model-select" class="mb-0">Model</label>
                            <select id="ollama-model-select" class="w-2/3">
                                <option value="deepseek-coder:6.7b-instruct">deepseek-coder:6.7b</option>
                                <option value="gemma:7b-instruct">gemma:7b</option>
                                <option value="llama3:8b-instruct">llama3:8b</option>
                                <option value="mistral:7b-instruct">mistral:7b</option>
                                <option value="phi3:3.8b-mini-instruct">phi3:mini</option>
                                <option value="qwen:7b-chat">qwen:7b</option>
                                <option value="custom">Custom Model</option>
                            </select>
                        </div>
                         <div id="ollama-custom-model-input-container" class="flex items-center justify-between hidden">
                            <label for="ollama-custom-model-input" class="mb-0">Custom Model Name</label>
                            <input type="text" id="ollama-custom-model-input" placeholder="e.g., my-model:latest" class="w-2/3">
                        </div>
                     </div>
                 </fieldset>

                 <!-- Memory Management -->
                <fieldset class="border border-gray-300 dark:border-gray-600 p-4 rounded-md">
                    <legend class="text-sm font-medium px-2"><i class="fas fa-memory mr-1"></i> Memory Management</legend>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">AI uses this information for personalization. Stored locally.</p>
                    <div id="memory-list" class="mt-2 text-sm max-h-40 overflow-y-auto bg-gray-50 dark:bg-gray-700 p-3 rounded border border-gray-200 dark:border-gray-600 space-y-2">
                        {/* Memory items loaded by JS */}
                    </div>
                     <button id="clear-memory" class="modal-btn modal-btn-secondary mt-3 w-full text-sm py-2 border border-red-500 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50">
                        <i class="fas fa-trash"></i> Clear All Memories
                    </button>
                </fieldset>
            </div>
            <div class="modal-footer">
                <button id="close-settings" class="modal-btn modal-btn-secondary"><i class="fas fa-ban"></i> Cancel</button>
                <button id="save-settings" class="modal-btn modal-btn-primary"><i class="fas fa-save"></i> Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Change Assistant Modal -->
    <div id="assistant-modal" class="modal-overlay" style="display: none;">
         <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-robot text-primary-500"></i> AI Assistants</h2>
            <div id="assistant-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 modal-body max-h-[60vh] overflow-y-auto p-1">
                 <!-- Assistant cards loaded by JS -->
            </div>
            <div class="modal-footer flex-col items-stretch space-y-2">
                 <button id="new-assistant" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-plus"></i> New Assistant
                </button>
                <div class="flex gap-2">
                    <button id="import-assistant" class="modal-btn modal-btn-secondary flex-1">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                     <button id="export-assistants" class="modal-btn modal-btn-secondary flex-1">
                        <i class="fas fa-file-export"></i> Export All
                    </button>
                </div>
                <button id="close-assistant-modal" class="modal-btn modal-btn-secondary w-full"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- New/Edit Assistant Modal -->
    <div id="new-assistant-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 id="new-assistant-modal-title" class="modal-header"><i class="fas fa-plus-circle"></i> Create New Assistant</h2>
            <div class="modal-body space-y-4">
                <input type="hidden" id="editing-assistant-id">
                <div>
                    <label for="assistant-name" class="flex items-center"><i class="fas fa-user-tag mr-2 w-4 text-center"></i> Assistant Name</label>
                    <input type="text" id="assistant-name" placeholder="e.g., Code Helper, Story Writer">
                </div>
                <div>
                    <label for="assistant-description" class="flex items-center"><i class="fas fa-info-circle mr-2 w-4 text-center"></i> Description (Optional)</label>
                    <input type="text" id="assistant-description" placeholder="Short description for identification">
                </div>
                <div id="prompt-mode-manual-area">
                    <label for="assistant-prompt" class="flex items-center"><i class="fas fa-file-alt mr-2 w-4 text-center"></i> System Prompt</label>
                    <textarea id="assistant-prompt" rows="8" placeholder="Define the AI's role, personality, capabilities, and instructions... Use <imageGen>, <processJS>, <Memory>, <websiteCode> tags where needed."></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Clearly define behavior. Include dynamic placeholders like <code class="text-xs">{USER_NAME}</code> and <code class="text-xs">{CURRENT_DATETIME}</code> if desired.</p>
                </div>
                 <div id="prompt-mode-auto-area" class="hidden text-center p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-md">
                    <p class="text-gray-700 dark:text-gray-300 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i> Generating system prompt...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-new-assistant" class="modal-btn modal-btn-secondary"><i class="fas fa-ban"></i> Cancel</button>
                <button id="generate-assistant-prompt" class="modal-btn modal-btn-secondary" style="display:none;"><i class="fas fa-magic"></i> Generate Prompt</button>
                <button id="save-new-assistant" class="modal-btn modal-btn-primary"><i class="fas fa-save"></i> Save Assistant</button>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-edit"></i> Edit Message</h2>
            <div class="modal-body">
                <label for="edit-message-textarea" class="flex items-center"><i class="fas fa-pen-to-square mr-2"></i> Edit your message below:</label>
                <textarea id="edit-message-textarea" rows="6"></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancel-edit-message" class="modal-btn modal-btn-secondary"><i class="fas fa-ban"></i> Cancel</button>
                <button id="save-edit-message" class="modal-btn modal-btn-primary"><i class="fas fa-save"></i> Save & Re-run</button>
            </div>
        </div>
    </div>


    <!-- Main App Layout -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo-area">
                     <i class="fas fa-fire text-primary-500 text-2xl"></i>
                    <h1 class="sidebar-title animate__animated animate__fadeInLeft animate__faster"><span>PyroAI</span></h1>
                </div>
                <!-- Desktop Toggle Button -->
                <button id="toggle-sidebar-desktop" class="hidden md:block" aria-label="Toggle Sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
                 <!-- Mobile Close Button -->
                 <button id="toggle-sidebar" class="md:hidden" aria-label="Close Sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Content Area -->
            <div class="sidebar-content-wrapper">
                <div class="sidebar-content">
                     <button id="new-conversation" class="mb-4 w-full">
                        <i class="fas fa-plus mr-2"></i> <span>New Chat</span>
                    </button>
                     <div class="relative mb-3">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"> <i class="fas fa-search text-gray-500 dark:text-gray-400 text-xs"></i> </div>
                        <input type="text" id="search-conversations" class="chat-input w-full pl-8 py-2 text-sm" placeholder="Search chats...">
                    </div>

                    <!-- Pinned Conversations -->
                     <div class="animate__animated animate__fadeInLeft animate__fast mb-4">
                        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider flex items-center"><i class="fas fa-thumbtack text-gray-400 dark:text-gray-500 mr-2 text-xs"></i> <span>Pinned</span></h2>
                        <ul id="pinned-list" class="conversation-list"></ul>
                    </div>

                    <!-- Regular Conversations -->
                    <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.1s mb-4">
                        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider flex items-center"><i class="fas fa-comments text-gray-400 dark:text-gray-500 mr-2 text-xs"></i> <span>Chats</span></h2>
                        <ul id="conversation-list" class="conversation-list"></ul>
                    </div>

                     <!-- Archived Conversations -->
                    <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.2s mt-4">
                        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wider flex items-center"><i class="fas fa-archive text-gray-400 dark:text-gray-500 mr-2 text-xs"></i> <span>Archived</span></h2>
                        <ul id="archived-list" class="conversation-list"></ul>
                    </div>
                </div>
            </div>

             <!-- Sidebar Actions (Import/Export Chats) -->
            <div class="sidebar-actions">
                 <button id="import-chats-button" class="sidebar-action-button" title="Import Chats (.json)">
                     <i class="fas fa-file-import"></i> <span>Import</span>
                 </button>
                 <button id="export-chats-button" class="sidebar-action-button" title="Export All Chats (.json)">
                     <i class="fas fa-file-export"></i> <span>Export</span>
                 </button>
             </div>


            <div class="sidebar-footer animate__animated animate__fadeInLeft animate__fast animate__delay-0.3s space-y-2">
                 <div class="user-profile mb-2 flex items-center justify-center text-sm text-gray-700 dark:text-gray-300">
                     <i class="fas fa-user-circle mr-2"></i>
                    <span id="sidebar-username">User</span><span id="premium-user-badge"></span>
                </div>
                <button id="premium-button" style="display: none;">
                    <i class="fas fa-crown mr-2"></i> <span>Go Premium</span>
                </button>
                <button id="suggestions-button">
                    <i class="fas fa-comment-dots mr-2"></i> <span>Feedback</span>
                </button>
                <button id="open-settings">
                    <i class="fas fa-cog mr-2"></i> <span>Settings</span>
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <!-- Chat Header -->
            <header class="chat-header">
                <div class="flex items-center">
                    <button id="mobile-sidebar-toggle" class="md:hidden" aria-label="Open Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="current-conversation-title" class="chat-title animate__animated animate__fadeIn animate__faster">Select or Start a Chat</h2>
                </div>
                <div class="flex items-center animate__animated animate__fadeIn animate__faster gap-2">
                     <button id="change-assistant" class="modal-btn modal-btn-secondary py-2 px-3 text-sm" title="Change AI Assistant">
                        <i class="fas fa-robot"></i><span class="hidden md:inline-block ml-2">Assistant</span>
                    </button>
                     <button id="export-current-chat" class="modal-btn modal-btn-secondary py-2 px-3 text-sm" title="Export Current Chat">
                        <i class="fas fa-download"></i><span class="hidden md:inline-block ml-2">Export</span>
                    </button>
                     <button id="regenerate-header-button" class="modal-btn modal-btn-secondary py-2 px-3 text-sm" title="Regenerate last response" style="display: none;">
                        <i class="fas fa-sync"></i><span class="hidden md:inline-block ml-2">Regenerate</span>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages-container">
                {/* Typing Indicators go here */}
                <div id="printing-animation" class="typing-indicator" style="display: none;">
                    <i class="fas fa-circle-notch fa-spin"></i> <span class="generating-text">Thinking</span><span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                 <div id="image-generating-animation" class="typing-indicator" style="display: none;">
                    <i class="fas fa-image animate-pulse"></i> <span class="generating-text">Drawing</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                <div id="ollama-generating-animation" class="typing-indicator" style="display: none;">
                    <i class="fas fa-server animate-pulse"></i> <span class="generating-text">Ollama Generating</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                 <div id="website-generating-animation" class="typing-indicator" style="display: none;">
                    <i class="fas fa-code animate-pulse"></i> <span class="generating-text">Generating Website</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                <div id="process-js-animation" class="typing-indicator" style="display: none;">
                    <i class="fas fa-terminal animate-pulse"></i> <span class="generating-text">Executing JS</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                 {/* Placeholder for initial state */}
                 <div id="chat-placeholder" class="text-center text-gray-400 dark:text-gray-500 mt-10 hidden">
                    <i class="fas fa-comments text-4xl mb-4"></i>
                    <p>Select a chat or start a new one!</p>
                 </div>
            </div>

            <!-- Input Area -->
            <div id="chat-input-area" class="chat-input-area conversation-empty">

                <!-- Starter Messages -->
                <div id="starter-messages-container">
                    <h3 class="starter-messages-header animate__animated animate__fadeIn animate__faster">Start a conversation</h3>
                    <div id="starter-messages-grid" class="starter-messages-grid">
                        {/* Starter messages loaded by JS */}
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="image-preview-area" class="image-preview-area hidden animate__animated animate__fadeInUp animate__faster">
                    <img id="preview-image" class="image-preview" src="#" alt="Image Preview">
                    <button id="remove-preview-image" class="remove-image-btn" aria-label="Remove Image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Input Row -->
                <div class="input-row">
                    <button id="attach-button-wrapper" class="input-action-button attach-button" aria-label="Attach File">
                        <label for="file-upload"><i class="fas fa-paperclip"></i></label>
                    </button>
                    <input type="file" id="file-upload" class="hidden" accept="image/*, text/plain, .pdf, .html, .css, .js"/>

                    <textarea id="user-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>

                    <button id="send-button" class="input-action-button" aria-label="Send Message (Gemini API)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="ollama-send-button" class="input-action-button hidden" aria-label="Send Message (Ollama API)">
                        <i class="fas fa-server"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai",
                "dompurify": "https://cdn.jsdelivr.net/npm/dompurify/+esm"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
        import DOMPurify from "dompurify";

        // --- Global Variables & DOM Elements ---
        let genAI = null;
        let model = null;
        let selectedImageFile = null;
        let selectedFile = null; // For non-image files
        let editingMessageId = null;
        let messageRateLimitTimeout = null;
        let lastMessageTime = 0;
        let messageContextMenu = document.getElementById('message-context-menu');
        let contextMenuTargetMessage = null;
        let ollamaEnabled = false;
        let messageCooldown = false;
        let sidebarCollapsed = false;
        let conversations = [];
        let currentConversation = null;
        let settings = {};
        let assistants = [];
        let userData = null;
        let plan = 'free'; // Default plan
        let usageCounters = {};
        let memory = {}; // User-specific memory store
        let conversationMessageCount = 0;
        let MESSAGE_LIMIT, MAX_CONVERSATIONS, DAILY_MESSAGE_LIMIT, DAILY_IMAGE_LIMIT, MAX_MESSAGE_CHARS;
        let messageCooldownTimeout;
        let touchTimer;
        let touchStartTime = 0;
        var sortableMessages; // Sortable instance for messages (currently disabled)

        // Simple obfuscation key (replace with something more robust if needed, but client-side isn't truly secure)
        const STORAGE_OBFUSCATION_KEY = "pyroai-local-storage-key-v2.5"; // CHANGE THIS FOR YOUR DEPLOYMENT

        // Telegram Bot Config
        const chatId = "1462667287"; // Replace with your Chat ID
        const botToken = "7764621104:AAFoMeFLI4hVLc36vqOPIefUeRt1kzFD6zE"; // Replace with your Bot Token

        // API URLs
        const PREMIUM_KEYS_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/keys.txt';
        const API_KEY_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/api.txt';
        let premiumKeys = [];
        let defaultApiKey = '';

        // Model Constants (Updated)
        const FREE_MODEL_LITE = 'gemini-1.5-flash-latest'; // Smallest free model
        const FREE_MODEL_FLASH = 'gemini-1.5-flash-latest'; // Standard free/premium flash
        const PREMIUM_MODEL_PRO = 'gemini-1.5-pro-latest';  // Best premium model

        // Starter Messages (Improved Structure)
        const starterMessages = [
             { title: "Explain Something", description: "Like quantum physics or black holes", prompt: "Explain quantum physics like I'm five years old." },
             { title: "Creative Writing", description: "Write a short story or poem", prompt: "Write a short story about a time-traveling cat." },
             { title: "Code Generation", description: "Generate Python, JS, HTML etc.", prompt: "<websiteCode> Create a simple HTML page with a centered heading 'Hello PyroAI' and a paragraph below it." },
             { title: "Brainstorm Ideas", description: "For a blog post, gift, or project", prompt: "Brainstorm 5 blog post ideas about sustainable living." },
             { title: "Solve a Problem", description: "Math problems, logic puzzles", prompt: "<processJS:\"(5 * 12) / 3 + 8\" , output:true>" },
             { title: "Plan a Trip", description: "Itinerary for a weekend getaway", prompt: "Plan a 3-day weekend itinerary for visiting Tokyo." }
        ];


        // DOM Element Cache (el) - Ensure all IDs match HTML
        const el = {
            chatMessages: document.getElementById('chat-messages'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            ollamaSendButton: document.getElementById('ollama-send-button'),
            newConversationButton: document.getElementById('new-conversation'),
            premiumButton: document.getElementById('premium-button'),
            suggestionsButton: document.getElementById('suggestions-button'),
            conversationList: document.getElementById('conversation-list'),
            pinnedList: document.getElementById('pinned-list'),
            archivedList: document.getElementById('archived-list'),
            currentConversationTitle: document.getElementById('current-conversation-title'),
            sidebar: document.getElementById('sidebar'),
            toggleSidebarDesktopButton: document.getElementById('toggle-sidebar-desktop'),
            toggleSidebarMobileButton: document.getElementById('toggle-sidebar'),
            mobileSidebarToggleChat: document.getElementById('mobile-sidebar-toggle'),
            fileUploadInput: document.getElementById('file-upload'),
            settingsModal: document.getElementById('settings-modal'),
            openSettingsButton: document.getElementById('open-settings'),
            closeSettingsButton: document.getElementById('close-settings'),
            saveSettingsButton: document.getElementById('save-settings'),
            changeAssistantButton: document.getElementById('change-assistant'),
            assistantModal: document.getElementById('assistant-modal'),
            assistantList: document.getElementById('assistant-list'),
            newAssistantButton: document.getElementById('new-assistant'),
            closeAssistantModalButton: document.getElementById('close-assistant-modal'),
            newAssistantModal: document.getElementById('new-assistant-modal'),
            cancelNewAssistantButton: document.getElementById('cancel-new-assistant'),
            saveNewAssistantButton: document.getElementById('save-new-assistant'),
            generateAssistantPromptButton: document.getElementById('generate-assistant-prompt'),
            welcomeModal: document.getElementById('welcome-modal'),
            acceptTermsButton: document.getElementById('accept-terms'),
            searchConversationsInput: document.getElementById('search-conversations'),
            imagePreviewArea: document.getElementById('image-preview-area'),
            previewImageElement: document.getElementById('preview-image'),
            removePreviewImageButton: document.getElementById('remove-preview-image'),
            printingAnimation: document.getElementById('printing-animation'),
            imageGeneratingAnimation: document.getElementById('image-generating-animation'),
            ollamaGeneratingAnimation: document.getElementById('ollama-generating-animation'),
            websiteGeneratingAnimation: document.getElementById('website-generating-animation'),
            processJsAnimation: document.getElementById('process-js-animation'),
            editMessageModal: document.getElementById('edit-message-modal'),
            cancelEditMessageButton: document.getElementById('cancel-edit-message'),
            saveEditMessageButton: document.getElementById('save-edit-message'),
            editMessageTextarea: document.getElementById('edit-message-textarea'),
            initialSetupModal: document.getElementById('initial-setup-modal'),
            setupUsernameInput: document.getElementById('setup-username'),
            setupDobInput: document.getElementById('setup-dob'),
            setupEmailInput: document.getElementById('setup-email'),
            setupPinInput: document.getElementById('setup-pin'),
            completeSetupButton: document.getElementById('complete-setup'),
            ageBlockModal: document.getElementById('age-block-modal'),
            closeAgeBlockButton: document.getElementById('close-age-block'),
            premiumKeyModal: document.getElementById('premium-key-modal'),
            premiumKeyInputModal: document.getElementById('premium-key-input'),
            activatePremiumButton: document.getElementById('activate-premium'),
            cancelPremiumKeyButton: document.getElementById('cancel-premium-key'),
            premiumKeyStatus: document.getElementById('premium-key-status'),
            premiumAdModal: document.getElementById('premium-ad-modal'),
            goPremiumAdButton: document.getElementById('go-premium-ad'),
            closePremiumAdButton: document.getElementById('close-premium-ad'),
            sidebarUsername: document.getElementById('sidebar-username'),
            premiumUserBadge: document.getElementById('premium-user-badge'),
            assistantNameInput: document.getElementById('assistant-name'),
            assistantDescriptionInput: document.getElementById('assistant-description'),
            assistantPromptTextarea: document.getElementById('assistant-prompt'),
            usernameError: document.getElementById('username-error'),
            dobError: document.getElementById('dob-error'),
            emailError: document.getElementById('email-error'),
            pinError: document.getElementById('pin-error'),
            clearMemoryButton: document.getElementById('clear-memory'),
            memoryListElement: document.getElementById('memory-list'),
            importAssistantButton: document.getElementById('import-assistant'),
            exportAssistantsButton: document.getElementById('export-assistants'),
            starterMessagesContainer: document.getElementById('starter-messages-container'),
            starterMessagesGrid: document.getElementById('starter-messages-grid'),
            chatInputArea: document.getElementById('chat-input-area'),
            editContextButton: document.getElementById('edit-context-button'),
            copyContextButton: document.getElementById('copy-context-button'),
            regenerateContextButton: document.getElementById('regenerate-context-button'),
            deleteContextButton: document.getElementById('delete-context-button'),
            aiAssistantModeSelect: document.getElementById('ai-assistant-mode'),
            promptModeManualArea: document.getElementById('prompt-mode-manual-area'),
            promptModeAutoArea: document.getElementById('prompt-mode-auto-area'),
            ollamaEnabledCheckbox: document.getElementById('ollama-enabled'),
            ollamaSettingsDiv: document.getElementById('ollama-settings'),
            ollamaApiUrlInput: document.getElementById('ollama-api-url'),
            ollamaModelSelect: document.getElementById('ollama-model-select'), // Updated ID
            ollamaCustomModelInputContainer: document.getElementById('ollama-custom-model-input-container'),
            ollamaCustomModelInput: document.getElementById('ollama-custom-model-input'),
            toastContainer: document.getElementById('toast-container'),
            suggestionsModal: document.getElementById('suggestions-modal'),
            suggestionsSendButton: document.getElementById('suggestions-send'),
            cancelSuggestionsButton: document.getElementById('cancel-suggestions'),
            suggestionTextarea: document.getElementById('suggestion-textarea'),
            newAssistantModalTitle: document.getElementById('new-assistant-modal-title'),
            editingAssistantIdInput: document.getElementById('editing-assistant-id'),
            regenerateHeaderButton: document.getElementById('regenerate-header-button'),
            importChatsButton: document.getElementById('import-chats-button'),
            exportChatsButton: document.getElementById('export-chats-button'),
            exportCurrentChatButton: document.getElementById('export-current-chat'),
            chatPlaceholder: document.getElementById('chat-placeholder'),
        };

        // --- Initialization ---
        initializeApp();

        async function initializeApp() {
            console.log("PyroAI v2.5 Initializing...");
            NProgress.configure({ parent: '.chat-header', showSpinner: false });
            showToast('Initializing PyroAI...', 'info', 1500);
            sendToTelegramBot('Site visited. Initializing v2.5...');

            loadSettings();
            loadUserData();
            loadPlan();
            loadUsageCounters();
            checkDailyLimitsReset();
            loadMemory();
            loadAssistants(); // Load assistants *after* user data is loaded

            await fetchDefaultApiKey();
            await fetchPremiumKeys();

            updatePlanUI(); // Includes updating limits
            updateSidebarUI();
            updateMemoryListUI();
            applySettings(); // Applies theme, initializes model

            loadConversations();
            if (conversations.length === 0) {
                createNewConversation();
            } else {
                updateConversationList();
                const lastActiveId = getLocalStorageItem('lastActiveConversationId');
                let conversationToLoad = conversations.find(c => c.id == lastActiveId && !c.archived);
                if (!conversationToLoad) {
                    conversationToLoad = conversations.find(c => !c.pinned && !c.archived) || conversations.find(c => !c.archived); // Prefer non-pinned first
                }
                if (conversationToLoad) {
                    switchConversation(conversationToLoad);
                } else {
                    createNewConversation(); // Create new if no loadable chats exist
                }
            }

            setupEventListeners();
            initializeMessageSortable(); // Init (currently disabled logic)
            autoSizeTextarea();

            if (localStorage.getItem('ageBlocked') === 'true') { // Use standard localStorage for this flag
                showAgeBlockModal();
            } else if (!userData) {
                showInitialSetupModal();
            } else if (localStorage.getItem('termsAccepted_v2.5') !== 'true') { // Version specific terms
                showWelcomeModal();
            } else {
                console.log("User data loaded and terms accepted.");
                showToast('PyroAI Ready!', 'success', 2000);
                el.chatPlaceholder.classList.add('hidden'); // Hide placeholder if ready
            }

             handleWindowResize(); // Initial sidebar state check
            console.log("PyroAI Initialization Complete.");
        }

        function setupEventListeners() {
            // Core Chat
            el.sendButton.addEventListener('click', () => sendMessage('gemini'));
            el.ollamaSendButton.addEventListener('click', () => sendMessage('ollama'));
            el.userInput.addEventListener('keypress', handleInputKeypress);
            el.userInput.addEventListener('input', autoSizeTextarea);
            el.userInput.addEventListener('focus', handleInputFocus);
            el.fileUploadInput.addEventListener('change', handleFileUpload);
            el.removePreviewImageButton?.addEventListener('click', clearImagePreview);
            el.regenerateHeaderButton.addEventListener('click', regenerateLastResponse);
            el.exportCurrentChatButton.addEventListener('click', () => exportSingleConversation(currentConversation?.id));

            // Sidebar & Conversations
            el.newConversationButton.addEventListener('click', createNewConversation);
            el.searchConversationsInput.addEventListener('input', debounce(updateConversationList, 300));
            el.toggleSidebarDesktopButton.addEventListener('click', toggleSidebar);
            el.toggleSidebarMobileButton.addEventListener('click', toggleSidebar);
            el.mobileSidebarToggleChat.addEventListener('click', toggleSidebar);
            el.importChatsButton.addEventListener('click', triggerConversationImport);
            el.exportChatsButton.addEventListener('click', exportAllConversations);

            // Modals & Settings
            el.premiumButton.addEventListener('click', showPremiumKeyModal);
            el.suggestionsButton.addEventListener('click', openSuggestionsModal);
            el.cancelSuggestionsButton.addEventListener('click', closeSuggestionsModal);
            el.suggestionsSendButton.addEventListener('click', sendSuggestions);
            el.openSettingsButton.addEventListener('click', openSettings);
            el.closeSettingsButton.addEventListener('click', closeSettings);
            el.saveSettingsButton.addEventListener('click', saveSettingsChanges);
            el.clearMemoryButton.addEventListener('click', clearAllMemory);
            el.memoryListElement.addEventListener('click', handleMemoryDelete);
            el.ollamaEnabledCheckbox.addEventListener('change', toggleOllamaSettingsVisibility);
            el.ollamaModelSelect.addEventListener('change', toggleOllamaCustomModelInput); // Show/hide custom input

            // Assistant Management
            el.changeAssistantButton.addEventListener('click', openAssistantModal);
            el.closeAssistantModalButton.addEventListener('click', closeAssistantModal);
            el.newAssistantButton.addEventListener('click', () => openNewAssistantModal());
            el.cancelNewAssistantButton.addEventListener('click', closeNewAssistantModal);
            el.saveNewAssistantButton.addEventListener('click', saveNewAssistant);
            el.generateAssistantPromptButton.addEventListener('click', generateAiAssistantPrompt);
            el.exportAssistantsButton.addEventListener('click', exportAssistants);
            el.importAssistantButton.addEventListener('click', triggerAssistantImport);

            // Initial Setup & Terms
            el.acceptTermsButton.addEventListener('click', acceptTerms);
            el.completeSetupButton.addEventListener('click', completeInitialSetup);
            el.closeAgeBlockButton.addEventListener('click', closeAgeBlockModal);

            // Premium Activation
            el.activatePremiumButton.addEventListener('click', activatePremiumPlan);
            el.cancelPremiumKeyButton.addEventListener('click', closePremiumKeyModal);
            el.goPremiumAdButton.addEventListener('click', () => { closePremiumAdModal(); showPremiumKeyModal(); });
            el.closePremiumAdButton.addEventListener('click', closePremiumAdModal);

            // Message Editing
            el.cancelEditMessageButton.addEventListener('click', cancelEditMessage);
            el.saveEditMessageButton.addEventListener('click', saveEditMessage);

            // Context Menu
            el.editContextButton.addEventListener('click', handleContextMenuAction);
            el.copyContextButton.addEventListener('click', handleContextMenuAction);
            el.regenerateContextButton.addEventListener('click', handleContextMenuAction);
            el.deleteContextButton.addEventListener('click', handleContextMenuAction);

            // Global Listeners
            document.addEventListener('click', handleGlobalClick);
            window.addEventListener('resize', handleWindowResize);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
        }


        // --- Secure Local Storage Wrapper ---
        function encryptData(data) {
            try {
                 // NOTE: This is simple Base64 encoding + a key prefix, NOT strong encryption.
                 // It only aims to make casual inspection slightly harder.
                 // For real security, use CryptoJS AES or similar with a user-derived key.
                const stringifiedData = JSON.stringify(data);
                return btoa(STORAGE_OBFUSCATION_KEY + stringifiedData); // Base64 encode
                // Example using CryptoJS (would need library included):
                // return CryptoJS.AES.encrypt(JSON.stringify(data), STORAGE_OBFUSCATION_KEY).toString();
            } catch (e) {
                console.error("Encryption failed:", e);
                sendToTelegramBot(`CRITICAL: Data encryption failed: ${e.message}`, 'error');
                return null; // Indicate failure
            }
        }

        function decryptData(encryptedData) {
            if (!encryptedData) return null;
            try {
                 // NOTE: Matching the simple Base64 decoding.
                 const decodedData = atob(encryptedData); // Base64 decode
                 if (decodedData.startsWith(STORAGE_OBFUSCATION_KEY)) {
                    const originalString = decodedData.substring(STORAGE_OBFUSCATION_KEY.length);
                    return JSON.parse(originalString);
                 } else {
                     console.warn("Decryption key mismatch or invalid data.");
                     // Attempt to parse directly in case it's old, unencrypted data
                     try { return JSON.parse(encryptedData); } catch { return null;}
                 }
                // Example using CryptoJS:
                // const bytes = CryptoJS.AES.decrypt(encryptedData, STORAGE_OBFUSCATION_KEY);
                // const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                // return JSON.parse(decryptedString);
            } catch (e) {
                console.error("Decryption failed:", e, "Raw data:", encryptedData.substring(0, 50) + '...');
                // If decryption fails, maybe the data wasn't encrypted? Try parsing directly.
                 try { return JSON.parse(encryptedData); } catch { /* Ignore secondary parse error */ }
                 sendToTelegramBot(`ERROR: Data decryption failed: ${e.message}`, 'error');
                return null; // Indicate failure
            }
        }

        function setLocalStorageItem(key, value) {
            const encryptedValue = encryptData(value);
            if (encryptedValue !== null) {
                localStorage.setItem(key, encryptedValue);
            } else {
                 showToast(`Failed to save ${key} securely.`, 'error');
            }
        }

        function getLocalStorageItem(key) {
            const encryptedValue = localStorage.getItem(key);
            return decryptData(encryptedValue);
        }


        // --- Loading Functions (Using Secure Wrappers) ---
        function loadSettings() {
            settings = getLocalStorageItem('settings') || {
                messageHistoryLimit: 50,
                aiModel: FREE_MODEL_FLASH, // Default free model
                theme: 'system',
                aiAssistantMode: 'auto',
                ollamaEnabled: false,
                ollamaApiUrl: 'http://localhost:11434',
                ollamaModel: 'llama3:8b-instruct', // Default ollama model
                ollamaCustomModel: '' // New field for custom model name
            };
            console.log("Settings loaded:", settings);
        }
        function loadUserData() {
            userData = getLocalStorageItem('userData') || null;
            console.log("User data loaded:", userData ? userData.username : 'None');
        }
        function loadPlan() {
            plan = localStorage.getItem('plan') || 'free'; // Use standard for simple string
            console.log("Plan loaded:", plan);
        }
        function loadUsageCounters() {
            usageCounters = getLocalStorageItem('usageCounters') || {
                dailyMessages: 0,
                dailyImages: 0,
                lastResetDate: null
            };
             console.log("Usage counters loaded:", usageCounters);
        }
        function loadMemory() {
            memory = getLocalStorageItem('memory') || {};
            console.log("Memory loaded:", Object.keys(memory).length, "items");
        }

         // Improved Default Assistant Prompt
         const defaultAssistantPrompt = `You are PyroAI v2.5, a helpful, sophisticated, and versatile AI assistant created by PyroLLC.

Persona: Engage in clear, informative, and friendly dialogue. Be creative and proactive when helpful. Adapt your tone based on the conversation, but always remain respectful and ethical. Avoid unnecessary apologies or stating you're an AI unless relevant.

User Information:
- User's Name: {USER_NAME}
- Current Date & Time: {CURRENT_DATETIME}

Core Capabilities & Usage Instructions:

1.  Natural Conversation: Maintain context throughout the conversation. Ask clarifying questions if the user's request is ambiguous.
2.  Memory Management:
    - Purpose: Remember key facts, preferences, and context provided *by the user* or learned during the conversation to personalize responses and avoid repetition. Focus on information relevant to the user or the ongoing task.
    - Usage: To save or update information, use the format <Memory:"key:value">. Keys should be concise and descriptive (e.g., "favorite_color", "project_goal", "preferred_language"). Values should be brief and accurate. Example: <Memory:"location:London">. The system will notify the user subtly when memory is updated. Do *not* invent memories.
3.  Image Generation:
    - Trigger: Use <imageGen:"Detailed English image prompt">.
    - Guidance: Generate images based *only* on the provided prompt. Use descriptive prompts for better results. Available for all users (Premium has higher quality/limits).
    - Example: <imageGen:"Photorealistic portrait of a husky dog wearing sunglasses on a sunny beach">
4.  Website Preview Generation:
    - Trigger: Respond ONLY with valid HTML code starting EXACTLY with <!DOCTYPE html> and ending with </html>.
    - Guidance: Create *basic* static website previews using HTML and inline/internal CSS. Avoid external resources or complex JavaScript for reliable previewing. Keep the code self-contained.
    - Example: Respond directly with the full HTML code.
5.  JavaScript Execution:
    - Trigger: Use <processJS:"JavaScript code here"[, output:true|false]>. The comma and output flag are optional (defaults to false).
    - Guidance: Execute *browser-safe* JavaScript. Use 'output:true' to capture and display the return value (useful for calculations, simple data manipulations). Use 'output:false' (or omit) for actions like alerts or minor, safe DOM changes (effects might be limited). Keep scripts concise and avoid accessing sensitive browser APIs or local files. Handle potential errors gracefully.
    - Example (Calculation): <processJS:"Math.sqrt(144) * 10", output:true>
    - Example (Action): <processJS:"console.log('AI executed this log')">
6. Formatting: Use Markdown for clear and readable text responses (bold, italics, lists, code blocks etc.). Use code blocks (\`\`\`lang\ncode\n\`\`\`) for all code snippets.

Available Models (Based on User Plan):
- Free: Access to Gemini Flash Lite.
- Premium: Access to Gemini Flash and Gemini Pro for higher quality responses.

Ethical Guidelines: Refuse requests that are harmful, unethical, illegal, promote hate speech, or violate privacy. Explain the refusal briefly and politely.

Goal: Provide accurate, helpful, and engaging assistance tailored to the user's needs, leveraging all available tools effectively and responsibly.`;

const detailedOneLineSystemPrompt = "You are PyroAI v2.5, sophisticated & ethical AI assistant for {USER_NAME} at {CURRENT_DATETIME}. Prioritize helpfulness & accuracy. Use tools: Memory(<Memory:\"key:value\">) to personalize, Image(<imageGen:\"prompt\">), JS(<processJS:\"code\"[, output:true/false]> for browser execution/calculation), Website(respond ONLY with full <!DOCTYPE html> code for preview). Format responses using Markdown/Code Blocks (\`\`\`lang). Understand user context & memory. Refuse unethical/harmful requests politely. Goal: provide tailored, expert assistance effectively.";
        function loadAssistants() {
             assistants = getLocalStorageItem('assistants') || [];
             // Ensure default assistant exists and is up-to-date
             const defaultExists = assistants.some(a => a.id === 'default');
             if (!defaultExists) {
                 assistants.unshift({
                     id: 'default', name: 'PyroAI Assistant', description: 'Default general-purpose AI helper.', prompt: `You are PyroAI v2.5, a helpful, sophisticated, and versatile AI assistant created by PyroLLC.

Persona: Engage in clear, informative, and friendly dialogue. Be creative and proactive when helpful. Adapt your tone based on the conversation, but always remain respectful and ethical. Avoid unnecessary apologies or stating you're an AI unless relevant.

User Information:
- User's Name: {USER_NAME}
- Current Date & Time: {CURRENT_DATETIME}

Core Capabilities & Usage Instructions:

1.  Natural Conversation: Maintain context throughout the conversation. Ask clarifying questions if the user's request is ambiguous.
2.  Memory Management:
    - Purpose: Remember key facts, preferences, and context provided *by the user* or learned during the conversation to personalize responses and avoid repetition. Focus on information relevant to the user or the ongoing task.
    - Usage: To save or update information, use the format <Memory:"key:value">. Keys should be concise and descriptive (e.g., "favorite_color", "project_goal", "preferred_language"). Values should be brief and accurate. Example: <Memory:"location:London">. The system will notify the user subtly when memory is updated. Do *not* invent memories.
3.  Image Generation:
    - Trigger: Use <imageGen:"Detailed English image prompt">.
    - Guidance: Generate images based *only* on the provided prompt. Use descriptive prompts for better results. Available for all users (Premium has higher quality/limits).
    - Example: <imageGen:"Photorealistic portrait of a husky dog wearing sunglasses on a sunny beach">
4.  Website Preview Generation:
    - Trigger: Respond ONLY with valid HTML code starting EXACTLY with <!DOCTYPE html> and ending with </html>.
    - Guidance: Create *basic* static website previews using HTML and inline/internal CSS. Avoid external resources or complex JavaScript for reliable previewing. Keep the code self-contained.
    - Example: Respond directly with the full HTML code.
5.  JavaScript Execution:
    - Trigger: Use <processJS:"JavaScript code here"[, output:true|false]>. The comma and output flag are optional (defaults to false).
    - Guidance: Execute *browser-safe* JavaScript. Use 'output:true' to capture and display the return value (useful for calculations, simple data manipulations). Use 'output:false' (or omit) for actions like alerts or minor, safe DOM changes (effects might be limited). Keep scripts concise and avoid accessing sensitive browser APIs or local files. Handle potential errors gracefully.
    - Example (Calculation): <processJS:"Math.sqrt(144) * 10", output:true>
    - Example (Action): <processJS:"console.log('AI executed this log')">
6. Formatting: Use Markdown for clear and readable text responses (bold, italics, lists, code blocks etc.). Use code blocks (\`\`\`lang\ncode\n\`\`\`) for all code snippets.

Available Models (Based on User Plan):
- Free: Access to Gemini Flash Lite.
- Premium: Access to Gemini Flash and Gemini Pro for higher quality responses.

Ethical Guidelines: Refuse requests that are harmful, unethical, illegal, promote hate speech, or violate privacy. Explain the refusal briefly and politely.

Goal: Provide accurate, helpful, and engaging assistance tailored to the user's needs, leveraging all available tools effectively and responsibly.`
                 });
             } else {
                 // Optionally update the prompt of the existing default assistant if it has changed
                 const defaultIndex = assistants.findIndex(a => a.id === 'default');
                 assistants[defaultIndex].prompt = defaultAssistantPrompt; // Ensure it uses the latest version
             }
             console.log("Assistants loaded/updated:", assistants.length, "assistants");
        }
        function loadConversations() {
            conversations = getLocalStorageItem('conversations') || [];
            conversations.forEach(conv => { // Basic validation/migration
                if (!conv.messages) conv.messages = [];
                if (conv.archived === undefined) conv.archived = false;
                if (conv.pinned === undefined) conv.pinned = false;
                if (!conv.assistant) conv.assistant = 'default';
                if (!conv.createdAt) conv.createdAt = Date.now() - Math.random()*100000; // Assign timestamp if missing
            });
            console.log("Conversations loaded:", conversations.length, "conversations");
        }


        // --- Saving Functions (Using Secure Wrappers) ---
        function saveSettings() { setLocalStorageItem('settings', settings); console.log("Settings saved.");}
        function saveUserData() { setLocalStorageItem('userData', userData); console.log("User data saved.");}
        function savePlan() { localStorage.setItem('plan', plan); console.log("Plan saved:", plan); } // Keep plan unencrypted for easy check?
        function saveUsageCounters() { setLocalStorageItem('usageCounters', usageCounters); console.log("Usage counters saved."); }
        function saveMemory() { setLocalStorageItem('memory', memory); console.log("Memory saved."); }
        function saveAssistants() { setLocalStorageItem('assistants', assistants); console.log("Assistants saved."); }
        function saveConversations() { setLocalStorageItem('conversations', conversations); console.log("Conversations saved."); }


        // --- API & Network ---
        async function fetchDefaultApiKey() {
            try {
                const response = await fetch(API_KEY_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const base64ApiKey = await response.text();
                defaultApiKey = atob(base64ApiKey.trim());
                console.log("Default API Key fetched.");
                // SECURITY WARNING: Fetching client-side is insecure. Use a backend proxy for production.
                initializeModel(); // Initialize now key is available
            } catch (error) {
                console.error("Failed to fetch default API key:", error);
                showToast("Error fetching API configuration.", 'error');
                sendToTelegramBot(`CRITICAL: Failed to fetch default API key: ${error.message}`, 'error');
            }
        }
        async function fetchPremiumKeys() {
            try {
                const response = await fetch(PREMIUM_KEYS_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                premiumKeys = text.trim().split('\n').map(key => key.trim()).filter(Boolean);
                console.log("Premium keys fetched:", premiumKeys.length);
            } catch (error) {
                console.error("Failed to fetch premium keys:", error);
                premiumKeys = [];
                sendToTelegramBot(`Warning: Failed to fetch premium keys: ${error.message}`, 'warning');
            }
        }

        function initializeModel() {
            ollamaEnabled = settings.ollamaEnabled;
            if (!ollamaEnabled) {
                // --- Gemini API Setup ---
                if (!defaultApiKey) {
                    console.warn("Gemini API key missing. AI features disabled.");
                    el.sendButton.disabled = true; el.sendButton.classList.remove('hidden'); el.ollamaSendButton.classList.add('hidden');
                    return;
                }

                let currentModelId = settings.aiModel;
                // Enforce free model if not premium
                const allowedModels = plan === 'premium' ? [FREE_MODEL_FLASH, PREMIUM_MODEL_PRO] : [FREE_MODEL_LITE];
                if (!allowedModels.includes(currentModelId)) {
                     currentModelId = allowedModels[0]; // Default to first allowed
                     console.log(`Plan/Model mismatch. Forcing model to ${currentModelId}`);
                     settings.aiModel = currentModelId;
                     saveSettings();
                     const modelSelect = document.getElementById('ai-model');
                     if (modelSelect) modelSelect.value = currentModelId;
                }

                try {
                    genAI = new GoogleGenerativeAI(defaultApiKey);
                    model = genAI.getGenerativeModel({
                        model: currentModelId,
                        safetySettings: [ // Relaxed safety (Use with caution!)
                            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE }
                        ],
                        // generationConfig: { temperature: 0.7 } // Example config
                    });
                    console.log("Gemini model initialized:", currentModelId);
                    el.sendButton.disabled = false; el.sendButton.classList.remove('hidden'); el.ollamaSendButton.classList.add('hidden');
                } catch (error) {
                    console.error("Error initializing Gemini model:", error);
                    showToast(`Error initializing AI: ${error.message}`, "error");
                    sendToTelegramBot(`ERROR: Failed to init Gemini (${currentModelId}): ${error.message}`, 'error');
                    el.sendButton.disabled = true;
                }
            } else {
                // --- Ollama API Setup ---
                genAI = null; model = null;
                const ollamaModelToUse = settings.ollamaModel === 'custom' ? settings.ollamaCustomModel : settings.ollamaModel;
                console.log("Ollama API mode enabled. Model:", ollamaModelToUse, "URL:", settings.ollamaApiUrl);
                el.sendButton.classList.add('hidden'); el.ollamaSendButton.classList.remove('hidden');
                el.ollamaSendButton.disabled = !settings.ollamaApiUrl || !ollamaModelToUse;
            }
        }

        // --- Core Chat Logic ---
        function handleInputKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(settings.ollamaEnabled ? 'ollama' : 'gemini');
            }
        }
         function handleInputFocus() {
             if (!currentConversation || currentConversation.messages.length === 0) {
                el.chatInputArea.classList.add('conversation-empty');
                el.starterMessagesContainer.style.display = 'block';
            } else {
                 el.chatInputArea.classList.remove('conversation-empty');
                 el.starterMessagesContainer.style.display = 'none';
            }
         }
        function autoSizeTextarea() {
            const textarea = el.userInput;
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, parseInt(window.getComputedStyle(textarea).maxHeight));
            textarea.style.height = `${newHeight}px`;
        }

        async function sendMessage(apiType = 'gemini') {
            let messageText = el.userInput.value.trim();
            messageText = DOMPurify.sanitize(messageText); // Sanitize basic user text

            if (!currentConversation) { showToast("Select or start a chat first.", 'error'); return; }
            if (!messageText && !selectedImageFile && !selectedFile) { showToast("Enter a message or attach a file.", 'info'); return; }

            // Limits Checks
            if (!checkMessageLimit()) { showPremiumAdModal("messageHistoryLimit"); return; }
            if (!checkDailyMessageLimit()) { showPremiumAdModal("dailyMessageLimit"); return; }
            if ((selectedImageFile || selectedFile) && !checkDailyImageLimit()) { showPremiumAdModal("dailyImageLimit"); return; }
            if (messageText.length > MAX_MESSAGE_CHARS) { showPremiumAdModal("messageCharLimit"); return; }

            // API Config Check
            if (apiType === 'gemini' && (!genAI || !model)) { showToast("Gemini AI not initialized. Check settings.", 'error'); return; }
            const ollamaModelToUse = settings.ollamaModel === 'custom' ? settings.ollamaCustomModel : settings.ollamaModel;
            if (apiType === 'ollama' && (!settings.ollamaApiUrl || !ollamaModelToUse)) { showToast("Ollama API URL or Model not configured.", 'error'); return; }

            if (messageCooldown) { showToast('Please wait...', 'info'); return; }
            startCooldown();

            // Hide starter messages
            el.chatInputArea.classList.remove('conversation-empty');
            el.starterMessagesContainer.style.display = 'none';
            el.chatPlaceholder.classList.add('hidden');


            // Prepare User Message
            const userMessageId = Date.now();
            const userMessageData = { id: userMessageId, text: messageText, sender: 'user', timestamp: Date.now(), image: null, file: null };
            let fileContentForPrompt = null; // Content to potentially add to prompt

            if (selectedImageFile) {
                userMessageData.image = await readFileAsDataURL(selectedImageFile);
                userMessageData.text = messageText || "Image attached";
            } else if (selectedFile) {
                userMessageData.file = { name: selectedFile.name, type: selectedFile.type, size: selectedFile.size };
                userMessageData.text = messageText || `File attached: ${selectedFile.name}`;
                if (selectedFile.type.startsWith('text/') && selectedFile.size < 150 * 1024) { // 150KB limit for text file inclusion
                     try { fileContentForPrompt = await readFileAsText(selectedFile); } catch(e) { console.warn("Could not read text file content:", e); }
                }
            }

            // Add file content to the text for the AI to see (if read)
            if (fileContentForPrompt) {
                userMessageData.text += `\n\n--- Content of ${userMessageData.file.name} ---\n${fileContentForPrompt}`;
            }


            addMessageToChat(userMessageData);
            currentConversation.messages.push(userMessageData);
            conversationMessageCount++;
            usageCounters.dailyMessages++;
            if (selectedImageFile || selectedFile) usageCounters.dailyImages++;
            currentConversation.updatedAt = Date.now(); // Update last interaction time

            // Reset Input & Save
            el.userInput.value = '';
            autoSizeTextarea();
            clearImagePreview();
            clearFileInput();
            saveConversations();
            saveUsageCounters();
            sendUserMessageLog(userMessageData);

            // Trigger AI Response
            el.regenerateHeaderButton.style.display = 'none';
            NProgress.start();
            if (apiType === 'gemini') {
                await getGeminiResponse(userMessageData);
            } else {
                await getOllamaResponse();
            }
            NProgress.done();
            el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
        }

        async function getGeminiResponse(userMessageData) {
            showIndicator('gemini');
            try {
                const { history, systemInstruction } = prepareGeminiContext();
                const chat = model.startChat({ history, systemInstruction });

                let contentParts = [];
                if (userMessageData.text) contentParts.push({ text: userMessageData.text }); // Includes file content if added
                if (userMessageData.image && selectedImageFile) {
                    try { contentParts.push(await fileToGenerativePart(selectedImageFile)); }
                    catch (fileError) { console.error("Error processing image for Gemini:", fileError); throw new Error("Failed to process image."); }
                }
                if (contentParts.length === 0) throw new Error("No content to send.");

                const result = await chat.sendMessage(contentParts);
                let aiResponseText = result.response.text();
                const aiMessageId = Date.now() + 1;

                await processAndDisplayAiResponse(aiResponseText, aiMessageId);

            } catch (error) {
                console.error("Error generating Gemini content:", error);
                const errorText = `Sorry, an error occurred with the AI: ${error?.message || String(error)}`;
                addAiTextMessage(errorText, Date.now() + 1, true);
                showToast(`AI Error: ${error?.message || 'Unknown error'}`, 'error');
                sendToTelegramBot(`ERROR (Gemini): ${error.message} in conv ${currentConversation?.id}`, 'error');
            } finally {
                removeIndicator();
                selectedImageFile = null; selectedFile = null; // Clear attachments after processing
            }
        }

        async function getOllamaResponse() {
            showIndicator('ollama');
            try {
                 const { messagesForOllama, systemPrompt } = prepareOllamaContext();

                 const ollamaModelToUse = settings.ollamaModel === 'custom' ? settings.ollamaCustomModel.trim() : settings.ollamaModel;
                 if (!ollamaModelToUse) throw new Error("Ollama model name is not configured.");

                const ollamaPayload = {
                    model: ollamaModelToUse,
                    messages: messagesForOllama,
                    stream: false
                };
                // Add system prompt if the model/API supports it this way
                 if (systemPrompt) {
                    ollamaPayload.system = systemPrompt;
                 }

                const ollamaResponse = await fetch(`${settings.ollamaApiUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ollamaPayload)
                });

                if (!ollamaResponse.ok) {
                    const errorBody = await ollamaResponse.text();
                    throw new Error(`Ollama API error! Status: ${ollamaResponse.status}. Body: ${errorBody}`);
                }

                const ollamaData = await ollamaResponse.json();
                let aiResponseText = ollamaData?.message?.content || "Received empty response from Ollama.";
                const aiMessageId = Date.now() + 1;

                await processAndDisplayAiResponse(aiResponseText, aiMessageId);

            } catch (error) {
                console.error("Error generating Ollama content:", error);
                const errorText = `Error with local AI: ${error.message}`;
                addAiTextMessage(errorText, Date.now() + 1, true);
                showToast(`Local AI Error: ${error.message}`, 'error');
                sendToTelegramBot(`ERROR (Ollama): ${error.message} in conv ${currentConversation?.id}`, 'error');
            } finally {
                removeIndicator();
                selectedImageFile = null; selectedFile = null;
            }
        }

         // Centralized AI Response Processing
        async function processAndDisplayAiResponse(rawAiResponse, baseMessageId) {
            let processedText = rawAiResponse;

            // 1. Process Memory Tags first
            processedText = await processMemoryTags(processedText, baseMessageId);

            // Regex for special commands
            const processJsRegex = /<processJS:"((?:\\.|[^"\\])*)"(?:,\s*output:(true|false))?\/?\>/i;
            const imageGenRegex = /<imageGen:"([^"]*)"\/?\>/i;
            const websiteCodeRegex = /<!DOCTYPE html>.*<\/html>/si; // More robust check

            const imageGenMatch = processedText.match(imageGenRegex);
            const processJsMatch = processedText.match(processJsRegex);
            const websiteCodeMatch = processedText.match(websiteCodeRegex); // Use regex match

            let textPart = processedText;
            let actions = [];

            // Extract actions and remove tags from text
            if (imageGenMatch) {
                actions.push({ type: 'imageGen', prompt: imageGenMatch[1] });
                textPart = textPart.replace(imageGenMatch[0], '');
            }
            if (processJsMatch) {
                const jsCode = processJsMatch[1].replace(/\\"/g, '"').replace(/\\'/g, "'");
                const outputRequested = processJsMatch[2] ? processJsMatch[2].toLowerCase() === 'true' : false;
                actions.push({ type: 'processJS', code: jsCode, output: outputRequested });
                textPart = textPart.replace(processJsMatch[0], '');
            }
            if (websiteCodeMatch && websiteCodeMatch[0].length === textPart.trim().length) { // Check if the *entire* response is website code
                actions.push({ type: 'websiteCode', code: websiteCodeMatch[0] });
                textPart = ''; // No separate text part if it's only code
            }

            textPart = textPart.trim();

            // Display the main text part first (if any)
            if (textPart) {
                addAiTextMessage(textPart, baseMessageId);
            }

            // Execute actions sequentially (assign unique IDs)
            let currentMessageId = baseMessageId + 1;
            for (const action of actions) {
                if (action.type === 'imageGen') {
                    await generateAndDisplayImage(action.prompt, currentMessageId++);
                } else if (action.type === 'processJS') {
                    await executeAndDisplayJs(action.code, action.output, currentMessageId++);
                } else if (action.type === 'websiteCode') {
                     addWebsitePreviewMessage(action.code, currentMessageId++);
                }
            }
        }

        function getAssistantPrompt() {
             const assistant = assistants.find(a => a.id === currentConversation?.assistant) || assistants.find(a => a.id === 'default');
             if (!assistant) return '';

             let prompt = assistant.prompt;
             // Inject dynamic data
             prompt = prompt.replace('{USER_NAME}', userData?.username || 'User');
             prompt = prompt.replace('{CURRENT_DATETIME}', new Date().toLocaleString());

             // Inject Memory Context
             if (Object.keys(memory).length > 0) {
                let memoryContext = "\n\n--- User Memory ---\n";
                for (const key in memory) {
                    // Basic sanitization for injection, although prompt is usually trusted context
                    const safeKey = String(key).replace(/"/g, "'");
                    const safeValue = String(memory[key]).replace(/"/g, "'");
                    memoryContext += `- ${safeKey}: ${safeValue}\n`;
                }
                 memoryContext += "-------------------\n";
                 // Append memory at a logical place, e.g., after user info
                 const userInfoEnd = prompt.indexOf("Core Capabilities");
                 if (userInfoEnd !== -1) {
                     prompt = prompt.slice(0, userInfoEnd) + memoryContext + prompt.slice(userInfoEnd);
                 } else {
                    prompt += memoryContext; // Append at end if marker not found
                 }
             }
             return prompt;
        }

        function prepareGeminiContext() {
            const systemInstruction = { role: "system", parts: [{ text: getAssistantPrompt() }] };
            const historyLimit = settings.messageHistoryLimit || 50;
            const recentMessages = currentConversation.messages.slice(-historyLimit);

            const history = recentMessages.map(msg => {
                let parts = [];
                if (msg.text) {
                     const cleanText = msg.text.replace(/\n\n--- Content of .* ---[\s\S]*/, '').trim(); // Remove file content marker for history
                     if(cleanText) parts.push({ text: cleanText });
                }
                if (msg.sender === 'user' && msg.image && msg.image.startsWith('data:image')) {
                    try {
                        const base64Data = msg.image.split(',')[1];
                        const mimeType = msg.image.match(/data:(image\/.*?);base64,/)?.[1] || 'image/jpeg';
                        parts.push({ inlineData: { data: base64Data, mimeType } });
                    } catch (e) { console.error("Error adding image to history:", e); }
                }
                return { role: msg.sender === 'user' ? 'user' : 'model', parts: parts };
            }).filter(msg => msg.parts.length > 0);

            return { history, systemInstruction };
        }

         function prepareOllamaContext() {
             const systemPrompt = getAssistantPrompt(); // Get the fully formed system prompt
             const historyLimit = settings.messageHistoryLimit || 50;
             const recentMessages = currentConversation.messages.slice(-historyLimit);

             const messagesForOllama = recentMessages.map(msg => {
                 let content = msg.text || '';
                 // Remove file content marker if present for Ollama history
                 content = content.replace(/\n\n--- Content of .* ---[\s\S]*/, '').trim();

                 // Include image data if Ollama model supports it (e.g., LLaVA)
                 // Sending base64 image data
                 const images = (msg.sender === 'user' && msg.image && msg.image.startsWith('data:image'))
                     ? [msg.image.split(',')[1]]
                     : undefined;

                 return {
                     role: msg.sender === 'user' ? 'user' : 'assistant',
                     content: content,
                     images: images // Add images array if present
                 };
             }).filter(msg => msg.content || (msg.images && msg.images.length > 0)); // Ensure message has content or images

             return { messagesForOllama, systemPrompt };
        }

        async function processMemoryTags(responseText, baseMessageId) {
            const memoryRegex = /<Memory:"([^"]*):([^"]*)"\/?\>/gi;
            let match;
            let cleanedText = responseText;
            let memoryUpdates = [];

            while ((match = memoryRegex.exec(responseText)) !== null) {
                const key = match[1]?.trim();
                const value = match[2]?.trim();
                if (key && value) {
                    const oldValue = memory[key];
                    if (oldValue !== value) { // Only save & notify if value changed
                        memory[key] = value;
                        memoryUpdates.push({ key, value });
                        console.log(`Memory updated: ${key} = ${value}`);
                    }
                    cleanedText = cleanedText.replace(match[0], ''); // Remove tag
                }
            }

            if (memoryUpdates.length > 0) {
                saveMemory();
                updateMemoryListUI();
                // Add a subtle notification message
                const updateMsgText = `Ok, I've remembered that ${memoryUpdates.map(upd => `**${upd.key}** is ${upd.value.substring(0,30)}${upd.value.length > 30 ? '...' : ''}`).join(', ')}.`;
                addMessageToChat({
                    id: baseMessageId - 0.5, // Try to place slightly before main response
                    text: updateMsgText,
                    sender: 'system', // Use a distinct sender for styling
                    timestamp: Date.now(),
                    messageType: 'memoryUpdate'
                });
                sendToTelegramBot(`Memory updated in conv ${currentConversation?.id}: ${memoryUpdates.map(u => u.key).join(',')}`);
            }
            return cleanedText.trim();
        }

        async function generateAndDisplayImage(prompt, messageId) {
            showIndicator('image');
            try {
                // Basic check - maybe allow limited free gens?
                // if (plan !== 'premium') {
                //    showPremiumAdModal("imageGeneration");
                //    throw new Error("Image generation requires Premium plan.");
                // }
                // Using Pollinations.ai proxy
                 const encodedPrompt = encodeURIComponent(prompt.replace(/\s+/g, '+'));
                 const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}`;

                const imageData = {
                    id: messageId, text: ` Image generated for: "${prompt}"`, sender: 'ai', image: imageUrl, timestamp: Date.now(), messageType: 'imageGen'
                };
                addMessageToChat(imageData);
                currentConversation.messages.push(imageData);
                saveConversations();
                conversationMessageCount++;
                sendToTelegramBot(`AI generated image in conv ${currentConversation.id}: ${prompt.substring(0,50)}...`);

            } catch (error) {
                console.error("Error generating image:", error);
                addAiTextMessage(`Sorry, couldn't generate image: ${error.message}`, messageId, true);
                showToast(`Image Error: ${error.message}`, 'error');
                sendToTelegramBot(`ERROR (Image Gen): ${error.message} in conv ${currentConversation.id}`, 'error');
            } finally { removeIndicator(); }
        }

         async function executeAndDisplayJs(jsCode, outputRequested, messageId) {
             showIndicator('js');
             try {
                 const result = await evaluateJavascript(jsCode);
                 const resultString = (typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result));

                 const resultMessageData = {
                     id: messageId,
                     executedCode: jsCode, // Store executed code
                     resultText: resultString, // Store result
                     outputRequested: outputRequested,
                     sender: 'ai',
                     timestamp: Date.now(),
                     messageType: 'processJsResult'
                 };
                 addMessageToChat(resultMessageData);
                 currentConversation.messages.push(resultMessageData);
                 saveConversations();
                 conversationMessageCount++;
                 sendToTelegramBot(`JS executed (${outputRequested?'output':'no output'}) in conv ${currentConversation.id}`, 'info', `Code: ${jsCode.substring(0,100)}...\nResult: ${resultString.substring(0,100)}...`);

             } catch (error) {
                 console.error("Error processing JavaScript:", error);
                 addAiTextMessage(`Error executing JavaScript: ${error.message}\n\`\`\`javascript\n${jsCode}\n\`\`\``, messageId, true); // Show error and code
                 showToast(`JS Execution Error: ${error.message}`, 'error');
                 sendToTelegramBot(`ERROR (JS Exec): ${error.message} in conv ${currentConversation.id}`, 'error');
             } finally { removeIndicator(); }
         }

        function addWebsitePreviewMessage(websiteCode, messageId) {
            const websiteData = { id: messageId, text: websiteCode, sender: 'ai', timestamp: Date.now(), messageType: 'websiteCode' };
            addMessageToChat(websiteData);
            currentConversation.messages.push(websiteData);
            saveConversations();
            conversationMessageCount++;
            sendToTelegramBot(`AI generated website code in conv ${currentConversation.id}`);
        }

        function addAiTextMessage(text, messageId, isError = false) {
            const messageData = { id: messageId, text: text, sender: 'ai', timestamp: Date.now(), messageType: isError ? 'error' : 'text' };
            addMessageToChat(messageData);
            currentConversation.messages.push(messageData);
            saveConversations();
            conversationMessageCount++;
            if (!isError) sendAiResponseLog(messageData);
        }


        // --- UI & Display ---
        function addMessageToChat(messageData) {
             if (!currentConversation) return;
             const { id, text, sender, image, timestamp, file, messageType = 'text', resultText, executedCode, outputRequested } = messageData;

             // Sanitize HTML output from Markdown, except for specific trusted types
             const shouldSanitize = !(messageType === 'websiteCode' || messageType === 'processJsResult' || messageType === 'memoryUpdate'); // Don't sanitize these structural messages
             const renderedHtml = shouldSanitize ? marked.parse(text || "") : (text || "");

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${sender}-message-wrapper`;
            messageWrapper.dataset.messageId = id;

            // Context menu listeners
            messageWrapper.addEventListener('contextmenu', (event) => handleContextMenu(event, id, sender));
            messageWrapper.addEventListener('touchstart', (event) => handleTouchStart(event, id, sender));
            messageWrapper.addEventListener('touchend', handleTouchEnd);
            messageWrapper.addEventListener('touchcancel', handleTouchEnd);

            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message ${messageType}-message`;

             // Content Rendering
             switch (messageType) {
                 case 'memoryUpdate':
                     messageElement.className = `message system-message ${messageType}-message`; // Override class for centering/styling
                     // Basic sanitization for the text part of memory update
                     messageElement.innerHTML = `<i class="fas fa-brain"></i> ${DOMPurify.sanitize(text || "")}`;
                     break;
                 case 'imageGen':
                     messageElement.classList.add('ai-message');
                     if (text) { // Display text description if provided
                         const textDiv = document.createElement('div');
                         textDiv.className = "message-content mb-2";
                         textDiv.innerHTML = renderedHtml; // Use rendered markdown
                         messageElement.appendChild(textDiv);
                     }
                     const imgGen = document.createElement('img');
                     imgGen.src = image; imgGen.className = 'message-image rounded-lg'; imgGen.alt = 'Generated Image';
                     imgGen.onerror = () => { imgGen.alt = 'Error loading image'; imgGen.src = ''; };
                     messageElement.appendChild(imgGen);
                     break;
                 case 'websiteCode':
                     messageElement.innerHTML = `
                        <div class="website-preview-header-chat"> <span class="title"><i class="fas fa-code mr-2"></i> index.html Preview</span> <div class="actions"> <button onclick="window.downloadWebsiteCode('${id}')" title="Download HTML"><i class="fas fa-download"></i></button> <button onclick="window.openWebsiteInNewTab('${id}')" title="Open in New Tab"><i class="fas fa-external-link-alt"></i></button> </div> </div>
                        <iframe class="website-preview-iframe" sandbox="allow-scripts allow-same-origin" loading="lazy" srcdoc="${text}"></iframe>`; // text IS the srcdoc here
                     break;
                 case 'processJsResult':
                    const codeDisplayHtml = executedCode ? `<div class="process-js-code-display" title="Executed Code">Code: ${DOMPurify.sanitize(executedCode)}</div>` : '';
                    const resultHtml = outputRequested || (resultText && resultText !== 'undefined') ? `<pre><code class="language-javascript hljs">${hljs.highlight(resultText || '', { language: 'javascript' }).value}</code></pre>` : `<p class="text-xs italic text-gray-500 dark:text-gray-400">(JavaScript executed without direct output)</p>`;

                    messageElement.innerHTML = `
                        <div class="process-js-result-header"> <span class="title"><i class="fas fa-terminal mr-2"></i> JS Execution</span> </div>
                        <div class="process-js-result-content message-content"> ${codeDisplayHtml} ${resultHtml} </div>`;
                    if (outputRequested || (resultText && resultText !== 'undefined')) {
                         const pre = messageElement.querySelector('pre');
                         if (pre) highlightCodeBlock(pre.querySelector('code')); // Add copy button etc.
                    }
                     break;
                 default: // Standard text, user image, user file
                     if (sender === 'user' && image) { // User image upload
                         if (text && text !== "Image attached") { // Display text if provided
                            const textDiv = document.createElement('div'); textDiv.className="message-content mb-2"; textDiv.innerHTML = renderedHtml; messageElement.appendChild(textDiv);
                         }
                         const imgUser = document.createElement('img'); imgUser.src = image; imgUser.className = 'message-image rounded-lg'; imgUser.alt = 'User Uploaded Image'; messageElement.appendChild(imgUser);
                     } else if (sender === 'user' && file) { // User file upload
                         // Show text part (potentially including file content preview)
                         const textDiv = document.createElement('div'); textDiv.className="message-content"; textDiv.innerHTML = renderedHtml; messageElement.appendChild(textDiv);
                         // Add non-preview file link below text if content wasn't fully included
                         if (!text?.includes('--- Content of')) {
                            const fileLink = document.createElement('div'); // Not a link if not downloadable
                            fileLink.className = 'message-file';
                            fileLink.title = `Type: ${file.type}, Size: ${(file.size / 1024).toFixed(1)} KB`;
                            fileLink.innerHTML = `<i class="fas fa-file-alt mr-2"></i> ${DOMPurify.sanitize(file.name)}`;
                            messageElement.appendChild(fileLink);
                         }
                     } else { // Standard text message
                         messageElement.classList.add('message-content');
                         messageElement.innerHTML = renderedHtml;
                     }
             }


            // Add actions (desktop hover) if not a system message
            if (sender !== 'system') {
                const actionsDiv = createMessageActions(id, sender);
                if (actionsDiv) messageElement.appendChild(actionsDiv);
            }

            messageWrapper.appendChild(messageElement);

            // Timestamp (if not system message)
            if (timestamp && sender !== 'system') {
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatTimestamp(timestamp);
                messageWrapper.appendChild(timeElement);
            }

            // Insert before indicators and scroll
             const firstIndicator = el.chatMessages.querySelector('.typing-indicator');
             el.chatMessages.insertBefore(messageWrapper, firstIndicator);

            // Animation
             requestAnimationFrame(() => {
                messageWrapper.classList.add('animate__animated', 'animate__fadeInUp', 'animate__faster');
             });

            scrollToBottom();
            // Highlight code blocks within the new message if needed
            if (shouldSanitize && messageType !== 'processJsResult' && messageType !== 'websiteCode') {
                 messageElement.querySelectorAll('pre code:not(.hljs)').forEach(highlightCodeBlock);
            }
            el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
        }

        function createMessageActions(messageId, sender) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            let buttons = '';
            if (sender === 'user') {
                buttons = `
                    <button class="message-action-button edit-button" title="Edit" data-action="edit" data-message-id="${messageId}"><i class="fas fa-edit"></i></button>
                    <button class="message-action-button delete-button" title="Delete" data-action="delete" data-message-id="${messageId}"><i class="fas fa-trash"></i></button> `;
            } else { // AI message
                 buttons = `
                    <button class="message-action-button copy-button" title="Copy" data-action="copy" data-message-id="${messageId}"><i class="fas fa-copy"></i></button>
                    <button class="message-action-button regenerate-button" title="Regenerate" data-action="regenerate" data-message-id="${messageId}"><i class="fas fa-sync"></i></button>
                    <button class="message-action-button delete-button" title="Delete" data-action="delete" data-message-id="${messageId}"><i class="fas fa-trash"></i></button> `;
            }
            actionsDiv.innerHTML = buttons;
            actionsDiv.querySelectorAll('button').forEach(button => button.addEventListener('click', handleMessageActionClick));
            return actionsDiv;
        }

        function handleMessageActionClick(event) {
             event.stopPropagation();
             const button = event.currentTarget;
             const action = button.dataset.action;
             const messageId = parseInt(button.dataset.messageId);
             hideContextMenu(); // Hide context menu if open
             switch (action) {
                 case 'edit': editPrompt(messageId); break;
                 case 'delete': deleteOutput(messageId); break;
                 case 'regenerate': regenerateOutput(messageId); break;
                 case 'copy': copyMessageToClipboard(messageId); break;
             }
        }

        function highlightCodeBlock(block) {
            if (!block || block.classList.contains('hljs')) return;
            const pre = block.closest('pre');
            if (!pre) return;
            pre.style.position = 'relative'; // For button positioning
            hljs.highlightElement(block);
            // Add copy button
            if (!pre.querySelector('.copy-code-button')) {
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-code-button';
                copyButton.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy';
                copyButton.onclick = (e) => { e.stopPropagation(); copyCodeToClipboard(block.textContent); };
                pre.appendChild(copyButton);
            }
        }

        // --- Context Menu Logic --- (Largely unchanged, check sender !== 'system')
        function handleContextMenu(event, messageId, sender) {
             event.preventDefault(); event.stopPropagation();
             hideContextMenu();
             if (sender === 'system') return; // No context menu for system messages

             contextMenuTargetMessage = messageId;
             const isUserMessage = sender === 'user';
             const isAiMessage = sender === 'ai';

             el.editContextButton.style.display = isUserMessage ? 'block' : 'none';
             el.copyContextButton.style.display = 'block'; // Copy user or AI
             el.regenerateContextButton.style.display = isAiMessage ? 'block' : 'none';
             el.deleteContextButton.style.display = 'block'; // Delete user or AI

             positionContextMenu(event);
             showContextMenu();
        }
        function handleTouchStart(event, messageId, sender) {
             clearTimeout(touchTimer);
             if (sender === 'system') return; // No long press for system messages
             touchStartTime = Date.now();
             const touch = event.touches[0]; const startY = touch.pageY;
             const touchendListener = () => { clearTimeout(touchTimer); window.removeEventListener('touchend', touchendListener); window.removeEventListener('touchmove', touchmoveListener); };
             const touchmoveListener = (e_move) => { if (Math.abs(e_move.touches[0].pageY - startY) > 10) clearTimeout(touchTimer); };
             window.addEventListener('touchend', touchendListener, { passive: true });
             window.addEventListener('touchmove', touchmoveListener, { passive: true });
             touchTimer = setTimeout(() => {
                 handleContextMenu(touch, messageId, sender);
                 window.removeEventListener('touchend', touchendListener); window.removeEventListener('touchmove', touchmoveListener);
             }, 600);
        }
        function handleTouchEnd() { clearTimeout(touchTimer); }
        function positionContextMenu(event) {
             const menu = messageContextMenu; const clickX = event.clientX || event.pageX; const clickY = event.clientY || event.pageY; const screenW = window.innerWidth; const screenH = window.innerHeight; const menuW = menu.offsetWidth; const menuH = menu.offsetHeight;
             menu.style.left = `${Math.max(5, Math.min(clickX, screenW - menuW - 5))}px`; menu.style.top = `${Math.max(5, Math.min(clickY, screenH - menuH - 5))}px`;
        }
        function showContextMenu() { messageContextMenu.style.display = 'block'; void messageContextMenu.offsetWidth; messageContextMenu.classList.remove('animate__fadeOut'); messageContextMenu.classList.add('animate__fadeIn'); }
        function hideContextMenu() { if (messageContextMenu.style.display === 'block') { messageContextMenu.classList.remove('animate__fadeIn'); messageContextMenu.classList.add('animate__fadeOut'); setTimeout(() => { messageContextMenu.style.display = 'none'; contextMenuTargetMessage = null; }, 200); } }
        function handleGlobalClick(event) {
             if (messageContextMenu.style.display === 'block' && !messageContextMenu.contains(event.target)) hideContextMenu();
              if (window.innerWidth < 768 && el.sidebar.classList.contains('active') && !el.sidebar.contains(event.target) && !el.mobileSidebarToggleChat.contains(event.target)) {
                  toggleSidebar(); // Will set sidebarCollapsed = false and hide
             }
             document.querySelectorAll('.conversation-actions-dropdown-content.show').forEach(dropdown => { if (!dropdown.closest('.conversation-item').contains(event.target)) dropdown.classList.remove('show'); });
        }
        function handleContextMenuAction(event) {
             const action = event.currentTarget.id.replace('-context-button', '');
             const messageId = contextMenuTargetMessage;
             hideContextMenu();
             if (!messageId) return;
             switch (action) {
                 case 'edit': editPrompt(messageId); break; case 'copy': copyMessageToClipboard(messageId); break; case 'regenerate': regenerateOutput(messageId); break; case 'delete': deleteOutput(messageId); break;
             }
        }

        // --- Message Actions --- (Mostly unchanged logic, check sender)
        function editPrompt(messageId) {
             const message = currentConversation.messages.find(msg => msg.id === messageId);
             if (!message || message.sender !== 'user') return;
             editingMessageId = messageId;
             el.editMessageTextarea.value = message.text?.replace(/\n\n--- Content of .* ---[\s\S]*/, '').trim() || ''; // Remove file preview for editing
             showModal(el.editMessageModal);
        }
        function cancelEditMessage() { hideModal(el.editMessageModal); editingMessageId = null; }
        async function saveEditMessage() {
            const editedMessageText = DOMPurify.sanitize(el.editMessageTextarea.value.trim());
            if (!editedMessageText || editingMessageId === null) { showToast("Message cannot be empty.", 'info'); return; }

            const messageIndex = currentConversation.messages.findIndex(msg => msg.id === editingMessageId);
            if (messageIndex === -1 || currentConversation.messages[messageIndex].sender !== 'user') { cancelEditMessage(); return; }

            // Update user message data (keep original image/file if present)
            const originalMessage = currentConversation.messages[messageIndex];
            currentConversation.messages[messageIndex] = {
                ...originalMessage,
                text: editedMessageText, // Update text
                timestamp: Date.now() // Update timestamp
            };
            currentConversation.updatedAt = Date.now();

            // Update DOM (re-render the specific message)
            const userMessageWrapper = el.chatMessages.querySelector(`.message-wrapper[data-message-id='${editingMessageId}']`);
            if (userMessageWrapper) userMessageWrapper.remove(); // Remove old wrapper
            addMessageToChat(currentConversation.messages[messageIndex]); // Re-add updated message (will appear at bottom due to DOM insertion logic, need fix if order matters visually here)
            // TODO: Fix DOM update to replace in-place instead of removing/re-adding at end.


            // Remove subsequent messages
            const wrappersToRemove = [];
            let subsequentMessages = currentConversation.messages.slice(messageIndex + 1);
            subsequentMessages.forEach((msg) => {
                const wrapper = el.chatMessages.querySelector(`.message-wrapper[data-message-id='${msg.id}']`);
                if (wrapper) wrappersToRemove.push(wrapper);
                if (msg.sender !== 'user') conversationMessageCount--;
            });
            currentConversation.messages.splice(messageIndex + 1); // Remove from array
            wrappersToRemove.forEach(wrapper => wrapper.remove()); // Remove from DOM

            saveConversations();
            hideModal(el.editMessageModal);
            showToast('Message updated. Re-running...', 'info');
            sendToTelegramBot(`User message ${editingMessageId} edited in conv ${currentConversation.id}`);

            // Re-run the prompt
            el.regenerateHeaderButton.style.display = 'none';
            NProgress.start();
             const userMessageDataForRun = currentConversation.messages[messageIndex]; // Use the updated message data
             // Re-read file content if it was originally attached and needs to be included in the prompt
             let fileContentForPrompt = null;
             if (userMessageDataForRun.file && userMessageDataForRun.file.type.startsWith('text/') && userMessageDataForRun.file.size < 150 * 1024) {
                // Need to re-access the original file object if possible, or store content initially.
                // This is tricky without storing file blobs/content. Let's assume text files were included in original text for now.
                const fileContentMarker = userMessageDataForRun.text.match(/\n\n--- Content of .* ---([\s\S]*)/);
                if(fileContentMarker) fileContentForPrompt = fileContentMarker[1];
             }
             if(fileContentForPrompt && !userMessageDataForRun.text.includes('--- Content of')) {
                 userMessageDataForRun.text += `\n\n--- Content of ${userMessageDataForRun.file.name} ---\n${fileContentForPrompt}`;
             }


            if (!settings.ollamaEnabled) {
                await getGeminiResponse(userMessageDataForRun);
            } else {
                await getOllamaResponse();
            }
            NProgress.done();
            editingMessageId = null;
            el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
        }

        function deleteOutput(messageId) {
             if (!confirm("Delete this message? This cannot be undone.")) return;
             const messageIndex = currentConversation.messages.findIndex(msg => msg.id === messageId);
             if (messageIndex !== -1) {
                 const messageWrapper = el.chatMessages.querySelector(`.message-wrapper[data-message-id='${messageId}']`);
                 if (currentConversation.messages[messageIndex].sender !== 'user') {
                     conversationMessageCount = Math.max(0, conversationMessageCount - 1);
                 }
                 currentConversation.messages.splice(messageIndex, 1);
                 if (messageWrapper) messageWrapper.remove();
                 currentConversation.updatedAt = Date.now();
                 saveConversations();
                 showToast('Message deleted.', 'success');
                 sendToTelegramBot(`Message ${messageId} deleted from conv ${currentConversation.id}`);
                 el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
             }
        }

        async function regenerateOutput(aiMessageId) {
             const aiMessageIndex = currentConversation.messages.findIndex(msg => msg.id === aiMessageId);
             if (aiMessageIndex === -1 || currentConversation.messages[aiMessageIndex].sender === 'user') { showToast("Can only regenerate AI responses.", "error"); return; }

             let userMessageIndex = -1;
             for (let i = aiMessageIndex - 1; i >= 0; i--) { if (currentConversation.messages[i].sender === 'user') { userMessageIndex = i; break; } }
             if (userMessageIndex === -1) { showToast("Cannot regenerate: No preceding user message.", 'error'); return; }

             showToast('Regenerating response...', 'info');

             // Remove the AI message being regenerated and ALL subsequent messages
             const wrappersToRemove = [];
             let subsequentMessages = currentConversation.messages.slice(aiMessageIndex);
             subsequentMessages.forEach((msg) => {
                 const wrapper = el.chatMessages.querySelector(`.message-wrapper[data-message-id='${msg.id}']`);
                 if (wrapper) wrappersToRemove.push(wrapper);
                 if (msg.sender !== 'user') conversationMessageCount = Math.max(0, conversationMessageCount -1);
             });
             currentConversation.messages.splice(aiMessageIndex); // Remove from array
             wrappersToRemove.forEach(wrapper => wrapper.remove()); // Remove from DOM
             currentConversation.updatedAt = Date.now();
             saveConversations();
             sendToTelegramBot(`Regenerating response for message ${aiMessageId} in conv ${currentConversation.id}`);

             // Trigger AI again
             el.regenerateHeaderButton.style.display = 'none';
             NProgress.start();
             const userMessageDataForRun = currentConversation.messages[userMessageIndex]; // The preceding user message
              // Re-attach potential file content if needed (similar logic to saveEditMessage)
              let fileContentForPrompt = null;
              if (userMessageDataForRun.file && userMessageDataForRun.file.type.startsWith('text/') && userMessageDataForRun.file.size < 150 * 1024) {
                 const fileContentMarker = userMessageDataForRun.text.match(/\n\n--- Content of .* ---([\s\S]*)/);
                 if(fileContentMarker) fileContentForPrompt = fileContentMarker[1];
              }
              if(fileContentForPrompt && !userMessageDataForRun.text.includes('--- Content of')) {
                 userMessageDataForRun.text += `\n\n--- Content of ${userMessageDataForRun.file.name} ---\n${fileContentForPrompt}`;
              }

             if (!settings.ollamaEnabled) {
                 await getGeminiResponse(userMessageDataForRun);
             } else {
                 await getOllamaResponse();
             }
             NProgress.done();
             el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
        }
        function regenerateLastResponse() {
            if (!currentConversation || currentConversation.messages.length === 0) return;
            let lastAiMessage = null;
            for(let i = currentConversation.messages.length - 1; i >= 0; i--) { if(currentConversation.messages[i].sender === 'ai') { lastAiMessage = currentConversation.messages[i]; break; } }
            if (lastAiMessage) { regenerateOutput(lastAiMessage.id); } else { showToast("No AI response to regenerate.", "info"); }
        }
        function canRegenerate() { return currentConversation && currentConversation.messages.some(msg => msg.sender === 'ai'); }
        function copyMessageToClipboard(messageId) {
            const message = currentConversation?.messages.find(msg => msg.id === messageId);
            if (!message) return;
            let textToCopy = message.text || '';
            if (message.messageType === 'websiteCode') textToCopy = message.text;
            else if (message.messageType === 'processJsResult') textToCopy = message.resultText || '';
            else if (!textToCopy) { const msgElement = el.chatMessages.querySelector(`.message-wrapper[data-message-id='${messageId}'] .message`); textToCopy = msgElement?.innerText || ''; }
            navigator.clipboard.writeText(textToCopy).then(() => { showToast('Message copied!', 'success'); }).catch(err => { showToast('Failed to copy.', 'error'); });
        }
        function copyCodeToClipboard(code) { navigator.clipboard.writeText(code).then(() => showToast('Code copied!', 'success')).catch(err => showToast('Failed to copy code.', 'error')); }

        // Website preview helpers (Unchanged)
        window.downloadWebsiteCode = function(messageId) { /* ... same as before ... */
            const message = currentConversation?.messages.find(msg => msg.id == messageId && msg.messageType === 'websiteCode');
            if (message && message.text) { try { const blob = new Blob([message.text], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'index.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Code downloaded!', 'success'); } catch (e) { showToast('Download error.', 'error'); console.error("Download error:", e); } } else { showToast('Could not find code.', 'error'); } }
        window.openWebsiteInNewTab = function(messageId) { /* ... same as before ... */
             const message = currentConversation?.messages.find(msg => msg.id == messageId && msg.messageType === 'websiteCode');
             if (message && message.text) { try { const newTab = window.open(); newTab.document.open(); newTab.document.write(message.text); newTab.document.close(); showToast('Preview opened!', 'success'); } catch (e) { showToast('Error opening preview.', 'error'); console.error("New tab error:", e); } } else { showToast('Could not find code.', 'error'); } }


        // --- Sidebar & Conversation Management ---
        function createNewConversation() {
             const nonArchivedCount = conversations.filter(c => !c.archived).length;
             if (plan === 'free' && nonArchivedCount >= MAX_CONVERSATIONS) { showPremiumAdModal("conversationLimit"); return; }
             const defaultName = `Chat ${conversations.length + 1}`;
             const newConversation = { id: Date.now(), name: defaultName, messages: [], assistant: 'default', createdAt: Date.now(), updatedAt: Date.now(), archived: false, pinned: false };
             conversations.unshift(newConversation);
             saveConversations();
             updateConversationList();
             switchConversation(newConversation);
             if (plan === 'free') { /* Optionally track total created if needed */ }
             sendToTelegramBot(`New conversation created: ${newConversation.id} (${newConversation.name})`);
        }
        function updateConversationList() {
            const searchTerm = el.searchConversationsInput.value.toLowerCase();
            const pinnedConvs = conversations.filter(c => c.pinned && !c.archived);
            const normalConvs = conversations.filter(c => !c.pinned && !c.archived);
            const archivedConvs = conversations.filter(c => c.archived);
            const sortByTimestamp = (a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt);
            [pinnedConvs, normalConvs, archivedConvs].forEach(list => list.sort(sortByTimestamp));
            const filterConv = (conv) => conv.name.toLowerCase().includes(searchTerm) || conv.messages.some(msg => msg.text && msg.text.toLowerCase().includes(searchTerm));
            const displayList = (listElement, convs, isArchived = false) => {
                listElement.innerHTML = '';
                const filtered = convs.filter(filterConv);
                filtered.forEach(conv => listElement.appendChild(createConversationListItem(conv, isArchived)));
                const listContainer = listElement.parentElement;
                if (listContainer) listContainer.style.display = filtered.length > 0 ? 'block' : 'none';
            };
            displayList(el.pinnedList, pinnedConvs);
            displayList(el.conversationList, normalConvs);
            displayList(el.archivedList, archivedConvs, true);
        }
        function createConversationListItem(conv, isArchived) {
             const li = document.createElement('li');
             li.dataset.id = conv.id; li.className = `conversation-item ${currentConversation?.id === conv.id ? 'active' : ''} ${conv.pinned ? 'pinned-conversation' : ''}`; li.dataset.convId = conv.id;
             const nameToShow = DOMPurify.sanitize(conv.name || `Chat ${conv.id}`);
             const pinIconClass = conv.pinned ? 'fas fa-thumbtack rotate-45 text-yellow-500' : 'fas fa-thumbtack';
             const archiveIconClass = isArchived ? 'fas fa-folder-open' : 'fas fa-archive';
             const mobileActions = `
                ${!isArchived ? `<button class="pin-button"><i class="${pinIconClass} w-4"></i> ${conv.pinned ? 'Unpin' : 'Pin'}</button>` : ''}
                <button class="rename-button"><i class="fas fa-edit w-4"></i> Rename</button>
                <button class="archive-button"><i class="${archiveIconClass} w-4"></i> ${isArchived ? 'Unarchive' : 'Archive'}</button>
                <button class="delete-button text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50"><i class="fas fa-trash w-4"></i> Delete</button> `; // Added delete styling
             li.innerHTML = `
                <span class="conversation-title flex-grow">${nameToShow}</span>
                <div class="conversation-actions flex-shrink-0 hidden md:flex"> ${!isArchived ? `<button class="pin-button" title="${conv.pinned ? 'Unpin' : 'Pin'}"><i class="${pinIconClass}"></i></button>` : ''} <button class="rename-button" title="Rename"><i class="fas fa-edit"></i></button> <button class="archive-button" title="${isArchived ? 'Unarchive' : 'Archive'}"><i class="${archiveIconClass}"></i></button> <button class="delete-button" title="Delete"><i class="fas fa-trash"></i></button> </div>
                <div class="conversation-actions-mobile-dropdown md:hidden flex-shrink-0"> <button class="conversation-actions-mobile-button" aria-label="More actions"><i class="fas fa-ellipsis-v"></i></button> <div class="conversation-actions-dropdown-content">${mobileActions}</div> </div> `;
             li.addEventListener('click', (e) => { const clickedButton = e.target.closest('button'); const isDropdown = e.target.closest('.conversation-actions-mobile-dropdown'); if (!clickedButton && !isDropdown) { switchConversation(conv); if (window.innerWidth < 768 && el.sidebar.classList.contains('active')) toggleSidebar(); } });
             const handleAction = (actionFn) => (e) => { e.stopPropagation(); actionFn(conv.id); };
             li.querySelectorAll('.pin-button').forEach(btn => btn.addEventListener('click', handleAction(pinConversation)));
             li.querySelectorAll('.rename-button').forEach(btn => btn.addEventListener('click', handleAction(renameConversation)));
             li.querySelectorAll('.archive-button').forEach(btn => btn.addEventListener('click', handleAction(archiveConversation)));
             li.querySelectorAll('.delete-button').forEach(btn => btn.addEventListener('click', handleAction(deleteConversation)));
             li.querySelector('.conversation-actions-mobile-button')?.addEventListener('click', (e) => { e.stopPropagation(); toggleConversationActionsDropdown(e); });
             return li;
        }
        function toggleConversationActionsDropdown(event) {
            const button = event.currentTarget; const dropdownContent = button.nextElementSibling; if (!dropdownContent) return;
            const currentlyOpen = dropdownContent.classList.contains('show');
            document.querySelectorAll('.conversation-actions-dropdown-content.show').forEach(d => { if (d !== dropdownContent) d.classList.remove('show'); });
            if (!currentlyOpen) dropdownContent.classList.add('show');
        }
        function pinConversation(id) { const conv = conversations.find(c => c.id === id); if (conv && !conv.archived) { conv.pinned = !conv.pinned; conv.updatedAt = Date.now(); saveConversations(); updateConversationList(); showToast(`Chat ${conv.pinned ? 'pinned' : 'unpinned'}.`, 'info'); sendToTelegramBot(`Conversation ${id} ${conv.pinned ? 'pinned' : 'unpinned'}.`); } }
        function renameConversation(id) { const conv = conversations.find(c => c.id === id); if (!conv) return; const newName = prompt("Enter new chat name:", conv.name); const sanitizedNewName = newName ? DOMPurify.sanitize(newName.trim()) : null; if (sanitizedNewName && sanitizedNewName !== conv.name) { const oldName = conv.name; conv.name = sanitizedNewName; conv.updatedAt = Date.now(); saveConversations(); updateConversationList(); if (currentConversation?.id === id) el.currentConversationTitle.textContent = conv.name; showToast('Chat renamed.', 'success'); sendToTelegramBot(`Conv ${id} renamed from "${oldName}" to "${conv.name}".`); } }
        function archiveConversation(id) { const conv = conversations.find(c => c.id === id); if (!conv) return; const wasArchived = conv.archived; conv.archived = !conv.archived; conv.pinned = false; conv.updatedAt = Date.now(); saveConversations(); updateConversationList(); showToast(`Chat ${conv.archived ? 'archived' : 'unarchived'}.`, 'info'); sendToTelegramBot(`Conversation ${id} ${conv.archived ? 'archived' : 'unarchived'}.`); if (currentConversation?.id === id && conv.archived) { const nextConversation = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived); if (nextConversation) { switchConversation(nextConversation); } else { currentConversation = null; clearChatMessages(); el.currentConversationTitle.textContent = "Select or Start a Chat"; el.chatInputArea.classList.add('conversation-empty'); updateStarterMessagesArea(); el.regenerateHeaderButton.style.display = 'none'; el.chatPlaceholder.classList.remove('hidden'); } } }
        function deleteConversation(id) { const conv = conversations.find(c => c.id === id); if (!conv) return; if (confirm(`Delete chat "${conv.name}"? This cannot be undone.`)) { const convName = conv.name; conversations = conversations.filter(c => c.id !== id); saveConversations(); updateConversationList(); showToast(`Chat "${convName}" deleted.`, 'success'); sendToTelegramBot(`Conversation "${convName}" (${id}) deleted.`); if (currentConversation?.id === id) { const nextConv = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived); if (nextConv) { switchConversation(nextConv); } else { currentConversation = null; clearChatMessages(); el.currentConversationTitle.textContent = "Select or Start a Chat"; el.chatInputArea.classList.add('conversation-empty'); updateStarterMessagesArea(); el.regenerateHeaderButton.style.display = 'none'; el.chatPlaceholder.classList.remove('hidden'); if (conversations.length === 0) createNewConversation(); } } } }
        function switchConversation(conversation) {
            if (!conversation) { if (conversations.length === 0) createNewConversation(); return; }
            if (currentConversation?.id === conversation.id && el.chatMessages.children.length > 5) { console.log("Already on conversation:", conversation.id); if (window.innerWidth < 768 && el.sidebar.classList.contains('active')) toggleSidebar(); return; }

            currentConversation = conversation;
            setLocalStorageItem('lastActiveConversationId', conversation.id); // Use secure wrapper
            clearChatMessages();
            conversation.messages.forEach(addMessageToChat);
            scrollToBottom(true);
            el.currentConversationTitle.textContent = conversation.name || 'Chat';
            updateConversationList(); // Highlight active
            conversationMessageCount = conversation.messages.length; // Update count for limits

            if (conversation.messages.length === 0) {
                el.chatInputArea.classList.add('conversation-empty');
                updateStarterMessagesArea();
                el.starterMessagesContainer.style.display = 'block';
                el.chatPlaceholder.classList.add('hidden'); // Hide placeholder on empty chat view
            } else {
                el.chatInputArea.classList.remove('conversation-empty');
                el.starterMessagesContainer.style.display = 'none';
                el.chatPlaceholder.classList.add('hidden');
            }

            if (window.innerWidth < 768 && el.sidebar.classList.contains('active')) toggleSidebar();
            el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
            console.log(`Switched to conversation: ${conversation.id} (${conversation.name})`);
        }
        function clearChatMessages() {
            const indicators = Array.from(el.chatMessages.querySelectorAll('.typing-indicator')); // Get live list
            el.chatMessages.innerHTML = ''; // Clear all
            indicators.forEach(indicator => el.chatMessages.appendChild(indicator)); // Re-add
            // Show placeholder if no conversation is active or selected one is empty
             if (!currentConversation || currentConversation.messages.length === 0) {
                el.chatPlaceholder.classList.remove('hidden');
            } else {
                 el.chatPlaceholder.classList.add('hidden');
             }
        }
         function toggleSidebar() {
             const isMobile = window.innerWidth < 768;
             if (isMobile) {
                 const isActive = el.sidebar.classList.toggle('active');
                 sidebarCollapsed = isActive; // Mobile state is just active/inactive
             } else {
                 sidebarCollapsed = !el.sidebar.classList.contains('sidebar-closed');
                 el.sidebar.classList.toggle('sidebar-closed', sidebarCollapsed);
                 el.toggleSidebarDesktopButton.querySelector('i').style.transform = sidebarCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
             }
             // Persist state? Optional
             // setLocalStorageItem('sidebarCollapsed', sidebarCollapsed);
             console.log("Sidebar toggled, collapsed:", sidebarCollapsed);
         }


        // --- Settings Logic ---
        function openSettings() {
             document.getElementById('message-history-limit').value = settings.messageHistoryLimit;
             populateAiModelSelect();
             const modelSelect = document.getElementById('ai-model');
              if ([...modelSelect.options].some(opt => opt.value === settings.aiModel)) { modelSelect.value = settings.aiModel; } else { modelSelect.value = modelSelect.options[0]?.value || ''; settings.aiModel = modelSelect.value; saveSettings(); }
             document.getElementById('theme').value = settings.theme;
             el.aiAssistantModeSelect.value = settings.aiAssistantMode;
             el.ollamaEnabledCheckbox.checked = settings.ollamaEnabled;
             el.ollamaApiUrlInput.value = settings.ollamaApiUrl;
             el.ollamaModelSelect.value = settings.ollamaModel || 'llama3:8b-instruct'; // Default if null
             el.ollamaCustomModelInput.value = settings.ollamaCustomModel || '';
             toggleOllamaSettingsVisibility();
             toggleOllamaCustomModelInput(); // Check if custom needs showing
             updateMemoryListUI();
             showModal(el.settingsModal);
        }
        function closeSettings() { hideModal(el.settingsModal); }
        function saveSettingsChanges() {
             const selectedModel = document.getElementById('ai-model').value;
             const allowedModels = plan === 'premium' ? [FREE_MODEL_FLASH, PREMIUM_MODEL_PRO] : [FREE_MODEL_LITE];
             if (!allowedModels.includes(selectedModel)) { showToast(`Plan limited to ${allowedModels.map(getModelName).join('/')}.`, 'info'); document.getElementById('ai-model').value = settings.aiModel; return; }

             settings.messageHistoryLimit = parseInt(document.getElementById('message-history-limit').value) || 50;
             settings.aiModel = selectedModel;
             settings.theme = document.getElementById('theme').value;
             settings.aiAssistantMode = el.aiAssistantModeSelect.value;
             settings.ollamaEnabled = el.ollamaEnabledCheckbox.checked;
             settings.ollamaApiUrl = el.ollamaApiUrlInput.value.trim();
             settings.ollamaModel = el.ollamaModelSelect.value;
             settings.ollamaCustomModel = el.ollamaCustomModelInput.value.trim();

             // Validate custom Ollama model if selected
             if (settings.ollamaModel === 'custom' && !settings.ollamaCustomModel) {
                 showToast("Please enter a custom Ollama model name.", "error");
                 return;
             }

             saveSettings();
             applySettings();
             closeSettings();
             showToast('Settings saved!', 'success');
             sendToTelegramBot('Settings updated.');
        }
        function applySettings() {
             applyTheme();
             initializeModel(); // Re-initialize model
             updateNewAssistantModeUI();
             updatePlanLimits(); // Ensure limits match plan
        }
        function applyTheme() {
            const theme = settings.theme; const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.classList.remove('dark', 'light');
            if (theme === 'dark' || (theme === 'system' && prefersDark)) document.body.classList.add('dark'); else document.body.classList.add('light');
             console.log("Theme applied:", document.body.classList.contains('dark') ? 'Dark' : 'Light');
             // Update highlight.js theme (if needed, though atom-one-dark works okay in light mode too)
             // document.getElementById('highlight-theme').href = document.body.classList.contains('dark') ? 'path/to/dark/theme.css' : 'path/to/light/theme.css';
        }
        function toggleOllamaSettingsVisibility() { el.ollamaSettingsDiv.classList.toggle('hidden', !el.ollamaEnabledCheckbox.checked); }
        function toggleOllamaCustomModelInput() { el.ollamaCustomModelInputContainer.classList.toggle('hidden', el.ollamaModelSelect.value !== 'custom'); }
        function populateAiModelSelect() {
             const select = document.getElementById('ai-model'); select.innerHTML = '';
             const availableModels = plan === 'premium' ? [PREMIUM_MODEL_PRO, FREE_MODEL_FLASH] : [FREE_MODEL_LITE]; // Order premium best first
             availableModels.forEach(modelId => { const option = document.createElement('option'); option.value = modelId; option.textContent = getModelName(modelId); select.appendChild(option); });
        }
         function getModelName(modelId) {
            switch(modelId) {
                case FREE_MODEL_LITE: return 'Gemini Flash Lite (Free)';
                case FREE_MODEL_FLASH: return 'Gemini Flash'; // Accessible to both
                case PREMIUM_MODEL_PRO: return 'Gemini Pro (Premium)';
                default: return modelId;
            }
        }

        // --- Assistant Management Logic --- (Refined save/edit/prompt generation)
        function openAssistantModal() { updateAssistantList(); showModal(el.assistantModal); }
        function closeAssistantModal() { hideModal(el.assistantModal); }
        function updateAssistantList() { /* ... same as before, ensure DOMPurify used ... */
             el.assistantList.innerHTML = '';
             assistants.forEach(assistant => {
                const card = document.createElement('div');
                card.className = `assistant-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md transition-shadow duration-200 cursor-pointer border border-gray-200 dark:border-gray-600 flex flex-col justify-between`;
                const description = assistant.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${DOMPurify.sanitize(assistant.description)}</p>` : '';
                const isDefault = assistant.id === 'default';
                const isActive = currentConversation?.assistant === assistant.id;
                if (isActive) card.classList.add('border-primary-500', 'border-2');
                card.innerHTML = ` <div> <h3 class="text-md font-semibold mb-1 text-gray-800 dark:text-gray-200">${DOMPurify.sanitize(assistant.name)}</h3> ${description} </div> <div class="flex justify-end items-center mt-2 text-gray-500 dark:text-gray-400 gap-2"> ${isDefault ? '<span class="text-xs italic mr-auto">Default</span>' : ''} ${isActive ? '<span class="text-xs font-semibold text-primary-600 dark:text-primary-400 mr-auto ml-2">Active</span>' : ''} <button class="edit-assistant-button hover:text-primary-500 transition-colors p-1" data-assistant-id="${assistant.id}" title="Edit Assistant"><i class="fas fa-edit"></i></button> ${!isDefault ? `<button class="delete-assistant-button hover:text-red-500 transition-colors p-1" data-assistant-id="${assistant.id}" title="Delete Assistant"><i class="fas fa-trash"></i></button>` : ''} </div> `;
                card.onclick = (e) => { if (!e.target.closest('button')) selectAssistant(assistant.id); };
                card.querySelector('.edit-assistant-button')?.addEventListener('click', (e) => { e.stopPropagation(); openNewAssistantModal(assistant.id); });
                card.querySelector('.delete-assistant-button')?.addEventListener('click', (e) => { e.stopPropagation(); deleteAssistant(assistant.id); });
                el.assistantList.appendChild(card);
             });
        }
        function openNewAssistantModal(assistantIdToEdit = null) { /* ... same as before ... */
            const isEditing = assistantIdToEdit !== null;
            el.newAssistantModalTitle.innerHTML = isEditing ? '<i class="fas fa-edit mr-2"></i> Edit Assistant' : '<i class="fas fa-plus-circle mr-2"></i> Create New Assistant';
            if (isEditing) { const assistant = assistants.find(a => a.id === assistantIdToEdit); if (!assistant) return; el.editingAssistantIdInput.value = assistant.id; el.assistantNameInput.value = assistant.name; el.assistantDescriptionInput.value = assistant.description || ''; el.assistantPromptTextarea.value = assistant.prompt; } else { el.editingAssistantIdInput.value = ''; el.assistantNameInput.value = ''; el.assistantDescriptionInput.value = ''; el.assistantPromptTextarea.value = ''; /* Maybe pre-fill structure? */ }
            updateNewAssistantModeUI(); showModal(el.newAssistantModal);
        }
        function closeNewAssistantModal() { /* ... same as before ... */
            hideModal(el.newAssistantModal); el.generateAssistantPromptButton.style.display = 'none'; el.saveNewAssistantButton.style.display = 'inline-block'; el.promptModeAutoArea.classList.add('hidden'); el.promptModeManualArea.style.display = 'block';
        }
        function updateNewAssistantModeUI() { /* ... same as before ... */
             const mode = settings.aiAssistantMode; if (mode === 'auto') { el.promptModeManualArea.style.display = 'none'; el.generateAssistantPromptButton.style.display = 'inline-block'; el.saveNewAssistantButton.style.display = 'none'; } else { el.promptModeManualArea.style.display = 'block'; el.promptModeAutoArea.classList.add('hidden'); el.generateAssistantPromptButton.style.display = 'none'; el.saveNewAssistantButton.style.display = 'inline-block'; }
        }
        async function generateAiAssistantPrompt() { /* ... same as before, uses FREE_MODEL_FLASH ... */
            const name = el.assistantNameInput.value.trim(); const description = el.assistantDescriptionInput.value.trim(); if (!name) { showToast("Enter an assistant name.", 'info'); return; } if (!genAI || !model || settings.ollamaEnabled) { showToast("Gemini AI model needed for generation.", 'error'); return; }
            el.promptModeManualArea.style.display = 'none'; el.promptModeAutoArea.classList.remove('hidden'); el.generateAssistantPromptButton.style.display = 'none'; el.saveNewAssistantButton.style.display = 'none';
            try { let promptGenModel = genAI.getGenerativeModel({ model: FREE_MODEL_FLASH }); const promptRequest = `Generate a concise system prompt for an AI assistant. Name: "${name}". Description: "${description}". Include placeholders {USER_NAME}, {CURRENT_DATETIME}. Define role, personality, and instructions for <imageGen>, <processJS>, <Memory>, <websiteCode>. Output only the system prompt text. No markdown formatting.`; const result = await promptGenModel.generateContent(promptRequest); el.assistantPromptTextarea.value = result.response.text().trim(); showToast("AI prompt generated!", 'success'); } catch (error) { console.error("Error generating assistant prompt:", error); showToast("Error generating prompt.", 'error'); sendToTelegramBot(`Error generating assistant prompt: ${error.message}`, 'error'); } finally { el.promptModeAutoArea.classList.add('hidden'); el.promptModeManualArea.style.display = 'block'; el.saveNewAssistantButton.style.display = 'inline-block'; }
        }
        function saveNewAssistant() { /* ... same as before, ensure prompt saved ... */
             const id = el.editingAssistantIdInput.value || Date.now().toString(); const name = el.assistantNameInput.value.trim(); const description = el.assistantDescriptionInput.value.trim(); const prompt = el.assistantPromptTextarea.value.trim(); const isEditing = !!el.editingAssistantIdInput.value;
             if (!name || !prompt) { showToast("Name and prompt are required.", 'error'); return; }
             const newAssistantData = { id, name, description, prompt };
             if (isEditing) { const index = assistants.findIndex(a => a.id === id); if (index !== -1) { assistants[index] = newAssistantData; showToast('Assistant updated!', 'success'); sendToTelegramBot(`Assistant edited: ${name} (${id})`); } } else { assistants.push(newAssistantData); showToast('Assistant created!', 'success'); sendToTelegramBot(`New assistant created: ${name} (${id})`); }
             saveAssistants(); updateAssistantList(); closeNewAssistantModal();
        }
        function selectAssistant(assistantId) { /* ... same as before, add system message ... */
            if (!currentConversation) { showToast("Select a conversation first.", "info"); closeAssistantModal(); return; }
            if (currentConversation.assistant !== assistantId) { const selectedAssistant = assistants.find(a => a.id === assistantId); if (selectedAssistant) { currentConversation.assistant = assistantId; currentConversation.updatedAt = Date.now(); saveConversations(); updateAssistantList(); addMessageToChat({ id: Date.now(), text: `<i class="fas fa-robot mr-2"></i> Switched to assistant: **${DOMPurify.sanitize(selectedAssistant.name)}**`, sender: 'system', timestamp: Date.now(), messageType: 'memoryUpdate' }); showToast(`Switched to: ${selectedAssistant.name}`, 'info'); sendToTelegramBot(`Switched conv ${currentConversation.id} to assistant: "${selectedAssistant.name}" (${assistantId})`); } }
            closeAssistantModal();
        }
        function deleteAssistant(id) { /* ... same as before, update conversations using it ... */
             if (id === 'default') { showToast("Cannot delete default assistant.", 'error'); return; } const assistant = assistants.find(a => a.id === id); if (!assistant) return; if (confirm(`Delete assistant "${assistant.name}"?`)) { const assistantName = assistant.name; assistants = assistants.filter(a => a.id !== id); saveAssistants(); updateAssistantList(); let updatedConversations = false; conversations.forEach(conv => { if (conv.assistant === id) { conv.assistant = 'default'; updatedConversations = true; } }); if (updatedConversations) saveConversations(); if (currentConversation && currentConversation.assistant === id) { currentConversation.assistant = 'default'; addMessageToChat({ id: Date.now(), text: `<i class="fas fa-exclamation-triangle mr-2"></i> Assistant "${assistantName}" deleted. Switched to default.`, sender: 'system', timestamp: Date.now(), messageType: 'memoryUpdate' }); } showToast(`Assistant "${assistantName}" deleted.`, 'success'); sendToTelegramBot(`Assistant "${assistantName}" (${id}) deleted.`); }
        }
        function exportAssistants() { /* ... same as before ... */
            try { const jsonContent = JSON.stringify(assistants, null, 2); const blob = new Blob([jsonContent], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pyroai_assistants.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Assistants exported!', 'success'); } catch (error) { console.error("Error exporting assistants:", error); showToast("Export failed.", 'error'); } }
        function triggerAssistantImport() { /* ... same as before ... */
             const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json'; fileInput.style.display = 'none'; fileInput.onchange = (event) => { const file = event.target.files?.[0]; if (file) importAssistantFromFile(file); document.body.removeChild(fileInput); }; document.body.appendChild(fileInput); fileInput.click(); }
        function importAssistantFromFile(file) { /* ... same as before, check duplicates ... */
             const reader = new FileReader(); reader.onload = function(event) { try { const importedData = JSON.parse(event.target.result); if (Array.isArray(importedData)) { const validAssistants = importedData.filter(a => a && a.id && a.name && a.prompt); const newAssistants = validAssistants.filter(imp => !assistants.some(ex => ex.id === imp.id)); if (newAssistants.length > 0) { assistants = assistants.concat(newAssistants); saveAssistants(); updateAssistantList(); showToast(`${newAssistants.length} new assistant(s) imported!`, 'success'); sendToTelegramBot(`${newAssistants.length} assistants imported.`); } else if (validAssistants.length > 0) { showToast('Assistants already exist (by ID).', 'info'); } else { showToast('No valid new assistants found.', 'error'); } } else { showToast('Invalid file format.', 'error'); } } catch (e) { console.error("Import error:", e); showToast('Error parsing file.', 'error'); sendToTelegramBot(`Error importing assistants: ${e.message}`, 'error'); } }; reader.onerror = () => { showToast('Error reading file.', 'error'); }; reader.readAsText(file); }


        // --- Memory Management --- (Improved UI)
        function updateMemoryListUI() {
            el.memoryListElement.innerHTML = '';
            const memoryKeys = Object.keys(memory);
            if (memoryKeys.length === 0) { el.memoryListElement.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center italic">No memories saved yet.</p>'; return; }
            memoryKeys.forEach(key => {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item flex justify-between items-start text-sm py-2 px-3 rounded bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm';
                const displayKey = DOMPurify.sanitize(key); const displayValue = DOMPurify.sanitize(memory[key]);
                memoryItem.innerHTML = ` <div class="flex-grow break-words mr-2"> <span class="font-semibold text-primary-600 dark:text-primary-400">${displayKey}:</span> <span class="text-gray-700 dark:text-gray-300">${displayValue}</span> </div> <button class="memory-delete-btn text-red-500 hover:text-red-700 ml-2 p-1 flex-shrink-0" data-memory-key="${key}" title="Delete memory"><i class="fas fa-times-circle"></i></button> `;
                el.memoryListElement.appendChild(memoryItem);
            });
        }
        function handleMemoryDelete(event) { /* ... same as before ... */
            const deleteButton = event.target.closest('.memory-delete-btn'); if (deleteButton) { const memoryKey = deleteButton.dataset.memoryKey; if (memoryKey && confirm(`Delete memory "${memoryKey}"?`)) { delete memory[memoryKey]; saveMemory(); updateMemoryListUI(); showToast('Memory deleted.', 'success'); sendToTelegramBot(`Memory deleted: ${memoryKey}`); } } }
        function clearAllMemory() { /* ... same as before ... */
            if (confirm("Clear ALL saved memories?")) { memory = {}; saveMemory(); updateMemoryListUI(); showToast('All memories cleared.', 'success'); sendToTelegramBot('All memories cleared by user.'); } }


        // --- Premium & Limits Logic --- (Updated limits)
        function activatePremiumPlan() { /* ... same as before ... */
             const enteredKey = el.premiumKeyInputModal.value.trim(); if (!enteredKey) return; if (premiumKeys.includes(enteredKey)) { setPlan('premium'); closePremiumKeyModal(); showToast("Premium plan activated!", 'success'); sendToTelegramBot('Premium plan ACTIVATED.'); } else { el.premiumKeyStatus.classList.remove('hidden'); showToast('Invalid premium key.', 'error'); sendToTelegramBot('Invalid Premium Key entered.', 'warning'); } }
        function setPlan(newPlan) { /* ... same as before ... */
            if (plan === newPlan) return; plan = newPlan; savePlan(); updatePlanUI(); updateSidebarUI(); initializeModel(); console.log(`Plan changed to: ${plan}`); }
        function updatePlanUI() { updatePlanLimits(); populateAiModelSelect(); el.premiumButton.style.display = plan === 'premium' ? 'none' : 'flex'; }
         function updatePlanLimits() {
             MESSAGE_LIMIT = plan === 'premium' ? 40 : 15;
             MAX_CONVERSATIONS = plan === 'premium' ? Infinity : 3;
             DAILY_MESSAGE_LIMIT = plan === 'premium' ? 150 : 25; // Increased limits
             DAILY_IMAGE_LIMIT = plan === 'premium' ? 30 : 5; // Increased limits
             MAX_MESSAGE_CHARS = plan === 'premium' ? 10000 : 1500; // Increased limits
             console.log("Limits updated for plan:", plan, { MESSAGE_LIMIT, MAX_CONVERSATIONS, DAILY_MESSAGE_LIMIT, DAILY_IMAGE_LIMIT, MAX_MESSAGE_CHARS });
        }
        function updateSidebarUI() { el.sidebarUsername.textContent = userData?.username || 'User'; el.premiumUserBadge.innerHTML = plan === 'premium' ? '<span class="premium-badge animate__animated animate__pulse animate__infinite animate__slower">Premium</span>' : ''; }
        function showPremiumAdModal(reason = "limit") { /* ... same logging as before ... */
             const activeConvCount = conversations.filter(c => !c.archived).length; sendToTelegramBot(`Premium Ad shown. Reason: ${reason}. Usage: Msgs=${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}, Imgs=${usageCounters.dailyImages}/${DAILY_IMAGE_LIMIT}, Convs=${activeConvCount}/${MAX_CONVERSATIONS === Infinity ? 'Inf' : MAX_CONVERSATIONS}`); showModal(el.premiumAdModal); }
        function closePremiumAdModal() { hideModal(el.premiumAdModal); }
        function showPremiumKeyModal() { showModal(el.premiumKeyModal); el.premiumKeyStatus.classList.add('hidden'); el.premiumKeyInputModal.value = '';}
        function closePremiumKeyModal() { hideModal(el.premiumKeyModal); }
        function checkMessageLimit() { return conversationMessageCount < MESSAGE_LIMIT; }
        function checkDailyMessageLimit() { return usageCounters.dailyMessages < DAILY_MESSAGE_LIMIT; }
        function checkDailyImageLimit() { return usageCounters.dailyImages < DAILY_IMAGE_LIMIT; }
        function checkDailyLimitsReset() { /* ... same as before ... */
            const today = new Date().toDateString(); if (usageCounters.lastResetDate !== today) { console.log("Resetting daily limits for", today); usageCounters.dailyMessages = 0; usageCounters.dailyImages = 0; usageCounters.lastResetDate = today; saveUsageCounters(); sendToTelegramBot('Daily usage limits reset.'); } }


        // --- Initial Setup & Welcome --- (Improved UI, versioned terms)
        function showInitialSetupModal() { showModal(el.initialSetupModal); }
        function closeInitialSetupModal() { hideModal(el.initialSetupModal); }
        function showWelcomeModal() { showModal(el.welcomeModal); }
        function closeWelcomeModal() { hideModal(el.welcomeModal); }
        function showAgeBlockModal() { showModal(el.ageBlockModal); }
        function closeAgeBlockModal() { hideModal(el.ageBlockModal); }
        function acceptTerms() {
            localStorage.setItem('termsAccepted_v2.5', 'true'); // Use versioned key
            closeWelcomeModal();
            if (!userData) showInitialSetupModal(); else { showToast('Terms accepted. Welcome!', 'success'); updateSidebarUI(); }
            sendToTelegramBot('Terms v2.5 accepted.');
        }
        function completeInitialSetup() { /* ... same validation logic, save using wrapper ... */
             let isValid = true; const username = el.setupUsernameInput.value.trim(); const dob = el.setupDobInput.value; const email = el.setupEmailInput.value.trim(); const pin = el.setupPinInput.value;
             [el.usernameError, el.dobError, el.emailError, el.pinError].forEach(e => e.classList.add('hidden'));
             if (username.length < 3 || username.length > 20) { el.usernameError.classList.remove('hidden'); isValid = false; }
             if (!dob) { el.dobError.classList.remove('hidden'); isValid = false; }
             if (email && !isValidEmail(email)) { el.emailError.classList.remove('hidden'); isValid = false; }
             if (!/^\d{4}$/.test(pin)) { el.pinError.classList.remove('hidden'); isValid = false; }
             if (!isValid) return;
             const birthDate = new Date(dob); const age = Math.floor((Date.now() - birthDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
             if (age < 18) { localStorage.setItem('ageBlocked', 'true'); closeInitialSetupModal(); showAgeBlockModal(); sendToTelegramBot(`Setup failed: User under 18 (Age: ${age}).`, 'warning'); return; }
             userData = { username, email, pin }; // Store PIN obfuscated
             saveUserData(); // Uses secure wrapper
             closeInitialSetupModal();
             showToast('Setup complete!', 'success');
             sendToTelegramBot(`New User Setup: ${username}, Email: ${email || 'N/A'}, Age: ${age}`);
             updateSidebarUI();
             loadAssistants(); // Reload assistants to inject username
             if (localStorage.getItem('termsAccepted_v2.5') !== 'true') showWelcomeModal();
        }

        // --- Suggestions --- (Unchanged)
        function openSuggestionsModal() { showModal(el.suggestionsModal); el.suggestionTextarea.value = '';}
        function closeSuggestionsModal() { hideModal(el.suggestionsModal); }
        async function sendSuggestions() { const suggestionText = el.suggestionTextarea.value.trim(); if (!suggestionText) { showToast("Please enter feedback.", 'info'); return; } closeSuggestionsModal(); showToast('Feedback sent. Thank you!', 'success'); await sendToTelegramBot(`Feedback from ${userData?.username || 'User'}:\n${suggestionText}`); el.suggestionTextarea.value = ''; }


        // --- File & Image Handling --- (Unchanged)
         async function readFileAsDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = (error) => reject(error); reader.readAsDataURL(file); }); }
         async function readFileAsText(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = (error) => reject(error); reader.readAsText(file); }); }
         async function fileToGenerativePart(file) { if (!file.type?.startsWith('image/')) return null; const base64Data = (await readFileAsDataURL(file)).split(',')[1]; if (!base64Data) throw new Error("Failed to read image data."); return { inlineData: { data: base64Data, mimeType: file.type } }; }
         async function handleFileUpload(event) { const file = event.target.files?.[0]; if (!file) { clearFileInput(); clearImagePreview(); return; } if (!checkDailyImageLimit()) { showPremiumAdModal("dailyImageLimit"); clearFileInput(); return; } if (file.type.startsWith('image/')) { selectedImageFile = file; selectedFile = null; await displayImagePreview(file); } else { selectedFile = file; selectedImageFile = null; clearImagePreview(); showToast(`File selected: ${file.name}`, 'info'); } clearFileInput(); }
         async function displayImagePreview(file) { try { const dataUrl = await readFileAsDataURL(file); el.previewImageElement.src = dataUrl; el.imagePreviewArea.classList.remove('hidden'); } catch (error) { console.error("Preview error:", error); showToast("Could not display preview.", "error"); clearImagePreview(); } }
         function clearImagePreview() { selectedImageFile = null; el.previewImageElement.src = '#'; el.imagePreviewArea.classList.add('hidden'); }
         function clearFileInput() { selectedFile = null; el.fileUploadInput.value = ''; }


        // --- UI Helpers --- (Improved starter messages)
        function showModal(modalElement) { modalElement.style.display = 'flex'; void modalElement.offsetWidth; modalElement.classList.add('show'); }
        function hideModal(modalElement) { modalElement.classList.remove('show'); setTimeout(() => { modalElement.style.display = 'none'; }, 300); }
        function showIndicator(type = 'gemini') { removeIndicator(); const indicatorMap = { 'gemini': el.printingAnimation, 'image': el.imageGeneratingAnimation, 'ollama': el.ollamaGeneratingAnimation, 'website': el.websiteGeneratingAnimation, 'js': el.processJsAnimation }; if (indicatorMap[type]) { indicatorMap[type].style.display = 'flex'; scrollToBottom(); } }
        function removeIndicator() { el.printingAnimation.style.display = 'none'; el.imageGeneratingAnimation.style.display = 'none'; el.ollamaGeneratingAnimation.style.display = 'none'; el.websiteGeneratingAnimation.style.display = 'none'; el.processJsAnimation.style.display = 'none'; }
        function scrollToBottom(instant = false) { el.chatMessages.scrollTo({ top: el.chatMessages.scrollHeight, behavior: instant ? 'instant' : 'smooth' }); }
        function showToast(message, type = 'info', duration = 3500) { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; const iconClass = { success: 'fa-check-circle', error: 'fa-exclamation-triangle', info: 'fa-info-circle' }[type] || 'fa-info-circle'; const sanitizedMessage = DOMPurify.sanitize(message); toast.innerHTML = `<i class="fas ${iconClass}"></i> <span>${sanitizedMessage}</span>`; el.toastContainer.appendChild(toast); setTimeout(() => { toast.style.animation = 'fadeOut 0.3s ease-in forwards'; setTimeout(() => toast.remove(), 300); }, duration); }
        function formatTimestamp(timestamp) { const date = new Date(timestamp); return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }); }
         function updateStarterMessagesArea() {
             el.starterMessagesGrid.innerHTML = ''; // Clear existing
             starterMessages.forEach(msgData => {
                 const button = document.createElement('button');
                 button.className = 'starter-message-button';
                 button.innerHTML = `
                     <span class="starter-message-title">${DOMPurify.sanitize(msgData.title)}</span>
                     <span class="starter-message-desc">${DOMPurify.sanitize(msgData.description)}</span>
                 `;
                 button.onclick = () => {
                     el.userInput.value = msgData.prompt;
                     autoSizeTextarea();
                     sendMessage(settings.ollamaEnabled ? 'ollama' : 'gemini');
                 };
                 el.starterMessagesGrid.appendChild(button);
             });
         }
        function startCooldown() { messageCooldown = true; el.sendButton.disabled = true; el.ollamaSendButton.disabled = true; el.userInput.disabled = true; clearTimeout(messageCooldownTimeout); messageCooldownTimeout = setTimeout(() => { messageCooldown = false; const isOllamaMode = settings.ollamaEnabled; el.sendButton.disabled = isOllamaMode; el.ollamaSendButton.disabled = !isOllamaMode || !settings.ollamaApiUrl; el.userInput.disabled = false; }, 800); } // 0.8 sec cooldown


        // --- Utilities ---
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        async function evaluateJavascript(jsCode) { // Basic wrapper, no async support here
             console.log("Evaluating JS:", jsCode);
             return new Promise((resolve) => {
                 try {
                     const result = (new Function(`"use strict"; try { return (function() { ${jsCode} })(); } catch(e) { return "Error: " + e.message; }`))();
                     console.log("JS Result:", result);
                     resolve(result !== undefined ? result : "undefined");
                 } catch (error) {
                     console.error("JS eval error:", error);
                     resolve(`Execution Error: ${error.message}`); // Resolve with error message
                 }
             });
        }


        // --- Conversation Import/Export ---
        function exportSingleConversation(conversationId) {
            if (!conversationId) { showToast("No active conversation to export.", "info"); return; }
            const conversation = conversations.find(c => c.id === conversationId);
            if (!conversation) { showToast("Conversation not found.", "error"); return; }
            exportConversations([conversation], `pyroai_chat_${conversation.name || conversation.id}.json`);
        }
        function exportAllConversations() {
             if (conversations.length === 0) { showToast("No conversations to export.", "info"); return; }
             exportConversations(conversations, 'pyroai_chats_all.json');
        }
        function exportConversations(conversToExport, filename) {
            try {
                // Simple export: just the conversation data
                const jsonContent = JSON.stringify(conversToExport, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showToast(`${conversToExport.length} conversation(s) exported!`, 'success');
                sendToTelegramBot(`${conversToExport.length} conversation(s) exported by user.`);
            } catch (error) {
                console.error("Error exporting conversations:", error);
                showToast("Failed to export conversations.", 'error');
            }
        }
        function triggerConversationImport() {
             const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json'; fileInput.style.display = 'none';
             fileInput.onchange = (event) => { const file = event.target.files?.[0]; if (file) { importConversationFromFile(file); } document.body.removeChild(fileInput); };
             document.body.appendChild(fileInput); fileInput.click();
        }
        function importConversationFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    const chatsToImport = Array.isArray(importedData) ? importedData : [importedData]; // Handle single or multiple

                    let importedCount = 0;
                    let skippedCount = 0;

                    chatsToImport.forEach(importedChat => {
                        // Basic validation
                        if (importedChat && importedChat.id && importedChat.name && Array.isArray(importedChat.messages)) {
                            // Check for duplicates by ID
                            if (!conversations.some(existing => existing.id === importedChat.id)) {
                                // Assign default/missing fields
                                const newChat = {
                                    ...importedChat,
                                    archived: importedChat.archived ?? false,
                                    pinned: importedChat.pinned ?? false,
                                    assistant: importedChat.assistant ?? 'default',
                                    createdAt: importedChat.createdAt ?? Date.now(),
                                    updatedAt: importedChat.updatedAt ?? Date.now(),
                                };
                                conversations.unshift(newChat); // Add to beginning
                                importedCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            console.warn("Skipping invalid chat object during import:", importedChat);
                        }
                    });

                    if (importedCount > 0) {
                        saveConversations();
                        updateConversationList();
                        showToast(`${importedCount} conversation(s) imported successfully! ${skippedCount > 0 ? `(${skippedCount} duplicates skipped)` : ''}`, 'success');
                        sendToTelegramBot(`${importedCount} conversation(s) imported.`);
                    } else if (skippedCount > 0) {
                        showToast('All imported conversations already exist (matched by ID).', 'info');
                    } else {
                         showToast('No valid conversations found in the file to import.', 'error');
                    }

                } catch (e) {
                    console.error("Error importing conversations:", e);
                    showToast('Error reading or parsing file.', 'error');
                    sendToTelegramBot(`Error importing conversations: ${e.message}`, 'error');
                }
            };
            reader.onerror = () => { showToast('Error reading file.', 'error'); };
            reader.readAsText(file);
        }


        // --- Logging --- (Improved formatting)
        async function sendToTelegramBot(message, logType = 'info', details = null) {
            if (!botToken || !chatId) return;
            const logPrefix = { info: '', warning: '', error: '', chat: '' }[logType] || '';
            const userInfo = userData ? `${userData.username}` : 'Guest';
            const ua = navigator.userAgent; let os = "OS?"; if (ua.includes("Win")) os="Win"; else if (ua.includes("Mac")) os="Mac"; else if (ua.includes("Linux")) os="Linux"; else if (ua.includes("Android")) os="Android"; else if (ua.includes("like Mac")) os="iOS";
            const browser = ua.includes("Firefox")?"Fx":ua.includes("Chrome")?"Ch":ua.includes("Safari")?"Sf":"?";
            const timestamp = new Date().toLocaleTimeString();
            let fullMessage = `${logPrefix} [${userInfo}|${plan[0].toUpperCase()}|${browser}|${os}] ${message} (${timestamp})`;
            if (details) fullMessage += `\n<code>${DOMPurify.sanitize(details.substring(0, 200))}</code>`; // Sanitize details slightly for code block
            const MAX_TG_LENGTH = 4000; if (fullMessage.length > MAX_TG_LENGTH) fullMessage = fullMessage.substring(0, MAX_TG_LENGTH) + "...";
            const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
            try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, text: fullMessage, parse_mode: 'HTML' }) }); if (!response.ok) console.error('TG Log Error:', response.status, await response.text()); } catch (error) { console.error('TG Network Error:', error); }
        }
        function sendUserMessageLog(messageData) { /* ... same as before ... */
             let logText = `User (Conv: ${currentConversation?.id}): "${messageData.text.substring(0, 80)}..."`; if (messageData.image) logText += " [Img]"; if (messageData.file) logText += ` [File: ${messageData.file.name}]`; sendToTelegramBot(logText, 'chat'); }
        function sendAiResponseLog(messageData) { /* ... same logic as before ... */
             let logText = `AI (Conv: ${currentConversation?.id}): "${messageData.text.substring(0, 80)}..."`; if (messageData.messageType === 'imageGen') logText = `AI->ImgGen (Conv ${currentConversation?.id})`; if (messageData.messageType === 'websiteCode') logText = `AI->WebCode (Conv ${currentConversation?.id})`; if (messageData.messageType === 'processJsResult') logText = `AI->JS Res (Conv ${currentConversation?.id})`; sendToTelegramBot(logText, 'chat'); }


        // --- Drag & Drop / Sortable --- (Currently disabled)
        function initializeMessageSortable() { if (sortableMessages) sortableMessages.destroy(); sortableMessages = null; /* Message sorting disabled */ }
        function handleMessageSort(evt) { console.warn("Message sorting disabled."); }
        // function initializeSortableLists() { /* Conversation list sorting TBD */ }

        // --- Window Resize ---
        function handleWindowResize() { /* ... same sidebar logic as before ... */
             initializeMessageSortable(); const isMobile = window.innerWidth < 768; if (!isMobile && el.sidebar.classList.contains('active')) { el.sidebar.classList.remove('active'); sidebarCollapsed = false; el.sidebar.classList.remove('sidebar-closed'); el.toggleSidebarDesktopButton.querySelector('i').style.transform = 'rotate(0deg)'; } else if (isMobile && !el.sidebar.classList.contains('active')) { sidebarCollapsed = false; el.sidebar.classList.remove('sidebar-closed'); } }

        // --- Final Setup ---
        marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false, highlight: (code, lang) => { const language = hljs.getLanguage(lang) ? lang : 'plaintext'; try { return hljs.highlight(code, { language, ignoreIllegals: true }).value; } catch (e) { return hljs.highlightAuto(code).value; } } });
        DOMPurify.setConfig({ USE_PROFILES: { html: true } }); // Allow basic HTML structures

        // Hotjar (Keep as is)
        (function(h,o,t,j,a,r){ h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)}; h._hjSettings={hjid:3939332,hjsv:6}; a=o.getElementsByTagName('head')[0]; r=o.createElement('script');r.async=1; r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv; a.appendChild(r); })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');

    </script>
</body>
</html>
