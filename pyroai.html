














































<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyroAI - Advanced AI Chat Platform</title>
    <meta name="description" content="PyroAI - Advanced AI chat platform by PyroLLC. Experience intelligent conversations with our state-of-the-art AI technology.">
    <meta name="keywords" content="PyroAI, PyroLLC, PyroALW, AI chat, artificial intelligence, chatbot, machine learning, intelligent assistant, PyroAI platform, advanced AI">
    <meta name="author" content="PyroLLC">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="PyroAI - Advanced AI Chat Platform">
    <meta property="og:description" content="Experience the next generation of AI chat with PyroAI. Powered by PyroLLC's cutting-edge technology.">
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/134533935?v=4">
    <meta property="og:url" content="https://pyrollc.com.tr">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PyroAI - Advanced AI Chat Platform">
    <meta name="twitter:description" content="Experience the next generation of AI chat with PyroAI. Powered by PyroLLC's cutting-edge technology.">
    <link rel="canonical" href="https://pyrollc.com.tr">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/monokai-sublime.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #7C3AED;
            --primary-color-hover: #9753FF;
            --secondary-color: #2DD4CF;
            --background-color: #F8FAFC;
            --text-color: #0F172A;
            --light-gray: #E2E8F0;
            --medium-gray: #CBD5E0;
            --dark-gray: #64748B;
            --darker-gray: #334155;
            --code-bg: #EDF2F7;
            --shadow-light: rgba(0, 0, 0, 0.07);
            --accent-color: #FBBF24;

            /* Light theme colors */
            --background-light: var(--background-color);
            --text-light: var(--text-color);
            --sidebar-light: #FFFFFF;
            --message-user-light: var(--primary-color);
            --message-ai-light: #FFFFFF;
            --message-user-text-light: white;
            --message-ai-text-light: var(--text-color);
            --pinned-background-light: #FFFCEB;
            --pinned-border-light: #FBBF24;


            /* Dark Theme Colors */
            --background-dark: #181825;
            --text-dark: #E0E7E8;
            --sidebar-dark: #272738;
            --message-user-dark: #7C3AED;
            --message-ai-dark: #3B3B4F;
            --message-user-text-dark: white;
            --message-ai-text-dark: var(--text-dark);
            --code-bg-dark: #2D2D3A;
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --pinned-background-dark: #4338CA;
            --pinned-border-dark: #D4D0AB;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px var(--shadow-light);
            margin: 1rem;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: var(--sidebar-light);
            border-right: 1px solid var(--medium-gray);
            overflow-y: auto;
            transition: width 0.4s ease, transform 0.4s ease;
            z-index: 20;
            box-shadow: 3px 0 8px var(--shadow-light);
            display: flex;
            flex-direction: column;
        }

        .sidebar-closed {
            transform: translateX(-100%);
            width: 0;
        }

        .sidebar-header {
            padding: 1.75rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-logo-area {
            display: flex;
            align-items: center;
        }

        .sidebar-title {
             font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            letter-spacing: -0.025em;
            margin-left: 0.5rem;
        }


        .sidebar-content {
            padding: 1.25rem 1.75rem;
            flex-grow: 1;
        }
        .sidebar-footer {
            padding: 1.25rem 1.75rem;
            border-top: 1px solid var(--medium-gray);
            text-align: center;
            margin-top: auto;
        }


        .conversation-list {
            padding-top: 0.5rem;
        }

        .conversation-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: scale(1);
        }

        .conversation-item:hover {
            background-color: var(--light-gray);
            transform: scale(1.03);
        }

        .conversation-item.active {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.03);
        }
        .conversation-item.active:hover {
            background-color: var(--primary-color-hover);
            color: white;
        }
        .conversation-item.active .text-gray-700, .conversation-item.active:hover .text-gray-700{
            color: white;
        }

        .conversation-title {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 0.5rem;
        }

        .conversation-actions {
            display: flex;
            gap: 0.3rem;
        }

        .conversation-actions button {
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, color 0.3s ease;
            border-radius: 0.3rem;
        }
        .conversation-actions button:hover {
            opacity: 1;
            background-color: var(--light-gray);
            color: var(--primary-color);
        }
        .conversation-item.active .conversation-actions button,  .conversation-item.active:hover .conversation-actions button{
            color: white;
            opacity: 1;
        }
        .conversation-item.active .conversation-actions button:hover, .conversation-item.active:hover .conversation-actions button:hover {
            color: var(--light-gray);
        }
        .conversation-actions-mobile-dropdown {
            position: relative;
        }

        .conversation-actions-mobile-button {
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease, color 0.3s ease;
            border-radius: 0.3rem;
        }

        .conversation-actions-mobile-button:hover {
            opacity: 1;
            background-color: var(--light-gray);
            color: var(--primary-color);
        }

        .conversation-actions-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--sidebar-light);
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.5rem;
            padding: 0.5rem 0;
            margin-top: 0.2rem;
        }

        .conversation-actions-dropdown-content.show {
            display: block;
        }

        .conversation-actions-dropdown-content button {
            display: block;
            width: 100%;
            padding: 0.6rem 1rem;
            text-align: left;
            clear: both;
            white-space: nowrap;
        }
        .conversation-actions-dropdown-content button:hover {
             background-color: var(--light-gray);
        }


        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background-color);
        }

        .chat-header {
            padding: 1.75rem;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.025em;
        }

        .chat-messages-container {
            flex-grow: 1;
            padding: 1.75rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            scrollbar-gutter: stable;
             padding-bottom: 6rem; /* Space for input area */
        }

        .message-wrapper {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .message {
            padding: 0.9rem 1.4rem;
            border-radius: 1.25rem;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light);
            animation: fadeInUp 0.5s ease-out;
            position: relative;
            transition: box-shadow 0.3s ease;
             user-select: text; /* Make message text selectable */
            -webkit-user-select: text; /* Safari */
            -ms-user-select: text; /* IE 10+ and Edge */
        }
        .message:hover {
            box-shadow: 0 5px 10px 0 var(--shadow-light), 0 2px 5px 0 var(--shadow-light);
        }

        .message.user-message {
            background-color: var(--message-user-light);
            color: var(--message-user-text-light);
            margin-left: auto;
            border-top-right-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            border-bottom-left-radius: 1.25rem;
        }

        .message.ai-message {
            background-color: var(--message-ai-light);
            color: var(--message-ai-text-light);
            margin-right: auto;
            border-top-left-radius: 1.5rem;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.25rem;
        }
        .message.image-gen-message {
            background-color: var(--message-ai-light);
            color: var(--message-ai-text-light);
            margin-right: auto;
            border-top-left-radius: 1.5rem;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.25rem;
            text-align: center;
        }
        .message-content {
            @apply markdown-body;
        }
        .message-content > *:first-child {
            margin-top: 0;
        }
        .message-content > *:last-child {
            margin-bottom: 0;
        }


        .message-file {
            display: block;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: var(--code-bg);
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.3s ease;
            border: 1px solid var(--medium-gray);
        }
        .message-file:hover {
            background-color: var(--light-gray);
        }


        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
        }
        .message-time {
            font-size: 0.8rem;
            color: var(--dark-gray);
            margin-top: 0.25rem;
            align-self: flex-end;
        }
        .message.user-message + .message-time {
            color: white;
        }
        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
            gap: 0.4rem;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .message-action-button {
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            opacity: 0.7;
            padding: 0.3rem;
            border-radius: 0.3rem;
            transition: opacity 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        .message-action-button:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.05);
            color: var(--primary-color);
        }
        /* Context Menu Styles */
        #message-context-menu {
            position: fixed;
            z-index: 55;
            background-color: var(--sidebar-light);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 0.5rem 0;
            min-width: 160px;
            display: none; /* Hidden by default */
        }

        #message-context-menu button {
            display: block;
            width: 100%;
            padding: 0.6rem 1.2rem;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-color);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        #message-context-menu button:hover {
            background-color: var(--light-gray);
        }


        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-indicator, #printing-animation, #image-generating-animation {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0.9rem 1.4rem;
            border-radius: 1.25rem;
            background-color: var(--message-ai-light);
            color: var(--message-ai-text-light);
            max-width: 85%;
            margin-right: auto;
            box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light);
            animation: pulse-shadow 1.5s infinite;
        }

        @keyframes pulse-shadow {
            0% { box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light); }
            50% { box-shadow: 0 4px 9px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light); }
            100% { box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light); }
        }


        .typing-indicator span, #printing-animation .printing-dot, #image-generating-animation .generating-dot {
            display: inline-block;
            margin-left: 6px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--dark-gray);
            opacity: 0.7;
        }
        .typing-indicator span {
            animation: typingDots 1.5s infinite;
        }

        #printing-animation .printing-dot {
            animation: printing 1.3s infinite;
            margin-right: 5px;
        }
        #image-generating-animation .generating-dot {
            animation: printing 1.3s infinite;
            margin-right: 5px;
        }


        .typing-indicator span:nth-child(2), #printing-animation .printing-dot:nth-child(2), #image-generating-animation .generating-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3), #printing-animation .printing-dot:nth-child(3), #image-generating-animation .generating-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDots {
            0%, 60%, 100% { opacity: 0.7; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-6px); }
        }

        @keyframes printing {
            0% { opacity: 0.4; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-3px); }
            40% { opacity: 0.4; transform: translateY(0); }
            100% { opacity: 0.4; transform: translateY(0); }
        }


        .chat-input-area {
            padding: 1.75rem;
            background-color: #fff;
            border-top: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 -3px 8px var(--shadow-light);
            position: sticky;
            bottom: 0;
            z-index: 30;
        }
        .chat-input-area.conversation-empty {
            flex-direction: column;
            align-items: stretch;
        }
        #starter-messages-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .starter-message-button {
            padding: 0.6rem 0.9rem;
            border-radius: 0.5rem;
            background-color: var(--light-gray);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 1px 3px 0 var(--shadow-light);
            text-align: center;
        }
        .starter-message-button:hover {
            background-color: var(--medium-gray);
            transform: scale(1.02);
        }


        .image-preview-area {
            margin-bottom: 0.75rem;
            position: relative;
            display: inline-block;
        }

        .image-preview {
            max-height: 70px;
            border-radius: 0.5rem;
            margin-right: 0.75rem;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2), 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            color: var(--dark-gray);
            font-size: 0.9rem;
            line-height: 0;
            text-align: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .remove-image-btn:hover {
            background-color: var(--light-gray);
            transform: scale(1.1);
        }

        /* New Conversation Button Styles */
        #new-conversation {
            margin: 1rem 0;
            padding: 0.8rem 1.2rem;
            border-radius: 0.5rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        #premium-button {
            margin: 0.5rem 0;
            padding: 0.8rem 1.2rem;
            border-radius: 0.5rem;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            #new-conversation, #premium-button {
                margin: 0.8rem 0;
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
            }

            #new-conversation i, #premium-button i {
                font-size: 0.9rem;
            }

            .sidebar-content {
                padding: 1rem;
            }
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.9rem 1.4rem;
            border: 1px solid var(--medium-gray);
            border-radius: 0.75rem;
            font-size: 1.05rem;
            line-height: 1.5rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.4), 0 2px 4px 0 var(--shadow-light);
        }

        .send-button, .attach-button {
            padding: 0.9rem 1.6rem;
            border-radius: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
        }

        .send-button:hover,  .attach-button:hover{
            background-color: var(--primary-color-hover);
            transform: scale(1.05);
            box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light);
        }
        .send-button:active, .attach-button:active {
            transform: scale(0.97);
        }

        .attach-button {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            font-weight: 500;
        }
        .attach-button:hover {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }


        /* Enhanced Mobile Styles */
        @media (max-width: 768px) {
            /* Core Layout */
            .app-container {
                width: 100vw;
                max-width: 100%;
                overflow-x: hidden;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            .chat-area {
                width: 100%;
                max-width: 100vw;
            }

            /* Sidebar Optimizations */
            .sidebar {
                width: 260px;
                transform: translateX(-100%);
                position: fixed;
                height: 100vh;
                z-index: 50;
                transition: transform 0.3s ease;
                box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            }
            #mobile-sidebar-toggle {
                display: block;
            }
            .sidebar.active {
                transform: translateX(0);
            }
             .sidebar-header {
                padding: 1.2rem;
            }
            .sidebar-content {
                padding: 1rem;
            }
            .sidebar-footer {
                padding: 1rem;
            }
            .sidebar-title {
                font-size: 1.3rem;
            }


            /* Header Styles */
            .chat-header {
                padding: 0.8rem;
                height: 60px;
            }

            .chat-title {
                font-size: 1.1rem;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Message Area */
            .chat-messages-container {
                padding: 0.8rem;
                padding-bottom: 80px;
            }

            .message {
                max-width: 95%;
                padding: 0.7rem 1rem;
                margin: 0.4rem 0;
                font-size: 0.95rem;
            }
             .message:hover .message-actions {
                display: none !important;
            }


            .message.user-message {
                margin-left: auto;
                margin-right: 0.3rem;
            }

            .message.ai-message {
                margin-right: auto;
                margin-left: 0.3rem;
            }
            .message.image-gen-message {
                margin-right: auto;
                margin-left: 0.3rem;
            }

            /* Input Area */
            .chat-input-area {
                padding: 0.8rem;
                gap: 0.5rem;
                position: fixed;
                bottom: 0;
                width: 100%;
                background: var(--background-light);
                z-index: 40;
                box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            }
            .chat-input-area.conversation-empty {
                flex-direction: column;
            }


            .chat-input {
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
                height: 40px;
            }

            .send-button, .attach-button {
                padding: 0.6rem;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Modal Optimizations */
            .modal-content {
                width: 90%;
                padding: 1.2rem;
                margin: 1rem;
            }

            .modal-header {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
            }

            /* Assistant Cards */
            .assistant-card {
                padding: 0.8rem;
                margin-bottom: 0.8rem;
            }

            /* Image Preview */
            .image-preview-area {
                position: absolute;
                bottom: 100%;
                left: 0;
                padding: 0.5rem;
                width: 100%;
                background: var(--background-light);
            }

            .image-preview {
                max-height: 60px;
            }

            /* Typing Indicator */
            .typing-indicator, #printing-animation, #image-generating-animation {
                max-width: 95%;
                margin: 0.4rem 0.3rem;
                padding: 0.7rem 1rem;
            }

            /* Navigation Elements */
            #mobile-sidebar-toggle {
                padding: 0.5rem;
                margin-right: 0.5rem;
            }

            /* Action Buttons */
            .conversation-actions button {
                padding: 0.4rem;
                margin: 0 0.2rem;
            }

            /* Search Input */
            #search-conversations {
                height: 36px;
                font-size: 0.9rem;
            }

            /* Dark Mode Adjustments */
            body.dark .chat-input-area {
                background: var(--background-dark);
            }

            body.dark .image-preview-area {
                background: var(--background-dark);
            }
        }

        /* Additional Touch Optimizations */
        @media (hover: none) {
            .message, .send-button, .attach-button, .modal-btn {
                -webkit-tap-highlight-color: transparent;
            }

            .conversation-item {
                padding: 0.8rem;
                margin: 0.4rem 0;
            }

            .conversation-actions button {
                min-height: 36px;
                min-width: 36px;
            }
        }


        /* Highlight.js Theme Adjustments */
        .hljs {
            background: var(--code-bg);
            color: var(--text-color);
            border-radius: 0.6rem;
            padding: 1.2rem;
            overflow-x: auto;
            tab-size: 4;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        /* Copy Code Button */
        .copy-code-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 0.4rem 0.7rem;
            border-radius: 0.3rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 0.95rem;
        }
        .message:hover .copy-code-button, .hljs:hover + .copy-code-button {
            opacity: 1;
        }


        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            backdrop-filter: blur(7px);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--sidebar-light);
            border-radius: 0.8rem;
            padding: 2.25rem;
            max-width: 600px;
            width: 95%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.45);
            transform: translateY(-40px);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
            overflow-y: auto;
            max-height: 90vh;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.75rem;
            color: var(--text-color);
            text-align: center;
            letter-spacing: -0.025em;
        }

        .modal-body {
            margin-bottom: 2rem;
            color: var(--text-color);
        }

        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
        }

        .modal-btn {
            padding: 0.9rem 1.6rem;
            border-radius: 0.6rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
        }
        .modal-btn:hover {
            transform: scale(1.04);
            box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light);
        }
        .modal-btn:active {
            transform: scale(0.97);
        }

        .modal-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: var(--primary-color-hover);
        }

        .modal-btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-color);
            font-weight: 500;
        }

        .modal-btn-secondary:hover {
            background-color: var(--medium-gray);
        }

        /* Dark Mode Styles */
        body.dark {
            --background-color: #181825;
            --text-color: #E0E7E8;
            --light-gray: #4A5568;
            --medium-gray: #6B7280;
            --dark-gray: #D1D5DB;
            --darker-gray: #E5E7E8;
            --code-bg: #2D2D3A;
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --shadow-light:  rgba(0, 0, 0, 0.4);

            --sidebar-light: #272738;
            --message-user-light: #7C3AED;
            --message-ai-light: #3B3B4F;
            --message-user-text-light: var(--message-user-text-dark);
            --message-ai-text-light: var(--message-ai-text-dark);
            --pinned-background-dark: #4338CA;
            --pinned-border-dark: #D4D0AB;
        }
        body.dark .app-container {
            box-shadow: 0 5px 15px var(--shadow-dark);
        }

        body.dark .sidebar {
            border-right-color: var(--medium-gray);
            box-shadow: 3px 0 10px var(--shadow-dark);
        }
        body.dark .chat-header {
            border-bottom-color: var(--medium-gray);
        }
        body.dark .chat-input-area {
            background-color: var(--sidebar-dark);
            border-top-color: var(--medium-gray);
            box-shadow: 0 -3px 10px var(--shadow-dark);
        }
        body.dark .chat-input {
            background-color: var(--sidebar-dark);
            color: var(--text-dark);
            border-color: var(--medium-gray);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        body.dark .chat-input:focus {
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.7), 0 2px 5px 0 var(--shadow-dark);
        }
        body.dark .conversation-item:hover, body.dark .conversation-item.active:hover {
            background-color: #4A5568;
        }
        body.dark .modal-content {
            background-color: var(--sidebar-dark);
            color: var(--text-dark);
            box-shadow: 0 8px 30px var(--shadow-dark);
        }
        body.dark .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        body.dark .search-input {
            background-color: var(--sidebar-dark);
            color: var(--text-dark);
            border-color: var(--medium-gray);
        }
        body.dark .conversation-item:hover{
            background-color: var(--darker-gray);
        }
        body.dark .markdown-body blockquote{
            color: #d1d5db;
        }
        body.dark .hljs {
            background: var(--code-bg-dark);
            color: var(--text-dark);
        }
        body.dark .conversation-list, body.dark .archived-list {
            scrollbar-color: var(--medium-gray) transparent;
            scrollbar-width: thin;
        }

        body.dark .conversation-list::-webkit-scrollbar,  body.dark .archived-list::-webkit-scrollbar{
            width: 8px;
        }

        body.dark  .conversation-list::-webkit-scrollbar-track, body.dark .archived-list::-webkit-scrollbar-track {
            background: transparent;
        }

        body.dark .conversation-list::-webkit-scrollbar-thumb, body.dark .archived-list::-webkit-scrollbar-thumb {
            background-color: var(--medium-gray);
            border-radius: 5px;
        }
        body.dark .conversation-list::-webkit-scrollbar-thumb:hover, body.dark .archived-list::-webkit-scrollbar-thumb:hover {
            background-color: var(--dark-gray);
        }


        /* Scrollbar Customization */
        .conversation-list, .archived-list, .chat-messages-container, .sidebar{
            scrollbar-color: var(--medium-gray) transparent;
            scrollbar-width: thin;
            overflow-y: auto;
        }

        .conversation-list::-webkit-scrollbar, .archived-list::-webkit-scrollbar, .chat-messages-container::-webkit-scrollbar, .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .conversation-list::-webkit-scrollbar-track,  .archived-list::-webkit-scrollbar-track, .chat-messages-container::-webkit-scrollbar-track, .sidebar::-webkit-scrollbar-track{
            background: transparent;
        }

        .conversation-list::-webkit-scrollbar-thumb, .archived-list::-webkit-scrollbar-thumb, .chat-messages-container::-webkit-scrollbar-thumb, .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--medium-gray);
            border-radius: 5px;
        }

        .conversation-list::-webkit-scrollbar-thumb:hover, .archived-list::-webkit-scrollbar-thumb:hover, .chat-messages-container::-webkit-scrollbar-thumb:hover, .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: var(--dark-gray);
        }
        /* Pinned Conversation Style */
        .pinned-conversation {
            background-color: var(--pinned-background-light);
            border-left: 5px solid var(--pinned-border-light);
        }
        body.dark .pinned-conversation {
            background-color: var(--pinned-background-dark);
            border-left-color: var(--pinned-border-dark);
            color: var(--text-dark);
        }
        body.dark .pinned-conversation:hover {
            background-color: #524BDB;
        }
        .pinned-conversation:hover {
            background-color: #FFF2C8;
        }
        .pinned-conversation.active {
            background-color: var(--primary-color);
            color: white;
        }
        .pinned-conversation.active:hover {
            background-color: var(--primary-color-hover);
            color: white;
        }
        .pinned-conversation.active .text-gray-700,  .pinned-conversation.active:hover .text-gray-700{
            color: white;
        }
        .pinned-conversation .conversation-actions button, .pinned-conversation.active .conversation-actions button, .pinned-conversation:hover .conversation-actions button, .pinned-conversation.active:hover .conversation-actions button {
            color: var(--dark-gray);
        }
        .pinned-conversation.active .conversation-actions button, .pinned-conversation.active:hover .conversation-actions button {
            color: white;
        }
        .pinned-conversation:hover .conversation-actions button {
            color: var(--primary-color);
        }
        .tag {
            display: none; /* Hide tags visually */
        }
        .premium-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            margin-left: 0.5rem;
            vertical-align: middle;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            opacity: 0.8;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        /* Memory Update Message Style */
        .memory-update-message {
            background-color: var(--pinned-background-light); /* Açık tema için arka plan rengi */
            color: var(--accent-color); /* Vurgu rengiyle metin rengi */
            border: 1px solid var(--pinned-border-light); /* Kenarlık rengi */
            padding: 0.7rem 1.2rem;
            border-radius: 0.75rem;
            margin: 0.5rem auto; /* Ortalamak için otomatik kenar boşlukları */
            max-width: 80%; /* Maksimum genişlik */
            font-size: 0.95rem;
            text-align: center;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
            animation: fadeIn 0.4s ease-out;
        }
        body.dark .memory-update-message {
            background-color: var(--pinned-background-dark); /* Koyu tema için arka plan rengi */
            border-color: var(--pinned-border-dark); /* Koyu tema için kenarlık rengi */
            color: var(--pinned-border-dark); /* Koyu tema için metin rengi */
            box-shadow: 0 2px 4px 0 var(--shadow-dark);
        }
        /* Improved Hover Effects and Transitions */
        .conversation-item:hover, .send-button:hover, .attach-button:hover, .modal-btn:hover, .conversation-actions button:hover, #new-conversation:hover, .message-action-button:hover, #premium-button:hover {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.3s ease;
        }
        .send-button, .attach-button, .modal-btn, #new-conversation, .conversation-actions button, .conversation-item, .message-action-button, #premium-button {
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .conversation-actions button:hover {
            transform: scale(1.1);
        }
        .send-button:hover, .attach-button:hover, .modal-btn:hover, #new-conversation:hover, #premium-button:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light);
        }
        .conversation-item:hover {
            box-shadow: 0 2px 4px 0 var(--shadow-light), 0 1px 2px 0 var(--shadow-light);
        }
        .conversation-item.active, .pinned-conversation.active {
            box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light);
        }

        /* Enhanced Setup Modal Styles */
        #initial-setup-modal .modal-content {
            max-width: 500px;
            padding: 2rem;
        }

        #initial-setup-modal .modal-header {
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }

        #initial-setup-modal .modal-body .mb-4 {
            margin-bottom: 1rem;
        }

        #initial-setup-modal .modal-body label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        #initial-setup-modal .modal-body input[type="text"],
        #initial-setup-modal .modal-body input[type="date"],
        #initial-setup-modal .modal-body input[type="email"],
        #initial-setup-modal .modal-body input[type="password"] {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--medium-gray);
            box-shadow: none;
            font-size: 1rem;
        }

        #initial-setup-modal .modal-body input[type="text"]:focus,
        #initial-setup-modal .modal-body input[type="date"]:focus,
        #initial-setup-modal .modal-body input[type="email"]:focus,
        #initial-setup-modal .modal-body input[type="password"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }

        #initial-setup-modal .modal-footer {
            margin-top: 1.5rem;
        }

        /* Welcome Modal Enhancements */
        #welcome-modal .modal-content {
            padding: 2.5rem;
        }

        #welcome-modal .modal-header {
            font-size: 2.2rem;
            margin-bottom: 2rem;
            text-shadow: 0 1px 1px var(--shadow-light);
        }

        #welcome-modal .modal-body p,
        #welcome-modal .modal-body ul {
            font-size: 1.05rem;
            color: var(--darker-gray);
        }

        #welcome-modal .modal-body li {
            margin-bottom: 0.4rem;
        }

        #welcome-modal .modal-footer {
            margin-top: 2rem;
        }

        /* Enhanced Input Validation Styles */
        input:invalid, textarea:invalid {
            border-color: #EF4444; /* Red border for invalid inputs */
            box-shadow: 0 0 0 1px #EF4444; /* Red shadow */
        }

        input:focus:invalid, textarea:focus:invalid {
            border-color: #EF4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); /* More pronounced red shadow on focus */
        }
        .error-message {
            color: #EF4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block; /* Ensure it takes full width */
        }
        .hidden {
            display: none !important;
        }
         .animate-pulse-fast {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

    </style>
</head>
<body class="bg-gray-50">

    <!-- Message Context Menu -->
    <div id="message-context-menu" class="animate__animated animate__faster" style="display:none;">
        <button id="edit-context-button"><i class="fas fa-edit mr-2"></i> Edit</button>
        <button id="copy-context-button"><i class="fas fa-copy mr-2"></i> Copy</button>
        <button id="delete-context-button"><i class="fas fa-trash mr-2"></i> Delete</button>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay show" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn animate__faster">
            <h2 class="modal-header"><i class="fas fa-magic mr-2 text-primary-400"></i> Welcome to <span class="font-extrabold">PyroAI</span>!</h2>
            <div class="modal-body">
                <p class="text-gray-700 mb-4 animate__animated animate__fadeIn animate__delay-0.2s">
                    Experience the magic of intelligent conversations with PyroAI, a cutting-edge AI chat platform powered by PyroLLC. Before you dive in, please acknowledge the following terms for using this preview version:
                </p>
                <ul class="list-disc list-inside text-gray-700 mb-4 animate__animated animate__fadeIn animate__delay-0.3s">
                    <li><span class="font-semibold">Beta Program:</span> PyroAI is currently in beta. Expect occasional bugs or unexpected behavior. Your feedback is invaluable in helping us improve!</li>
                    <li><span class="font-semibold">Conversation Logging:</span> To enhance and refine our AI models, conversations may be logged and reviewed. This data helps us ensure quality and improve performance.</li>
                    <li><span class="font-semibold">Data Sensitivity:</span> Please refrain from sharing any sensitive or personal information within your conversations. PyroLLC is not responsible for data shared by users during the beta phase.</li>
                    <li><span class="font-semibold">Service "As Is":</span> PyroAI is provided "as is" without warranties of any kind, either express or implied. We strive for excellence but cannot guarantee uninterrupted or error-free service.</li>
                    <li><span class="font-semibold">Terms of Use:</span> By proceeding to use PyroAI, you signify your understanding and agreement to these terms. If you do not agree with any part of these terms, please do not use the platform.</li>
                </ul>
                <p class="text-gray-700 mb-4 animate__animated animate__fadeIn animate__delay-0.4s">
                    We're excited to have you explore the capabilities of PyroAI. Thank you for being part of our beta community!
                </p>
            </div>
            <div class="modal-footer animate__animated animate__slideInUp animate__delay-0.5s">
                <button id="accept-terms" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-check-circle mr-2"></i> I Accept & Enter PyroAI
                </button>
            </div>
        </div>
    </div>

    <!-- Initial Setup Modal -->
    <div id="initial-setup-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-user-cog mr-2 text-primary-400"></i> Initial Setup</h2>
            <div class="modal-body">
                <p class="text-gray-700 mb-4">Welcome to PyroAI! Please complete the initial setup to personalize your experience.</p>
                <div class="mb-4">
                    <label for="setup-username" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-user mr-2"></i>Username</label>
                    <input type="text" id="setup-username" class="mt-1 block w-full" placeholder="Choose a username" required minlength="3" maxlength="20">
                    <p id="username-error" class="error-message hidden">Username must be between 3 and 20 characters.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-dob" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-calendar-alt mr-2"></i>Date of Birth</label>
                    <input type="date" id="setup-dob" class="mt-1 block w-full" required>
                    <p id="dob-error" class="error-message hidden">Please select your date of birth.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-email" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-envelope mr-2"></i>Email Address (Optional)</label>
                    <input type="email" id="setup-email" class="mt-1 block w-full" placeholder="Your email address">
                    <p class="text-gray-500 text-xs mt-1">Optional but helps in account recovery.</p>
                    <p id="email-error" class="error-message hidden">Invalid email format.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-pin" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-lock mr-2"></i>Create PIN</label>
                    <input type="password" id="setup-pin" class="mt-1 block w-full" placeholder="4-digit PIN for security" required pattern="[0-9]{4}">
                    <p id="pin-error" class="error-message hidden">PIN must be 4 digits.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="complete-setup" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-check-circle mr-2"></i> Complete Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Age Block Modal -->
    <div id="age-block-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-ban mr-2 text-red-500"></i> Access Denied</h2>
            <div class="modal-body">
                <p class="text-gray-700 mb-4">
                    You must be 18 years or older to use PyroAI. We apologize, but access is restricted for users under this age.
                </p>
            </div>
            <div class="modal-footer">
                <button id="close-age-block" class="modal-btn modal-btn-secondary w-full">
                    <i class="fas fa-times-circle mr-2"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Key Modal -->
    <div id="premium-key-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-crown mr-2 text-yellow-500"></i> Activate Premium</h2>
            <div class="modal-body">
                <p class="text-gray-700 mb-4">
                    Unlock premium features by entering your Premium Key.
                </p>
                <div class="mb-4">
                    <label for="premium-key-input" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-key mr-2"></i> <span>Premium Key</span></label>
                    <input type="text" id="premium-key-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="Enter your premium key">
                </div>
                <div id="premium-key-status" class="text-red-500 text-sm mt-2 hidden animate__animated animate__fadeIn"><i class="fas fa-exclamation-triangle mr-1"></i> Invalid key. Please try again.</div>
            </div>
            <div class="modal-footer">
                <button id="cancel-premium-key" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="activate-premium" class="modal-btn modal-btn-primary"><i class="fas fa-lock-open mr-2"></i> Activate Premium</button>
            </div>
        </div>
    </div>

    <!-- Premium Ad Modal -->
    <div id="premium-ad-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-gift mr-2 text-yellow-500"></i> PyroAI Premium - Unlock More!</h2>
            <div class="modal-body">
                <p class="text-gray-700 mb-4">
                    Enhance your PyroAI experience and remove limitations by upgrading to Premium!
                </p>
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-3 py-2 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Feature
                                </th>
                                <th class="px-3 py-2 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Free
                                </th>
                                <th class="px-3 py-2 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Premium
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    Messages per Chat
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    15
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm font-semibold text-primary-500">
                                    40
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    Max Conversations
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    3
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm font-semibold text-primary-500">
                                    Unlimited
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    Daily Messages
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    10
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm font-semibold text-primary-500">
                                    100
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    Daily Images
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    3
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm font-semibold text-primary-500">
                                    20
                                </td>
                            </tr>
                             <tr>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    Message Characters
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm">
                                    1,000
                                </td>
                                <td class="px-3 py-3 border-b border-gray-200 bg-white text-sm font-semibold text-primary-500">
                                    10,000
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 bg-white text-sm">
                                    AI Models
                                </td>
                                <td class="px-3 py-3 bg-white text-sm">
                                    Fast
                                </td>
                                <td class="px-3 py-3 bg-white text-sm font-semibold text-primary-500">
                                    Fast, Pro, Max
                                </td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 bg-white text-sm">
                                    Image Generation
                                </td>
                                <td class="px-3 py-3 bg-white text-sm">
                                    <i class="fas fa-times text-red-500"></i>
                                </td>
                                <td class="px-3 py-3 bg-white text-sm font-semibold text-primary-500">
                                    <i class="fas fa-check text-green-500"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-gray-700 text-sm">
                    Upgrade now for an enhanced AI experience with more messages, conversations, advanced models, and image generation!
                </p>
            </div>
            <div class="modal-footer">
                <button id="go-premium-ad" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-crown mr-2"></i> Go Premium
                </button>
                <button id="close-premium-ad" class="modal-btn modal-btn-secondary w-full">
                    <i class="fas fa-times-circle mr-2"></i> Continue with Free
                </button>
            </div>
        </div>
    </div>


    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo-area">
                    <h1 class="sidebar-title animate__animated animate__fadeInLeft animate__faster"><i class="fas fa-fire text-primary-500 mr-2"></i> PyroAI</h1>
                </div>
                <button id="toggle-sidebar" class="md:hidden text-gray-600 hover:text-gray-800 transition-colors duration-200" aria-label="Close Sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="animate__animated animate__fadeInLeft animate__fast">
                    <h2 class="text-md font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-thumbtack text-gray-500 mr-3"></i> <span>Pinned</span></h2>
                    <ul id="pinned-list" class="conversation-list mb-4"></ul>
                </div>

                <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.1s">
                    <h2 class="text-md font-semibold text-gray-700 mb-2 flex items-center"><i class="fas fa-comments text-gray-500 mr-3"></i> <span>Conversations</span></h2>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-500"></i>
                        </div>
                        <input type="text" id="search-conversations" class="search-input chat-input mb-3 pl-10" placeholder="Search conversations...">
                    </div>
                    <ul id="conversation-list" class="conversation-list"></ul>
                </div>

                <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.2s">
                    <h2  class="text-md font-semibold text-gray-700 mb-2 mt-3 flex items-center"><i class="fas fa-folder text-gray-500 mr-3"></i> <span>Archived</span></h2>
                    <ul id="archived-list" class="archived-list"></ul>
                </div>
            </div>
            <div class="sidebar-footer animate__animated animate__fadeInLeft animate__fast animate__delay-0.3s">
                <div class="user-profile mb-3 flex items-center justify-center">
                     <i class="fas fa-user-circle text-gray-500 mr-2"></i>
                    <span id="sidebar-username" class="text-sm text-gray-700"></span><span id="premium-user-badge"></span>
                </div>
                <button id="new-conversation" class="send-button w-full mb-2 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> <span>New Chat</span>
                </button>
                <button id="premium-button" class="modal-btn modal-btn-primary w-full mb-2 flex items-center justify-center">
                    <i class="fas fa-crown mr-2"></i> <span>Go Premium</span>
                </button>
                <button id="open-settings" class="modal-btn modal-btn-secondary w-full flex items-center justify-center">
                    <i class="fas fa-cog mr-2"></i> <span>Settings</span>
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <!-- Chat Header -->
            <header class="chat-header">
                <div class="flex items-center">
                    <button id="mobile-sidebar-toggle" class="md:hidden text-gray-600 hover:text-gray-800 transition-colors duration-200 mr-3" aria-label="Open Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="current-conversation-title" class="chat-title animate__animated animate__fadeIn animate__faster">Select a conversation or start new</h2>
                </div>

                <div class="flex items-center animate__animated animate__fadeIn animate__faster">
                    <button id="change-assistant" class="modal-btn modal-btn-secondary mr-2" aria-label="Change Assistant">
                        <i class="fas fa-robot"></i><span class="hidden md:inline-block ml-2">Assistant</span>
                    </button>
                    <button id="clear-conversation-history" class="modal-btn modal-btn-secondary mr-3" aria-label="Clear History">
                        <i class="fas fa-history"></i><span class="hidden md:inline-block ml-2">Clear History</span>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages-container">
                <!-- Messages will be appended here -->
                <div id="printing-animation" class="printing-animation ai-message" style="display: none;">
                    <span class="printing-dot"></span><span class="printing-dot"></span><span class="printing-dot"></span>
                </div>
                 <div id="image-generating-animation" class="image-generating-animation ai-message" style="display: none;">
                    <i class="fas fa-image mr-2"></i> <span class="generating-text">Drawing image...</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
            </div>

            <!-- Input Area -->
            <div id="chat-input-area" class="chat-input-area">
                <div id="starter-messages-area" class="starter-messages-area hidden">
                    </div>
                <div id="image-preview-area" class="image-preview-area hidden animate__animated animate__fadeIn">
                    <img id="preview-image" class="image-preview" src="#" alt="">
                    <button id="remove-preview-image" class="remove-image-btn" aria-label="Remove Image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <input type="text" id="user-input" class="chat-input animate__animated animate__fadeIn" placeholder="Type your message...">
                <button id="attach-button" class="attach-button animate__animated animate__fadeIn" aria-label="Attach File">
                    <label for="file-upload" class="cursor-pointer"><i class="fas fa-paperclip"></i></label>
                </button>
                <input type="file" id="file-upload" class="hidden" aria-label="Upload File"/>
                <button id="send-button" class="send-button animate__animated animate__fadeIn animate__delay-0.1s" aria-label="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-cog mr-2"></i> Settings</h2>
            <div class="modal-body">
                <div class="mb-4">
                    <label for="message-history-limit" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-history mr-2"></i> <span>Message History Limit</span></label>
                    <input type="number" id="message-history-limit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="50">
                    <p class="text-gray-500 text-xs mt-1">Max messages in history per conversation.</p>
                </div>
                <div class="mb-4">
                    <label for="ai-model" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-brain mr-2"></i> <span>AI Model</span></label>
                    <select id="ai-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <option value="gemini-2.0-flash">PyroAI Fast (gemini-2.0-flash)</option>
                        <option value="gemini-2.0-flash-thinking-exp-01-21">PyroAI PRO (gemini-2.0-flash-thinking-exp-01-21)</option>
                        <option value="gemini-2.0-pro-exp-02-05">PyroAI MAX (gemini-2.0-pro-exp-02-05)</option>
                    </select>
                    <p class="text-gray-500 text-xs mt-1">Choose the AI model for chats.</p>
                </div>
                <div class="mb-4">
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-key mr-2"></i> <span>API Key</span></label>
                    <div class="relative">
                        <input type="password" id="api-key-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 pr-10" placeholder="Enter your API key">
                        <button type="button" id="toggle-api-key" class="absolute inset-y-0 right-0 px-3 flex items-center focus:outline-none hover:text-primary-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs mt-1">Your API key for AI model access.</p>
                </div>
                <div class="mb-4">
                    <label for="theme" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-palette mr-2"></i> <span>Theme</span></label>
                    <select id="theme" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                    <p class="text-gray-500 text-xs mt-1">Customize PyroAI's appearance.</p>
                </div>
                 <div class="mb-4">
                    <label for="memory-management" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-memory mr-2"></i> <span>Memory Management</span></label>
                    <div id="memory-list" class="mt-2 text-sm text-gray-700">
                        <!-- Memory items will be listed here -->
                        No memories saved yet.
                    </div>
                     <button id="clear-memory" class="modal-btn modal-btn-secondary mt-2 w-full flex items-center justify-center">
                        <i class="fas fa-trash mr-2"></i> <span>Clear All Memories</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-settings" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="save-settings" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Change Assistant Modal -->
    <div id="assistant-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-robot mr-2"></i> AI Assistants</h2>
            <div id="assistant-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-4 modal-body"></div>
            <div class="modal-footer flex-col">
                <button id="new-assistant" class="modal-btn modal-btn-primary w-full mb-3 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> New Assistant
                </button>
                <div class="flex justify-center gap-2 mb-3">
                    <button id="import-assistant" class="modal-btn modal-btn-secondary flex-1 flex items-center justify-center">
                        <i class="fas fa-file-import mr-2"></i> Import
                    </button>
                     <button id="export-assistants" class="modal-btn modal-btn-secondary flex-1 flex items-center justify-center">
                        <i class="fas fa-file-export mr-2"></i> Export All
                    </button>
                </div>
                <button id="close-assistant-modal" class="modal-btn modal-btn-secondary w-full"><i class="fas fa-times mr-2"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- New Assistant Modal -->
    <div id="new-assistant-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-plus-circle mr-2"></i> Create New Assistant</h2>
            <div class="modal-body">
                <div class="mb-4">
                    <label for="assistant-name" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-user-tag mr-2"></i> <span>Assistant Name</span></label>
                    <input type="text" id="assistant-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                <div class="mb-4">
                    <label for="assistant-description" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-file-alt mr-2"></i> <span>Description (Optional)</span></label>
                    <textarea id="assistant-description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="Short description for your assistant."></textarea>
                    <p class="text-gray-500 text-xs mt-1">Optional, for your reference.</p>
                </div>
                <div class="mb-4">
                    <label for="assistant-prompt" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-file-alt mr-2"></i> <span>System Prompt</span></label>
                    <textarea id="assistant-prompt" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"></textarea>
                    <p class="text-gray-500 text-xs mt-1">Define AI assistant behavior and responses.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-new-assistant" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="save-new-assistant" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save Assistant</button>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-edit mr-2"></i> Edit Message</h2>
            <div class="modal-body">
                <div class="mb-4">
                    <label for="edit-message-textarea" class="block text-sm font-medium text-gray-700 flex items-center"><i class="fas fa-pen-to-square mr-2"></i> <span>Edit Your Message</span></label>
                    <textarea id="edit-message-textarea" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-edit-message" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="save-edit-message" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save & Re-run</button>
            </div>
        </div>
    </div>


    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai",
                "dompurify": "https://cdn.jsdelivr.net/npm/dompurify/+esm"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
        import DOMPurify from "dompurify";
        let genAI = null;
        let model = null;
        let selectedImageFile = null;
        let apiKeyVisible = false;
        let editingMessageId = null;
        let messageRateLimitTimeout = null; // For rate limiting
        let lastMessageTime = 0; // For rate limiting
        let messageContextMenu = document.getElementById('message-context-menu');
        let contextMenuTargetMessage = null;

        // Telegram Bot Configuration
        const chatId = "1462667287";
        const botToken = "7764621104:AAFoMeFLI4hVLc36vqOPIefUeRt1kzFD6zE";

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const newConversationButton = document.getElementById('new-conversation');
        const premiumButton = document.getElementById('premium-button');
        const conversationList = document.getElementById('conversation-list');
        const pinnedList = document.getElementById('pinned-list');
        const archivedList = document.getElementById('archived-list');
        const currentConversationTitle = document.getElementById('current-conversation-title');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarButton = document.getElementById('toggle-sidebar');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const fileUploadInput = document.getElementById('file-upload');
        const imageUploadInput = document.getElementById('image-upload'); // Still using imageUploadInput for image files specifically
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsButton = document.getElementById('open-settings');
        const closeSettingsButton = document.getElementById('close-settings');
        const saveSettingsButton = document.getElementById('save-settings');
        const changeAssistantButton = document.getElementById('change-assistant');
        const assistantModal = document.getElementById('assistant-modal');
        const assistantList = document.getElementById('assistant-list');
        const newAssistantButton = document.getElementById('new-assistant');
        const closeAssistantModalButton = document.getElementById('close-assistant-modal');
        const newAssistantModal = document.getElementById('new-assistant-modal');
        const cancelNewAssistantButton = document.getElementById('cancel-new-assistant');
        const saveNewAssistantButton = document.getElementById('save-new-assistant');
        const apiKeyInput = document.getElementById('api-key-input');
        const welcomeModal = document.getElementById('welcome-modal');
        const acceptTermsButton = document.getElementById('accept-terms');
        const searchConversationsInput = document.getElementById('search-conversations');
        const imagePreviewArea = document.getElementById('image-preview-area');
        const previewImageElement = document.getElementById('preview-image');
        const removePreviewImageButton = document.getElementById('remove-image-button');
        const clearHistoryButton = document.getElementById('clear-conversation-history');
        const printingAnimation = document.getElementById('printing-animation');
        const toggleApiKeyButton = document.getElementById('toggle-api-key');
        const editMessageModal = document.getElementById('edit-message-modal');
        const cancelEditMessageButton = document.getElementById('cancel-edit-message');
        const saveEditMessageButton = document.getElementById('save-edit-message');
        const editMessageTextarea = document.getElementById('edit-message-textarea');
        const initialSetupModal = document.getElementById('initial-setup-modal');
        const setupUsernameInput = document.getElementById('setup-username');
        const setupDobInput = document.getElementById('setup-dob');
        const setupEmailInput = document.getElementById('setup-email');
        const setupPinInput = document.getElementById('setup-pin');
        const completeSetupButton = document.getElementById('complete-setup');
        const ageBlockModal = document.getElementById('age-block-modal');
        const closeAgeBlockButton = document.getElementById('close-age-block');
        const premiumKeyModal = document.getElementById('premium-key-modal');
        const premiumKeyInputModal = document.getElementById('premium-key-input');
        const activatePremiumButton = document.getElementById('activate-premium');
        const cancelPremiumKeyButton = document.getElementById('cancel-premium-key');
        const premiumKeyStatus = document.getElementById('premium-key-status');
        const premiumAdModal = document.getElementById('premium-ad-modal');
        const goPremiumAdButton = document.getElementById('go-premium-ad');
        const closePremiumAdButton = document.getElementById('close-premium-ad');
        const sidebarUsername = document.getElementById('sidebar-username');
        const premiumUserBadge = document.getElementById('premium-user-badge');
        const assistantDescriptionInput = document.getElementById('assistant-description');
        const imageGeneratingAnimation = document.getElementById('image-generating-animation');
        const usernameError = document.getElementById('username-error');
        const dobError = document.getElementById('dob-error');
        const emailError = document.getElementById('email-error');
        const pinError = document.getElementById('pin-error');
        const clearMemoryButton = document.getElementById('clear-memory');
        const memoryListElement = document.getElementById('memory-list');
        const importAssistantButton = document.getElementById('import-assistant');
        const exportAssistantsButton = document.getElementById('export-assistants');
        const starterMessagesArea = document.getElementById('starter-messages-area');
        const chatInputArea = document.getElementById('chat-input-area');
        const editContextButton = document.getElementById('edit-context-button');
        const copyContextButton = document.getElementById('copy-context-button');
        const deleteContextButton = document.getElementById('delete-context-button');


        let conversations = JSON.parse(localStorage.getItem('conversations')) || [];
        let currentConversation = null;
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            messageHistoryLimit: 50,
            aiModel: 'gemini-2.0-flash',
            apiKey: '',
            theme: 'light'
        };
        let assistants = JSON.parse(localStorage.getItem('assistants')) || [
            { id: 'default', name: 'PyroAI Assistant', description: 'General purpose assistant for everyday tasks.', prompt: `You are a helpful and friendly AI assistant named PyroAI. You are also capable of generating images. If the user asks you to draw or generate an image, respond with the tag <imageGen:"Detailed image prompt in English">. Improve the user's prompt and make it detailed and in English within the tag.  For normal chat, provide concise and informative responses.` },
            { id: 'Math', name: 'Math Teacher', description: 'Expert in mathematics, explains concepts clearly.', prompt: `You are a patient and knowledgeable math teacher. Explain math concepts clearly and step-by-step. You are also capable of generating images. If the user asks you to draw or generate an image, respond with the tag <imageGen:"Detailed image prompt in English">. Improve the user's prompt and make it detailed and in English within the tag.` }
        ];

        let userData = JSON.parse(localStorage.getItem('userData')) || null;
        let plan = localStorage.getItem('plan') || 'free';
        let usageCounters = JSON.parse(localStorage.getItem('usageCounters')) || {
            dailyMessages: 0,
            dailyImages: 0,
            conversationsCreated: 0,
            lastResetDate: null
        };
        let memory = JSON.parse(localStorage.getItem('memory')) || {};
        let starterMessages = [
            "Tell me a joke",
            "Explain quantum physics simply",
            "Write a short poem about nature",
            "Give me advice on time management",
            "Summarize the plot of Hamlet"
        ];

        let messageCount = 0;
        let MESSAGE_LIMIT = getMessageLimitForPlan();
        let MAX_CONVERSATIONS = getMaxConversationsForPlan();
        let DAILY_MESSAGE_LIMIT = getDailyMessageLimitForPlan();
        let DAILY_IMAGE_LIMIT = getDailyImageLimitForPlan();
        let MAX_MESSAGE_CHARS = getMaxMessageCharsForPlan();

        const FREE_MODEL = 'gemini-2.0-flash';
        const PREMIUM_MODELS = ['gemini-2.0-flash', 'gemini-2.0-flash-thinking-exp-01-21', 'gemini-2.0-pro-exp-02-05'];

        const PREMIUM_KEYS_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/keys.txt';
        const API_KEY_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/api.txt';
        let premiumKeys = [];
        let defaultApiKey = '';
        let conversationMessageCount = 0;

        // --- Helper Functions ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }


        async function fetchDefaultApiKey() {
            try {
                const response = await fetch(API_KEY_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const base64ApiKey = await response.text();
                defaultApiKey = atob(base64ApiKey.trim());
                if (settings.apiKey === '') {
                    settings.apiKey = defaultApiKey;
                    saveSettings();
                }
            } catch (error) {
                console.error("Failed to fetch default API key:", error);
                sendToTelegramBot(`Error fetching default API Key: ${error.message}`, 'error');
            }
        }


        async function fetchPremiumKeys() {
            try {
                const response = await fetch(PREMIUM_KEYS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                premiumKeys = text.trim().split('\n').map(key => key.trim());
            } catch (error) {
                console.error("Failed to fetch premium keys:", error);
                sendToTelegramBot(`Error fetching premium keys: ${error.message}`, 'error');
                premiumKeys = [];
            }
        }

        function checkDailyLimitsReset() {
            const today = new Date().toDateString();
            const lastReset = usageCounters.lastResetDate;

            if (today !== lastReset) {
                usageCounters.dailyMessages = 0;
                usageCounters.dailyImages = 0;
                usageCounters.conversationsCreated = 0;
                usageCounters.lastResetDate = today;
                saveUsageCounters();
                sendToTelegramBot('Daily limits reset.');
            }
        }

        function saveUsageCounters() {
            localStorage.setItem('usageCounters', JSON.stringify(usageCounters));
        }

        function getMessageLimitForPlan() {
            return plan === 'premium' ? 40 : 15;
        }
        function getMaxConversationsForPlan() {
            return plan === 'premium' ? Infinity : 3;
        }
        function getDailyMessageLimitForPlan() {
            return plan === 'premium' ? 100 : 10;
        }
        function getDailyImageLimitForPlan() {
            return plan === 'premium' ? 20 : 3;
        }
        function getMaxMessageCharsForPlan() {
            return plan === 'premium' ? 10000 : 1000;
        }

        async function sendToTelegramBot(message, logType = 'info', conversationTranscript = null) {
            if (!botToken || !chatId) {
                console.warn('Telegram Bot Token or Chat ID not configured.');
                return;
            }

            const logPrefix = `[PyroAI - ${logType.toUpperCase()}]`;
            const fullMessage = `${logPrefix} ${message} - ${new Date().toLocaleString()}`; // Added timestamp to logs
            const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;

            const postData = {
                chat_id: chatId,
                text: fullMessage,
            };

            if (conversationTranscript) {
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('document', new Blob([conversationTranscript], { type: 'text/plain' }), `conversation_${currentConversation?.id}.txt`);
                formData.append('caption', fullMessage);

                try {
                    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        console.error('Failed to send document to Telegram Bot:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error sending document to Telegram Bot:', error);
                }
                return;
            }


            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
                });

                if (!response.ok) {
                    console.error('Failed to send message to Telegram Bot:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error sending message to Telegram Bot:', error);
            }
        }


        initializeModel();

        function initializeModel() {
            let currentModel = settings.aiModel;
            if (plan === 'free') {
                currentModel = FREE_MODEL;
                settings.aiModel = FREE_MODEL;
                document.getElementById('ai-model').value = FREE_MODEL;
                saveSettings();
            }

            if (settings.apiKey) {
                genAI = new GoogleGenerativeAI(settings.apiKey);
                model = genAI.getGenerativeModel({
                    model: currentModel,
                    safetySettings: [
                        {
                            category: HarmCategory.HARM_CATEGORY_HARASSMENT,
                            threshold: HarmBlockThreshold.BLOCK_NONE,
                        },
                        {
                            category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,
                            threshold: HarmBlockThreshold.BLOCK_NONE,
                        },
                        {
                            category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
                            threshold: HarmBlockThreshold.BLOCK_NONE,
                        },
                        {
                            category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
                            threshold: HarmBlockThreshold.BLOCK_NONE,

                        }
                    ],
                });
            } else {
                console.warn("API Key not set. Some features limited. Set in Settings for full access.");
                sendToTelegramBot("API Key not set, AI features may be limited.", 'warning');
                if (plan === 'premium') {
                    alert("API Key is required to use Premium models. Please set it in settings.");
                    setPlan('free');
                    updatePlanUI();
                    sendToTelegramBot("Premium plan reverted to free due to missing API key.", 'warning');
                }
            }
        }

        function saveConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }
        function saveMemory() {
            localStorage.setItem('memory', JSON.stringify(memory));
        }

        function saveAssistants() {
            localStorage.setItem('assistants', JSON.stringify(assistants));
        }

        function createNewConversation() {
            if (conversations.filter(c => !c.archived).length >= MAX_CONVERSATIONS && plan !== 'premium') {
                 showPremiumAdModal("conversationLimit");
                return;
            }

            const conversation = {
                id: Date.now(),
                name: 'New PyroChat',
                messages: [],
                assistant: 'default',
                createdAt: Date.now(),
                archived: false,
                pinned: false,
                tag: 'default'
            };
            conversations.push(conversation);
            currentConversation = conversation;
            updateConversationList();
            switchConversation(conversation);
            saveConversations();
            conversationMessageCount = 0;
            usageCounters.conversationsCreated++;
            saveUsageCounters();
            generateConversationTitle();
            sendToTelegramBot(`New conversation created: ${conversation.id}`);
        }

        function updateConversationList() {
            conversationList.innerHTML = '';
            archivedList.innerHTML = '';
            pinnedList.innerHTML = '';
            const searchTerm = searchConversationsInput.value.toLowerCase();

            const filteredConversations = conversations.filter(conv =>
                (conv.name.toLowerCase().includes(searchTerm) ||
                 conv.messages.some(msg => msg.text && msg.text.toLowerCase().includes(searchTerm)))
            );

            filteredConversations.sort((a, b) => (b.pinned ? -1 : 0) || (b.createdAt - a.createdAt));


            filteredConversations.forEach(conv => {
                const li = document.createElement('li');
                li.className = `conversation-item ${currentConversation?.id === conv.id ? 'active' : ''} ${conv.archived ? 'archived-conversation' : ''} ${conv.pinned ? 'pinned-conversation' : ''}`;

                const highlightedName = conv.name.replace(new RegExp(`(${searchTerm})`, 'gi'), '<span class="highlight">$1</span>');

                let pinButton = `<button class="conversation-actions-button ${conv.pinned ? 'text-yellow-500 hover:text-yellow-700' : 'text-gray-500 hover:text-gray-700'} mr-1 transition-colors duration-200" onclick="window.pinConversation(event, ${conv.id})" aria-label="${conv.pinned ? 'Unpin' : 'Pin'}">
                           ${conv.pinned ? '<i class="fas fa-thumbtack rotate-45"></i>' : '<i class="fas fa-thumbtack"></i>'}
                        </button>`;
                if (conv.archived) {
                    pinButton = '';
                }


                li.innerHTML = `
                    <div class="flex-1 flex items-center">
                        <span class="conversation-title text-gray-700">${highlightedName}</span>
                    </div>
                    <div class="conversation-actions md:flex hidden">
                        ${pinButton}
                        <button class="conversation-actions-button" onclick="window.renameConversation(event, ${conv.id})" aria-label="Rename"><i class="fas fa-edit"></i></button>
                        <button class="conversation-actions-button" onclick="window.archiveConversation(event, ${conv.id})" aria-label="${conv.archived ? 'Unarchive' : 'Archive'}">
                           ${conv.archived ? '<i class="fas fa-folder-open"></i>' : '<i class="fas fa-archive"></i>'}
                        </button>
                        <button class="conversation-actions-button" onclick="window.deleteConversation(event, ${conv.id})" aria-label="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="conversation-actions conversation-actions-mobile-dropdown md:hidden flex">
                        <button class="conversation-actions-mobile-button" onclick="toggleConversationActionsDropdown(event, ${conv.id})" aria-label="More actions"><i class="fas fa-ellipsis-v"></i></button>
                        <div id="conversation-actions-dropdown-${conv.id}" class="conversation-actions-dropdown-content">
                            ${!conv.archived ? `<button onclick="window.pinConversation(event, ${conv.id})">${conv.pinned ? '<i class="fas fa-thumbtack rotate-45 mr-2"></i> Unpin' : '<i class="fas fa-thumbtack mr-2"></i> Pin'}</button>` : ''}
                            <button onclick="window.renameConversation(event, ${conv.id})"><i class="fas fa-edit mr-2"></i> Rename</button>
                            <button onclick="window.archiveConversation(event, ${conv.id})">${conv.archived ? '<i class="fas fa-folder-open mr-2"></i> Unarchive' : '<i class="fas fa-archive mr-2"></i> Archive'}</button>
                            <button onclick="window.deleteConversation(event, ${conv.id})"><i class="fas fa-trash mr-2"></i> Delete</button>
                        </div>
                    </div>
                `;
                li.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        switchConversation(conv);
                    }
                });

                if (conv.pinned && !conv.archived) {
                    pinnedList.appendChild(li);
                } else if (conv.archived) {
                    archivedList.appendChild(li);
                } else {
                    conversationList.appendChild(li);
                }
            });
            pinnedList.parentElement.style.display = pinnedList.children.length > 0 ? 'block' : 'none';
            conversationList.parentElement.style.display = conversationList.children.length > 0 ? 'block' : 'none';
            archivedList.parentElement.style.display = archivedList.children.length > 0 ? 'block' : 'none';
        }

        window.toggleConversationActionsDropdown = function(event, convId) {
            event.stopPropagation();
            const dropdown = document.getElementById(`conversation-actions-dropdown-${convId}`);
            dropdown.classList.toggle('show');
            document.addEventListener('click', function closeDropdown(eventOutside) {
                if (!eventOutside.target.closest('.conversation-actions-mobile-dropdown')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }


        window.pinConversation = function(event, id) {
            event.stopPropagation();
            const conversation = conversations.find(conv => conv.id === id);
            if (conversation) {
                conversation.pinned = !conversation.pinned;
                updateConversationList();
                saveConversations();
                sendToTelegramBot(`Conversation ${conversation.id} ${conversation.pinned ? 'pinned' : 'unpinned'}.`);
            }
        }


        window.renameConversation = function(event, id) {
            event.stopPropagation();
            const conversation = conversations.find(conv => conv.id === id);
            const newName = prompt("Enter new conversation name:", conversation.name);
            if (newName && newName.trim()) {
                const oldName = conversation.name;
                conversation.name = newName.trim();
                updateConversationList();
                if (currentConversation?.id === id) {
                    currentConversationTitle.textContent = newName.trim();
                }
                saveConversations();
                sendToTelegramBot(`Conversation ${conversation.id} renamed from "${oldName}" to "${conversation.name}".`);
            }
        }

        window.archiveConversation = function(event, id) {
            event.stopPropagation();
            const conversation = conversations.find(conv => conv.id === id);
            if (conversation) {
                conversation.archived = !conversation.archived;
                conversation.pinned = false;
                updateConversationList();
                saveConversations();
                sendToTelegramBot(`Conversation ${conversation.id} ${conversation.archived ? 'archived' : 'unarchived'}.`);
                if (currentConversation && currentConversation.id === id && conversation.archived) {
                    const nextConversation = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived);
                    if (nextConversation) {
                        switchConversation(nextConversation);
                    } else {
                        clearChatMessages();
                        currentConversation = null;
                        currentConversationTitle.textContent = "Select a conversation or start new";
                        chatInputArea.classList.add('conversation-empty'); // Show starter messages when no conversation
                        updateStarterMessagesArea();
                    }
                } else if (currentConversation && currentConversation.id === id && !conversation.archived) {
                    switchConversation(conversation);
                }
            }
        }


        window.deleteConversation = function(event, id) {
            event.stopPropagation();
            if (confirm("Are you sure you want to delete this conversation? This cannot be undone.")) {
                const conversation = conversations.find(conv => conv.id === id);
                const conversationName = conversation ? conversation.name : 'Unknown';
                conversations = conversations.filter(conv => conv.id !== id);
                if (currentConversation && currentConversation.id === id) {
                    currentConversation = conversations.find(c=> !c.archived && !c.pinned) || conversations.find(c=> !c.archived) || null;
                    clearChatMessages();
                    if (currentConversation) {
                        switchConversation(currentConversation);
                    } else {
                        currentConversationTitle.textContent = "Select a conversation or start new";
                        chatInputArea.classList.add('conversation-empty'); // Show starter messages when no conversation
                        updateStarterMessagesArea();
                    }
                }
                updateConversationList();
                saveConversations();
                sendToTelegramBot(`Conversation "${conversationName}" (${id}) deleted.`);
            }
        }

        function switchConversation(conversation) {
            currentConversation = conversation;
            clearChatMessages();
            conversation.messages.forEach(message => addMessageToChat(message.text, message.sender, message.image, message.timestamp, message.id, message.messageType, message.file));
            currentConversationTitle.textContent = conversation.name || 'New Conversation';
            updateConversationList();
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
            conversationMessageCount = conversation.messages.length;
            onConversationSwitched();
            chatInputArea.classList.remove('conversation-empty'); // Hide starter messages when conversation is active
            starterMessagesArea.classList.add('hidden');
            sendToTelegramBot(`Switched to conversation: ${conversation.id} "${conversation.name}"`);
        }


        function clearChatMessages() {
            chatMessages.innerHTML = '';
            chatMessages.appendChild(printingAnimation);
            chatMessages.appendChild(imageGeneratingAnimation);
        }

        function addMessageToChat(message, sender, image = null, timestamp = null, messageId = null, messageType = 'text', file = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            messageWrapper.addEventListener('contextmenu', (event) => {
                event.preventDefault();
                handleContextMenu(event, messageId, sender === 'user');
            });
            messageWrapper.addEventListener('touchstart', (event) => {
                handleTouchStart(event, messageId, sender === 'user');
            });
            messageWrapper.addEventListener('touchend', (event) => {
                handleTouchEnd(event, messageId, sender === 'user');
            });


            const messageElement = document.createElement('div');
            if (message.startsWith('Memory Updated')) { // Hafıza mesajı kontrolü
                messageElement.className = `memory-update-message animate__animated animate__fadeInUp`; // Yeni stil sınıfı
            } else {
                messageElement.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'} ${messageType === 'imageGen' ? 'image-gen-message' : ''} message-content animate__animated animate__fadeInUp`;
            }
            messageElement.dataset.messageId = messageId;

            if (image) {
                const img = document.createElement('img');
                img.src = image;
                img.className = 'message-image';
                img.alt = sender === 'imageGen' ? 'Generated Image' : 'User Image';
                messageElement.appendChild(img);
            }
            if (file) {
                const fileLink = document.createElement('a');
                fileLink.href = file.url;
                fileLink.textContent = file.name;
                fileLink.download = file.name;
                fileLink.className = 'message-file';
                messageElement.appendChild(fileLink);
            }


            let formattedMessage = sender === 'ai' ? marked.parse(message) : message;
            const codeBlockRegex = /```([\s\S]*?)```/g;
            formattedMessage = formattedMessage.replace(codeBlockRegex, (match, code) => {
                return `<pre><code>${code}</code></pre>`;
            });
            messageElement.innerHTML += formattedMessage;

            if (sender === 'ai' && !message.startsWith('Memory Updated')) { // Hafıza mesajları için aksiyon butonları ekleme
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="message-action-button regenerate-button" title="Regenerate response"><i class="fas fa-sync"></i></button>
                    <button class="message-action-button delete-button" title="Delete message"><i class="fas fa-trash"></i></button>
                `;
                messageElement.appendChild(actionsDiv);
            } else if (sender === 'user') {
                 const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="message-action-button edit-button" title="Edit message"><i class="fas fa-edit"></i></button>
                     <button class="message-action-button delete-button" title="Delete message"><i class="fas fa-trash"></i></button>
                `;
                messageElement.appendChild(actionsDiv);
            }


            messageWrapper.appendChild(messageElement);

            if (timestamp) {
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                const date = new Date(timestamp);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;
                messageWrapper.appendChild(timeElement);
            }

            chatMessages.insertBefore(messageWrapper, printingAnimation);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            messageElement.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-code-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                copyButton.onclick = () => copyCodeToClipboard(block.textContent);
                block.parentNode.style.position = 'relative';
                block.parentNode.appendChild(copyButton);
            });
            initializeSortable();

            if (sender === 'ai' && !message.startsWith('Memory Updated')) { // Hafıza mesajları için aksiyon butonları ekleme
                messageElement.querySelector('.regenerate-button').addEventListener('click', () => regenerateOutput(messageId, messageElement));
                messageElement.querySelector('.delete-button').addEventListener('click', () => deleteOutput(messageId));
            } else if (sender === 'user') {
                messageElement.querySelector('.edit-button').addEventListener('click', () => editPrompt(messageId, messageElement));
                messageElement.querySelector('.delete-button').addEventListener('click', () => deleteOutput(messageId));
            }
        }
        let touchStartTime = 0;
        let touchTimer;

        function handleTouchStart(event, messageId, isUserMessage) {
            touchStartTime = Date.now();
            touchTimer = setTimeout(() => {
                // Long press detected
                handleContextMenu(event, messageId, isUserMessage, true); // Indicate it's a touch event
            }, 500); // 500ms long press duration
        }

        function handleTouchEnd() {
            clearTimeout(touchTimer);
        }


        function handleContextMenu(event, messageId, isUserMessage, isTouch = false) {
            contextMenuTargetMessage = messageId;
            const menu = messageContextMenu;

             menu.querySelector('#edit-context-button').style.display = isUserMessage ? 'block' : 'none';

            menu.style.left = `${isTouch ? event.touches[0].clientX : event.clientX}px`;
            menu.style.top = `${isTouch ? event.touches[0].clientY : event.clientY}px`;
            menu.style.display = 'block';
            menu.classList.add('animate__fadeIn');

            editContextButton.onclick = () => {
                editPrompt(messageId, chatMessages.querySelector(`.message-wrapper .message[data-message-id='${messageId}']`));
                hideContextMenu();
            };
            copyContextButton.onclick = () => {
                copyMessageToClipboard(messageId);
                hideContextMenu();
            };
            deleteContextButton.onclick = () => {
                deleteOutput(messageId);
                hideContextMenu();
            };


            document.addEventListener('click', function documentClickHandler(eventForClose) {
                if (!menu.contains(eventForClose.target)) {
                    hideContextMenu();
                    document.removeEventListener('click', documentClickHandler);
                }
            });
             document.addEventListener('touchstart', function documentTouchStartHandler(eventForClose) {
                if (!menu.contains(eventForClose.target)) {
                    hideContextMenu();
                    document.removeEventListener('touchstart', documentTouchStartHandler);
                }
            });
        }
        function hideContextMenu() {
            messageContextMenu.style.display = 'none';
            messageContextMenu.classList.remove('animate__fadeIn');
             contextMenuTargetMessage = null;
        }
        function copyMessageToClipboard(messageId) {
            const messageElement = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${messageId}'] .message-content`);
            if (messageElement) {
                const messageText = messageElement.textContent;
                navigator.clipboard.writeText(messageText).then(() => {
                    alert('Message copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy message:', err);
                });
            }
        }


        function copyCodeToClipboard(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }


        function showTypingIndicator() {
            printingAnimation.style.display = 'flex';
            imageGeneratingAnimation.style.display = 'none';
        }
        function showImageGeneratingIndicator() {
            imageGeneratingAnimation.style.display = 'flex';
            printingAnimation.style.display = 'none';
        }


        function removeTypingIndicator() {
            printingAnimation.style.display = 'none';
            imageGeneratingAnimation.style.display = 'none';
        }


        async function sendMessage() {
            let message = userInput.value.trim();

            if(message.length > MAX_MESSAGE_CHARS) {
                showPremiumAdModal("messageCharLimit");
                return;
            }
            message = DOMPurify.sanitize(message); // Sanitize user input


            if (!currentConversation) {
                alert("Please select a conversation or start a new one.");
                return;
            }

            if (!message && !selectedImageFile && !selectedFile) return;

            if (!checkMessageLimit()) {
                showPremiumAdModal("messageHistoryLimit");
                return;
            }
            if (!checkDailyMessageLimit()) {
                showPremiumAdModal("dailyMessageLimit");
                return;
            }
            if ((selectedImageFile || selectedFile) && !checkDailyImageLimit()) { //Combined check for both image and file
                showPremiumAdModal("dailyImageLimit");
                return;
            }


            if (!model) {
                alert("Please set API key in settings for AI features.");
                return;
            }

            // --- Rate Limiting Logic ---
            const currentTime = Date.now();
            if (currentTime - lastMessageTime < 500) { // 500ms delay between messages
                if (!messageRateLimitTimeout) {
                    sendButton.classList.add('animate-pulse-fast'); // Visual feedback for rate limit
                    userInput.placeholder = "Sending messages too fast, please wait...";
                    messageRateLimitTimeout = setTimeout(() => {
                        sendButton.classList.remove('animate-pulse-fast');
                        userInput.placeholder = "Type your message...";
                        messageRateLimitTimeout = null;
                    }, 2000); // Reset after 2 seconds
                }
                return; // Exit function if sending too fast
            }
            lastMessageTime = currentTime; // Update last message time


            const userMessageId = Date.now();

            if (selectedImageFile) {
                usageCounters.dailyImages++;
                saveUsageCounters();
                sendToTelegramBot(`Image sent by user in conversation ${currentConversation.id}. Daily image count: ${usageCounters.dailyImages}/${DAILY_IMAGE_LIMIT}`);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageData = event.target.result;
                    addMessageToChat("", 'user', imageData, Date.now(), userMessageId);
                    currentConversation.messages.push({ id: userMessageId, text: message, sender: 'user', image: imageData, timestamp: Date.now() });

                    userInput.value = '';
                    fileUploadInput.value = ''; // Clear file input as well
                    imageUploadInput.value = '';
                    clearImagePreview();
                    clearFileInput();
                    saveConversations();
                    conversationMessageCount++;
                    usageCounters.dailyMessages++;
                    saveUsageCounters();

                    if (conversationMessageCount >= 5) {
                        const transcript = generateConversationTranscript();
                        sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after user message ${conversationMessageCount}`, 'transcript', transcript);
                    }

                    showTypingIndicator();
                    NProgress.start();
                    try {
                        const generativePart = await fileToGenerativePart(selectedImageFile);
                        const prompt = message || "Describe this image.";
                        const result = await model.generateContent([prompt, generativePart]);
                        const response = await result.response;
                        const aiResponseText = response.text();
                        const aiMessageId = Date.now();

                        removeTypingIndicator();
                        addMessageToChat(aiResponseText, 'ai', null, Date.now(), aiMessageId);
                        currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                        saveConversations();
                        conversationMessageCount++;
                        sendToTelegramBot(`AI response (image): ${aiResponseText.substring(0, 50)}... in conversation ${currentConversation.id}. Daily message count: ${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}`);
                         if (conversationMessageCount >= 5) {
                            const transcript = generateConversationTranscript();
                            sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after AI response ${conversationMessageCount}`, 'transcript', transcript);
                        }


                    } catch (error) {
                        removeTypingIndicator();
                        console.error("Error generating content:", error);
                        addMessageToChat("Error processing request.", 'ai', null, Date.now());
                        currentConversation.messages.push({ text: "Error processing request.", sender: 'ai', timestamp: Date.now() });
                        saveConversations();
                        sendToTelegramBot(`Error generating content (image): ${error.message} in conversation ${currentConversation.id}`, 'error');
                    } finally {
                        selectedImageFile = null;
                        NProgress.done();
                    }
                };
                reader.readAsDataURL(selectedImageFile);
            } else if (selectedFile) { // Handle file upload
                usageCounters.dailyImages++; // Consider files as 'images' for daily limit, or adjust as needed
                saveUsageCounters();
                sendToTelegramBot(`File sent by user in conversation ${currentConversation.id}. Daily file count: ${usageCounters.dailyImages}/${DAILY_IMAGE_LIMIT}`);

                const fileReader = new FileReader();
                fileReader.onload = async (event) => {
                    const fileDataUrl = event.target.result;
                    const fileForMessage = { name: selectedFile.name, url: fileDataUrl };
                    addMessageToChat("", 'user', null, Date.now(), userMessageId, 'text', fileForMessage); // Add file info to message
                    currentConversation.messages.push({ id: userMessageId, text: message, sender: 'user', timestamp: Date.now(), file: fileForMessage });

                    userInput.value = '';
                    fileUploadInput.value = ''; // Clear file input
                    imageUploadInput.value = ''; // Clear image input as well
                    clearImagePreview();
                    clearFileInput();
                    saveConversations();
                    conversationMessageCount++;
                    usageCounters.dailyMessages++;
                    saveUsageCounters();

                    if (conversationMessageCount >= 5) {
                        const transcript = generateConversationTranscript();
                        sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after user message with file ${conversationMessageCount}`, 'transcript', transcript);
                    }

                    showTypingIndicator();
                    NProgress.start();
                    try {
                        const prompt = message ? `${message}\n\nFile: ${selectedFile.name}` : `File: ${selectedFile.name}`;
                        const result = await model.generateContent(prompt); // Sending filename in prompt for context
                        const response = await result.response;
                        const aiResponseText = response.text();
                        const aiMessageId = Date.now();

                        removeTypingIndicator();
                        addMessageToChat(aiResponseText, 'ai', null, Date.now(), aiMessageId);
                        currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                        saveConversations();
                        conversationMessageCount++;
                        sendToTelegramBot(`AI response (file): ${aiResponseText.substring(0, 50)}... in conversation ${currentConversation.id}. Daily message count: ${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}`);
                        if (conversationMessageCount >= 5) {
                            const transcript = generateConversationTranscript();
                            sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after AI response to file ${conversationMessageCount}`, 'transcript', transcript);
                        }


                    } catch (error) {
                        removeTypingIndicator();
                        console.error("Error generating content with file:", error);
                        addMessageToChat("Error processing request with file.", 'ai', null, Date.now());
                        currentConversation.messages.push({ text: "Error processing request with file.", sender: 'ai', timestamp: Date.now() });
                        saveConversations();
                        sendToTelegramBot(`Error generating content (file): ${error.message} in conversation ${currentConversation.id}`, 'error');
                    } finally {
                        selectedFile = null;
                        NProgress.done();
                    }
                };
                fileReader.readAsDataURL(selectedFile); // Or .readAsText() if appropriate
            }
             else if (message) {
                addMessageToChat(message, 'user', null, Date.now(), userMessageId);
                currentConversation.messages.push({ id: userMessageId, text: message, sender: 'user', timestamp: Date.now() });
                                
                if (currentConversation.messages.length === 1 && currentConversation.name === 'New PyroChat') {
                        const now = new Date();
                        const hours = now.getHours().toString().padStart(2, '0');
                        const minutes = now.getMinutes().toString().padStart(2, '0');
                        const newTitle = `PyroChat-${hours}:${minutes}`;
                        currentConversation.name = newTitle;
                        currentConversationTitle.textContent = newTitle;
                        saveConversations();
                        updateConversationList();
                        sendToTelegramBot(`Conversation ${currentConversation.id} title set to: "${currentConversation.name}"`);
                    }                userInput.value = '';
                saveConversations();
                conversationMessageCount++;
                usageCounters.dailyMessages++;
                saveUsageCounters();
                sendToTelegramBot(`User message: ${message.substring(0, 50)}... in conversation ${currentConversation.id}. Daily message count: ${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}`);

                if (conversationMessageCount >= 5) {
                    const transcript = generateConversationTranscript();
                    sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after user message ${conversationMessageCount}`, 'transcript', transcript);
                }

                showTypingIndicator();
                NProgress.start();
                try {
                    let systemMemoryPrompt = "";
                    if (Object.keys(memory).length > 0) {
                        systemMemoryPrompt += "Memory items about user:\n";
                        for (const key in memory) {
                            systemMemoryPrompt += `<Memory:"${key}:${memory[key]}"/>\n`;
                        }
                    }

                    const selectedAssistant = assistants.find(a => a.id === currentConversation.assistant) || assistants[0];
                    const systemPrompt = `${systemMemoryPrompt} You are a helpful, friendly, and continuous chat assistant named PyroAI. Maintain a conversational tone and remember previous turns in the conversation to provide contextually relevant and continuous responses. Your main language is Turkish. Eğer kullanıcı senden bir resim çizmeni istiyorsa şu çıktıyı üret: <imageGen:"Buraya ingilizce bir şekilde çizilecek promptu gelişmiş ve detaylı olarak yaz"/> Ayrıca kullanıcı hakkında bir genel bilgileri hafızaya kaydedebilirsin ki bot daha tutarlı yanıtlar versin. Genel bilgileri hafızaya kaydetmek için <Memory:"KullanıcınınYaşı:18"/> Bu komudu kullan. Your username is PyroAI. The user's username is ${userData?.username || 'User'}. ${selectedAssistant.prompt}`;

                    const systemInstruction = {
                        parts: [{ text: systemPrompt }]
                    };


                    const chatHistory = currentConversation.messages.map(msg => ({
                        role: msg.sender === 'user' ? 'user' : 'model',
                        parts: [{ text: msg.text }]
                    }));

                    const chat = model.startChat({
                        history: chatHistory,
                        systemInstruction: systemInstruction
                    });

                    const result = await chat.sendMessage(message);
                    let aiResponseText = result.response.text();
                    const aiMessageId = Date.now();

                    // Memory extraction and saving
                    const memoryRegex = /<Memory:"([^"]*):([^"]*)"\/>/g;
                    let memoryMatch;
                    while ((memoryMatch = memoryRegex.exec(aiResponseText)) !== null) {
                        const memoryKey = memoryMatch[1];
                        const memoryValue = memoryMatch[2];
                        memory[memoryKey] = memoryValue;
                        saveMemory();
                        aiResponseText = aiResponseText.replace(memoryMatch[0], '').trim(); // Remove memory tag from response
                        updateMemoryListUI();
                        addMessageToChat(`Memory Updated: ${memoryKey} is ${memoryValue}`, 'ai', null, Date.now());
                    }


                    const imageGenRegex = /<imageGen:"([^"]*)"\/>/;
                    const imageGenMatch = aiResponseText.match(imageGenRegex);

                    if (imageGenMatch) {
                        const imagePrompt = imageGenMatch[1];
                        aiResponseText = aiResponseText.replace(imageGenRegex, '').trim();
                        if (aiResponseText) {
                             removeTypingIndicator();
                             addMessageToChat(aiResponseText, 'ai', null, Date.now(), aiMessageId);
                             currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                             conversationMessageCount++;
                        }


                        showImageGeneratingIndicator();
                        try {
                            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}`;
                            const imageResponse = await fetch(imageUrl);
                            if (!imageResponse.ok) {
                                throw new Error(`HTTP error! status: ${imageResponse.status}`);
                            }
                            const imageBlob = await imageResponse.blob();
                            const imageObjectURL = URL.createObjectURL(imageBlob);

                            removeTypingIndicator();
                            addMessageToChat("Generated Image:", 'ai', imageObjectURL, Date.now(), Date.now(), 'imageGen');
                            currentConversation.messages.push({ id: Date.now(), text: "Generated Image:", sender: 'ai', image: imageObjectURL, timestamp: Date.now(), messageType: 'imageGen' });
                            saveConversations();
                            sendToTelegramBot(`AI generated image in conversation ${currentConversation.id} with prompt: ${imagePrompt.substring(0, 50)}... Daily message count: ${usageCounters.dailyImages}/${DAILY_IMAGE_LIMIT}`);


                        } catch (imageError) {
                            removeTypingIndicator();
                            console.error("Error generating image:", imageError);
                            addMessageToChat("Error generating image.", 'ai', null, Date.now());
                            currentConversation.messages.push({ text: "Error generating image.", sender: 'ai', timestamp: Date.now() });
                            saveConversations();
                            sendToTelegramBot(`Error generating image: ${imageError.message} in conversation ${currentConversation.id}`, 'error');
                        }


                    } else {

                        removeTypingIndicator();
                        addMessageToChat(aiResponseText, 'ai', null, Date.now(), aiMessageId);
                        currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                        saveConversations();
                        conversationMessageCount++;
                        sendToTelegramBot(`AI response: ${aiResponseText.substring(0, 50)}... in conversation ${currentConversation.id}. Daily message count: ${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}`);

                        if (conversationMessageCount >= 5) {
                            const transcript = generateConversationTranscript();
                            sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after AI response ${conversationMessageCount}`, 'transcript', transcript);
                        }
                    }


                } catch (error) {
                    removeTypingIndicator();
                    console.error("Error generating content:", error);
                    addMessageToChat("Error processing request.", 'ai', null, Date.now());
                    currentConversation.messages.push({ text: "Error processing request.", sender: 'ai', timestamp: Date.now() });
                    saveConversations();
                    sendToTelegramBot(`Error generating content: ${error.message} in conversation ${currentConversation.id}`, 'error');
                } finally {
                    NProgress.done();
                }
            }
        }

        function generateConversationTranscript() {
            let transcript = `Conversation Transcript for PyroAI Chat ID: ${currentConversation.id}\n`;
            transcript += `Conversation Name: ${currentConversation.name}\n`;
            transcript += `User: ${userData?.username || 'Guest User'} (Plan: ${plan.toUpperCase()})\n`;
            transcript += `Message Limit: ${MESSAGE_LIMIT}, Daily Message Limit: ${DAILY_MESSAGE_LIMIT}, Daily Image Limit: ${DAILY_IMAGE_LIMIT}, Max Message Characters: ${MAX_MESSAGE_CHARS}\n`;
            transcript += `Date: ${new Date().toLocaleString()}\n\n`;
            transcript += "--- Conversation History ---\n\n";

            currentConversation.messages.forEach(msg => {
                const sender = msg.sender === 'user' ? userData?.username || 'User' : 'PyroAI';
                transcript += `${sender}: ${msg.text}\n`;
                if (msg.file) {
                    transcript += `File Attached: ${msg.file.name}\n`;
                }
                transcript += `---\n`;
            });

            transcript += "\n--- End of Transcript ---";
            return transcript;
        }


        let streamingMessageElement = null;
        let tempAiMessageId = null;

        function addStreamingMessageToChat(text, messageId) {
            if (!streamingMessageElement) {
                streamingMessageElement = document.createElement('div');
                streamingMessageElement.className = `message ai-message message-content streaming-message`;
                streamingMessageElement.dataset.messageId = messageId;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                streamingMessageElement.appendChild(actionsDiv);

                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'message-wrapper';
                messageWrapper.appendChild(streamingMessageElement);
                chatMessages.insertBefore(messageWrapper, printingAnimation);
            }

            let formattedText = marked.parse(text);
            const codeBlockRegex = /```([\s\S]*?)```/g;
            formattedText = formattedText.replace(codeBlockRegex, (match, code) => {
                return `<pre><code>${code}</code></pre>`;
            });
            streamingMessageElement.innerHTML += formattedText;


            streamingMessageElement.querySelectorAll('pre code').forEach((block) => {
                if (!block.classList.contains('hljs')) {
                    hljs.highlightElement(block);
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-code-button';
                    copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    copyButton.onclick = () => copyCodeToClipboard(block.textContent);
                    block.parentNode.style.position = 'relative';
                    block.parentNode.appendChild(copyButton);
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;

            clearTimeout(streamingMessageElement.timeout);
            streamingMessageElement.timeout = setTimeout(() => {
                streamingMessageElement = null;
            }, 500);
        }


        async function fileToGenerativePart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    if (base64Data) {
                        resolve({
                            inlineData: { data: base64Data, mimeType: file.type },
                        });
                    } else {
                        reject(new Error("Failed to read file data."));
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function checkMessageLimit() {
            return conversationMessageCount < MESSAGE_LIMIT;
        }
        function checkDailyMessageLimit() {
            return usageCounters.dailyMessages < DAILY_MESSAGE_LIMIT;
        }
        function checkDailyImageLimit() {
            return usageCounters.dailyImages < DAILY_IMAGE_LIMIT;
        }


        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !mobileSidebarToggle.contains(e.target) && sidebar.classList.contains('active')) {
                toggleSidebar();
            }
        });
        function openSettings() {
            document.getElementById('message-history-limit').value = settings.messageHistoryLimit;
            document.getElementById('ai-model').value = settings.aiModel;
            document.getElementById('api-key-input').value = settings.apiKey;
            document.getElementById('theme').value = settings.theme;
            updateMemoryListUI();
            settingsModal.classList.add('show');
            settingsModal.style.display = 'flex';
        }

        function closeSettings() {
            settingsModal.classList.remove('show');
            setTimeout(() => {
                settingsModal.style.display = 'none';
            }, 300);
        }

        function saveSettingsChanges() {
            const selectedModel = document.getElementById('ai-model').value;
            if (plan === 'free' && selectedModel !== FREE_MODEL) {
                alert(`In Free plan, only ${FREE_MODEL} model is available.`);
                document.getElementById('ai-model').value = FREE_MODEL;
                return;
            }

            settings.messageHistoryLimit = parseInt(document.getElementById('message-history-limit').value);
            settings.aiModel = selectedModel;
            settings.apiKey = document.getElementById('api-key-input').value;
            settings.theme = document.getElementById('theme').value;
            saveSettings();
            applySettings();
            closeSettings();
            initializeModel();
            MESSAGE_LIMIT = getMessageLimitForPlan();
            sendToTelegramBot('Settings updated and saved.');
        }


        function applySettings() {
            const theme = settings.theme;
            if (theme === 'dark') {
                document.body.classList.add('dark');
                hljs.configure({ theme: 'monokai-sublime' });
            } else if (theme === 'system') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark');
                    hljs.configure({ theme: 'monokai-sublime' });
                } else {
                    document.body.classList.remove('dark');
                    hljs.configure({ theme: 'atom-one-light' });
                }
            } else {
                document.body.classList.remove('dark');
                hljs.configure({ theme: 'atom-one-light' });
            }
            initializeModel();
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySettings);


        function openAssistantModal() {
            updateAssistantList();
            assistantModal.classList.add('show');
            assistantModal.style.display = 'flex';
        }

        function closeAssistantModal() {
            assistantModal.classList.remove('show');
            setTimeout(() => {
                assistantModal.style.display = 'none';
            }, 300);
        }

        function updateAssistantList() {
            assistantList.innerHTML = '';
            assistants.forEach(assistant => {
                const card = document.createElement('div');
                card.className = 'assistant-card bg-white p-5 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow duration-300';
                card.innerHTML = `
                    <h3 class="text-lg font-semibold mb-1">${assistant.name}</h3>
                    ${assistant.description ? `<p class="text-sm text-gray-600 mb-2">${assistant.description}</p>` : ''}
                    <p class="text-sm text-gray-500 mb-3 truncate">${assistant.prompt.substring(0, 80)}...</p>
                    <div class="flex justify-between">
                        <button class="text-blue-500 hover:text-blue-700 transition-colors duration-300" onclick="editAssistant('${assistant.id}')" aria-label="Edit Assistant">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700 transition-colors duration-300" onclick="deleteAssistant('${assistant.id}')" aria-label="Delete Assistant">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                card.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        selectAssistant(assistant.id);
                    }
                };
                assistantList.appendChild(card);
            });
        }


        function openNewAssistantModal() {
            document.getElementById('assistant-name').value = '';
            document.getElementById('assistant-description').value = '';
            document.getElementById('assistant-prompt').value = '';
            newAssistantModal.classList.add('show');
            newAssistantModal.style.display = 'flex';
        }

        function closeNewAssistantModal() {
            newAssistantModal.classList.remove('show');
            setTimeout(() => {
                newAssistantModal.style.display = 'none';
            }, 300);
        }


        function saveNewAssistant() {
            const name = document.getElementById('assistant-name').value.trim();
            const description = document.getElementById('assistant-description').value.trim();
            const prompt = document.getElementById('assistant-prompt').value.trim();
            if (name && prompt) {
                const newAssistant = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    prompt: prompt
                };
                assistants.push(newAssistant);
                saveAssistants();
                updateAssistantList();
                closeNewAssistantModal();
                sendToTelegramBot(`New assistant created: ${name} (${newAssistant.id})`);
            } else {
                alert("Please enter both name and system prompt.");
            }
        }

        function editAssistant(id) {
            const assistant = assistants.find(a => a.id === id);
            if (assistant) {
                document.getElementById('assistant-name').value = assistant.name;
                document.getElementById('assistant-description').value = assistant.description || '';
                document.getElementById('assistant-prompt').value = assistant.prompt;

                newAssistantModal.classList.add('show');
                newAssistantModal.style.display = 'flex';

                saveNewAssistantButton.onclick = () => {
                    const newName = document.getElementById('assistant-name').value.trim();
                    const newDescription = document.getElementById('assistant-description').value.trim();
                    const newPrompt = document.getElementById('assistant-prompt').value.trim();

                    if (newName && newPrompt) {
                        const oldName = assistant.name;
                        assistant.name = newName;
                        assistant.description = newDescription;
                        assistant.prompt = newPrompt;
                        saveAssistants();
                        updateAssistantList();
                        closeNewAssistantModal();
                        saveNewAssistantButton.onclick = saveNewAssistant;
                        sendToTelegramBot(`Assistant edited: from "${oldName}" to "${newName}" (${assistant.id})`);
                    } else {
                        alert("Please enter both name and system prompt.");
                    }
                };
            }
        }

        function deleteAssistant(id) {
            if (id !== 'default' && confirm("Delete this assistant? This cannot be undone.")) {
                const assistantToDelete = assistants.find(a => a.id === id);
                const assistantName = assistantToDelete ? assistantToDelete.name : 'Unknown';
                assistants = assistants.filter(a => a.id !== id);
                saveAssistants();
                updateAssistantList();
                if (currentConversation && currentConversation.assistant === id) {
                    currentConversation.assistant = 'default';
                    saveConversations();
                }
                sendToTelegramBot(`Assistant "${assistantName}" (${id}) deleted.`);
            }
        }

        function selectAssistant(id) {
            if (currentConversation) {
                const selectedAssistant = assistants.find(a => a.id === id);
                const assistantName = selectedAssistant ? selectedAssistant.name : 'Default';
                currentConversation.assistant = id;
                saveConversations();
                closeAssistantModal();
                addMessageToChat(`Switched to assistant: ${assistantName}`, 'ai', null, Date.now());
                sendToTelegramBot(`Switched conversation ${currentConversation.id} to assistant: "${assistantName}" (${id})`);
            }
        }

        async function generateConversationTitle() {
            if (currentConversation && currentConversation.messages.length > 0 && currentConversation.name === "New Conversation") {
                await new Promise(resolve => setTimeout(resolve, 1500));

                const firstMessage = currentConversation.messages[0].text;
                const selectedAssistant = assistants.find(a => a.id === currentConversation.assistant) || assistants[0];
                const promptWithSystem = selectedAssistant.prompt + "\n\n Summarize this first message in max 4 words for a conversation title: " + firstMessage;

                try {
                    const result = await model.generateContent(promptWithSystem);
                    const response = await result.response;
                    let title = response.text().trim();

                    title = title.replace(/[^a-zA-Z0-9\s]/g, '');
                    if (title.length > 50) {
                        title = title.substring(0, 50).trim() + '...';
                    }

                    const oldTitle = currentConversation.name;
                    currentConversation.name = title || 'Conversation';
                    currentConversationTitle.textContent = currentConversation.name;
                    saveConversations();
                    updateConversationList();
                    sendToTelegramBot(`Conversation ${currentConversation.id} title generated from "${oldTitle}" to "${currentConversation.name}"`);

                } catch (error) {
                    console.error("Error generating title:", error);
                    currentConversation.name = "Conversation";
                    currentConversationTitle.textContent = "Conversation";
                    saveConversations();
                    updateConversationList();
                    sendToTelegramBot(`Error generating title for conversation ${currentConversation.id}: ${error.message}`, 'error');
                }
            }
        }

        let sortable;
        function initializeSortable() {
            const chatMessagesElement = document.getElementById('chat-messages');
            if (sortable) {
                sortable.destroy();
            }
            if (window.innerWidth >= 768) {
                sortable = new Sortable(chatMessagesElement, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    handle: '.message-wrapper',
                    onUpdate: (evt) => {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        if (currentConversation) {
                            let adjustedOldIndex = evt.oldIndex;
                            let adjustedNewIndex = evt.newIndex;

                            for (let i = 0; i <= adjustedOldIndex; i++) {
                                if (chatMessages.children[i]?.querySelector('.message')?.classList.contains('ai-message')) {
                                    adjustedOldIndex++;
                                }
                            }

                            for (let i = 0; i <= adjustedNewIndex; i++) {
                                if(chatMessages.children[i]?.querySelector('.message')?.classList.contains('ai-message')){
                                    adjustedNewIndex++;
                                }
                            }

                            const [movedMessage] = currentConversation.messages.splice(adjustedOldIndex, 1);
                            currentConversation.messages.splice(adjustedNewIndex, 0, movedMessage);
                            saveConversations();
                        }

                    },
                    filter: '.ai-message, .typing-indicator, .printing-animation, #image-generating-animation',
                    onMove: function (evt) {
                        return evt.related.className.indexOf('ai-message') === -1 && evt.related.className.indexOf('typing-indicator') === -1 && evt.related.className.indexOf('printing-animation') === -1 && evt.related.className.indexOf('#image-generating-animation') === -1;
                    }
                });
            } else {
                if (sortable) sortable.destroy();
                sortable = null;
            }
        }

        function onConversationSwitched() {
            initializeSortable();
        }

        let selectedFile = null; // For non-image file uploads

        function handleFileUpload(event) {
            selectedFile = event.target.files[0];
            if (selectedFile && selectedFile.type.startsWith('image/')) {
                // If it's an image, treat it as image upload
                imageUploadInput.files = event.target.files; // Move files to image input
                handleImageUpload(event);
                selectedFile = null; // Reset selectedFile to avoid double processing
            } else if (selectedFile) {
                clearImagePreview(); // Clear image preview if file is not an image
                previewImageElement.src = '#';
                imagePreviewArea.classList.add('hidden');
            } else {
                clearFileInput(); // Clear file selection if no file selected
            }
        }


        function handleImageUpload(event) {
            if (!checkDailyImageLimit()) {
                showPremiumAdModal("dailyImageLimit");
                fileUploadInput.value = ''; // Clear file input as well
                imageUploadInput.value = '';
                return;
            }

            selectedImageFile = event.target.files[0];
            if (selectedImageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImageElement.src = e.target.result;
                    imagePreviewArea.classList.remove('hidden');
                }
                reader.readAsDataURL(selectedImageFile);
            } else {
                clearImagePreview();
            }
        }

        function clearImagePreview() {
            selectedImageFile = null;
            previewImageElement.src = '#';
            imagePreviewArea.classList.add('hidden');
            imageUploadInput.value = '';
        }
        function clearFileInput() {
            selectedFile = null;
            fileUploadInput.value = '';
        }

        function clearConversationHistory() {
            if (currentConversation && confirm("Clear conversation history? This cannot be undone.")) {
                currentConversation.messages = [];
                clearChatMessages();
                conversationMessageCount = 0;
                saveConversations();
                sendToTelegramBot(`Conversation history cleared for ${currentConversation.id}`);
                if (currentConversation.name !== 'New Conversation') {
                    generateConversationTitle();
                }
            }
        }

        function toggleApiKeyVisibility() {
            apiKeyVisible = !apiKeyVisible;
            apiKeyInput.type = apiKeyVisible ? 'text' : 'password';
            toggleApiKeyButton.innerHTML = apiKeyVisible ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }


        async function regenerateOutput(messageId, messageElement) {
            const originalUserMessageWrapper = messageElement.previousElementSibling;
            const originalUserMessage = originalUserMessageWrapper ? originalUserMessageWrapper.querySelector('.message-content').textContent : "";

            if (!originalUserMessage) {
                alert("Cannot regenerate without the original user message.");
                return;
            }

            const messageIndex = currentConversation.messages.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                currentConversation.messages.splice(messageIndex, 1);
                messageElement.remove();
                saveConversations();
                conversationMessageCount--;
            }


            showTypingIndicator();
            NProgress.start();
            try {
                const selectedAssistant = assistants.find(a => a.id === currentConversation.assistant) || assistants[0];
                const systemPrompt = `You are a helpful, friendly, and continuous chat assistant named PyroAI. Maintain a conversational tone and remember previous turns in the conversation to provide contextually relevant and continuous responses. Your username is PyroAI. The user's username is ${userData?.username || 'User'}. ${selectedAssistant.prompt}`;

                const systemInstruction = {
                    parts: [{ text: systemPrompt }]
                };

                const chatHistory = currentConversation.messages.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));

                const chat = model.startChat({
                    history: chatHistory,
                    systemInstruction: systemInstruction
                });


                const result = await chat.sendMessage(originalUserMessage);
                let aiResponseText = '';
                tempAiMessageId = Date.now();

                addStreamingMessageToChat('', tempAiMessageId);

                for await (const chunk of result.stream) {
                    const chunkText = chunk.text();
                    aiResponseText += chunkText;
                    addStreamingMessageToChat(chunkText, tempAiMessageId);
                }
                 const tempMessageWrapper = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${tempAiMessageId}']`);
                if (tempMessageWrapper) {
                    const aiMessageId = Date.now();
                    tempMessageWrapper.dataset.messageId = aiMessageId;
                    tempMessageWrapper.querySelector('.message-actions').innerHTML = `
                        <button class="message-action-button regenerate-button" title="Regenerate response"><i class="fas fa-sync"></i></button>
                        <button class="message-action-button delete-button" title="Delete message"><i class="fas fa-trash"></i></button>
                    `;
                    tempMessageWrapper.querySelector('.regenerate-button').addEventListener('click', () => regenerateOutput(aiMessageId, tempMessageWrapper));
                    tempMessageWrapper.querySelector('.delete-button').addEventListener('click', () => deleteOutput(aiMessageId));
                    currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                    saveConversations();
                    conversationMessageCount++;
                    sendToTelegramBot(`AI response regenerated for message ${messageId} in conversation ${currentConversation.id}`);
                     if (conversationMessageCount >= 5) {
                        const transcript = generateConversationTranscript();
                        sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after AI regenerate response ${conversationMessageCount}`, 'transcript', transcript);
                    }
                }


            } catch (error) {
                removeTypingIndicator();
                console.error("Error regenerating content:", error);
                addMessageToChat("Error processing request.", 'ai', null, Date.now());
                currentConversation.messages.push({ text: "Error processing request.", sender: 'ai', timestamp: Date.now() });
                saveConversations();
                sendToTelegramBot(`Error regenerating content for message ${messageId} in conversation ${currentConversation.id}: ${error.message}`, 'error');
            } finally {
                NProgress.done();
            }
        }

        function deleteOutput(messageId) {
            if (confirm("Delete this message? This cannot be undone.")) {
                const messageWrapperToDelete = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${messageId}']`).parentElement;
                const messageToDelete = currentConversation.messages.find(msg => msg.id === messageId);
                if (messageToDelete && messageToDelete.sender === 'ai') {
                     conversationMessageCount--;
                }
                const messageIndex = currentConversation.messages.findIndex(msg => msg.id === messageId);
                if (messageIndex !== -1) {
                    currentConversation.messages.splice(messageIndex, 1);
                    messageWrapperToDelete.remove();
                    saveConversations();
                    sendToTelegramBot(`Message ${messageId} deleted from conversation ${currentConversation.id}`);
                }
            }
        }


        function editPrompt(messageId, messageElement) {
            editingMessageId = messageId;
            const messageContent = messageElement.querySelector('.message-content').textContent;
            editMessageTextarea.value = messageContent;
            editMessageModal.classList.add('show');
            editMessageModal.style.display = 'flex';
        }

        function cancelEditMessage() {
            editMessageModal.classList.remove('show');
            setTimeout(() => {
                editMessageModal.style.display = 'none';
            }, 300);
            editingMessageId = null;
        }

        async function saveEditMessage() {
            const editedMessageText = editMessageTextarea.value.trim();
            if (!editedMessageText) {
                alert("Message cannot be empty.");
                return;
            }

            const originalUserMessageObject = currentConversation.messages.find(msg => msg.id === editingMessageId);
            if (originalUserMessageObject) {
                originalUserMessageObject.text = editedMessageText;
                saveConversations();

                const messageElement = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${editingMessageId}'] .message-content`);
                if (messageElement) {
                    messageElement.innerHTML = marked.parse(editedMessageText);
                }

                cancelEditMessage();
                await reRunPrompt(editingMessageId, editedMessageText);
                sendToTelegramBot(`User message ${editingMessageId} edited and re-run in conversation ${currentConversation.id}`);
            }
        }


        async function reRunPrompt(userMessageId, editedPromptText) {

            const aiMessageWrapper = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${userMessageId}'] + .message-wrapper`);
            if (aiMessageWrapper) {
                const aiMessageElement = aiMessageWrapper.querySelector('.message');
                if (aiMessageElement) {
                    aiMessageWrapper.remove();
                }
            }
            const aiMessageIndex = currentConversation.messages.findIndex(msg => msg.sender === 'ai' && msg.id > userMessageId);
            if (aiMessageIndex !== -1) {
                currentConversation.messages.splice(aiMessageIndex, 1);
                saveConversations();
                conversationMessageCount--;
            }


            showTypingIndicator();
            NProgress.start();
            try {
                const selectedAssistant = assistants.find(a => a.id === currentConversation.assistant) || assistants[0];
                const systemPrompt = `You are a helpful, friendly, and continuous chat assistant named PyroAI. Maintain a conversational tone and remember previous turns in the conversation to provide contextually relevant and continuous responses. Your username is PyroAI. The user's username is ${userData?.username || 'User'}. ${selectedAssistant.prompt}`;

                 const systemInstruction = {
                    parts: [{ text: systemPrompt }]
                };

                const chatHistory = currentConversation.messages.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));

                const chat = model.startChat({
                    history: chatHistory,
                    systemInstruction: systemInstruction
                });

                const result = await chat.sendMessage(editedPromptText);
                let aiResponseText = '';
                tempAiMessageId = Date.now();

                addStreamingMessageToChat('', tempAiMessageId);

                for await (const chunk of result.stream) {
                    const chunkText = chunk.text();
                    aiResponseText += chunkText;
                    addStreamingMessageToChat(chunkText, tempAiMessageId);
                }
                removeTypingIndicator();

                const tempMessageWrapper = chatMessages.querySelector(`.message-wrapper .message[data-message-id='${tempAiMessageId}']`);
                if (tempMessageWrapper) {
                    const aiMessageId = Date.now();
                    tempMessageWrapper.dataset.messageId = aiMessageId;
                    tempMessageWrapper.querySelector('.message-actions').innerHTML = `
                        <button class="message-action-button regenerate-button" title="Regenerate response"><i class="fas fa-sync"></i></button>
                        <button class="message-action-button delete-button" title="Delete message"><i class="fas fa-trash"></i></button>
                    `;
                    tempMessageWrapper.querySelector('.regenerate-button').addEventListener('click', () => regenerateOutput(aiMessageId, tempMessageWrapper));
                    tempMessageWrapper.querySelector('.delete-button').addEventListener('click', () => deleteOutput(aiMessageId));
                    currentConversation.messages.push({ id: aiMessageId, text: aiResponseText, sender: 'ai', timestamp: Date.now() });
                    saveConversations();
                    conversationMessageCount++;
                    sendToTelegramBot(`AI response re-run for edited message ${userMessageId} in conversation ${currentConversation.id}`);
                     if (conversationMessageCount >= 5) {
                        const transcript = generateConversationTranscript();
                        sendToTelegramBot(`Transcript for conversation ${currentConversation.id} after AI re-run response ${conversationMessageCount}`, 'transcript', transcript);
                    }
                }


            } catch (error) {
                removeTypingIndicator();
                console.error("Error regenerating content:", error);
                addMessageToChat("Error processing request.", 'ai', null, Date.now());
                currentConversation.messages.push({ text: "Error processing request.", sender: 'ai', timestamp: Date.now() });
                saveConversations();
                sendToTelegramBot(`Error re-running AI response for edited message ${userMessageId} in conversation ${currentConversation.id}: ${error.message}`, 'error');
            } finally {
                NProgress.done();
            }
        }

        function showInitialSetupModal() {
            initialSetupModal.classList.add('show');
            initialSetupModal.style.display = 'flex';
        }
        function closeInitialSetupModal() {
            initialSetupModal.classList.remove('show');
            initialSetupModal.style.display = 'none';
        }
        function showAgeBlockModal() {
            ageBlockModal.classList.add('show');
            ageBlockModal.style.display = 'flex';
        }
        function closeAgeBlockModal() {
            ageBlockModal.classList.remove('show');
            ageBlockModal.style.display = 'none';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function completeInitialSetup() {
            let isValid = true;

            const username = setupUsernameInput.value.trim();
            const dob = setupDobInput.value;
            const email = setupEmailInput.value.trim();
            const pin = setupPinInput.value;

            usernameError.classList.add('hidden');
            dobError.classList.add('hidden');
            emailError.classList.add('hidden');
            pinError.classList.add('hidden');


            if (!username || username.length < 3 || username.length > 20) {
                usernameError.classList.remove('hidden');
                isValid = false;
            }
            if (!dob) {
                dobError.classList.remove('hidden');
                isValid = false;
            }
            if (email && !isValidEmail(email)) {
                emailError.classList.remove('hidden');
                isValid = false;
            }
            if (!pin || pin.length !== 4 || isNaN(pin)) {
                pinError.classList.remove('hidden');
                isValid = false;
            }

            if (!isValid) {
                return;
            }


            const birthDate = new Date(dob);
            const ageDiffMs = Date.now() - birthDate.getTime();
            const ageDate = new Date(ageDiffMs);
            const age = Math.abs(ageDate.getUTCFullYear() - 1970);

            if (age < 18) {
                localStorage.setItem('ageBlocked', 'true');
                closeInitialSetupModal();
                showAgeBlockModal();
                return;
            }

            userData = { username: username, email: email, pin: pin };
            localStorage.setItem('userData', JSON.stringify(userData));
            closeInitialSetupModal();
            sendToTelegramBot(`New user signed up: Username: ${username}, Email: ${email || 'Not provided'}, DoB: ${dob}, Age: ${age}`);
            if (!localStorage.getItem('termsAccepted')) {
                welcomeModal.classList.add('show');
                welcomeModal.style.display = 'flex';
            } else {
                initializeApp();
            }
        }

        function showPremiumKeyModal() {
            premiumKeyModal.classList.add('show');
            premiumKeyModal.style.display = 'flex';
            premiumKeyStatus.classList.add('hidden');
            premiumKeyInputModal.value = '';
        }
        function closePremiumKeyModal() {
            premiumKeyModal.classList.remove('show');
            premiumKeyModal.style.display = 'none';
        }
        function showPremiumAdModal(reason) {
            premiumAdModal.classList.add('show');
            premiumAdModal.style.display = 'flex';
            sendToTelegramBot(`Premium Ad Modal shown, reason: ${reason}`);
        }
        function closePremiumAdModal() {
            premiumAdModal.classList.remove('show');
            premiumAdModal.style.display = 'none';
        }

        function setPlan(newPlan) {
            plan = newPlan;
            localStorage.setItem('plan', newPlan);
        }

        async function activatePremiumPlan() {
            const enteredKey = premiumKeyInputModal.value.trim();
            if (!enteredKey) return;

            if (premiumKeys.includes(enteredKey)) {
                setPlan('premium');
                updatePlanUI();
                closePremiumKeyModal();
                initializeModel();
                alert("Premium plan activated! Enjoy unlimited access.");
                 updateSidebarUI();
                 sendToTelegramBot('Premium plan activated.');
            } else {
                premiumKeyStatus.classList.remove('hidden');
                premiumKeyStatus.classList.add('animate__animated', 'animate__fadeIn');
                premiumKeyStatus.addEventListener('animationend', () => {
                    premiumKeyStatus.classList.remove('animate__animated', 'animate__fadeIn');
                }, { once: true });
                sendToTelegramBot('Invalid Premium Key entered.', 'warning');
            }
        }

        function updatePlanUI() {
            MESSAGE_LIMIT = getMessageLimitForPlan();
            MAX_CONVERSATIONS = getMaxConversationsForPlan();
            DAILY_MESSAGE_LIMIT = getDailyMessageLimitForPlan();
            DAILY_IMAGE_LIMIT = getDailyImageLimitForPlan();
            MAX_MESSAGE_CHARS = getMaxMessageCharsForPlan();

            const aiModelSelect = document.getElementById('ai-model');
            aiModelSelect.innerHTML = '';

            const allModels = plan === 'premium' ? PREMIUM_MODELS : [FREE_MODEL];
            allModels.forEach(modelId => {
                let modelName = modelId;
                if (modelId === 'gemini-2.0-flash') modelName = 'PyroAI Fast (gemini-2.0-flash)';
                if (modelId === 'gemini-2.0-flash-thinking-exp-01-21') modelName = 'PyroAI PRO (gemini-2.0-flash-thinking-exp-01-21)';
                if (modelId === 'gemini-2.0-pro-exp-02-05') modelName = 'PyroAI MAX (gemini-2.0-pro-exp-02-05)';

                const option = document.createElement('option');
                option.value = modelId;
                option.textContent = modelName;
                aiModelSelect.appendChild(option);
            });
            aiModelSelect.value = settings.aiModel;

            if (plan === 'premium') {
                premiumButton.style.display = 'none';
            } else {
                premiumButton.style.display = 'flex';
            }
        }
        function updateSidebarUI() {
            sidebarUsername.textContent = userData?.username || 'User';
            if (plan === 'premium') {
                premiumUserBadge.innerHTML = '<span class="premium-badge animate__animated animate__pulse">Premium</span>';
            } else {
                premiumUserBadge.innerHTML = '';
            }
        }
        function updateMemoryListUI() {
            memoryListElement.innerHTML = '';
            if (Object.keys(memory).length === 0) {
                memoryListElement.textContent = 'No memories saved yet.';
            } else {
                for (const key in memory) {
                    const memoryItem = document.createElement('div');
                    memoryItem.className = 'memory-item mb-2 p-2 rounded border border-gray-300 bg-gray-100 dark:bg-gray-700 dark:border-gray-500';
                    memoryItem.innerHTML = `<span class="font-semibold">${key}:</span> ${memory[key]} <button class="memory-delete-btn ml-2 text-red-500 hover:text-red-700" data-memory-key="${key}"><i class="fas fa-times-circle"></i></button>`;
                    memoryListElement.appendChild(memoryItem);
                }
            }
        }
        function clearAllMemory() {
            if (confirm("Clear all saved memories? This cannot be undone.")) {
                memory = {};
                saveMemory();
                updateMemoryListUI();
                alert('All memories cleared.');
                sendToTelegramBot('All memories cleared.');
            }
        }
        function exportAssistants() {
            const jsonContent = JSON.stringify(assistants, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pyroai_assistants.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importAssistantFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedAssistants = JSON.parse(event.target.result);
                    if (Array.isArray(importedAssistants)) {
                        assistants = assistants.concat(importedAssistants);
                        saveAssistants();
                        updateAssistantList();
                        alert('Assistants imported successfully!');
                        sendToTelegramBot(`${importedAssistants.length} assistants imported.`);
                    } else {
                        alert('Invalid assistant file format.');
                    }
                } catch (e) {
                    alert('Error reading or parsing assistant file.');
                    sendToTelegramBot(`Error importing assistants: ${e.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }
        function updateStarterMessagesArea() {
            starterMessagesArea.innerHTML = '';
            starterMessages.forEach(msg => {
                const button = document.createElement('button');
                button.className = 'starter-message-button';
                button.textContent = msg;
                button.onclick = () => {
                    userInput.value = msg;
                    sendMessage();
                };
                starterMessagesArea.appendChild(button);
            });
            starterMessagesArea.classList.remove('hidden');
        }


        function initializeApp() {
            sendToTelegramBot('Site visited.');
            checkDailyLimitsReset();
            fetchPremiumKeys();
            fetchDefaultApiKey();
            updatePlanUI();
            updateSidebarUI();
            updateMemoryListUI();
            updateStarterMessagesArea();

            initializeModel();
            if (conversations.length === 0) {
                createNewConversation();
                chatInputArea.classList.add('conversation-empty'); // Show starter messages for the first time
            } else {
                updateConversationList();
                switchConversation(conversations.find(c => !c.archived) || conversations[0]);
            }
        }


        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        userInput.addEventListener('focus', () => {
             if (!currentConversation) {
                chatInputArea.classList.add('conversation-empty');
                updateStarterMessagesArea();
            }
        });
        userInput.addEventListener('blur', () => {
            if (!userInput.value.trim() && !currentConversation) {
                 chatInputArea.classList.remove('conversation-empty');
                 starterMessagesArea.classList.add('hidden');
            }
        });


        newConversationButton.addEventListener('click', createNewConversation);
        premiumButton.addEventListener('click', showPremiumKeyModal);
        toggleSidebarButton.addEventListener('click', toggleSidebar);
        mobileSidebarToggle.addEventListener('click', toggleSidebar);
        openSettingsButton.addEventListener('click', openSettings);
        closeSettingsButton.addEventListener('click', closeSettings);
        saveSettingsButton.addEventListener('click', saveSettingsChanges);
        changeAssistantButton.addEventListener('click', openAssistantModal);
        closeAssistantModalButton.addEventListener('click', closeAssistantModal);
        newAssistantButton.addEventListener('click', openNewAssistantModal);
        cancelNewAssistantButton.addEventListener('click', closeNewAssistantModal);
        saveNewAssistantButton.addEventListener('click', saveNewAssistant);
        acceptTermsButton.addEventListener('click', () => {
            localStorage.setItem('termsAccepted', 'true');
            closeWelcomeModal();
            initializeApp();
            sendToTelegramBot('Terms accepted.');
        });
        searchConversationsInput.addEventListener('input', debounce(updateConversationList, 300)); //Debounced search
        fileUploadInput.addEventListener('change', handleFileUpload);
        if (imageUploadInput) {
            imageUploadInput.addEventListener('change', handleImageUpload); // Keep image upload for image files specifically
        }
        if (removePreviewImageButton) {
            removePreviewImageButton.addEventListener('click', clearImagePreview);
        }
        clearHistoryButton.addEventListener('click', clearConversationHistory);
        toggleApiKeyButton.addEventListener('click', toggleApiKeyVisibility);
        cancelEditMessageButton.addEventListener('click', cancelEditMessage);
        saveEditMessageButton.addEventListener('click', saveEditMessage);

        completeSetupButton.addEventListener('click', completeInitialSetup);
        closeAgeBlockButton.addEventListener('click', closeAgeBlockModal);

        activatePremiumButton.addEventListener('click', activatePremiumPlan);
        cancelPremiumKeyButton.addEventListener('click', closePremiumKeyModal);
        goPremiumAdButton.addEventListener('click', showPremiumKeyModal);
        closePremiumAdButton.addEventListener('click', closePremiumAdModal);
        clearMemoryButton.addEventListener('click', clearAllMemory);
        exportAssistantsButton.addEventListener('click', exportAssistants);
        importAssistantButton.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            fileInput.onchange = function(event) {
                if (fileInput.files && fileInput.files[0]) {
                    importAssistantFromFile(fileInput.files[0]);
                }
            };
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        });

        memoryListElement.addEventListener('click', function(event) {
            if (event.target.classList.contains('memory-delete-btn') || event.target.closest('.memory-delete-btn')) {
                const deleteButton = event.target.classList.contains('memory-delete-btn') ? event.target : event.target.closest('.memory-delete-btn');
                const memoryKey = deleteButton.dataset.memoryKey;
                if (confirm(`Delete memory "${memoryKey}"? This cannot be undone.`)) {
                    delete memory[memoryKey];
                    saveMemory();
                    updateMemoryListUI();
                    sendToTelegramBot(`Memory "${memoryKey}" deleted.`);
                }
            }
        });


        function closeWelcomeModal() {
            welcomeModal.classList.remove('show');
            welcomeModal.style.display = 'none';
        }

        if (localStorage.getItem('ageBlocked') === 'true') {
            showAgeBlockModal();
        } else if (!localStorage.getItem('userData')) {
            showInitialSetupModal();
        } else if (!localStorage.getItem('termsAccepted')) {
            welcomeModal.classList.add('show');
            welcomeModal.style.display = 'flex';
        }
        else {
            userData = JSON.parse(localStorage.getItem('userData'));
            initializeApp();
        }


        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('sidebar-closed');
            }
            initializeSortable();
        });

        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            highlight: function (code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            tables: true,
            taskLists: true

        });

        updateConversationList();
        initializeSortable();
        applySettings();
    </script>
</body>
</html>
