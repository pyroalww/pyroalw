
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PyroAI v2 - Advanced AI Chat Platform</title>
    <meta name="description" content="PyroAI v2 - Enhanced AI chat platform by PyroLLC. Experience intelligent conversations, automatic website previews, JS execution, and more.">
    <meta name="keywords" content="PyroAI, PyroLLC, PyroALW, AI chat, artificial intelligence, chatbot, machine learning, intelligent assistant, website preview, javascript execution, premium AI">
    <meta name="author" content="PyroLLC">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="PyroAI v2 - Advanced AI Chat Platform">
    <meta property="og:description" content="Experience the next generation of AI chat with PyroAI v2. Featuring integrated website previews, JS execution, and enhanced features.">
    <meta property="og:image" content="https://avatars.githubusercontent.com/u/134533935?v=4">
    <meta property="og:url" content="https://pyrollc.com.tr"> <!-- Update if URL changes -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PyroAI v2 - Advanced AI Chat Platform">
    <meta name="twitter:description" content="Enhanced AI chat experience with integrated website previews, JS execution, and more.">
    <link rel="canonical" href="https://pyrollc.com.tr"> <!-- Update if URL changes -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css"> <!-- Updated Highlight.js Style -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> <!-- Updated SortableJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #7C3AED; /* Purple */
            --primary-color-hover: #9753FF; /* Lighter Purple */
            --secondary-color: #10B981; /* Emerald */
            --background-color: #F9FAFB; /* Very Light Gray */
            --text-color: #1F2937; /* Dark Gray */
            --light-gray: #E5E7EB;
            --medium-gray: #D1D5DB;
            --dark-gray: #6B7280;
            --darker-gray: #374151;
            --code-bg: #F3F4F6; /* Slightly darker than background */
            --shadow-light: rgba(0, 0, 0, 0.06);
            --accent-color: #FBBF24; /* Amber */

            /* Light theme */
            --background-light: var(--background-color);
            --text-light: var(--text-color);
            --sidebar-light: #FFFFFF;
            --message-user-light: var(--primary-color);
            --message-ai-light: #FFFFFF;
            --message-user-text-light: white;
            --message-ai-text-light: var(--text-color);
            --pinned-background-light: #FEF3C7; /* Light Yellow */
            --pinned-border-light: var(--accent-color);

            /* Dark Theme */
            --background-dark: #111827; /* Very Dark Blue/Gray */
            --text-dark: #E5E7EB; /* Light Gray */
            --sidebar-dark: #1F2937; /* Dark Gray/Blue */
            --message-user-dark: #7C3AED;
            --message-ai-dark: #374151; /* Darker Gray/Blue */
            --message-user-text-dark: white;
            --message-ai-text-dark: var(--text-dark);
            --code-bg-dark: #2b303b; /* Darker Code Background */
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --pinned-background-dark: #3730A3; /* Indigo */
            --pinned-border-dark: #A5B4FC; /* Light Indigo */

            --toast-success-bg: #ECFDF5;
            --toast-success-text: #065F46;
            --toast-success-border: #10B981;
            --toast-error-bg: #FEF2F2;
            --toast-error-text: #991B1B;
            --toast-error-border: #EF4444;
            --toast-info-bg: #EFF6FF;
            --toast-info-text: #1E40AF;
            --toast-info-border: #3B82F6;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
            font-size: 16px; /* Base font size */
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px -5px var(--shadow-light), 0 5px 10px -6px var(--shadow-light);
            margin: 1rem;
            overflow: hidden;
            background-color: var(--background-light); /* Explicit background */
        }
        @media (max-width: 768px) {
            .app-container {
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-light);
            border-right: 1px solid var(--light-gray);
            overflow-y: auto;
            transition: width 0.3s ease, transform 0.3s ease; /* Added width transition */
            z-index: 20;
            box-shadow: 2px 0 5px -2px var(--shadow-light);
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Collapsed State (Desktop) */
        .sidebar-closed {
            width: 80px;
        }
        .sidebar-closed .sidebar-title,
        .sidebar-closed .sidebar-content span, /* Hide text spans */
        .sidebar-closed .sidebar-footer span,
        .sidebar-closed #search-conversations,
        .sidebar-closed .conversation-title,
        .sidebar-closed .conversation-actions,
        .sidebar-closed .user-profile span:not(#premium-user-badge),
        .sidebar-closed #new-conversation span,
        .sidebar-closed #premium-button span,
        .sidebar-closed #suggestions-button span,
        .sidebar-closed #open-settings span {
            display: none;
        }
        .sidebar-closed .sidebar-header,
        .sidebar-closed .sidebar-footer {
            padding-left: 1rem;
            padding-right: 1rem;
            justify-content: center; /* Center items when collapsed */
        }
        .sidebar-closed .sidebar-content h2 i {
            margin-right: 0; /* Remove margin from icons */
        }
        .sidebar-closed .sidebar-content h2 {
             justify-content: center; /* Center section titles */
        }
        .sidebar-closed .conversation-item {
            justify-content: center; /* Center icons in conversation items */
        }
         .sidebar-closed #toggle-sidebar-desktop i {
             transform: rotate(180deg); /* Flip chevron */
        }


        /* Mobile Sidebar Collapse (translateX) */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
                width: 280px; /* Consistent mobile width */
                box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.active { /* Mobile active state */
                transform: translateX(0);
            }
            /* Reset desktop collapse styles for mobile */
            .sidebar-closed, .sidebar {
                width: 280px; /* Always use mobile width */
            }
            .sidebar-closed .sidebar-title,
            .sidebar-closed .sidebar-content span,
            .sidebar-closed .sidebar-footer span,
            .sidebar-closed #search-conversations,
            .sidebar-closed .conversation-title,
            .sidebar-closed .conversation-actions,
            .sidebar-closed .user-profile span:not(#premium-user-badge),
            .sidebar-closed #new-conversation span,
            .sidebar-closed #premium-button span,
            .sidebar-closed #suggestions-button span,
            .sidebar-closed #open-settings span {
                display: inline-block; /* Show text again on mobile */
            }
             .sidebar-closed .sidebar-header,
            .sidebar-closed .sidebar-footer {
                 padding: 1.75rem; /* Restore padding */
                 justify-content: space-between;
             }
             .sidebar-closed .sidebar-content h2 i {
                margin-right: 0.75rem; /* Restore icon margin */
             }
             .sidebar-closed .sidebar-content h2 {
                 justify-content: flex-start; /* Restore section title alignment */
             }
             .sidebar-closed .conversation-item {
                 justify-content: space-between; /* Restore conversation item alignment */
             }
             .sidebar-closed #toggle-sidebar-desktop {
                 display: none; /* Hide desktop toggle on mobile */
             }
             #mobile-sidebar-toggle { display: block; } /* Always show mobile toggle */
        }


        .sidebar-header {
            padding: 1.75rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .sidebar-logo-area { display: flex; align-items: center; }
        .sidebar-title { font-size: 1.5rem; font-weight: 700; color: var(--text-color); letter-spacing: -0.025em; margin-left: 0.5rem; }

        #toggle-sidebar-desktop, #toggle-sidebar {
            color: var(--dark-gray);
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
            cursor: pointer;
        }
        #toggle-sidebar-desktop:hover, #toggle-sidebar:hover {
             background-color: var(--light-gray);
             color: var(--primary-color);
        }
        #toggle-sidebar { display: none; } /* Mobile toggle hidden by default */


        .sidebar-content { padding: 1.25rem 1.75rem; flex-grow: 1; }
        .sidebar-footer { padding: 1.25rem 1.75rem; border-top: 1px solid var(--light-gray); text-align: center; margin-top: auto; flex-shrink: 0; }

        .conversation-list { padding-top: 0.5rem; }
        .conversation-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }
        .conversation-item:hover {
            background-color: var(--light-gray);
            transform: translateX(3px);
            box-shadow: 2px 2px 5px var(--shadow-light);
        }
        .conversation-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 3px 8px -2px rgba(124, 58, 237, 0.5);
            transform: translateX(3px);
        }
        .conversation-item.active:hover { background-color: var(--primary-color-hover); }
        .conversation-item.active .text-gray-700, .conversation-item.active .dark-gray { color: white !important; }

        .conversation-title {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 0.5rem;
            font-size: 0.95rem;
        }

        .conversation-actions { display: flex; gap: 0.3rem; }
        .conversation-actions button, .conversation-actions-mobile-button {
            padding: 0.5rem; background: none; border: none; color: var(--dark-gray); cursor: pointer; opacity: 0.8; transition: all 0.2s ease; border-radius: 0.3rem;
        }
        .conversation-actions button:hover, .conversation-actions-mobile-button:hover {
            opacity: 1; background-color: rgba(0,0,0,0.05); color: var(--primary-color); transform: scale(1.1);
        }
        .conversation-item.active .conversation-actions button { color: white; opacity: 0.9; }
        .conversation-item.active .conversation-actions button:hover { background-color: rgba(255,255,255,0.2); }

        /* Mobile dropdown styles from v14, adjusted slightly */
        .conversation-actions-mobile-dropdown { position: relative; }
        .conversation-actions-dropdown-content {
            display: none; position: absolute; right: 0; background-color: var(--sidebar-light); min-width: 140px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.15); z-index: 1; border-radius: 0.5rem; padding: 0.5rem 0; margin-top: 0.2rem; border: 1px solid var(--light-gray);
        }
        .conversation-actions-dropdown-content.show { display: block; }
        .conversation-actions-dropdown-content button { display: block; width: 100%; padding: 0.6rem 1rem; text-align: left; clear: both; white-space: nowrap; font-size: 0.9rem; }
        .conversation-actions-dropdown-content button:hover { background-color: var(--light-gray); }

        /* --- Chat Area --- */
        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background-light);
            overflow: hidden; /* Prevent chat area itself from scrolling */
        }

        .chat-header {
            padding: 1.5rem 1.75rem; /* Reduced vertical padding slightly */
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header shrinking */
            min-height: 70px; /* Ensure consistent height */
        }

        .chat-title {
            font-size: 1.5rem; /* Slightly smaller */
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.02em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 65%;
        }

        #mobile-sidebar-toggle { display: none; } /* Hidden by default, shown via media query */

        .chat-messages-container {
            flex-grow: 1;
            padding: 1.75rem;
            overflow-y: auto; /* Allow only this container to scroll */
            scroll-behavior: smooth;
            scrollbar-gutter: stable;
            padding-bottom: 2rem; /* Space above input */
        }

        .message-wrapper {
            margin-bottom: 1.25rem; /* Increased spacing */
            display: flex;
            flex-direction: column;
            max-width: 90%; /* Limit wrapper width */
        }
        .message-wrapper.user-message-wrapper { align-self: flex-end; max-width: 85%; } /* Align user messages right */
        .message-wrapper.ai-message-wrapper { align-self: flex-start; max-width: 85%; } /* Align AI messages left */

        .message {
            padding: 0.9rem 1.4rem;
            border-radius: 1.25rem; /* Consistent radius */
            word-wrap: break-word;
            box-shadow: 0 2px 5px 0 var(--shadow-light), 0 1px 2px 0 var(--shadow-light);
            animation: fadeInUp 0.4s ease-out;
            position: relative;
            transition: box-shadow 0.25s ease;
            user-select: text;
            line-height: 1.5; /* Improved line spacing */
            width: fit-content; /* Make bubble fit content */
        }
         .message-wrapper.user-message-wrapper .message { margin-left: auto; } /* Ensure user bubble aligns right */
         .message-wrapper.ai-message-wrapper .message { margin-right: auto; } /* Ensure ai bubble aligns left */

        .message:hover { box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light); }

        .message.user-message {
            background-color: var(--message-user-light);
            color: var(--message-user-text-light);
            border-bottom-right-radius: 0.5rem; /* Tail effect */
        }

        .message.ai-message {
            background-color: var(--message-ai-light);
            color: var(--message-ai-text-light);
            border-bottom-left-radius: 0.5rem; /* Tail effect */
        }

        .message.image-gen-message, .message.website-code-message, .message.process-js-result-message {
            background-color: var(--message-ai-light);
            color: var(--message-ai-text-light);
            border-bottom-left-radius: 0.5rem;
        }
        .message.website-code-message { padding: 0; overflow: hidden; } /* Remove padding for preview container */
        .message.process-js-result-message pre { margin-top: 0.5rem; }


        .message-content { /* Apply styles to markdown content inside */
            font-size: 1rem;
        }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        .message-content p { margin-bottom: 0.75em; } /* Spacing between paragraphs */
        .message-content ul, .message-content ol { margin-left: 1.5em; margin-bottom: 0.75em; }
        .message-content li { margin-bottom: 0.25em; }
        .message-content blockquote {
            border-left: 4px solid var(--medium-gray);
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 0.75em;
            color: var(--dark-gray);
            font-style: italic;
        }
        .message-content a { color: var(--primary-color); text-decoration: underline; }
        body.dark .message-content a { color: var(--primary-color-hover); }


        /* --- Website Preview in Chat --- */
        .website-preview-area-chat {
            margin-top: 0; /* Integrated, no top margin needed */
            border: none; /* Removed border, part of message bubble */
            border-radius: 1.25rem; /* Match message bubble */
             border-top-left-radius: 0; /* Adjust for header */
             border-top-right-radius: 0;
             overflow: hidden; /* Clip iframe */
             background-color: var(--code-bg); /* Background for the area */
        }
        .website-preview-header-chat {
             background-color: var(--darker-gray);
             padding: 0.6rem 1rem;
             font-size: 0.8rem;
             color: var(--background-light); /* Light text on dark header */
             border-bottom: 1px solid var(--medium-gray);
             display: flex;
             justify-content: space-between;
             align-items: center;
        }
        body.dark .website-preview-header-chat { background-color: #4B5563; color: var(--text-dark); border-bottom-color: #6B7280;}

        .website-preview-header-chat .title { font-weight: 500; }
        .website-preview-header-chat .actions button {
            background: none; border: none; color: var(--background-light); cursor: pointer; opacity: 0.8; transition: opacity 0.2s ease, transform 0.2s ease; padding: 0.3rem; margin-left: 0.5rem; font-size: 0.9rem;
        }
        body.dark .website-preview-header-chat .actions button { color: var(--text-dark); }
        .website-preview-header-chat .actions button:hover { opacity: 1; transform: scale(1.15); }
        .website-preview-iframe {
            width: 100%;
            height: 350px; /* Increased height */
            border: none;
            display: block; /* Remove potential extra space below iframe */
        }

        /* --- Other Message Types --- */
        .message-file {
            display: block; margin-top: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background-color: var(--code-bg); color: var(--text-color); text-decoration: none; transition: background-color 0.3s ease; border: 1px solid var(--medium-gray); display: flex; align-items: center; gap: 0.5rem;
        }
        .message-file:hover { background-color: var(--light-gray); }
        .message-image { max-width: 100%; height: auto; border-radius: 0.75rem; margin-top: 0.75rem; box-shadow: 0 2px 4px 0 var(--shadow-light); }

        .message-time {
            font-size: 0.75rem; /* Smaller time */
            color: var(--dark-gray);
            margin-top: 0.5rem; /* More space */
            align-self: flex-end;
            opacity: 0.8;
        }
        .message-wrapper.user-message-wrapper .message-time { color: var(--dark-gray); opacity: 0.8;} /* User time same color now */
        body.dark .message-wrapper.user-message-wrapper .message-time { color: #9CA3AF; } /* Dark mode user time */
        body.dark .message-wrapper.ai-message-wrapper .message-time { color: #9CA3AF; } /* Dark mode AI time */

        .message-actions {
            position: absolute;
            top: -10px; /* Position above slightly */
            right: 10px;
            display: flex; /* Changed to flex */
            gap: 0.5rem;
            background-color: var(--sidebar-light); /* Match sidebar */
            padding: 0.2rem 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateY(5px);
            z-index: 2;
        }
        .message-wrapper:hover .message-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-action-button {
            background: none; border: none; color: var(--dark-gray); cursor: pointer; opacity: 0.7; padding: 0.3rem; border-radius: 50%; transition: all 0.2s ease; font-size: 0.8rem;
        }
        .message-action-button:hover { opacity: 1; background-color: var(--light-gray); color: var(--primary-color); transform: scale(1.1); }

        /* Context Menu */
        #message-context-menu {
            position: fixed; z-index: 55; background-color: var(--sidebar-light); border-radius: 0.6rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 0.5rem 0; min-width: 160px; display: none; border: 1px solid var(--light-gray);
        }
        #message-context-menu button { display: block; width: 100%; padding: 0.7rem 1.2rem; text-align: left; background: none; border: none; color: var(--text-color); transition: background-color 0.2s ease; cursor: pointer; font-size: 0.9rem; }
        #message-context-menu button:hover { background-color: var(--light-gray); }
        #message-context-menu i { margin-right: 0.75rem; width: 1em; text-align: center; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicators */
        .typing-indicator, #printing-animation, #image-generating-animation, #process-js-animation, #ollama-generating-animation, #website-generating-animation {
            display: flex; align-items: center; justify-content: flex-start; padding: 0.9rem 1.4rem; border-radius: 1.25rem; background-color: var(--message-ai-light); color: var(--message-ai-text-light); width: fit-content; margin-right: auto; box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light); animation: pulse-shadow 1.5s infinite ease-in-out; align-self: flex-start; /* Ensure alignment */
        }
        .typing-indicator span, .generating-dot { /* Unified dot style */
            display: inline-block; margin-left: 4px; width: 8px; height: 8px; border-radius: 50%; background-color: var(--dark-gray); opacity: 0.7; animation: typingDots 1.4s infinite ease-in-out;
        }
        .generating-text { margin-right: 6px; font-size: 0.95rem; }
        .typing-indicator span:nth-child(2), .generating-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3), .generating-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse-shadow { 0%, 100% { box-shadow: 0 2px 5px 0 var(--shadow-light), 0 1px 2px 0 var(--shadow-light); } 50% { box-shadow: 0 4px 8px 0 var(--shadow-light), 0 2px 4px 0 var(--shadow-light); } }
        @keyframes typingDots { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        /* --- Input Area --- */
        .chat-input-area {
            padding: 1.25rem 1.75rem;
            background-color: var(--sidebar-light); /* Match sidebar */
            border-top: 1px solid var(--light-gray);
            display: flex;
            align-items: flex-end; /* Align items to bottom for multiline input */
            gap: 0.75rem;
            box-shadow: 0 -2px 5px var(--shadow-light);
            position: relative; /* Needed for image preview positioning */
            z-index: 30;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .chat-input-area.conversation-empty { flex-direction: column; align-items: stretch; }
        #starter-messages-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .starter-message-button { padding: 0.7rem 1rem; border-radius: 0.5rem; background-color: var(--light-gray); color: var(--text-color); border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 var(--shadow-light); text-align: left; }
        .starter-message-button:hover { background-color: var(--medium-gray); transform: translateY(-2px); box-shadow: 0 2px 4px 0 var(--shadow-light); }

        .image-preview-area {
            position: absolute;
            bottom: calc(100% + 0.5rem); /* Position above input area */
            left: 1.75rem;
            background-color: var(--sidebar-light);
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 -2px 5px var(--shadow-light);
            z-index: 35;
        }
        .image-preview { max-height: 60px; border-radius: 0.3rem; margin-right: 0.5rem; box-shadow: 0 1px 3px 0 var(--shadow-light); }
        .remove-image-btn {
            position: absolute; top: -8px; right: -8px; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2); color: var(--dark-gray); font-size: 0.8rem; line-height: 1; transition: all 0.2s ease;
        }
        .remove-image-btn:hover { background-color: var(--light-gray); transform: scale(1.1); color: var(--primary-color); }

        /* Input field using textarea for multiline */
        .chat-input {
            flex-grow: 1;
            padding: 0.9rem 1.4rem;
            border: 1px solid var(--medium-gray);
            border-radius: 0.75rem;
            font-size: 1rem;
            line-height: 1.5rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: inset 0 1px 2px 0 var(--shadow-light);
            background-color: var(--background-light);
            color: var(--text-color);
            resize: none; /* Disable manual resize */
            min-height: 48px; /* Minimum height for single line */
            max-height: 150px; /* Maximum height before scroll */
            overflow-y: auto; /* Add scroll if needed */
        }
        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2), inset 0 1px 2px 0 var(--shadow-light);
        }

        /* Action Buttons in Input Area */
        .input-action-button {
            padding: 0.75rem; /* Make buttons squarer */
            width: 48px; /* Fixed width */
            height: 48px; /* Fixed height */
            border-radius: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px 0 var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem; /* Icon size */
        }
        .input-action-button:hover {
            background-color: var(--primary-color-hover);
            transform: translateY(-2px);
            box-shadow: 0 3px 7px 0 var(--shadow-light), 0 1px 3px 0 var(--shadow-light);
        }
        .input-action-button:active { transform: translateY(0px) scale(0.98); }
        .input-action-button:disabled { background-color: var(--medium-gray); cursor: not-allowed; transform: none; box-shadow: 0 2px 4px 0 var(--shadow-light); }

        .attach-button { background-color: var(--light-gray); color: var(--dark-gray); }
        .attach-button:hover { background-color: var(--medium-gray); color: var(--text-color); }
        .attach-button label { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }

        /* --- Sidebar Buttons --- */
         #new-conversation, #premium-button, #suggestions-button, #open-settings {
            margin: 0.5rem 0; padding: 0.8rem 1.2rem; border-radius: 0.5rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-size: 0.95rem; font-weight: 500; transition: all 0.2s ease; border: 1px solid transparent;
        }
        #new-conversation { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #new-conversation:hover { background-color: var(--primary-color-hover); border-color: var(--primary-color-hover); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(124, 58, 237, 0.3); }

        #premium-button { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        #premium-button:hover { background-color: #F59E0B; border-color: #F59E0B; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(251, 191, 36, 0.3); }

        #suggestions-button, #open-settings { background-color: var(--sidebar-light); color: var(--dark-gray); border: 1px solid var(--medium-gray); }
        #suggestions-button:hover, #open-settings:hover { background-color: var(--light-gray); color: var(--text-color); border-color: var(--dark-gray); transform: translateY(-2px); box-shadow: 0 2px 5px var(--shadow-light); }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--sidebar-light); border-radius: 0.8rem; padding: 2rem; max-width: 600px; width: 95%; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); transform: scale(0.95); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; overflow-y: auto; max-height: 90vh; border: 1px solid var(--light-gray); }
        .modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }
        .modal-header { font-size: 1.6rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-color); text-align: center; }
        .modal-body { margin-bottom: 1.75rem; color: var(--text-color); line-height: 1.6; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; }
        .modal-btn { padding: 0.7rem 1.4rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 1px 3px 0 var(--shadow-light); }
        .modal-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px 0 var(--shadow-light); }
        .modal-btn:active { transform: translateY(0px) scale(0.98); }
        .modal-btn-primary { background-color: var(--primary-color); color: white; }
        .modal-btn-primary:hover { background-color: var(--primary-color-hover); }
        .modal-btn-secondary { background-color: var(--light-gray); color: var(--text-color); }
        .modal-btn-secondary:hover { background-color: var(--medium-gray); }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal-body input[type="text"], .modal-body input[type="number"], .modal-body input[type="date"], .modal-body input[type="email"], .modal-body input[type="password"], .modal-body select, .modal-body textarea {
            width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--medium-gray); background-color: var(--background-light); color: var(--text-light); transition: border-color 0.2s ease, box-shadow 0.2s ease; margin-top: 0.25rem;
        }
        .modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2); }
        .modal-body textarea { min-height: 100px; resize: vertical; }

        /* Dark Mode Styles */
        body.dark {
            --background-color: var(--background-dark);
            --text-color: var(--text-dark);
            --light-gray: #374151; /* Darker Light Gray */
            --medium-gray: #4B5563; /* Darker Medium Gray */
            --dark-gray: #9CA3AF;   /* Lighter Dark Gray */
            --darker-gray: #D1D5DB; /* Lighter Darker Gray */
            --code-bg: var(--code-bg-dark);
            --shadow-light: var(--shadow-dark); /* Use dark shadow in dark mode */
            --sidebar-light: var(--sidebar-dark);
            --message-user-light: var(--message-user-dark);
            --message-ai-light: var(--message-ai-dark);
            --message-user-text-light: var(--message-user-text-dark);
            --message-ai-text-light: var(--message-ai-text-dark);
            --pinned-background-light: var(--pinned-background-dark);
            --pinned-border-light: var(--pinned-border-dark);

            --toast-success-bg: #064E3B;
            --toast-success-text: #A7F3D0;
            --toast-error-bg: #7F1D1D;
            --toast-error-text: #FECACA;
            --toast-info-bg: #1E3A8A;
            --toast-info-text: #BFDBFE;
        }
        body.dark .app-container { background-color: var(--background-dark); box-shadow: 0 8px 25px -5px var(--shadow-dark), 0 5px 10px -6px var(--shadow-dark); }
        body.dark .sidebar, body.dark .chat-input-area, body.dark .modal-content, body.dark .chat-header { border-color: var(--medium-gray); }
        body.dark .chat-input-area { background-color: var(--sidebar-dark); box-shadow: 0 -2px 5px var(--shadow-dark); }
        body.dark .chat-input { background-color: #4B5563; color: var(--text-dark); border-color: #6B7280; box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.2); }
        body.dark .chat-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3), inset 0 1px 2px 0 rgba(0,0,0,0.2); }
        body.dark .conversation-item:hover { background-color: #374151; }
        body.dark .conversation-item.active { background-color: var(--primary-color); }
        body.dark .conversation-item.active:hover { background-color: var(--primary-color-hover); }
        body.dark .modal-content { background-color: #1F2937; border-color: var(--medium-gray); }
        body.dark .modal-overlay { background-color: rgba(0, 0, 0, 0.7); }
        body.dark .message.ai-message { background-color: var(--message-ai-dark); }
        body.dark .message-content blockquote { color: var(--darker-gray); border-left-color: var(--dark-gray); }
        body.dark .starter-message-button { background-color: #374151; color: var(--text-dark); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.3); }
        body.dark .starter-message-button:hover { background-color: #4B5563; }
        body.dark .attach-button { background-color: #374151; color: #9CA3AF; }
        body.dark .attach-button:hover { background-color: #4B5563; color: var(--text-dark); }
        body.dark #new-conversation:hover { box-shadow: 0 2px 5px rgba(124, 58, 237, 0.4); }
        body.dark #premium-button:hover { box-shadow: 0 2px 5px rgba(251, 191, 36, 0.4); }
        body.dark #suggestions-button:hover, body.dark #open-settings:hover { background-color: #374151; color: var(--text-dark); border-color: #6B7280; box-shadow: 0 2px 5px var(--shadow-dark); }
        body.dark .modal-body input, body.dark .modal-body select, body.dark .modal-body textarea { background-color: #374151; border-color: #6B7280; color: var(--text-dark); }
        body.dark .modal-body input:focus, body.dark .modal-body select:focus, body.dark .modal-body textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3); }

        /* Highlight.js Dark Mode */
        body.dark .hljs { background: var(--code-bg-dark); color: #abb2bf; /* Common dark theme text color */ }
        body.dark .hljs-keyword { color: #C678DD; }
        body.dark .hljs-built_in { color: #E6C07B; }
        body.dark .hljs-string { color: #98C379; }
        body.dark .hljs-comment { color: #5C6370; font-style: italic; }
        body.dark .hljs-number { color: #D19A66; }
        body.dark .hljs-function { color: #61AFEF; }
        body.dark .hljs-title.function_ { color: #61AFEF; }
        body.dark .hljs-params { color: #ABB2BF; }
        body.dark .hljs-meta { color: #ABB2BF; }


        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--medium-gray); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--dark-gray); }
        body.dark ::-webkit-scrollbar-thumb { background-color: #4B5563; }
        body.dark ::-webkit-scrollbar-thumb:hover { background-color: #6B7280; }

        /* Pinned Conversation */
        .pinned-conversation { background-color: var(--pinned-background-light); border-left: 4px solid var(--pinned-border-light); }
        body.dark .pinned-conversation { background-color: var(--pinned-background-dark); border-left-color: var(--pinned-border-dark); color: var(--text-dark); }
        body.dark .pinned-conversation:hover { background-color: rgba(55, 48, 163, 0.8); } /* Slightly lighter dark pin */
        .pinned-conversation:hover { background-color: #FEF9C3; } /* Lighter yellow */
        .pinned-conversation.active { background-color: var(--primary-color) !important; color: white !important; border-left-color: var(--primary-color-hover) !important; }

        /* Premium Badge */
        .premium-badge { display: inline-flex; align-items: center; justify-content: center; padding: 0.15rem 0.5rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600; color: #422006; /* Darker text for badge */ background-color: var(--accent-color); margin-left: 0.5rem; vertical-align: middle; line-height: 1; animation: pulse-badge 2.5s infinite ease-in-out; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.08); opacity: 1; } }

        /* Memory Update Message */
        .memory-update-message { background-color: var(--pinned-background-light); color: #92400E; /* Darker amber text */ border: 1px solid var(--pinned-border-light); padding: 0.6rem 1.1rem; border-radius: 0.75rem; margin: 0.5rem auto; max-width: 80%; font-size: 0.9rem; text-align: center; box-shadow: 0 1px 3px 0 var(--shadow-light); animation: fadeIn 0.4s ease-out; align-self: center; /* Center horizontally */ }
        body.dark .memory-update-message { background-color: #312E81; /* Darker Indigo */ border-color: var(--pinned-border-dark); color: #C7D2FE; /* Lighter Indigo Text */ box-shadow: 0 1px 3px 0 var(--shadow-dark); }

        /* Input Validation */
        input:invalid, textarea:invalid { border-color: #EF4444 !important; }
        input:focus:invalid, textarea:focus:invalid { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3) !important; }
        .error-message { color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem; display: block; }
        .hidden { display: none !important; }

        /* Code Block Styling */
        pre { position: relative; margin-bottom: 1em; }
        code.hljs { background: var(--code-bg); color: var(--text-color); border-radius: 0.6rem; padding: 1rem; overflow-x: auto; font-size: 0.9rem; line-height: 1.4; display: block; border: 1px solid var(--light-gray); }
        body.dark code.hljs { background: var(--code-bg-dark); color: var(--text-dark); border-color: var(--medium-gray); }
        .copy-code-button {
            position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 0.3rem; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; font-size: 0.8rem; z-index: 1;
        }
        pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background-color: rgba(0, 0, 0, 0.7); }

        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; }
        .toast { background-color: #fff; color: var(--text-light); padding: 0.8rem 1.2rem; border-radius: 0.5rem; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); opacity: 0; min-width: 250px; max-width: 350px; border-left-width: 4px; border-style: solid; display: flex; align-items: center; gap: 0.5rem; animation: slideInRight 0.3s ease-out forwards, fadeOut 0.3s ease-in forwards 3.2s; }
        .toast i { font-size: 1.1rem; }
        .toast.success { border-color: var(--toast-success-border); background-color: var(--toast-success-bg); color: var(--toast-success-text); }
        .toast.error { border-color: var(--toast-error-border); background-color: var(--toast-error-bg); color: var(--toast-error-text); }
        .toast.info { border-color: var(--toast-info-border); background-color: var(--toast-info-bg); color: var(--toast-info-text); }
        body.dark .toast { box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3); }
        body.dark .toast.success { background-color: var(--toast-success-bg); color: var(--toast-success-text); }
        body.dark .toast.error { background-color: var(--toast-error-bg); color: var(--toast-error-text); }
        body.dark .toast.info { background-color: var(--toast-info-bg); color: var(--toast-info-text); }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }


        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .app-container { margin: 0; border-radius: 0; }
            .chat-area { width: 100%; }
            .sidebar-header, .sidebar-footer { padding: 1.2rem; }
            .sidebar-content { padding: 1rem; }
            .sidebar-title { font-size: 1.3rem; }
            #toggle-sidebar-desktop { display: none; } /* Hide desktop toggle */
            #toggle-sidebar { display: block; } /* Show mobile (hamburger) toggle */
            .chat-header { padding: 0.8rem; min-height: 60px; }
            .chat-title { font-size: 1.1rem; max-width: calc(100% - 120px); }
            #mobile-sidebar-toggle { display: block; /* Show mobile toggle in chat header */ margin-right: 0.5rem; padding: 0.5rem; color: var(--dark-gray); }
            .chat-messages-container { padding: 0.8rem; padding-bottom: 1rem; }
            .message { max-width: 90%; padding: 0.7rem 1rem; font-size: 0.95rem; }
            .message-wrapper { max-width: 95%; }
            .message-actions { display: none !important; } /* Hide hover actions on mobile */
            .chat-input-area { padding: 0.8rem; gap: 0.5rem; position: sticky; /* Keep input at bottom */ bottom: 0; }
            .chat-input { padding: 0.7rem 1rem; font-size: 0.95rem; min-height: 42px; max-height: 120px; }
            .input-action-button { width: 42px; height: 42px; font-size: 1rem; }
            .image-preview-area { left: 0.8rem; bottom: calc(100% + 0.5rem); }
            .modal-content { width: 90%; padding: 1.2rem; }
            .modal-header { font-size: 1.3rem; margin-bottom: 1rem; }
            #starter-messages-area { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Message Context Menu -->
    <div id="message-context-menu" class="animate__animated animate__faster" style="display:none;">
        <button id="edit-context-button"><i class="fas fa-edit"></i> Edit</button>
        <button id="copy-context-button"><i class="fas fa-copy"></i> Copy</button>
        <button id="regenerate-context-button"><i class="fas fa-sync"></i> Regenerate</button>
        <button id="delete-context-button"><i class="fas fa-trash"></i> Delete</button>
    </div>

    <!-- Modals (Welcome, Setup, Age Block, Premium Key, Premium Ad, Suggestions, Settings, Assistant, New Assistant, Edit Message) -->
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay" style="display: none;">
         <div class="modal-content animate__animated animate__fadeIn animate__faster">
            <h2 class="modal-header"><i class="fas fa-magic mr-2 text-primary-500"></i> Welcome to <span class="font-extrabold">PyroAI v2</span>!</h2>
            <div class="modal-body">
                <p class="mb-4">
                    Explore enhanced AI conversations with PyroAI v2. Before you start, please acknowledge these terms for using this platform:
                </p>
                <ul class="list-disc list-inside mb-4 space-y-1">
                    <li><span class="font-semibold">Beta Program:</span> Features are continually improving. Expect potential bugs and report them via the Feedback section.</li>
                    <li><span class="font-semibold">Conversation Logging:</span> Conversations may be logged for AI improvement and quality assurance.</li>
                    <li><span class="font-semibold">Data Sensitivity:</span> Avoid sharing sensitive personal information. PyroLLC is not responsible for user-shared data.</li>
                    <li><span class="font-semibold">Service "As Is":</span> Provided without warranties. We strive for excellence but cannot guarantee uninterrupted service.</li>
                    <li><span class="font-semibold">Terms Agreement:</span> By using PyroAI, you agree to these terms.</li>
                </ul>
                <p>Thank you for being part of the PyroAI community!</p>
            </div>
            <div class="modal-footer">
                <button id="accept-terms" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-check-circle mr-2"></i> I Accept & Enter PyroAI
                </button>
            </div>
        </div>
    </div>

    <!-- Initial Setup Modal -->
    <div id="initial-setup-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-user-cog mr-2 text-primary-500"></i> Setup Your PyroAI Account</h2>
            <div class="modal-body">
                <p class="mb-6">Personalize your experience. This helps tailor interactions and keep things organized.</p>
                <div class="mb-4">
                    <label for="setup-username"><i class="fas fa-user mr-2"></i>Username</label>
                    <input type="text" id="setup-username" placeholder="Choose a username (3-20 chars)" required minlength="3" maxlength="20">
                    <p id="username-error" class="error-message hidden">Username must be 3-20 characters.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-dob"><i class="fas fa-calendar-alt mr-2"></i>Date of Birth</label>
                    <input type="date" id="setup-dob" required>
                    <p id="dob-error" class="error-message hidden">Please select your date of birth.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-email"><i class="fas fa-envelope mr-2"></i>Email Address (Optional)</label>
                    <input type="email" id="setup-email" placeholder="Your email for recovery (optional)">
                    <p id="email-error" class="error-message hidden">Invalid email format.</p>
                </div>
                <div class="mb-4">
                    <label for="setup-pin"><i class="fas fa-lock mr-2"></i>Create PIN (4 digits)</label>
                    <input type="password" id="setup-pin" placeholder="4-digit PIN for security" required pattern="[0-9]{4}" inputmode="numeric" maxlength="4">
                    <p id="pin-error" class="error-message hidden">PIN must be exactly 4 digits.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="complete-setup" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-check-circle mr-2"></i> Complete Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Age Block Modal -->
    <div id="age-block-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-ban mr-2 text-red-500"></i> Access Denied</h2>
            <div class="modal-body">
                <p class="mb-4">You must be 18 years or older to use PyroAI. Access is restricted.</p>
            </div>
            <div class="modal-footer">
                <button id="close-age-block" class="modal-btn modal-btn-secondary w-full">
                    <i class="fas fa-times-circle mr-2"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Key Modal -->
    <div id="premium-key-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-crown mr-2 text-yellow-500"></i> Activate Premium</h2>
            <div class="modal-body">
                <p class="mb-4">Enter your Premium Key to unlock enhanced features.</p>
                <div class="mb-4">
                    <label for="premium-key-input"><i class="fas fa-key mr-2"></i> Premium Key</label>
                    <input type="text" id="premium-key-input" placeholder="Enter your premium key">
                </div>
                <div id="premium-key-status" class="error-message hidden"><i class="fas fa-exclamation-triangle mr-1"></i> Invalid key. Please try again.</div>
            </div>
            <div class="modal-footer">
                <button id="cancel-premium-key" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="activate-premium" class="modal-btn modal-btn-primary"><i class="fas fa-lock-open mr-2"></i> Activate</button>
            </div>
        </div>
    </div>

    <!-- Premium Ad Modal -->
    <div id="premium-ad-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__fadeIn">
            <h2 class="modal-header"><i class="fas fa-gift mr-2 text-yellow-500"></i> PyroAI Premium - Unlock More!</h2>
            <div class="modal-body">
                <p class="mb-4"> Enhance your experience and remove limitations by upgrading!</p>
                <div class="overflow-x-auto mb-4 rounded-lg border border-gray-200 dark:border-gray-600">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-3 py-2 border-b-2 border-gray-200 dark:border-gray-600 text-left text-xs font-semibold uppercase tracking-wider">Feature</th>
                                <th class="px-3 py-2 border-b-2 border-gray-200 dark:border-gray-600 text-center text-xs font-semibold uppercase tracking-wider">Free</th>
                                <th class="px-3 py-2 border-b-2 border-gray-200 dark:border-gray-600 text-center text-xs font-semibold uppercase tracking-wider">Premium</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows remain the same as v14 -->
                            <tr>
                                <td class="px-3 py-3 text-sm">Messages per Chat</td>
                                <td class="px-3 py-3 text-sm text-center">15</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center">40</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 text-sm">Max Conversations</td>
                                <td class="px-3 py-3 text-sm text-center">3</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center"><i class="fas fa-infinity"></i></td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 text-sm">Daily Messages</td>
                                <td class="px-3 py-3 text-sm text-center">10</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center">100</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 text-sm">Daily Images/Files</td>
                                <td class="px-3 py-3 text-sm text-center">3</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center">20</td>
                            </tr>
                             <tr>
                                <td class="px-3 py-3 text-sm">Message Characters</td>
                                <td class="px-3 py-3 text-sm text-center">1,000</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center">10,000</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 text-sm">AI Models</td>
                                <td class="px-3 py-3 text-sm text-center">UltraLight</td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center">All Models</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-3 text-sm">Image Generation</td>
                                <td class="px-3 py-3 text-sm text-center"><i class="fas fa-times text-red-500"></i></td>
                                <td class="px-3 py-3 text-sm font-semibold text-primary-500 text-center"><i class="fas fa-check text-green-500"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p class="text-sm">Upgrade for more messages, conversations, advanced models, and image generation!</p>
            </div>
            <div class="modal-footer">
                <button id="close-premium-ad" class="modal-btn modal-btn-secondary"><i class="fas fa-times-circle mr-2"></i> Continue Free</button>
                <button id="go-premium-ad" class="modal-btn modal-btn-primary"><i class="fas fa-crown mr-2"></i> Go Premium</button>
            </div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div id="suggestions-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-comment-dots mr-2"></i> Suggestions & Complaints</h2>
            <div class="modal-body">
                <p class="mb-4">We value your feedback! Share your suggestions or complaints to help us improve.</p>
                <div class="mb-4">
                    <label for="suggestion-textarea"><i class="fas fa-pen-alt mr-2"></i> Your Feedback</label>
                    <textarea id="suggestion-textarea" rows="5" placeholder="Enter your feedback here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-suggestions" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="suggestions-send" class="modal-btn modal-btn-primary"><i class="fas fa-paper-plane mr-2"></i> Send Feedback</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-cog mr-2"></i> Settings</h2>
            <div class="modal-body space-y-5">
                 <div>
                    <label for="theme"><i class="fas fa-palette mr-2"></i> Theme</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
                 <div>
                    <label for="message-history-limit"><i class="fas fa-history mr-2"></i> Message History Limit (per chat)</label>
                    <input type="number" id="message-history-limit" value="50" min="10" max="100">
                </div>
                 <div>
                    <label for="ai-model"><i class="fas fa-brain mr-2"></i> Gemini API Model</label>
                    <select id="ai-model">
                        {/* Options loaded by JS */}
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Select the Gemini model (Premium required for Pro/Max).</p>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                     <div class="flex items-center mb-3">
                        <input type="checkbox" id="ollama-enabled" class="mr-2 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <label for="ollama-enabled" class="font-medium flex items-center"><i class="fas fa-server mr-2"></i> Enable Ollama API (Local)</label>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Use a local Ollama server instead of Google's Gemini API.</p>
                     <div id="ollama-settings" class="space-y-4 hidden pl-4 border-l-2 border-gray-200 dark:border-gray-600 ml-2">
                         <div>
                            <label for="ollama-api-url"><i class="fas fa-link mr-2"></i> Ollama API URL</label>
                            <input type="text" id="ollama-api-url" placeholder="http://localhost:11434">
                        </div>
                        <div>
                            <label for="ollama-model"><i class="fas fa-laptop-code mr-2"></i> Ollama Model</label>
                            <select id="ollama-model">
                                {/* Options remain the same as v14 */}
                                <option value="deepseek-r1:8b">deepseek-r1:8b</option>
                                <option value="qwen2.5-coder:7b">qwen2.5-coder:7b</option>
                                <option value="qwen2.5-coder:14b">qwen2.5-coder:14b</option>
                                <option value="gemma2:2b-instruct-q8_0">gemma2:2b-instruct-q8_0</option>
                                <option value="deepseek-r1:14b">deepseek-r1:14b</option>
                                <option value="deepseek-r1:1.5b">deepseek-r1:1.5b</option>
                                <option value="qwen2.5-coder:1.5b">qwen2.5-coder:1.5b</option>
                                <option value="huihui_ai/deepseek-r1-abliterated:latest">Uncensorred R1</option>
                            </select>
                        </div>
                     </div>
                </div>
                 <div>
                    <label for="ai-assistant-mode"><i class="fas fa-magic mr-2"></i> New Assistant Prompt Mode</label>
                    <select id="ai-assistant-mode">
                        <option value="auto">Auto-generate Prompt</option>
                        <option value="manual">Manual Prompt</option>
                    </select>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                    <label><i class="fas fa-memory mr-2"></i> Memory Management</label>
                    <div id="memory-list" class="mt-2 text-sm max-h-40 overflow-y-auto bg-gray-50 dark:bg-gray-700 p-3 rounded border border-gray-200 dark:border-gray-600">
                        {/* Memory items loaded by JS */}
                    </div>
                     <button id="clear-memory" class="modal-btn modal-btn-secondary mt-3 w-full text-sm py-2">
                        <i class="fas fa-trash mr-2"></i> Clear All Memories
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-settings" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="save-settings" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Change Assistant Modal -->
    <div id="assistant-modal" class="modal-overlay" style="display: none;">
         <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-robot mr-2"></i> AI Assistants</h2>
            <div id="assistant-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 modal-body max-h-[60vh] overflow-y-auto p-1">
                 <!-- Assistant cards loaded by JS -->
            </div>
            <div class="modal-footer flex-col items-stretch space-y-2">
                 <button id="new-assistant" class="modal-btn modal-btn-primary w-full">
                    <i class="fas fa-plus mr-2"></i> New Assistant
                </button>
                <div class="flex gap-2">
                    <button id="import-assistant" class="modal-btn modal-btn-secondary flex-1">
                        <i class="fas fa-file-import mr-2"></i> Import
                    </button>
                     <button id="export-assistants" class="modal-btn modal-btn-secondary flex-1">
                        <i class="fas fa-file-export mr-2"></i> Export All
                    </button>
                </div>
                <button id="close-assistant-modal" class="modal-btn modal-btn-secondary w-full"><i class="fas fa-times mr-2"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- New/Edit Assistant Modal -->
    <div id="new-assistant-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 id="new-assistant-modal-title" class="modal-header"><i class="fas fa-plus-circle mr-2"></i> Create New Assistant</h2>
            <div class="modal-body space-y-4">
                <input type="hidden" id="editing-assistant-id">
                <div>
                    <label for="assistant-name"><i class="fas fa-user-tag mr-2"></i> Assistant Name</label>
                    <input type="text" id="assistant-name" placeholder="e.g., Code Helper, Story Writer">
                </div>
                <div>
                    <label for="assistant-description"><i class="fas fa-info-circle mr-2"></i> Description (Optional)</label>
                    <input type="text" id="assistant-description" placeholder="Short description for identification">
                </div>
                <div id="prompt-mode-manual-area">
                    <label for="assistant-prompt"><i class="fas fa-file-alt mr-2"></i> System Prompt</label>
                    <textarea id="assistant-prompt" rows="6" placeholder="Define the AI's role, personality, and instructions..."></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Clearly define behavior and capabilities.</p>
                </div>
                 <div id="prompt-mode-auto-area" class="hidden text-center p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-md">
                    <p class="text-gray-700 dark:text-gray-300 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i> Generating system prompt...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-new-assistant" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="generate-assistant-prompt" class="modal-btn modal-btn-secondary" style="display:none;"><i class="fas fa-magic mr-2"></i> Generate Prompt</button>
                <button id="save-new-assistant" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save Assistant</button>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content animate__animated animate__zoomIn">
            <h2 class="modal-header"><i class="fas fa-edit mr-2"></i> Edit Message</h2>
            <div class="modal-body">
                <label for="edit-message-textarea"><i class="fas fa-pen-to-square mr-2"></i> Edit your message below:</label>
                <textarea id="edit-message-textarea" rows="6"></textarea>
            </div>
            <div class="modal-footer">
                <button id="cancel-edit-message" class="modal-btn modal-btn-secondary"><i class="fas fa-ban mr-2"></i> Cancel</button>
                <button id="save-edit-message" class="modal-btn modal-btn-primary"><i class="fas fa-save mr-2"></i> Save & Re-run</button>
            </div>
        </div>
    </div>


    <!-- Main App Layout -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo-area">
                    <h1 class="sidebar-title animate__animated animate__fadeInLeft animate__faster"><i class="fas fa-fire text-primary-500 mr-2"></i> <span>PyroAI</span></h1>
                </div>
                <!-- Desktop Toggle Button -->
                <button id="toggle-sidebar-desktop" class="hidden md:block" aria-label="Toggle Sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
                 <!-- Mobile Toggle Button (Hamburger) -->
                 <button id="toggle-sidebar" class="md:hidden" aria-label="Toggle Sidebar">
                    <i class="fas fa-times"></i> <!-- Close icon when open -->
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Pinned Conversations -->
                 <div class="animate__animated animate__fadeInLeft animate__fast">
                    <h2 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-thumbtack text-gray-500 dark:text-gray-400 mr-3"></i> <span>Pinned</span></h2>
                    <ul id="pinned-list" class="conversation-list mb-4"></ul>
                </div>

                <!-- Regular Conversations -->
                <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.1s">
                    <h2 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-comments text-gray-500 dark:text-gray-400 mr-3"></i> <span>Chats</span></h2>
                    <div class="relative mb-3">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-500 dark:text-gray-400"></i>
                        </div>
                        <input type="text" id="search-conversations" class="chat-input w-full pl-10 py-2 text-sm" placeholder="Search chats...">
                    </div>
                    <ul id="conversation-list" class="conversation-list"></ul>
                </div>

                 <!-- Archived Conversations -->
                <div class="animate__animated animate__fadeInLeft animate__fast animate__delay-0.2s mt-4">
                    <h2  class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-archive text-gray-500 dark:text-gray-400 mr-3"></i> <span>Archived</span></h2>
                    <ul id="archived-list" class="archived-list"></ul>
                </div>
            </div>

            <div class="sidebar-footer animate__animated animate__fadeInLeft animate__fast animate__delay-0.3s space-y-2">
                 <div class="user-profile mb-2 flex items-center justify-center text-sm text-gray-700 dark:text-gray-300">
                     <i class="fas fa-user-circle mr-2"></i>
                    <span id="sidebar-username">User</span><span id="premium-user-badge"></span>
                </div>
                <button id="new-conversation">
                    <i class="fas fa-plus mr-2"></i> <span>New Chat</span>
                </button>
                <button id="premium-button" style="display: none;">
                    <i class="fas fa-crown mr-2"></i> <span>Go Premium</span>
                </button>
                <button id="suggestions-button">
                    <i class="fas fa-comment-dots mr-2"></i> <span>Feedback</span>
                </button>
                <button id="open-settings">
                    <i class="fas fa-cog mr-2"></i> <span>Settings</span>
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <!-- Chat Header -->
            <header class="chat-header">
                <div class="flex items-center">
                    <button id="mobile-sidebar-toggle" class="md:hidden" aria-label="Open Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="current-conversation-title" class="chat-title animate__animated animate__fadeIn animate__faster">Select or Start a Chat</h2>
                </div>
                <div class="flex items-center animate__animated animate__fadeIn animate__faster">
                    <button id="change-assistant" class="modal-btn modal-btn-secondary py-2 px-3 text-sm">
                        <i class="fas fa-robot"></i><span class="hidden md:inline-block ml-2">Assistant</span>
                    </button>
                     <!-- Regenerate Last Response Button (Optional Header Placement) -->
                     <button id="regenerate-header-button" class="modal-btn modal-btn-secondary py-2 px-3 text-sm ml-2" title="Regenerate last response" style="display: none;">
                        <i class="fas fa-sync"></i><span class="hidden md:inline-block ml-2">Regenerate</span>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages-container">
                {/* Placeholder for typing indicators */}
                <div id="printing-animation" class="printing-animation" style="display: none;">
                    <span class="generating-text">Thinking</span><span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                 <div id="image-generating-animation" class="image-generating-animation" style="display: none;">
                    <i class="fas fa-image mr-2 animate-pulse"></i> <span class="generating-text">Drawing image</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                <div id="ollama-generating-animation" class="ollama-generating-animation" style="display: none;">
                    <i class="fas fa-server mr-2 animate-pulse"></i> <span class="generating-text">Ollama generating</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                 <div id="website-generating-animation" class="website-generating-animation" style="display: none;">
                    <i class="fas fa-code mr-2 animate-pulse"></i> <span class="generating-text">Generating website code</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                <div id="process-js-animation" class="process-js-animation" style="display: none;">
                    <i class="fas fa-calculator mr-2 animate-pulse"></i> <span class="generating-text">Processing JS</span> <span class="generating-dot"></span><span class="generating-dot"></span><span class="generating-dot"></span>
                </div>
                {/* Messages will be appended before these indicators */}
            </div>

            <!-- Input Area -->
            <div id="chat-input-area" class="chat-input-area conversation-empty">
             
                <div id="starter-messages-area" class="starter-messages-area"></div>

                <div id="image-preview-area" class="image-preview-area hidden animate__animated animate__fadeInUp">
                    <img id="preview-image" class="image-preview" src="#" alt="Image Preview">
                    <button id="remove-preview-image" class="remove-image-btn" aria-label="Remove Image">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="flex items-end gap-3 w-full">

                    <button id="attach-button-wrapper" class="input-action-button attach-button" aria-label="Attach File">
                        <label for="file-upload"><i class="fas fa-paperclip"></i></label>
                    </button>
                    <input type="file" id="file-upload" class="hidden"/>

                    <textarea id="user-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>

                    <button id="send-button" class="input-action-button" aria-label="Send Message (Gemini API)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="ollama-send-button" class="input-action-button hidden" aria-label="Send Message (Ollama API)">
                        <i class="fas fa-server"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai",
                "dompurify": "https://cdn.jsdelivr.net/npm/dompurify/+esm"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <script type="module">
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
        import DOMPurify from "dompurify";

        // --- Global Variables & DOM Elements ---
        let genAI = null;
        let model = null;
        let selectedImageFile = null;
        let selectedFile = null; // For non-image files
        let editingMessageId = null;
        let messageRateLimitTimeout = null;
        let lastMessageTime = 0;
        let messageContextMenu = document.getElementById('message-context-menu');
        let contextMenuTargetMessage = null;
        let ollamaEnabled = false;
        let messageCooldown = false;
        let sidebarCollapsed = false;
        let conversations = [];
        let currentConversation = null;
        let settings = {};
        let assistants = [];
        let userData = null;
        let plan = 'free'; // Default plan
        let usageCounters = {};
        let memory = {};
        let conversationMessageCount = 0;
        let MESSAGE_LIMIT, MAX_CONVERSATIONS, DAILY_MESSAGE_LIMIT, DAILY_IMAGE_LIMIT, MAX_MESSAGE_CHARS;
        let messageCooldownTimeout;
        let touchTimer;
        let touchStartTime = 0;
        var sortable; // Sortable instance

        // Telegram Bot Config
        const chatId = "1462667287"; // Replace with your Chat ID
        const botToken = "7764621104:AAFoMeFLI4hVLc36vqOPIefUeRt1kzFD6zE"; // Replace with your Bot Token

        // API URLs
        const PREMIUM_KEYS_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/keys.txt';
        const API_KEY_URL = 'https://raw.githubusercontent.com/pyroalww/newsfetch/refs/heads/main/api.txt';
        let premiumKeys = [];
        let defaultApiKey = '';

        // Model Constants
        const FREE_MODEL_LITE = 'gemini-1.5-flash-latest'; // Adjusted free model
        const FREE_MODEL_FLASH = 'gemini-1.5-flash-latest'; // Use same flash for manual free
        const PREMIUM_MODELS = [
            'gemini-1.5-flash-latest', // PyroAI Flash
            'gemini-pro',             // PyroAI Pro
            'gemini-1.5-pro-latest'   // PyroAI Max (Example)
        ];

        // Starter Messages
        const starterMessages = [
            "Tell me something interesting",
            "Explain black holes like I'm five",
            "Write a haiku about coding",
            "Suggest a healthy recipe",
            "What is the capital of Australia?"
        ];

        // DOM Element Cache
        const el = {
            chatMessages: document.getElementById('chat-messages'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            ollamaSendButton: document.getElementById('ollama-send-button'),
            newConversationButton: document.getElementById('new-conversation'),
            premiumButton: document.getElementById('premium-button'),
            suggestionsButton: document.getElementById('suggestions-button'),
            conversationList: document.getElementById('conversation-list'),
            pinnedList: document.getElementById('pinned-list'),
            archivedList: document.getElementById('archived-list'),
            currentConversationTitle: document.getElementById('current-conversation-title'),
            sidebar: document.getElementById('sidebar'),
            toggleSidebarDesktopButton: document.getElementById('toggle-sidebar-desktop'),
            toggleSidebarMobileButton: document.getElementById('toggle-sidebar'),
            mobileSidebarToggleChat: document.getElementById('mobile-sidebar-toggle'),
            fileUploadInput: document.getElementById('file-upload'),
            settingsModal: document.getElementById('settings-modal'),
            openSettingsButton: document.getElementById('open-settings'),
            closeSettingsButton: document.getElementById('close-settings'),
            saveSettingsButton: document.getElementById('save-settings'),
            changeAssistantButton: document.getElementById('change-assistant'),
            assistantModal: document.getElementById('assistant-modal'),
            assistantList: document.getElementById('assistant-list'),
            newAssistantButton: document.getElementById('new-assistant'),
            closeAssistantModalButton: document.getElementById('close-assistant-modal'),
            newAssistantModal: document.getElementById('new-assistant-modal'),
            cancelNewAssistantButton: document.getElementById('cancel-new-assistant'),
            saveNewAssistantButton: document.getElementById('save-new-assistant'),
            generateAssistantPromptButton: document.getElementById('generate-assistant-prompt'),
            welcomeModal: document.getElementById('welcome-modal'),
            acceptTermsButton: document.getElementById('accept-terms'),
            searchConversationsInput: document.getElementById('search-conversations'),
            imagePreviewArea: document.getElementById('image-preview-area'),
            previewImageElement: document.getElementById('preview-image'),
            removePreviewImageButton: document.getElementById('remove-image-button'),
            printingAnimation: document.getElementById('printing-animation'),
            imageGeneratingAnimation: document.getElementById('image-generating-animation'),
            ollamaGeneratingAnimation: document.getElementById('ollama-generating-animation'),
            websiteGeneratingAnimation: document.getElementById('website-generating-animation'),
            processJsAnimation: document.getElementById('process-js-animation'),
            editMessageModal: document.getElementById('edit-message-modal'),
            cancelEditMessageButton: document.getElementById('cancel-edit-message'),
            saveEditMessageButton: document.getElementById('save-edit-message'),
            editMessageTextarea: document.getElementById('edit-message-textarea'),
            initialSetupModal: document.getElementById('initial-setup-modal'),
            setupUsernameInput: document.getElementById('setup-username'),
            setupDobInput: document.getElementById('setup-dob'),
            setupEmailInput: document.getElementById('setup-email'),
            setupPinInput: document.getElementById('setup-pin'),
            completeSetupButton: document.getElementById('complete-setup'),
            ageBlockModal: document.getElementById('age-block-modal'),
            closeAgeBlockButton: document.getElementById('close-age-block'),
            premiumKeyModal: document.getElementById('premium-key-modal'),
            premiumKeyInputModal: document.getElementById('premium-key-input'),
            activatePremiumButton: document.getElementById('activate-premium'),
            cancelPremiumKeyButton: document.getElementById('cancel-premium-key'),
            premiumKeyStatus: document.getElementById('premium-key-status'),
            premiumAdModal: document.getElementById('premium-ad-modal'),
            goPremiumAdButton: document.getElementById('go-premium-ad'),
            closePremiumAdButton: document.getElementById('close-premium-ad'),
            sidebarUsername: document.getElementById('sidebar-username'),
            premiumUserBadge: document.getElementById('premium-user-badge'),
            assistantNameInput: document.getElementById('assistant-name'),
            assistantDescriptionInput: document.getElementById('assistant-description'),
            assistantPromptTextarea: document.getElementById('assistant-prompt'),
            usernameError: document.getElementById('username-error'),
            dobError: document.getElementById('dob-error'),
            emailError: document.getElementById('email-error'),
            pinError: document.getElementById('pin-error'),
            clearMemoryButton: document.getElementById('clear-memory'),
            memoryListElement: document.getElementById('memory-list'),
            importAssistantButton: document.getElementById('import-assistant'),
            exportAssistantsButton: document.getElementById('export-assistants'),
            starterMessagesArea: document.getElementById('starter-messages-area'),
            chatInputArea: document.getElementById('chat-input-area'),
            editContextButton: document.getElementById('edit-context-button'),
            copyContextButton: document.getElementById('copy-context-button'),
            regenerateContextButton: document.getElementById('regenerate-context-button'),
            deleteContextButton: document.getElementById('delete-context-button'),
            aiAssistantModeSelect: document.getElementById('ai-assistant-mode'),
            promptModeManualArea: document.getElementById('prompt-mode-manual-area'),
            promptModeAutoArea: document.getElementById('prompt-mode-auto-area'),
            ollamaEnabledCheckbox: document.getElementById('ollama-enabled'),
            ollamaSettingsDiv: document.getElementById('ollama-settings'),
            ollamaApiUrlInput: document.getElementById('ollama-api-url'),
            ollamaModelSelect: document.getElementById('ollama-model'),
            toastContainer: document.getElementById('toast-container'),
            suggestionsModal: document.getElementById('suggestions-modal'),
            suggestionsSendButton: document.getElementById('suggestions-send'),
            cancelSuggestionsButton: document.getElementById('cancel-suggestions'),
            suggestionTextarea: document.getElementById('suggestion-textarea'),
            newAssistantModalTitle: document.getElementById('new-assistant-modal-title'),
            editingAssistantIdInput: document.getElementById('editing-assistant-id'),
            regenerateHeaderButton: document.getElementById('regenerate-header-button')
        };

        // --- Initialization ---
        initializeApp();

        async function initializeApp() {
            console.log("PyroAI Initializing...");
            showToast('Initializing PyroAI...', 'info');
            sendToTelegramBot('Site visited. Initializing...');

            loadSettings(); // Load settings first
            loadUserData(); // Load user data
            loadPlan(); // Load plan status *after* user data/settings might influence it
            loadUsageCounters();
            checkDailyLimitsReset(); // Reset if needed
            loadMemory();
            loadAssistants();

            await fetchDefaultApiKey(); // Fetch API key for Gemini
            await fetchPremiumKeys(); // Fetch premium keys

            updatePlanUI(); // Update UI based on loaded plan
            updateSidebarUI(); // Update user info/badge
            updateMemoryListUI(); // Display memory
            applySettings(); // Apply theme, configure model visibility
            // initializeModel() is called within applySettings

            loadConversations();
            if (conversations.length === 0) {
                createNewConversation(); // Creates and switches
            } else {
                updateConversationList();
                // Switch to the last active non-archived conversation or the first non-archived one
                const lastActiveId = localStorage.getItem('lastActiveConversationId');
                let conversationToLoad = conversations.find(c => c.id == lastActiveId && !c.archived);
                if (!conversationToLoad) {
                    conversationToLoad = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived);
                }
                switchConversation(conversationToLoad || conversations[0]); // Fallback to first if all archived
            }

            setupEventListeners();
            initializeSortable();
            autoSizeTextarea(); // Initial size check

            // Handle initial modals (Welcome/Setup)
            if (localStorage.getItem('ageBlocked') === 'true') {
                showAgeBlockModal();
            } else if (!userData) {
                showInitialSetupModal();
            } else if (localStorage.getItem('termsAccepted') !== 'true') {
                showWelcomeModal();
            } else {
                console.log("User data and terms accepted.");
                showToast('PyroAI Ready!', 'success');
            }

            console.log("PyroAI Initialization Complete.");
        }

        function setupEventListeners() {
            // --- Core Chat ---
            el.sendButton.addEventListener('click', () => sendMessage('gemini'));
            el.ollamaSendButton.addEventListener('click', () => sendMessage('ollama'));
            el.userInput.addEventListener('keypress', handleInputKeypress);
            el.userInput.addEventListener('input', autoSizeTextarea); // Auto-resize textarea
            el.userInput.addEventListener('focus', handleInputFocus);
            el.fileUploadInput.addEventListener('change', handleFileUpload);
            el.removePreviewImageButton?.addEventListener('click', clearImagePreview);
            el.regenerateHeaderButton.addEventListener('click', regenerateLastResponse);


            // --- Sidebar & Conversations ---
            el.newConversationButton.addEventListener('click', createNewConversation);
            el.searchConversationsInput.addEventListener('input', debounce(updateConversationList, 300));
            el.toggleSidebarDesktopButton.addEventListener('click', toggleSidebar);
            el.toggleSidebarMobileButton.addEventListener('click', toggleSidebar);
            el.mobileSidebarToggleChat.addEventListener('click', toggleSidebar);


            // --- Modals & Settings ---
            el.premiumButton.addEventListener('click', showPremiumKeyModal);
            el.suggestionsButton.addEventListener('click', openSuggestionsModal);
            el.cancelSuggestionsButton.addEventListener('click', closeSuggestionsModal);
            el.suggestionsSendButton.addEventListener('click', sendSuggestions);
            el.openSettingsButton.addEventListener('click', openSettings);
            el.closeSettingsButton.addEventListener('click', closeSettings);
            el.saveSettingsButton.addEventListener('click', saveSettingsChanges);
            el.clearMemoryButton.addEventListener('click', clearAllMemory);
            el.memoryListElement.addEventListener('click', handleMemoryDelete);
            el.ollamaEnabledCheckbox.addEventListener('change', toggleOllamaSettingsVisibility);

            // --- Assistant Management ---
            el.changeAssistantButton.addEventListener('click', openAssistantModal);
            el.closeAssistantModalButton.addEventListener('click', closeAssistantModal);
            el.newAssistantButton.addEventListener('click', () => openNewAssistantModal()); // No args for new
            el.cancelNewAssistantButton.addEventListener('click', closeNewAssistantModal);
            el.saveNewAssistantButton.addEventListener('click', saveNewAssistant);
            el.generateAssistantPromptButton.addEventListener('click', generateAiAssistantPrompt);
            el.exportAssistantsButton.addEventListener('click', exportAssistants);
            el.importAssistantButton.addEventListener('click', triggerAssistantImport);

            // --- Initial Setup & Terms ---
            el.acceptTermsButton.addEventListener('click', acceptTerms);
            el.completeSetupButton.addEventListener('click', completeInitialSetup);
            el.closeAgeBlockButton.addEventListener('click', closeAgeBlockModal);

            // --- Premium Activation ---
            el.activatePremiumButton.addEventListener('click', activatePremiumPlan);
            el.cancelPremiumKeyButton.addEventListener('click', closePremiumKeyModal);
            el.goPremiumAdButton.addEventListener('click', () => { closePremiumAdModal(); showPremiumKeyModal(); });
            el.closePremiumAdButton.addEventListener('click', closePremiumAdModal);

            // --- Message Editing ---
            el.cancelEditMessageButton.addEventListener('click', cancelEditMessage);
            el.saveEditMessageButton.addEventListener('click', saveEditMessage);

            // --- Context Menu ---
            el.editContextButton.addEventListener('click', handleContextMenuAction);
            el.copyContextButton.addEventListener('click', handleContextMenuAction);
            el.regenerateContextButton.addEventListener('click', handleContextMenuAction);
            el.deleteContextButton.addEventListener('click', handleContextMenuAction);

            // --- Global Listeners ---
            document.addEventListener('click', handleGlobalClick);
            window.addEventListener('resize', handleWindowResize);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme); // Listen for system theme changes
        }


        // --- Loading Functions ---
        function loadSettings() {
            settings = JSON.parse(localStorage.getItem('settings')) || {
                messageHistoryLimit: 50,
                aiModel: FREE_MODEL_LITE, // Default free model
                theme: 'system', // Default to system theme
                aiAssistantMode: 'auto',
                ollamaEnabled: false,
                ollamaApiUrl: 'http://localhost:11434',
                ollamaModel: 'deepseek-r1:8b'
            };
            console.log("Settings loaded:", settings);
        }
        function loadUserData() {
            userData = JSON.parse(localStorage.getItem('userData')) || null;
            console.log("User data loaded:", userData);
        }
        function loadPlan() {
            // Load plan *after* potential overrides or checks
            plan = localStorage.getItem('plan') || 'free';
            console.log("Plan loaded:", plan);
        }
        function loadUsageCounters() {
             usageCounters = JSON.parse(localStorage.getItem('usageCounters')) || {
                dailyMessages: 0,
                dailyImages: 0, // Includes files
                conversationsCreated: 0, // Track created convos for free limit
                lastResetDate: null
            };
             console.log("Usage counters loaded:", usageCounters);
        }
        function loadMemory() {
            memory = JSON.parse(localStorage.getItem('memory')) || {};
            console.log("Memory loaded:", Object.keys(memory).length, "items");
        }
        function loadAssistants() {
            assistants = JSON.parse(localStorage.getItem('assistants')) || [
                // Default Assistant (Always Present)
                { id: 'default', name: 'PyroAI Assistant', description: 'General purpose AI helper.', prompt: `You are PyroAI, a helpful and friendly AI assistant.
                Capabilities:
                - Engage in natural conversation.
                - Generate images: Use <imageGen:"Detailed English prompt">.
                - Generate basic website code: Respond ONLY with valid HTML starting <!DOCTYPE html>.
                - Execute JavaScript for calculations/tasks: Use <processJS:"JavaScript code returning a value">. Example: <processJS:"Math.random() * 100">. The result will be sent back to you.
                - Remember user facts: Use <Memory:"key:value"> to store information.
                User: ${userData?.username || 'User'}. Maintain context and continuity.`
                },
                 { id: 'code-helper', name: 'Code Helper', description: 'Assists with programming questions.', prompt: `You are a specialized Code Helper AI. Provide accurate code examples, explain programming concepts clearly, and help debug code snippets. Prioritize clarity and correctness. You can use <processJS:"..."> for simple code execution examples if needed. User: ${userData?.username || 'User'}.` }
            ];
             console.log("Assistants loaded:", assistants.length, "assistants");
        }
        function loadConversations() {
            conversations = JSON.parse(localStorage.getItem('conversations')) || [];
            // Basic validation/migration if needed in future
            conversations.forEach(conv => {
                if (!conv.messages) conv.messages = [];
                if (conv.archived === undefined) conv.archived = false;
                if (conv.pinned === undefined) conv.pinned = false;
                 if (!conv.assistant) conv.assistant = 'default';
            });
             console.log("Conversations loaded:", conversations.length, "conversations");
        }


        // --- Saving Functions ---
        function saveSettings() { localStorage.setItem('settings', JSON.stringify(settings)); console.log("Settings saved.");}
        function saveUserData() { localStorage.setItem('userData', JSON.stringify(userData)); console.log("User data saved.");}
        function savePlan() { localStorage.setItem('plan', plan); console.log("Plan saved:", plan); }
        function saveUsageCounters() { localStorage.setItem('usageCounters', JSON.stringify(usageCounters)); console.log("Usage counters saved."); }
        function saveMemory() { localStorage.setItem('memory', JSON.stringify(memory)); console.log("Memory saved."); }
        function saveAssistants() { localStorage.setItem('assistants', JSON.stringify(assistants)); console.log("Assistants saved."); }
        function saveConversations() { localStorage.setItem('conversations', JSON.stringify(conversations)); console.log("Conversations saved."); }


        // --- API & Network ---
        async function fetchDefaultApiKey() {
            try {
                const response = await fetch(API_KEY_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const base64ApiKey = await response.text();
                defaultApiKey = atob(base64ApiKey.trim());
                console.log("Default API Key fetched successfully.");
                // Initialize model now that key is available
                initializeModel();
            } catch (error) {
                console.error("Failed to fetch default API key:", error);
                showToast("Error fetching API configuration.", 'error');
                sendToTelegramBot(`CRITICAL: Failed to fetch default API key: ${error.message}`, 'error');
            }
        }

        async function fetchPremiumKeys() {
            try {
                const response = await fetch(PREMIUM_KEYS_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                premiumKeys = text.trim().split('\n').map(key => key.trim()).filter(Boolean);
                 console.log("Premium keys fetched:", premiumKeys.length, "keys");
            } catch (error) {
                console.error("Failed to fetch premium keys:", error);
                premiumKeys = []; // Ensure it's empty on failure
                sendToTelegramBot(`Warning: Failed to fetch premium keys: ${error.message}`, 'warning');
            }
        }

        function initializeModel() {
            ollamaEnabled = settings.ollamaEnabled;
            if (!ollamaEnabled) {
                // --- Gemini API Setup ---
                if (!defaultApiKey) {
                    console.warn("Gemini API key not available. AI features disabled.");
                    showToast("Gemini API key missing. AI features disabled.", "error");
                     el.sendButton.disabled = true;
                     el.sendButton.classList.remove('hidden');
                     el.ollamaSendButton.classList.add('hidden');
                    return; // Stop if no key
                }

                let currentModelId = settings.aiModel;
                // Enforce free model if not premium
                if (plan === 'free' && !PREMIUM_MODELS.slice(0, 1).includes(currentModelId)) { // Only allow first model (Flash) for free
                     console.log(`Free plan detected. Forcing model to ${FREE_MODEL_FLASH}`);
                     currentModelId = FREE_MODEL_FLASH;
                     settings.aiModel = currentModelId; // Update setting state
                     // Update UI dropdown if settings modal is open (or next time it opens)
                     const modelSelect = document.getElementById('ai-model');
                     if (modelSelect) modelSelect.value = currentModelId;
                     saveSettings(); // Save the corrected setting
                }

                try {
                    genAI = new GoogleGenerativeAI(defaultApiKey);
                    model = genAI.getGenerativeModel({
                        model: currentModelId,
                        safetySettings: [ // Relax safety settings (Use with caution!)
                            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE }
                        ],
                        // generationConfig: { // Example: Adjust temperature
                        //     temperature: 0.7,
                        // }
                    });
                    console.log("Gemini model initialized:", currentModelId);
                    el.sendButton.disabled = false;
                    el.sendButton.classList.remove('hidden');
                    el.ollamaSendButton.classList.add('hidden');
                } catch (error) {
                    console.error("Error initializing Gemini model:", error);
                    showToast(`Error initializing AI model: ${error.message}`, "error");
                    sendToTelegramBot(`ERROR: Failed to initialize Gemini model (${currentModelId}): ${error.message}`, 'error');
                    el.sendButton.disabled = true;
                }

            } else {
                // --- Ollama API Setup ---
                genAI = null; // Ensure Gemini is not used
                model = null;
                console.log("Ollama API mode enabled. Model:", settings.ollamaModel, "URL:", settings.ollamaApiUrl);
                el.sendButton.classList.add('hidden');
                el.ollamaSendButton.classList.remove('hidden');
                 el.ollamaSendButton.disabled = !settings.ollamaApiUrl; // Disable if URL missing
            }
        }

        // --- Core Chat Logic ---

        function handleInputKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent newline
                if (!settings.ollamaEnabled) {
                    sendMessage('gemini');
                } else {
                    sendMessage('ollama');
                }
            }
        }
         function handleInputFocus() {
             if (!currentConversation || currentConversation.messages.length === 0) {
                el.chatInputArea.classList.add('conversation-empty');
                updateStarterMessagesArea(); // Show starters on focus if empty
            }
         }

        function autoSizeTextarea() {
            const textarea = el.userInput;
            textarea.style.height = 'auto'; // Temporarily shrink
            // Set height based on scroll height, but capped at max-height
            const newHeight = Math.min(textarea.scrollHeight, parseInt(window.getComputedStyle(textarea).maxHeight));
            textarea.style.height = `${newHeight}px`;
        }


        async function sendMessage(apiType = 'gemini') {
            let messageText = el.userInput.value.trim();
            messageText = DOMPurify.sanitize(messageText); // Sanitize user input

            if (!currentConversation) {
                showToast("Select or start a chat first.", 'error');
                return;
            }
            if (!messageText && !selectedImageFile && !selectedFile) {
                showToast("Enter a message or attach a file.", 'info');
                return;
            }

            // --- Check Limits ---
            if (!checkMessageLimit()) { showPremiumAdModal("messageHistoryLimit"); return; }
            if (!checkDailyMessageLimit()) { showPremiumAdModal("dailyMessageLimit"); return; }
            if ((selectedImageFile || selectedFile) && !checkDailyImageLimit()) { showPremiumAdModal("dailyImageLimit"); return; }
            if (messageText.length > MAX_MESSAGE_CHARS) { showPremiumAdModal("messageCharLimit"); return; }

            // --- Check API Configuration ---
            if (apiType === 'gemini' && (!genAI || !model)) { showToast("Gemini AI not initialized. Check settings or API key.", 'error'); return; }
            if (apiType === 'ollama' && !settings.ollamaApiUrl) { showToast("Ollama API URL not configured in settings.", 'error'); return; }

            // --- Cooldown Check ---
            if (messageCooldown) { showToast('Please wait a moment...', 'info'); return; }
            startCooldown();

            // --- Prepare and Add User Message ---
            const userMessageId = Date.now();
            const userMessageData = {
                id: userMessageId,
                text: messageText,
                sender: 'user',
                timestamp: Date.now(),
                image: null,
                file: null
            };

            let imageDataUrl = null;
            let fileData = null;

            if (selectedImageFile) {
                imageDataUrl = await readFileAsDataURL(selectedImageFile);
                userMessageData.image = imageDataUrl; // Store Data URL for display
                 userMessageData.text = messageText || "Image attached"; // Add placeholder text if none provided
            } else if (selectedFile) {
                // Store basic file info, Data URL if needed for display/preview
                fileData = { name: selectedFile.name, type: selectedFile.type, size: selectedFile.size };
                 // fileData.url = await readFileAsDataURL(selectedFile); // Optional: Read if needed for preview
                userMessageData.file = fileData;
                userMessageData.text = messageText || `File attached: ${selectedFile.name}`;
            }

            addMessageToChat(userMessageData);
            currentConversation.messages.push(userMessageData);
            conversationMessageCount++;
            usageCounters.dailyMessages++;
            if (selectedImageFile || selectedFile) usageCounters.dailyImages++;

            // Reset input & save state
            el.userInput.value = '';
            autoSizeTextarea(); // Reset height
            clearImagePreview();
            clearFileInput();
            saveConversations();
            saveUsageCounters();
            sendUserMessageLog(userMessageData); // Log user message

            // --- Trigger AI Response ---
             el.regenerateHeaderButton.style.display = 'none'; // Hide regenerate during generation
            NProgress.start();
            if (apiType === 'gemini') {
                await getGeminiResponse(userMessageData);
            } else {
                await getOllamaResponse(); // Ollama uses full history
            }
            NProgress.done();
             el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none'; // Show if possible
        }

        async function getGeminiResponse(userMessageData) {
            showIndicator('gemini');
            try {
                const { history, systemInstruction } = prepareGeminiContext();
                const chat = model.startChat({ history, systemInstruction });

                let contentParts = [];
                if (userMessageData.text) {
                    contentParts.push({ text: userMessageData.text });
                }
                if (userMessageData.image && selectedImageFile) { // Pass image data if present
                     try {
                        const generativePart = await fileToGenerativePart(selectedImageFile);
                        contentParts.push(generativePart);
                     } catch (fileError) {
                         console.error("Error processing image file for Gemini:", fileError);
                         throw new Error("Failed to process attached image."); // Propagate error
                     }
                }
                // Note: Gemini doesn't directly process arbitrary files like Ollama might.
                // If a non-image file was attached, its info is in userMessageData.text.

                if (contentParts.length === 0) {
                    throw new Error("No content to send to AI.");
                }

                const result = await chat.sendMessage(contentParts);
                let aiResponseText = result.response.text();
                const aiMessageId = Date.now() + 1; // Ensure unique ID

                // --- Process AI Response for Special Tags ---
                aiResponseText = await processMemoryTags(aiResponseText, aiMessageId);

                const imageGenMatch = aiResponseText.match(/<imageGen:"([^"]*)"\/?\>/);
                const processJsMatch = aiResponseText.match(/<processJS:"([^"]*)"\/?\>/);
                const websiteCodeMatch = aiResponseText.match(/<!DOCTYPE html>([\s\S]*?)<\/html>/i);

                if (imageGenMatch) {
                    const imagePrompt = imageGenMatch[1];
                    aiResponseText = aiResponseText.replace(imageGenMatch[0], '').trim();
                    if (aiResponseText) addAiTextMessage(aiResponseText, aiMessageId); // Add text part if exists
                    await generateAndDisplayImage(imagePrompt, aiMessageId + 1);
                } else if (processJsMatch) {
                    const jsCode = processJsMatch[1];
                    aiResponseText = aiResponseText.replace(processJsMatch[0], '').trim();
                     if (aiResponseText) addAiTextMessage(aiResponseText, aiMessageId);
                    await executeAndDisplayJs(jsCode, aiMessageId + 1);
                } else if (websiteCodeMatch) {
                     const websiteCode = websiteCodeMatch[0];
                     aiResponseText = aiResponseText.replace(websiteCodeMatch[0], '').trim(); // Remove code
                     if (aiResponseText) addAiTextMessage(aiResponseText, aiMessageId);
                     addWebsitePreviewMessage(websiteCode, aiMessageId + 1);
                }
                else if (aiResponseText) { // Standard text response
                     addAiTextMessage(aiResponseText, aiMessageId);
                }

            } catch (error) {
                console.error("Error generating Gemini content:", error);
                const errorText = `Sorry, I encountered an error: ${error.message}`;
                addAiTextMessage(errorText, Date.now() + 1, true); // Add as error message
                showToast(`AI Error: ${error.message}`, 'error');
                sendToTelegramBot(`ERROR (Gemini): ${error.message} in conv ${currentConversation?.id}`, 'error');
            } finally {
                removeIndicator();
                selectedImageFile = null; // Clear file after processing
                selectedFile = null;
            }
        }

        async function getOllamaResponse() {
            showIndicator('ollama');
            try {
                const messagesForOllama = currentConversation.messages.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.text,
                    // Include image data if Ollama model supports it (e.g., LLaVA)
                    images: msg.image ? [msg.image.split(',')[1]] : undefined // Pass base64 if image exists
                })).filter(msg => msg.content || msg.images); // Filter out potentially empty messages


                const ollamaResponse = await fetch(`${settings.ollamaApiUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: settings.ollamaModel,
                        messages: messagesForOllama,
                        stream: false // Keep stream false for simplicity now
                    })
                });

                if (!ollamaResponse.ok) {
                     const errorBody = await ollamaResponse.text();
                    throw new Error(`Ollama API error! Status: ${ollamaResponse.status}. Body: ${errorBody}`);
                }

                const ollamaData = await ollamaResponse.json();
                const aiResponseText = ollamaData?.message?.content || "Received empty response from Ollama.";
                const aiMessageId = Date.now() + 1;

                // Ollama responses likely won't have the custom tags, but process just in case
                const cleanedText = await processMemoryTags(aiResponseText, aiMessageId);
                 addAiTextMessage(cleanedText, aiMessageId);

            } catch (error) {
                console.error("Error generating Ollama content:", error);
                 const errorText = `Sorry, I encountered an error with the local AI: ${error.message}`;
                addAiTextMessage(errorText, Date.now() + 1, true); // Add as error message
                showToast(`Local AI Error: ${error.message}`, 'error');
                sendToTelegramBot(`ERROR (Ollama): ${error.message} in conv ${currentConversation?.id}`, 'error');
            } finally {
                removeIndicator();
                 selectedImageFile = null; // Clear file after processing
                 selectedFile = null;
            }
        }

        function prepareGeminiContext() {
             const selectedAssistant = assistants.find(a => a.id === currentConversation.assistant) || assistants[0];
             let systemPromptText = selectedAssistant.prompt.replace('${userData?.username || \'User\'}', userData?.username || 'User'); // Inject username


             // Add Memory Context
             if (Object.keys(memory).length > 0) {
                let memoryContext = "\n\n--- User Memory ---\n";
                for (const key in memory) {
                     // Simple key: value format for prompt
                    memoryContext += `- ${key}: ${memory[key]}\n`;
                }
                systemPromptText += memoryContext;
             }
             // Add Date/Time Context
             systemPromptText += `\nCurrent Date & Time: ${new Date().toLocaleString()}`;

             const systemInstruction = {
                parts: [{ text: systemPromptText }]
             };

             // Prepare History (limit based on settings)
             const historyLimit = settings.messageHistoryLimit || 50;
             const recentMessages = currentConversation.messages.slice(-historyLimit);

             const history = recentMessages.map(msg => {
                let parts = [];
                if(msg.text) parts.push({ text: msg.text });
                // Image parts are handled in sendMessage, not usually needed in history *text*
                return {
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: parts
                };
             }).filter(msg => msg.parts.length > 0); // Filter out messages with no text part

             return { history, systemInstruction };
        }

         async function processMemoryTags(responseText, baseMessageId) {
            const memoryRegex = /<Memory:"([^"]*):([^"]*)"\/?\>/g;
            let match;
            let cleanedText = responseText;
            let memoryUpdates = [];

            while ((match = memoryRegex.exec(responseText)) !== null) {
                const key = match[1]?.trim();
                const value = match[2]?.trim();
                if (key && value) {
                    memory[key] = value;
                    memoryUpdates.push({ key, value });
                    cleanedText = cleanedText.replace(match[0], ''); // Remove tag
                    console.log(`Memory updated: ${key} = ${value}`);
                }
            }

            if (memoryUpdates.length > 0) {
                saveMemory();
                updateMemoryListUI();
                // Add a separate notification message for memory updates
                const updateMsgText = `Memory Updated: ${memoryUpdates.map(upd => `${upd.key} set to ${upd.value}`).join(', ')}`;
                addMessageToChat({
                    id: baseMessageId - 0.5, // Ensure it appears before the main response
                    text: updateMsgText,
                    sender: 'ai', // Or a special 'system' sender?
                    timestamp: Date.now(),
                    messageType: 'memoryUpdate' // Special type for styling
                });
                 sendToTelegramBot(`Memory updated in conv ${currentConversation?.id}: ${JSON.stringify(memoryUpdates)}`);
            }
            return cleanedText.trim();
        }

        async function generateAndDisplayImage(prompt, messageId) {
            showIndicator('image');
            try {
                 if (plan !== 'premium') {
                    showPremiumAdModal("imageGeneration");
                    throw new Error("Image generation requires Premium plan.");
                 }
                // Using Pollinations.ai as an example proxy
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                // Optional: Fetch the image data directly to store it or handle errors
                // const imageResponse = await fetch(imageUrl);
                // if (!imageResponse.ok) throw new Error(`Image generation failed (status: ${imageResponse.status})`);
                // const imageBlob = await imageResponse.blob();
                // const imageObjectURL = URL.createObjectURL(imageBlob);
                // For simplicity, directly using the URL in <img> src
                const imageData = {
                    id: messageId,
                    text: `Image generated for: "${prompt}"`, // Add description
                    sender: 'ai',
                    image: imageUrl, // Use direct URL
                    timestamp: Date.now(),
                    messageType: 'imageGen'
                };
                addMessageToChat(imageData);
                currentConversation.messages.push(imageData);
                saveConversations();
                 conversationMessageCount++; // Count as a message turn
                sendToTelegramBot(`AI generated image in conv ${currentConversation.id}`, 'info', `Prompt: ${prompt}`);

            } catch (error) {
                console.error("Error generating image:", error);
                const errorText = `Sorry, couldn't generate image: ${error.message}`;
                 addAiTextMessage(errorText, messageId, true);
                 showToast(`Image Generation Error: ${error.message}`, 'error');
                 sendToTelegramBot(`ERROR (Image Gen): ${error.message} in conv ${currentConversation.id}`, 'error');
            } finally {
                removeIndicator();
            }
        }

        async function executeAndDisplayJs(jsCode, messageId) {
             showIndicator('js');
             try {
                const result = await evaluateJavascript(jsCode);
                const resultMessageData = {
                    id: messageId,
                    text: `JavaScript Execution Result:\n\`\`\`javascript\n${String(result)}\n\`\`\``, // Format result in code block
                    sender: 'ai',
                    timestamp: Date.now(),
                    messageType: 'processJsResult'
                };
                 addMessageToChat(resultMessageData);
                 currentConversation.messages.push(resultMessageData);
                 saveConversations();
                 conversationMessageCount++; // Count as a message turn
                 sendToTelegramBot(`JS executed in conv ${currentConversation.id}`, 'info', `Code: ${jsCode}\nResult: ${result}`);

             } catch (error) {
                 console.error("Error processing JavaScript:", error);
                 const errorText = `Error executing JavaScript: ${error.message}`;
                 addAiTextMessage(errorText, messageId, true);
                 showToast(`JS Execution Error: ${error.message}`, 'error');
                 sendToTelegramBot(`ERROR (JS Exec): ${error.message} in conv ${currentConversation.id}`, 'error');
             } finally {
                 removeIndicator();
             }
        }

        function addWebsitePreviewMessage(websiteCode, messageId) {
            const websiteData = {
                id: messageId,
                text: websiteCode, // Store the raw code
                sender: 'ai',
                timestamp: Date.now(),
                messageType: 'websiteCode' // Specific type for rendering
            };
             addMessageToChat(websiteData);
             currentConversation.messages.push(websiteData);
             saveConversations();
             conversationMessageCount++; // Count as a message turn
             sendToTelegramBot(`AI generated website code in conv ${currentConversation.id}`);
        }


         // Helper to add standard AI text messages
        function addAiTextMessage(text, messageId, isError = false) {
            const messageData = {
                id: messageId,
                text: text,
                sender: 'ai',
                timestamp: Date.now(),
                messageType: isError ? 'error' : 'text'
            };
            addMessageToChat(messageData);
            currentConversation.messages.push(messageData);
            saveConversations();
            conversationMessageCount++; // Count as a message turn
            if (!isError) {
                 sendAiResponseLog(messageData); // Log normal AI response
            }
        }


        // --- UI & Display ---

        function addMessageToChat(messageData) {
            const { id, text, sender, image, timestamp, file, messageType = 'text' } = messageData;

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${sender === 'user' ? 'user-message-wrapper' : 'ai-message-wrapper'}`;
            // Add context menu listeners
            messageWrapper.addEventListener('contextmenu', (event) => handleContextMenu(event, id, sender));
            messageWrapper.addEventListener('touchstart', (event) => handleTouchStart(event, id, sender));
            messageWrapper.addEventListener('touchend', handleTouchEnd);

            const messageElement = document.createElement('div');
             // Base classes + sender + type-specific class
            messageElement.className = `message ${sender}-message message-content ${messageType}-message animate__animated animate__fadeInUp`;
            messageElement.dataset.messageId = id;

            // --- Content Rendering based on messageType ---
             if (messageType === 'memoryUpdate') {
                messageElement.className = 'memory-update-message animate__animated animate__fadeInUp'; // Override class
                messageElement.innerHTML = `<i class="fas fa-brain mr-2"></i> ${text}`;
            }
             else if (messageType === 'imageGen') {
                 if (text && !text.startsWith("Image generated for:")) messageElement.innerHTML = `<p>${marked.parseInline(text)}</p>`; // Display text if provided
                 const img = document.createElement('img');
                 img.src = image;
                 img.className = 'message-image rounded-lg mt-2';
                 img.alt = 'Generated Image';
                 img.onerror = () => { img.alt = 'Error loading image'; img.src = ''; }; // Basic error handling
                 messageElement.appendChild(img);
             }
             else if (messageType === 'websiteCode') {
                 // Website Preview Rendering
                 messageElement.innerHTML = `
                    <div class="website-preview-header-chat">
                        <span class="title"><i class="fas fa-code mr-2"></i> index.html Preview</span>
                        <div class="actions">
                            <button onclick="window.downloadWebsiteCode('${id}')" title="Download HTML"><i class="fas fa-download"></i></button>
                            <button onclick="window.openWebsiteInNewTab('${id}')" title="Open in New Tab"><i class="fas fa-external-link-alt"></i></button>
                        </div>
                    </div>
                    <iframe class="website-preview-iframe" sandbox="allow-scripts allow-same-origin allow-popups" srcdoc="${text}"></iframe>
                 `;
                 // Add specific class for no padding
                 messageElement.classList.add('website-code-message');

             } else if (image) { // User image upload
                 messageElement.innerHTML = `<p>${marked.parseInline(text || "Image Uploaded")}</p>`; // Display text or placeholder
                 const img = document.createElement('img');
                 img.src = image; // data URL
                 img.className = 'message-image rounded-lg mt-2';
                 img.alt = 'User Uploaded Image';
                 messageElement.appendChild(img);
             } else if (file) { // User file upload
                 messageElement.innerHTML = `<p>${marked.parseInline(text)}</p>`;
                 const fileLink = document.createElement('a');
                 // fileLink.href = file.url; // Only if data URL was read and needed
                 fileLink.textContent = file.name;
                 // fileLink.download = file.name; // Download might not work with Data URLs depending on browser/size
                 fileLink.className = 'message-file';
                 fileLink.title = `Type: ${file.type}, Size: ${(file.size / 1024).toFixed(1)} KB`;
                 fileLink.innerHTML = `<i class="fas fa-file-alt mr-2"></i> ${file.name}`;
                 messageElement.appendChild(fileLink);
            } else { // Standard text message (user or AI)
                 // Use marked.parse for AI, escape HTML for user input? No, rely on DOMPurify earlier.
                 const renderedHtml = marked.parse(text || "");
                 messageElement.innerHTML = renderedHtml;
             }

            // Add actions (regenerate, delete, edit) - outside the content part
            const actionsDiv = createMessageActions(id, sender);
            if (actionsDiv) messageElement.appendChild(actionsDiv);

            messageWrapper.appendChild(messageElement);

            // Timestamp
            if (timestamp) {
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatTimestamp(timestamp);
                messageWrapper.appendChild(timeElement);
            }

            // Insert before indicators and scroll
            el.chatMessages.insertBefore(messageWrapper, el.printingAnimation);
            scrollToBottom();

            // Highlight code blocks within the new message
            messageElement.querySelectorAll('pre code').forEach(highlightCodeBlock);

            // Update regenerate button state
             el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
        }

        function createMessageActions(messageId, sender) {
            // Don't add actions to memory update messages
             if (document.querySelector(`.message[data-message-id='${messageId}']`)?.classList.contains('memory-update-message')) {
                 return null;
             }

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            let buttons = '';

            if (sender === 'user') {
                buttons = `
                    <button class="message-action-button edit-button" title="Edit message" data-action="edit" data-message-id="${messageId}"><i class="fas fa-edit"></i></button>
                    <button class="message-action-button delete-button" title="Delete message" data-action="delete" data-message-id="${messageId}"><i class="fas fa-trash"></i></button>
                `;
            } else { // AI message
                 buttons = `
                    <button class="message-action-button copy-button" title="Copy message" data-action="copy" data-message-id="${messageId}"><i class="fas fa-copy"></i></button>
                    <button class="message-action-button regenerate-button" title="Regenerate response" data-action="regenerate" data-message-id="${messageId}"><i class="fas fa-sync"></i></button>
                    <button class="message-action-button delete-button" title="Delete message" data-action="delete" data-message-id="${messageId}"><i class="fas fa-trash"></i></button>
                `;
            }
            actionsDiv.innerHTML = buttons;

             // Add event listeners directly here
             actionsDiv.querySelectorAll('button').forEach(button => {
                 button.addEventListener('click', handleMessageActionClick);
             });

            return actionsDiv;
        }

        function handleMessageActionClick(event) {
             event.stopPropagation(); // Prevent message wrapper click
             const button = event.currentTarget;
             const action = button.dataset.action;
             const messageId = parseInt(button.dataset.messageId); // Ensure it's a number
             const messageElement = el.chatMessages.querySelector(`.message[data-message-id='${messageId}']`);

             console.log(`Action: ${action}, Message ID: ${messageId}`);

             hideContextMenu(); // Hide context menu if open

             switch (action) {
                 case 'edit':
                     editPrompt(messageId, messageElement);
                     break;
                 case 'delete':
                     deleteOutput(messageId);
                     break;
                 case 'regenerate':
                     regenerateOutput(messageId);
                     break;
                 case 'copy':
                     copyMessageToClipboard(messageId, messageElement);
                     break;
             }
        }


        function highlightCodeBlock(block) {
            hljs.highlightElement(block);
            // Add copy button if not already present
            if (!block.parentNode.querySelector('.copy-code-button')) {
                 const copyButton = document.createElement('button');
                 copyButton.className = 'copy-code-button';
                 copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                 copyButton.onclick = () => copyCodeToClipboard(block.textContent);
                 block.parentNode.style.position = 'relative'; // Ensure parent is positioned
                 block.parentNode.appendChild(copyButton);
            }
        }

        // --- Context Menu Logic ---
        function handleContextMenu(event, messageId, sender) {
             event.preventDefault();
             contextMenuTargetMessage = messageId;
             const isUserMessage = sender === 'user';
             const isAiMessage = sender === 'ai'; // Or other AI types

             el.editContextButton.style.display = isUserMessage ? 'block' : 'none';
             el.copyContextButton.style.display = isAiMessage ? 'block' : 'none'; // Only allow copying AI messages? Or both? Let's allow both for now.
             el.regenerateContextButton.style.display = isAiMessage ? 'block' : 'none'; // Only regenerate AI messages
             el.deleteContextButton.style.display = 'block'; // Allow deleting both

             positionContextMenu(event);
             showContextMenu();
        }
        function handleTouchStart(event, messageId, sender) {
            touchStartTime = Date.now();
            touchTimer = setTimeout(() => {
                handleContextMenu(event.touches[0], messageId, sender); // Use touch event position
            }, 500); // Long press duration
        }
        function handleTouchEnd() { clearTimeout(touchTimer); }
        function positionContextMenu(event) {
             const menu = messageContextMenu;
             const clickX = event.clientX;
             const clickY = event.clientY;
             const screenW = window.innerWidth;
             const screenH = window.innerHeight;
             const menuW = menu.offsetWidth;
             const menuH = menu.offsetHeight;

             menu.style.left = `${(clickX + menuW > screenW) ? screenW - menuW - 5 : clickX}px`;
             menu.style.top = `${(clickY + menuH > screenH) ? screenH - menuH - 5 : clickY}px`;
        }
        function showContextMenu() {
            messageContextMenu.style.display = 'block';
            messageContextMenu.classList.add('animate__fadeIn');
             // Add global listener to hide menu
             // Defined in setupEventListeners as handleGlobalClick
        }
        function hideContextMenu() {
            if (messageContextMenu.style.display === 'block') {
                messageContextMenu.style.display = 'none';
                messageContextMenu.classList.remove('animate__fadeIn');
                contextMenuTargetMessage = null;
                // Remove global listener to hide menu
                // Done within handleGlobalClick itself
            }
        }
        function handleGlobalClick(event) {
             // Hide context menu if clicked outside
             if (messageContextMenu.style.display === 'block' && !messageContextMenu.contains(event.target)) {
                 hideContextMenu();
             }
             // Hide mobile sidebar if clicked outside
              if (window.innerWidth < 768 && el.sidebar.classList.contains('active') && !el.sidebar.contains(event.target) && !el.mobileSidebarToggleChat.contains(event.target)) {
                 toggleSidebar();
             }
        }
        function handleContextMenuAction(event) {
             const action = event.currentTarget.id.replace('-context-button', '');
             const messageId = contextMenuTargetMessage;
             const messageElement = el.chatMessages.querySelector(`.message[data-message-id='${messageId}']`);
             hideContextMenu(); // Hide menu after action selected

             if (!messageId || !messageElement) return;

             switch (action) {
                 case 'edit': editPrompt(messageId, messageElement); break;
                 case 'copy': copyMessageToClipboard(messageId, messageElement); break;
                 case 'regenerate': regenerateOutput(messageId); break;
                 case 'delete': deleteOutput(messageId); break;
             }
        }

        // --- Message Actions ---
        function editPrompt(messageId) {
             const message = currentConversation.messages.find(msg => msg.id === messageId);
             if (!message || message.sender !== 'user') return; // Only edit user messages

             editingMessageId = messageId;
             el.editMessageTextarea.value = message.text;
             showModal(el.editMessageModal);
        }
        function cancelEditMessage() { hideModal(el.editMessageModal); editingMessageId = null; }
        async function saveEditMessage() {
            const editedMessageText = DOMPurify.sanitize(el.editMessageTextarea.value.trim());
            if (!editedMessageText || editingMessageId === null) {
                showToast("Message cannot be empty.", 'info');
                return;
            }

            const messageIndex = currentConversation.messages.findIndex(msg => msg.id === editingMessageId);
            if (messageIndex === -1 || currentConversation.messages[messageIndex].sender !== 'user') {
                 cancelEditMessage();
                 return; // Should not happen if edit button only appears on user messages
            }

            // --- Update the user message ---
            currentConversation.messages[messageIndex].text = editedMessageText;
            currentConversation.messages[messageIndex].timestamp = Date.now(); // Update timestamp? Optional.

            // Update the DOM for the user message
            const userMessageElement = el.chatMessages.querySelector(`.message[data-message-id='${editingMessageId}']`);
            if (userMessageElement) {
                 userMessageElement.innerHTML = marked.parse(editedMessageText) + userMessageElement.querySelector('.message-actions')?.outerHTML || ''; // Re-render and keep actions
                 userMessageElement.querySelectorAll('pre code').forEach(highlightCodeBlock); // Re-highlight if needed
                 // Update timestamp display if shown
                 const timeElement = userMessageElement.closest('.message-wrapper')?.querySelector('.message-time');
                 if (timeElement) timeElement.textContent = formatTimestamp(Date.now());
            }

             // --- Remove subsequent AI messages ---
             const messagesToRemove = [];
             const wrappersToRemove = [];
             let subsequentMessages = currentConversation.messages.slice(messageIndex + 1);

             subsequentMessages.forEach((msg, idx) => {
                 messagesToRemove.push(msg.id);
                 const wrapper = el.chatMessages.querySelector(`.message[data-message-id='${msg.id}']`)?.closest('.message-wrapper');
                 if (wrapper) wrappersToRemove.push(wrapper);
             });

             // Remove from array
             currentConversation.messages.splice(messageIndex + 1);
             // Remove from DOM
             wrappersToRemove.forEach(wrapper => wrapper.remove());

             saveConversations();
             hideModal(el.editMessageModal);
             showToast('Message updated. Re-running...', 'info');
             sendToTelegramBot(`User message ${editingMessageId} edited in conv ${currentConversation.id}`);

             // --- Re-run the prompt ---
              el.regenerateHeaderButton.style.display = 'none'; // Hide regenerate during generation
             NProgress.start();
             if (!settings.ollamaEnabled) {
                 await getGeminiResponse(currentConversation.messages[messageIndex]); // Re-run with updated user data
             } else {
                 await getOllamaResponse(); // Re-run with full updated history
             }
             NProgress.done();
             editingMessageId = null;
              el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none'; // Show if possible
        }

        function deleteOutput(messageId) {
             if (!confirm("Delete this message? This cannot be undone.")) return;

             const messageIndex = currentConversation.messages.findIndex(msg => msg.id === messageId);
             if (messageIndex !== -1) {
                 const messageWrapper = el.chatMessages.querySelector(`.message[data-message-id='${messageId}']`)?.closest('.message-wrapper');

                 // Adjust message count if AI message deleted
                 if (currentConversation.messages[messageIndex].sender !== 'user') {
                     conversationMessageCount--;
                 }

                 currentConversation.messages.splice(messageIndex, 1);
                 if (messageWrapper) messageWrapper.remove();
                 saveConversations();
                 showToast('Message deleted.', 'success');
                 sendToTelegramBot(`Message ${messageId} deleted from conv ${currentConversation.id}`);
                 // Update regenerate button state
                 el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';
             }
        }

        async function regenerateOutput(aiMessageId) {
             const aiMessageIndex = currentConversation.messages.findIndex(msg => msg.id === aiMessageId);

             // Find the preceding user message
             let userMessageIndex = -1;
             for (let i = aiMessageIndex - 1; i >= 0; i--) {
                 if (currentConversation.messages[i].sender === 'user') {
                     userMessageIndex = i;
                     break;
                 }
             }

             if (userMessageIndex === -1) {
                 showToast("Cannot regenerate: No preceding user message found.", 'error');
                 console.error("Regenerate failed: Could not find user message before AI message ID", aiMessageId);
                 return;
             }

             const userMessageData = currentConversation.messages[userMessageIndex];

             showToast('Regenerating response...', 'info');

             // Remove the AI message being regenerated and any subsequent messages
             const messagesToRemove = [];
             const wrappersToRemove = [];
             let subsequentMessages = currentConversation.messages.slice(aiMessageIndex);

             subsequentMessages.forEach((msg) => {
                 messagesToRemove.push(msg.id);
                 const wrapper = el.chatMessages.querySelector(`.message[data-message-id='${msg.id}']`)?.closest('.message-wrapper');
                 if (wrapper) wrappersToRemove.push(wrapper);
                 // Decrement count for each non-user message removed
                 if (msg.sender !== 'user') conversationMessageCount--;
             });

             // Remove from array (starting from the AI message index)
             currentConversation.messages.splice(aiMessageIndex);
             // Remove from DOM
             wrappersToRemove.forEach(wrapper => wrapper.remove());

             saveConversations(); // Save after removal
             sendToTelegramBot(`Regenerating response for message ${aiMessageId} in conv ${currentConversation.id}`);

             // --- Trigger AI again with the preceding user message ---
             el.regenerateHeaderButton.style.display = 'none'; // Hide regenerate during generation
             NProgress.start();
             if (!settings.ollamaEnabled) {
                 await getGeminiResponse(userMessageData); // Pass the user message data that prompted the original AI response
             } else {
                 await getOllamaResponse(); // Ollama uses full history, which is now truncated correctly
             }
             NProgress.done();
             el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none'; // Show if possible
        }

        function regenerateLastResponse() {
            if (!currentConversation) return;
            const lastMessage = currentConversation.messages[currentConversation.messages.length - 1];
            if (lastMessage && lastMessage.sender !== 'user') { // Check if last msg is from AI
                regenerateOutput(lastMessage.id);
            } else {
                showToast("Last message is not an AI response.", "info");
            }
        }

        function canRegenerate() {
             if (!currentConversation || currentConversation.messages.length === 0) return false;
             const lastMessage = currentConversation.messages[currentConversation.messages.length - 1];
             return lastMessage.sender !== 'user'; // Can regenerate if the last message is from AI
        }


        function copyMessageToClipboard(messageId, messageElement) {
             // Find the actual content container, excluding actions etc.
             const contentElement = messageElement.querySelector('.message-content') || messageElement;
             // Basic text extraction, might need refinement for complex HTML
             const messageText = contentElement.innerText || contentElement.textContent;

             navigator.clipboard.writeText(messageText).then(() => {
                 showToast('Message copied!', 'success');
             }).catch(err => {
                 console.error('Failed to copy message:', err);
                 showToast('Failed to copy message.', 'error');
             });
        }

        function copyCodeToClipboard(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied!', 'success');
            }).catch(err => {
                console.error('Failed to copy code:', err);
                showToast('Failed to copy code.', 'error');
            });
        }

        // Website preview helpers
         window.downloadWebsiteCode = function(messageId) {
            const message = currentConversation?.messages.find(msg => msg.id == messageId && msg.messageType === 'websiteCode');
            if (message) {
                const blob = new Blob([message.text], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'index.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Website code downloaded!', 'success');
            }
        }
         window.openWebsiteInNewTab = function(messageId) {
             const message = currentConversation?.messages.find(msg => msg.id == messageId && msg.messageType === 'websiteCode');
             if (message) {
                 const newTab = window.open();
                 newTab.document.open();
                 newTab.document.write(message.text);
                 newTab.document.close();
                 showToast('Website opened in new tab!', 'success');
             }
        }


        // --- Sidebar & Conversation Management ---

        function createNewConversation() {
            if (plan !== 'premium' && conversations.filter(c => !c.archived).length >= MAX_CONVERSATIONS) {
                 showPremiumAdModal("conversationLimit");
                return;
            }

            const newConversation = {
                id: Date.now(),
                name: 'New Chat', // Default name
                messages: [],
                assistant: 'default', // Default assistant
                createdAt: Date.now(),
                archived: false,
                pinned: false,
            };
            conversations.unshift(newConversation); // Add to the beginning
            saveConversations(); // Save immediately
            updateConversationList(); // Update UI
            switchConversation(newConversation); // Switch to the new one
            // Don't increment usageCounters.conversationsCreated here, let it be natural
            sendToTelegramBot(`New conversation created: ${newConversation.id}`);
        }

        function updateConversationList() {
            const searchTerm = el.searchConversationsInput.value.toLowerCase();

            // Separate conversations into pinned, normal, and archived
            const pinnedConvs = conversations.filter(c => c.pinned && !c.archived);
            const normalConvs = conversations.filter(c => !c.pinned && !c.archived);
            const archivedConvs = conversations.filter(c => c.archived);

             // Sort each section (newest first)
             pinnedConvs.sort((a, b) => b.createdAt - a.createdAt);
             normalConvs.sort((a, b) => b.createdAt - a.createdAt);
             archivedConvs.sort((a, b) => b.createdAt - a.createdAt);


            // Filter based on search term
            const filterConv = (conv) =>
                conv.name.toLowerCase().includes(searchTerm) ||
                conv.messages.some(msg => msg.text && msg.text.toLowerCase().includes(searchTerm));

            const displayList = (listElement, convs, isArchived = false) => {
                listElement.innerHTML = '';
                const filtered = convs.filter(filterConv);
                filtered.forEach(conv => {
                    const li = createConversationListItem(conv, isArchived);
                    listElement.appendChild(li);
                });
                 // Show/hide the parent container (the div holding the h2 and ul)
                 listElement.parentElement.style.display = filtered.length > 0 ? 'block' : 'none';
            };

            displayList(el.pinnedList, pinnedConvs);
            displayList(el.conversationList, normalConvs);
            displayList(el.archivedList, archivedConvs, true);

             // Make lists sortable (if not mobile)
             initializeSortableLists();
        }


        function createConversationListItem(conv, isArchived) {
             const li = document.createElement('li');
             li.className = `conversation-item ${currentConversation?.id === conv.id ? 'active' : ''} ${conv.pinned ? 'pinned-conversation' : ''}`;
             li.dataset.convId = conv.id;

             const nameToShow = DOMPurify.sanitize(conv.name); // Sanitize name before display

             // Use icons for actions when sidebar is collapsed
             const pinIconClass = conv.pinned ? 'fas fa-thumbtack rotate-45 text-yellow-500' : 'fas fa-thumbtack';
             const archiveIconClass = isArchived ? 'fas fa-folder-open' : 'fas fa-archive';

             li.innerHTML = `
                <span class="conversation-title flex-grow text-gray-700 dark:text-gray-300">${nameToShow}</span>
                <div class="conversation-actions flex-shrink-0 md:flex hidden">
                    ${!isArchived ? `<button class="pin-button" title="${conv.pinned ? 'Unpin' : 'Pin'}"><i class="${pinIconClass}"></i></button>` : ''}
                    <button class="rename-button" title="Rename"><i class="fas fa-edit"></i></button>
                    <button class="archive-button" title="${isArchived ? 'Unarchive' : 'Archive'}"><i class="${archiveIconClass}"></i></button>
                    <button class="delete-button" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
                 <div class="conversation-actions-mobile-dropdown md:hidden flex-shrink-0">
                     <button class="conversation-actions-mobile-button" aria-label="More actions"><i class="fas fa-ellipsis-v"></i></button>
                     <div class="conversation-actions-dropdown-content">
                        ${!isArchived ? `<button class="pin-button"><i class="${pinIconClass} mr-2 w-4 text-center"></i> ${conv.pinned ? 'Unpin' : 'Pin'}</button>` : ''}
                         <button class="rename-button"><i class="fas fa-edit mr-2 w-4 text-center"></i> Rename</button>
                         <button class="archive-button"><i class="${archiveIconClass} mr-2 w-4 text-center"></i> ${isArchived ? 'Unarchive' : 'Archive'}</button>
                         <button class="delete-button"><i class="fas fa-trash mr-2 w-4 text-center"></i> Delete</button>
                     </div>
                 </div>
            `;

             // Add event listeners
             li.addEventListener('click', (e) => {
                 // Prevent switching if a button within the item was clicked
                 if (!e.target.closest('button')) {
                     switchConversation(conv);
                 }
             });

            // Add listeners for action buttons (delegated or direct)
            li.querySelectorAll('.pin-button').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); pinConversation(conv.id); }));
            li.querySelectorAll('.rename-button').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); renameConversation(conv.id); }));
            li.querySelectorAll('.archive-button').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); archiveConversation(conv.id); }));
            li.querySelectorAll('.delete-button').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteConversation(conv.id); }));
            li.querySelector('.conversation-actions-mobile-button')?.addEventListener('click', (e) => { e.stopPropagation(); toggleConversationActionsDropdown(e, conv.id); });


             return li;
        }

         function toggleConversationActionsDropdown(event, convId) {
            const dropdown = document.getElementById(`conversation-actions-dropdown-${convId}`); // This assumes dropdown has specific ID - needs fixing if not
            // Find the correct dropdown relative to the button clicked
            const button = event.currentTarget;
            const parentItem = button.closest('.conversation-item');
            const actualDropdown = parentItem.querySelector('.conversation-actions-dropdown-content');

            if (!actualDropdown) return;

            // Close other open dropdowns
            document.querySelectorAll('.conversation-actions-dropdown-content.show').forEach(d => {
                if (d !== actualDropdown) d.classList.remove('show');
            });

            actualDropdown.classList.toggle('show');

             // Add a one-time click listener to close the dropdown if clicking outside
             if (actualDropdown.classList.contains('show')) {
                 document.addEventListener('click', function closeHandler(e) {
                     if (!parentItem.contains(e.target)) {
                         actualDropdown.classList.remove('show');
                         document.removeEventListener('click', closeHandler);
                     }
                 }, { once: true });
             }
        }

        function pinConversation(id) {
            const conversation = conversations.find(conv => conv.id === id);
            if (conversation && !conversation.archived) {
                conversation.pinned = !conversation.pinned;
                conversation.updatedAt = Date.now(); // Optional: track update time
                saveConversations();
                updateConversationList(); // Re-render the lists
                showToast(`Chat ${conversation.pinned ? 'pinned' : 'unpinned'}.`, 'info');
                sendToTelegramBot(`Conversation ${id} ${conversation.pinned ? 'pinned' : 'unpinned'}.`);
            }
        }
        function renameConversation(id) {
            const conversation = conversations.find(conv => conv.id === id);
            if (!conversation) return;

            const newName = prompt("Enter new chat name:", conversation.name);
            if (newName && newName.trim() && newName.trim() !== conversation.name) {
                const oldName = conversation.name;
                conversation.name = newName.trim();
                 conversation.updatedAt = Date.now();
                saveConversations();
                updateConversationList();
                if (currentConversation?.id === id) {
                    el.currentConversationTitle.textContent = conversation.name;
                }
                 showToast('Chat renamed.', 'success');
                sendToTelegramBot(`Conv ${id} renamed from "${oldName}" to "${conversation.name}".`);
            }
        }
        function archiveConversation(id) {
             const conversation = conversations.find(conv => conv.id === id);
             if (!conversation) return;

             const wasArchived = conversation.archived;
             conversation.archived = !conversation.archived;
             conversation.pinned = false; // Unpin when archiving/unarchiving
             conversation.updatedAt = Date.now();
             saveConversations();
             updateConversationList(); // Re-render

             showToast(`Chat ${conversation.archived ? 'archived' : 'unarchived'}.`, 'info');
             sendToTelegramBot(`Conversation ${id} ${conversation.archived ? 'archived' : 'unarchived'}.`);

             // If the currently active conversation was just archived, switch to another
             if (currentConversation?.id === id && conversation.archived) {
                 const nextConversation = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived);
                 if (nextConversation) {
                     switchConversation(nextConversation);
                 } else {
                     // No other non-archived chats, clear the view
                     currentConversation = null;
                     clearChatMessages();
                     el.currentConversationTitle.textContent = "Select or Start a Chat";
                     el.chatInputArea.classList.add('conversation-empty');
                     updateStarterMessagesArea();
                      el.regenerateHeaderButton.style.display = 'none';
                 }
             }
        }
        function deleteConversation(id) {
             const conversation = conversations.find(conv => conv.id === id);
             if (!conversation) return;

             if (confirm(`Delete chat "${conversation.name}"? This cannot be undone.`)) {
                 const conversationName = conversation.name;
                 conversations = conversations.filter(conv => conv.id !== id);
                 saveConversations();
                 updateConversationList();

                 showToast(`Chat "${conversationName}" deleted.`, 'success');
                 sendToTelegramBot(`Conversation "${conversationName}" (${id}) deleted.`);

                 // If the deleted conversation was active, switch
                 if (currentConversation?.id === id) {
                     const nextConversation = conversations.find(c => !c.archived && !c.pinned) || conversations.find(c => !c.archived);
                     if (nextConversation) {
                         switchConversation(nextConversation);
                     } else {
                         currentConversation = null;
                         clearChatMessages();
                         el.currentConversationTitle.textContent = "Select or Start a Chat";
                         el.chatInputArea.classList.add('conversation-empty');
                         updateStarterMessagesArea();
                         el.regenerateHeaderButton.style.display = 'none';
                     }
                 }
             }
        }


        function switchConversation(conversation) {
            if (!conversation) {
                console.warn("Attempted to switch to null conversation");
                 // Optionally create a new one if none exist
                 if (conversations.length === 0) createNewConversation();
                return;
            }
            if (currentConversation?.id === conversation.id) return; // Already active

            currentConversation = conversation;
            localStorage.setItem('lastActiveConversationId', conversation.id); // Remember last active

            clearChatMessages();
            conversation.messages.forEach(addMessageToChat); // Load messages
            el.currentConversationTitle.textContent = conversation.name || 'Chat';
            updateConversationList(); // Highlight the active item
            conversationMessageCount = conversation.messages.length; // Reset count for limit checks

             // Manage input area display (starter messages vs input field)
             if (conversation.messages.length === 0) {
                 el.chatInputArea.classList.add('conversation-empty');
                 updateStarterMessagesArea();
             } else {
                 el.chatInputArea.classList.remove('conversation-empty');
                 el.starterMessagesArea.classList.add('hidden');
             }

             // Close mobile sidebar after selection
             if (window.innerWidth < 768 && el.sidebar.classList.contains('active')) {
                toggleSidebar();
             }
              el.regenerateHeaderButton.style.display = canRegenerate() ? 'block' : 'none';

             console.log(`Switched to conversation: ${conversation.id} (${conversation.name})`);
             // Don't log switching to Telegram to avoid noise, unless debugging
        }

        function clearChatMessages() {
            // Clear messages, keeping indicators
             const indicators = [
                 el.printingAnimation, el.imageGeneratingAnimation, el.ollamaGeneratingAnimation,
                 el.websiteGeneratingAnimation, el.processJsAnimation
             ];
             el.chatMessages.innerHTML = ''; // Clear all content
             indicators.forEach(indicator => el.chatMessages.appendChild(indicator)); // Re-add indicators
        }

        function toggleSidebar() {
             sidebarCollapsed = !sidebarCollapsed; // Toggle state
             const isMobile = window.innerWidth < 768;

             if (isMobile) {
                 // Mobile: Translate
                 el.sidebar.classList.toggle('active', sidebarCollapsed); // Use 'active' for translation
                 el.toggleSidebarMobileButton.innerHTML = sidebarCollapsed ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>'; // Update icon
             } else {
                 // Desktop: Change width
                 el.sidebar.classList.toggle('sidebar-closed', sidebarCollapsed);
                 // Update desktop toggle icon
                 el.toggleSidebarDesktopButton.innerHTML = sidebarCollapsed ? '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-chevron-left"></i>';
             }
             console.log("Sidebar toggled, collapsed:", sidebarCollapsed);
             // Trigger resize event slightly delayed to allow CSS transitions? Maybe not needed.
             // window.dispatchEvent(new Event('resize'));
        }


        // --- Settings Logic ---
        function openSettings() {
             // Populate settings modal fields
             document.getElementById('message-history-limit').value = settings.messageHistoryLimit;
             populateAiModelSelect(); // Re-populate based on current plan
             document.getElementById('ai-model').value = settings.aiModel; // Set current value
             document.getElementById('theme').value = settings.theme;
             el.aiAssistantModeSelect.value = settings.aiAssistantMode;
             el.ollamaEnabledCheckbox.checked = settings.ollamaEnabled;
             el.ollamaApiUrlInput.value = settings.ollamaApiUrl;
             el.ollamaModelSelect.value = settings.ollamaModel;
             toggleOllamaSettingsVisibility(); // Show/hide Ollama fields
             updateMemoryListUI();
             showModal(el.settingsModal);
        }
        function closeSettings() { hideModal(el.settingsModal); }
        function saveSettingsChanges() {
             const selectedModel = document.getElementById('ai-model').value;
             // Validate model selection based on plan
             if (plan === 'free' && !PREMIUM_MODELS.slice(0, 1).includes(selectedModel)) {
                 showToast(`Free plan limited to ${getModelName(FREE_MODEL_FLASH)}.`, 'info');
                 document.getElementById('ai-model').value = settings.aiModel; // Revert UI
                 return; // Prevent saving invalid selection
             }

             // Update settings object
             settings.messageHistoryLimit = parseInt(document.getElementById('message-history-limit').value) || 50;
             settings.aiModel = selectedModel;
             settings.theme = document.getElementById('theme').value;
             settings.aiAssistantMode = el.aiAssistantModeSelect.value;
             settings.ollamaEnabled = el.ollamaEnabledCheckbox.checked;
             settings.ollamaApiUrl = el.ollamaApiUrlInput.value.trim();
             settings.ollamaModel = el.ollamaModelSelect.value;

             saveSettings(); // Persist to localStorage
             applySettings(); // Apply theme and re-init model if needed
             closeSettings();
             showToast('Settings saved!', 'success');
             sendToTelegramBot('Settings updated.');
        }
        function applySettings() {
             applyTheme();
             initializeModel(); // Re-initialize model based on new settings (Gemini/Ollama, model ID)
             updateNewAssistantModeUI(); // Reflect changes in assistant creation mode
             // Update limits based on plan (in case plan changed)
             updatePlanLimits();
        }
        function applyTheme() {
            const theme = settings.theme;
            document.body.classList.remove('dark'); // Remove first to handle switch from dark
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
            }
             console.log("Theme applied:", document.body.classList.contains('dark') ? 'Dark' : 'Light');
        }
        function toggleOllamaSettingsVisibility() {
            el.ollamaSettingsDiv.classList.toggle('hidden', !el.ollamaEnabledCheckbox.checked);
        }
        function populateAiModelSelect() {
             const select = document.getElementById('ai-model');
             select.innerHTML = ''; // Clear existing options

             const availableModels = plan === 'premium' ? PREMIUM_MODELS : [FREE_MODEL_FLASH]; // Only Flash for free

             availableModels.forEach(modelId => {
                 const option = document.createElement('option');
                 option.value = modelId;
                 option.textContent = getModelName(modelId);
                 select.appendChild(option);
             });
        }
         function getModelName(modelId) {
            switch(modelId) {
                case 'gemini-1.5-flash-latest': return 'PyroAI Flash';
                case 'gemini-pro': return 'PyroAI Pro (Premium)';
                case 'gemini-1.5-pro-latest': return 'PyroAI Max (Premium)';
                default: return modelId; // Fallback
            }
        }


        // --- Assistant Management Logic ---
         function openAssistantModal() {
            updateAssistantList();
            showModal(el.assistantModal);
        }
        function closeAssistantModal() { hideModal(el.assistantModal); }
        function updateAssistantList() {
             el.assistantList.innerHTML = ''; // Clear existing list
             assistants.forEach(assistant => {
                const card = document.createElement('div');
                // Improved card styling
                card.className = `assistant-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md transition-shadow duration-200 cursor-pointer border border-gray-200 dark:border-gray-600 flex flex-col justify-between`;
                const description = assistant.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${DOMPurify.sanitize(assistant.description)}</p>` : '';
                const isDefault = assistant.id === 'default';

                card.innerHTML = `
                    <div>
                        <h3 class="text-md font-semibold mb-1 text-gray-800 dark:text-gray-200">${DOMPurify.sanitize(assistant.name)}</h3>
                        ${description}
                    </div>
                    <div class="flex justify-end items-center mt-2 text-gray-500 dark:text-gray-400 gap-2">
                         ${isDefault ? '<span class="text-xs italic mr-auto">Default</span>' : ''}
                         <button class="edit-assistant-button hover:text-primary-500 transition-colors p-1" data-assistant-id="${assistant.id}" title="Edit Assistant">
                             <i class="fas fa-edit"></i>
                         </button>
                         ${!isDefault ? `<button class="delete-assistant-button hover:text-red-500 transition-colors p-1" data-assistant-id="${assistant.id}" title="Delete Assistant">
                             <i class="fas fa-trash"></i>
                         </button>` : ''}
                     </div>
                 `;
                 // Click on card selects assistant (unless a button was clicked)
                 card.onclick = (e) => {
                     if (!e.target.closest('button')) {
                         selectAssistant(assistant.id);
                     }
                 };
                 // Add listeners to buttons within the card
                  card.querySelector('.edit-assistant-button')?.addEventListener('click', (e) => {
                     e.stopPropagation();
                     openNewAssistantModal(assistant.id); // Pass ID to edit
                 });
                  card.querySelector('.delete-assistant-button')?.addEventListener('click', (e) => {
                     e.stopPropagation();
                     deleteAssistant(assistant.id);
                 });

                 el.assistantList.appendChild(card);
             });
        }
        function openNewAssistantModal(assistantIdToEdit = null) {
            const isEditing = assistantIdToEdit !== null;
            el.newAssistantModalTitle.innerHTML = isEditing
                ? '<i class="fas fa-edit mr-2"></i> Edit Assistant'
                : '<i class="fas fa-plus-circle mr-2"></i> Create New Assistant';

            if (isEditing) {
                const assistant = assistants.find(a => a.id === assistantIdToEdit);
                if (!assistant) return; // Should not happen
                el.editingAssistantIdInput.value = assistant.id;
                el.assistantNameInput.value = assistant.name;
                el.assistantDescriptionInput.value = assistant.description || '';
                el.assistantPromptTextarea.value = assistant.prompt;
            } else {
                // Clear fields for new assistant
                el.editingAssistantIdInput.value = '';
                el.assistantNameInput.value = '';
                el.assistantDescriptionInput.value = '';
                el.assistantPromptTextarea.value = ''; // Maybe pre-fill with default structure?
            }

            updateNewAssistantModeUI(); // Show/hide relevant fields based on settings
            showModal(el.newAssistantModal);
        }
        function closeNewAssistantModal() {
            hideModal(el.newAssistantModal);
            // Reset generate/save button states if needed
             el.generateAssistantPromptButton.style.display = 'none';
             el.saveNewAssistantButton.style.display = 'inline-block';
             el.promptModeAutoArea.classList.add('hidden');
             el.promptModeManualArea.style.display = 'block';
        }
        function updateNewAssistantModeUI() {
             const mode = settings.aiAssistantMode;
             if (mode === 'auto') {
                 el.promptModeManualArea.style.display = 'none';
                 el.generateAssistantPromptButton.style.display = 'inline-block';
                 el.saveNewAssistantButton.style.display = 'none'; // Hide save initially in auto mode
             } else { // Manual mode
                 el.promptModeManualArea.style.display = 'block';
                 el.promptModeAutoArea.classList.add('hidden');
                 el.generateAssistantPromptButton.style.display = 'none';
                 el.saveNewAssistantButton.style.display = 'inline-block';
             }
        }
        async function generateAiAssistantPrompt() {
            const name = el.assistantNameInput.value.trim();
            const description = el.assistantDescriptionInput.value.trim();

            if (!name) {
                showToast("Enter an assistant name to generate prompt.", 'info');
                return;
            }
            if (!model && !ollamaEnabled) { // Check if model is available
                 showToast("AI model not available for generation.", 'error');
                 return;
            }


            el.promptModeManualArea.style.display = 'none';
            el.promptModeAutoArea.classList.remove('hidden');
            el.generateAssistantPromptButton.style.display = 'none';
            el.saveNewAssistantButton.style.display = 'none';

            try {
                // Use a simple prompt generation model (like Flash) regardless of current chat model
                 let promptGenModel = genAI.getGenerativeModel({ model: FREE_MODEL_FLASH }); // Use Flash for this task
                 const promptRequest = `Generate a concise and effective system prompt for an AI assistant.
                     Name: "${name}"
                     Description: "${description}"
                     Focus on defining its core role, personality (optional), and key instructions or limitations. Output only the system prompt text.`;

                const result = await promptGenModel.generateContent(promptRequest);
                const responseText = result.response.text();
                el.assistantPromptTextarea.value = responseText.trim(); // Set generated prompt
                showToast("AI prompt generated!", 'success');

            } catch (error) {
                console.error("Error generating assistant prompt:", error);
                showToast("Error generating prompt. Please try manually.", 'error');
                sendToTelegramBot(`Error generating assistant prompt: ${error.message}`, 'error');
                // Keep manual area hidden, let user retry or cancel
            } finally {
                 // Show manual area again, allow saving the generated (or manually entered) prompt
                 el.promptModeAutoArea.classList.add('hidden');
                 el.promptModeManualArea.style.display = 'block';
                 el.saveNewAssistantButton.style.display = 'inline-block'; // Show save button
            }
        }
        function saveNewAssistant() {
             const id = el.editingAssistantIdInput.value || Date.now().toString();
             const name = el.assistantNameInput.value.trim();
             const description = el.assistantDescriptionInput.value.trim();
             const prompt = el.assistantPromptTextarea.value.trim();
             const isEditing = !!el.editingAssistantIdInput.value;

             if (!name || !prompt) {
                 showToast("Assistant name and prompt are required.", 'error');
                 return;
             }

             const newAssistantData = { id, name, description, prompt };

             if (isEditing) {
                 // Find and update existing assistant
                 const index = assistants.findIndex(a => a.id === id);
                 if (index !== -1) {
                     assistants[index] = newAssistantData;
                     showToast('Assistant updated!', 'success');
                     sendToTelegramBot(`Assistant edited: ${name} (${id})`);
                 }
             } else {
                 // Add new assistant
                 assistants.push(newAssistantData);
                 showToast('Assistant created!', 'success');
                 sendToTelegramBot(`New assistant created: ${name} (${id})`);
             }

             saveAssistants();
             updateAssistantList(); // Update list in the modal if open
             closeNewAssistantModal();
        }
        function selectAssistant(assistantId) {
            if (currentConversation && currentConversation.assistant !== assistantId) {
                const selectedAssistant = assistants.find(a => a.id === assistantId);
                if (selectedAssistant) {
                     currentConversation.assistant = assistantId;
                     saveConversations();
                     closeAssistantModal();
                     // Add a system-like message indicating the switch
                     addMessageToChat({
                         id: Date.now(),
                         text: `Switched to assistant: **${selectedAssistant.name}**`,
                         sender: 'ai', // Or 'system'
                         timestamp: Date.now(),
                         messageType: 'info' // Style differently maybe?
                     });
                     showToast(`Switched to assistant: ${selectedAssistant.name}`, 'info');
                     sendToTelegramBot(`Switched conv ${currentConversation.id} to assistant: "${selectedAssistant.name}" (${assistantId})`);
                     // Optional: Clear context or start fresh? For now, just switch.
                }
            } else {
                 closeAssistantModal(); // Close even if no change
            }
        }
         function deleteAssistant(id) {
             if (id === 'default') {
                 showToast("Cannot delete the default assistant.", 'error');
                 return;
             }
             const assistant = assistants.find(a => a.id === id);
             if (!assistant) return;

             if (confirm(`Delete assistant "${assistant.name}"? This cannot be undone.`)) {
                 const assistantName = assistant.name;
                 assistants = assistants.filter(a => a.id !== id);
                 saveAssistants();
                 updateAssistantList(); // Update list in modal

                 // Check if any conversation uses this assistant and revert to default
                 let updatedConversations = false;
                 conversations.forEach(conv => {
                     if (conv.assistant === id) {
                         conv.assistant = 'default';
                         updatedConversations = true;
                     }
                 });
                 if (updatedConversations) saveConversations();

                 // If the current conversation used the deleted assistant, update its state
                 if (currentConversation && currentConversation.assistant === id) {
                     currentConversation.assistant = 'default';
                      // Add info message about the change
                     addMessageToChat({
                         id: Date.now(), text: `Assistant "${assistantName}" was deleted. Switched to default assistant.`, sender: 'ai', timestamp: Date.now(), messageType: 'info'
                     });
                 }

                 showToast(`Assistant "${assistantName}" deleted.`, 'success');
                 sendToTelegramBot(`Assistant "${assistantName}" (${id}) deleted.`);
             }
        }
         function exportAssistants() {
             try {
                const jsonContent = JSON.stringify(assistants, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pyroai_assistants.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Assistants exported!', 'success');
             } catch (error) {
                 console.error("Error exporting assistants:", error);
                 showToast("Failed to export assistants.", 'error');
             }
        }
        function triggerAssistantImport() {
             const fileInput = document.createElement('input');
             fileInput.type = 'file';
             fileInput.accept = '.json';
             fileInput.style.display = 'none';
             fileInput.onchange = (event) => {
                 const file = event.target.files?.[0];
                 if (file) {
                     importAssistantFromFile(file);
                 }
                 document.body.removeChild(fileInput); // Clean up input element
             };
             document.body.appendChild(fileInput);
             fileInput.click();
        }
        function importAssistantFromFile(file) {
             const reader = new FileReader();
             reader.onload = function(event) {
                 try {
                     const importedData = JSON.parse(event.target.result);
                     if (Array.isArray(importedData)) {
                         // Basic validation for each imported assistant object
                         const validAssistants = importedData.filter(a => a && a.id && a.name && a.prompt);
                         const newAssistants = validAssistants.filter(imp => !assistants.some(ex => ex.id === imp.id)); // Avoid duplicates by ID

                         if (newAssistants.length > 0) {
                            assistants = assistants.concat(newAssistants);
                            saveAssistants();
                            updateAssistantList(); // Update modal list
                            showToast(`${newAssistants.length} new assistant(s) imported successfully!`, 'success');
                            sendToTelegramBot(`${newAssistants.length} assistants imported.`);
                         } else if (validAssistants.length > 0) {
                             showToast('Assistants already exist (matched by ID).', 'info');
                         } else {
                              showToast('No valid assistants found in the file.', 'error');
                         }

                     } else {
                         showToast('Invalid file format. Expected a JSON array.', 'error');
                     }
                 } catch (e) {
                     console.error("Error importing assistants:", e);
                     showToast('Error reading or parsing file.', 'error');
                     sendToTelegramBot(`Error importing assistants: ${e.message}`, 'error');
                 }
             };
             reader.onerror = () => {
                 showToast('Error reading file.', 'error');
             };
             reader.readAsText(file);
        }


        // --- Memory Management ---
        function updateMemoryListUI() {
            el.memoryListElement.innerHTML = ''; // Clear current list
            const memoryKeys = Object.keys(memory);

            if (memoryKeys.length === 0) {
                el.memoryListElement.textContent = 'No memories saved yet.';
                return;
            }

            memoryKeys.forEach(key => {
                const memoryItem = document.createElement('div');
                memoryItem.className = 'memory-item flex justify-between items-center text-sm mb-1 py-1 px-2 rounded bg-gray-100 dark:bg-gray-600';
                memoryItem.innerHTML = `
                    <div><span class="font-semibold">${key}:</span> ${memory[key]}</div>
                    <button class="memory-delete-btn text-red-500 hover:text-red-700 ml-2 p-1" data-memory-key="${key}" title="Delete memory">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                el.memoryListElement.appendChild(memoryItem);
            });
        }
        function handleMemoryDelete(event) {
            const deleteButton = event.target.closest('.memory-delete-btn');
            if (deleteButton) {
                const memoryKey = deleteButton.dataset.memoryKey;
                if (memoryKey && confirm(`Delete memory "${memoryKey}"?`)) {
                    delete memory[memoryKey];
                    saveMemory();
                    updateMemoryListUI();
                    showToast('Memory deleted.', 'success');
                    sendToTelegramBot(`Memory deleted: ${memoryKey}`);
                }
            }
        }
        function clearAllMemory() {
            if (confirm("Clear ALL saved memories? This cannot be undone.")) {
                memory = {};
                saveMemory();
                updateMemoryListUI();
                showToast('All memories cleared.', 'success');
                sendToTelegramBot('All memories cleared by user.');
            }
        }


        // --- Premium & Limits Logic ---
        function activatePremiumPlan() {
             const enteredKey = el.premiumKeyInputModal.value.trim();
             if (!enteredKey) return;

             if (premiumKeys.includes(enteredKey)) {
                 setPlan('premium');
                 closePremiumKeyModal();
                 showToast("Premium plan activated!", 'success');
                 sendToTelegramBot('Premium plan ACTIVATED.');
             } else {
                 el.premiumKeyStatus.classList.remove('hidden');
                 // Optional: Add animation feedback
                 showToast('Invalid premium key.', 'error');
                 sendToTelegramBot('Invalid Premium Key entered.', 'warning');
             }
        }
        function setPlan(newPlan) {
            if (plan === newPlan) return; // No change
            plan = newPlan;
            savePlan(); // Save the new plan status
            updatePlanUI(); // Update model select, limits etc.
            updateSidebarUI(); // Update premium badge
            initializeModel(); // Re-init model in case plan affects allowed models
             console.log(`Plan changed to: ${plan}`);
        }
        function updatePlanUI() {
             updatePlanLimits();
             populateAiModelSelect(); // Update available models in settings
             // Hide/show premium button in sidebar
             el.premiumButton.style.display = plan === 'premium' ? 'none' : 'flex';
        }
         function updatePlanLimits() {
             MESSAGE_LIMIT = plan === 'premium' ? 40 : 15;
             MAX_CONVERSATIONS = plan === 'premium' ? Infinity : 3;
             DAILY_MESSAGE_LIMIT = plan === 'premium' ? 100 : 10;
             DAILY_IMAGE_LIMIT = plan === 'premium' ? 20 : 3;
             MAX_MESSAGE_CHARS = plan === 'premium' ? 10000 : 1000;
             console.log("Limits updated for plan:", plan, { MESSAGE_LIMIT, MAX_CONVERSATIONS, DAILY_MESSAGE_LIMIT, DAILY_IMAGE_LIMIT, MAX_MESSAGE_CHARS });
        }
        function updateSidebarUI() {
            el.sidebarUsername.textContent = userData?.username || 'User';
            el.premiumUserBadge.innerHTML = plan === 'premium' ? '<span class="premium-badge">Premium</span>' : '';
        }
        function showPremiumAdModal(reason = "limit") {
            // Log reason for showing ad
            sendToTelegramBot(`Premium Ad shown. Reason: ${reason}. Current usage: Msgs=${usageCounters.dailyMessages}/${DAILY_MESSAGE_LIMIT}, Imgs=${usageCounters.dailyImages}/${DAILY_IMAGE_LIMIT}, Convs=${conversations.filter(c => !c.archived).length}/${MAX_CONVERSATIONS}`);
            showModal(el.premiumAdModal);
        }
        function closePremiumAdModal() { hideModal(el.premiumAdModal); }
        function showPremiumKeyModal() { showModal(el.premiumKeyModal); el.premiumKeyStatus.classList.add('hidden'); el.premiumKeyInputModal.value = '';}
        function closePremiumKeyModal() { hideModal(el.premiumKeyModal); }

        function checkMessageLimit() { return conversationMessageCount < MESSAGE_LIMIT; }
        function checkDailyMessageLimit() { return usageCounters.dailyMessages < DAILY_MESSAGE_LIMIT; }
        function checkDailyImageLimit() { return usageCounters.dailyImages < DAILY_IMAGE_LIMIT; }
        function checkDailyLimitsReset() {
            const today = new Date().toDateString();
            if (usageCounters.lastResetDate !== today) {
                 console.log("Resetting daily limits for", today);
                 usageCounters.dailyMessages = 0;
                 usageCounters.dailyImages = 0;
                 // Don't reset conversationsCreated daily, it's a total count check for free plan
                 usageCounters.lastResetDate = today;
                 saveUsageCounters();
                 sendToTelegramBot('Daily usage limits reset.');
            }
        }


        // --- Initial Setup & Welcome ---
        function showInitialSetupModal() { showModal(el.initialSetupModal); }
        function closeInitialSetupModal() { hideModal(el.initialSetupModal); }
        function showWelcomeModal() { showModal(el.welcomeModal); }
        function closeWelcomeModal() { hideModal(el.welcomeModal); }
        function showAgeBlockModal() { showModal(el.ageBlockModal); }
        function closeAgeBlockModal() { hideModal(el.ageBlockModal); }
        function acceptTerms() {
            localStorage.setItem('termsAccepted', 'true');
            closeWelcomeModal();
            // If user data doesn't exist yet, show setup AFTER accepting terms
            if (!userData) {
                 showInitialSetupModal();
            } else {
                 // If setup was somehow done before terms, just continue
                 showToast('Terms accepted. Welcome!', 'success');
                 // Re-initialize or update UI elements that depend on acceptance if needed
            }
            sendToTelegramBot('Terms accepted.');
        }
        function completeInitialSetup() {
             // Validation logic (same as v14, minor tweaks)
             let isValid = true;
             const username = el.setupUsernameInput.value.trim();
             const dob = el.setupDobInput.value;
             const email = el.setupEmailInput.value.trim();
             const pin = el.setupPinInput.value;

             // Reset errors
             [el.usernameError, el.dobError, el.emailError, el.pinError].forEach(e => e.classList.add('hidden'));

             if (username.length < 3 || username.length > 20) { el.usernameError.classList.remove('hidden'); isValid = false; }
             if (!dob) { el.dobError.classList.remove('hidden'); isValid = false; }
             if (email && !isValidEmail(email)) { el.emailError.classList.remove('hidden'); isValid = false; }
             if (!/^\d{4}$/.test(pin)) { el.pinError.classList.remove('hidden'); isValid = false; } // Regex for 4 digits

             if (!isValid) return;

             // Age Check
             const birthDate = new Date(dob);
             const age = Math.floor((Date.now() - birthDate.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
             if (age < 18) {
                 localStorage.setItem('ageBlocked', 'true');
                 closeInitialSetupModal();
                 showAgeBlockModal();
                 sendToTelegramBot(`Setup attempt failed: User under 18 (Age: ${age}).`, 'warning');
                 return;
             }

             // Save data
             userData = { username, email, pin }; // Store PIN (consider hashing/secure storage if real backend)
             saveUserData();
             closeInitialSetupModal();
             showToast('Setup complete!', 'success');
             sendToTelegramBot(`New User Setup: ${username}, Email: ${email || 'N/A'}, Age: ${age}`);
             updateSidebarUI(); // Update username display immediately

             // Show welcome/terms if not accepted yet
             if (localStorage.getItem('termsAccepted') !== 'true') {
                 showWelcomeModal();
             }
        }

        // --- Suggestions ---
        function openSuggestionsModal() { showModal(el.suggestionsModal); el.suggestionTextarea.value = '';}
        function closeSuggestionsModal() { hideModal(el.suggestionsModal); }
        async function sendSuggestions() {
             const suggestionText = el.suggestionTextarea.value.trim();
             if (!suggestionText) {
                 showToast("Please enter your feedback.", 'info');
                 return;
             }
             closeSuggestionsModal();
             showToast('Feedback sent. Thank you!', 'success');
             await sendToTelegramBot(`Feedback Received: ${suggestionText}`);
             el.suggestionTextarea.value = ''; // Clear textarea
        }


        // --- File & Image Handling ---
         async function readFileAsDataURL(file) {
             return new Promise((resolve, reject) => {
                 const reader = new FileReader();
                 reader.onload = () => resolve(reader.result);
                 reader.onerror = (error) => reject(error);
                 reader.readAsDataURL(file);
             });
        }
         async function fileToGenerativePart(file) {
             const base64Data = (await readFileAsDataURL(file)).split(',')[1];
             if (!base64Data) throw new Error("Failed to read file data.");
             return { inlineData: { data: base64Data, mimeType: file.type } };
         }
         function handleFileUpload(event) {
             const file = event.target.files?.[0];
             if (!file) { clearFileInput(); clearImagePreview(); return; }

             // Check if it's an image
             if (file.type.startsWith('image/')) {
                 if (!checkDailyImageLimit()) {
                     showPremiumAdModal("dailyImageLimit");
                     clearFileInput(); // Clear the input
                     return;
                 }
                 selectedImageFile = file;
                 selectedFile = null; // Ensure only one is active
                 displayImagePreview(file);
                 clearFileInput(); // Clear the file input visually
             } else {
                 // Handle non-image file
                 if (!checkDailyImageLimit()) { // Use same limit for files for now
                     showPremiumAdModal("dailyImageLimit"); // Use image limit reason or create specific file limit reason
                     clearFileInput();
                     return;
                 }
                 selectedFile = file;
                 selectedImageFile = null;
                 clearImagePreview(); // Remove image preview if a file is selected
                 // Optionally display file info preview (e.g., filename) - TBD if needed
                 showToast(`File selected: ${file.name}`, 'info');
             }
         }
         function displayImagePreview(file) {
             const reader = new FileReader();
             reader.onload = (e) => {
                 el.previewImageElement.src = e.target.result;
                 el.imagePreviewArea.classList.remove('hidden');
             }
             reader.readAsDataURL(file);
         }
         function clearImagePreview() {
             selectedImageFile = null;
             el.previewImageElement.src = '#';
             el.imagePreviewArea.classList.add('hidden');
             // Don't clear fileUploadInput here, only the image state
         }
         function clearFileInput() {
             selectedFile = null;
             el.fileUploadInput.value = ''; // Clear the actual file input
             // Optionally remove any file info preview
         }


        // --- UI Helpers ---
        function showModal(modalElement) {
            modalElement.classList.add('show');
            modalElement.style.display = 'flex';
        }
        function hideModal(modalElement) {
            modalElement.classList.remove('show');
            // Optional: Use timeout to wait for animation before setting display:none
            setTimeout(() => { modalElement.style.display = 'none'; }, 300);
        }
        function showIndicator(type = 'gemini') {
             el.printingAnimation.style.display = type === 'gemini' ? 'flex' : 'none';
             el.imageGeneratingAnimation.style.display = type === 'image' ? 'flex' : 'none';
             el.ollamaGeneratingAnimation.style.display = type === 'ollama' ? 'flex' : 'none';
             el.websiteGeneratingAnimation.style.display = type === 'website' ? 'flex' : 'none';
             el.processJsAnimation.style.display = type === 'js' ? 'flex' : 'none';
             scrollToBottom(); // Scroll down when indicator appears
        }
        function removeIndicator() {
             el.printingAnimation.style.display = 'none';
             el.imageGeneratingAnimation.style.display = 'none';
             el.ollamaGeneratingAnimation.style.display = 'none';
             el.websiteGeneratingAnimation.style.display = 'none';
             el.processJsAnimation.style.display = 'none';
        }
        function scrollToBottom() {
            el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
        }
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`; // Removed animation classes, handled by CSS keyframes

             const iconClass = {
                 success: 'fa-check-circle',
                 error: 'fa-exclamation-triangle',
                 info: 'fa-info-circle'
             }[type] || 'fa-info-circle';

             toast.innerHTML = `<i class="fas ${iconClass} mr-2"></i> ${message}`;
             el.toastContainer.appendChild(toast);

             // Auto remove after delay (controlled by CSS animation)
             setTimeout(() => {
                 // Add fade-out animation class if needed, or just remove
                 toast.style.animation = 'fadeOut 0.3s ease-in forwards'; // Trigger fade out
                 setTimeout(() => toast.remove(), 300); // Remove after fade out
             }, 3200); // Keep slightly longer than CSS animation duration
        }
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        function updateStarterMessagesArea() {
            el.starterMessagesArea.innerHTML = ''; // Clear existing
            starterMessages.forEach(msg => {
                const button = document.createElement('button');
                button.className = 'starter-message-button';
                button.textContent = msg;
                button.onclick = () => {
                    el.userInput.value = msg;
                    autoSizeTextarea(); // Adjust size if pre-filled
                    if (!settings.ollamaEnabled) sendMessage('gemini'); else sendMessage('ollama');
                };
                el.starterMessagesArea.appendChild(button);
            });
             el.starterMessagesArea.classList.remove('hidden'); // Make sure it's visible
        }
        function startCooldown() {
            messageCooldown = true;
            el.sendButton.disabled = true;
            el.ollamaSendButton.disabled = true;
            el.userInput.disabled = true;

            clearTimeout(messageCooldownTimeout); // Clear previous timeout if any
            messageCooldownTimeout = setTimeout(() => {
                messageCooldown = false;
                el.sendButton.disabled = false;
                 // Only enable ollama button if ollama is configured
                 el.ollamaSendButton.disabled = !settings.ollamaApiUrl || !settings.ollamaEnabled;
                el.userInput.disabled = false;
            }, 1500); // 1.5 second cooldown
        }


        // --- Utilities ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        async function evaluateJavascript(jsCode) {
             // Using an async function allows `await` within the evaluated code if needed,
             // though direct `eval` is synchronous. Wrapping in Promise for safety.
             console.log("Evaluating JS:", jsCode);
             return new Promise(async (resolve, reject) => {
                 try {
                     // Using Function constructor for slightly safer evaluation than direct eval
                     const result = await Function(`"use strict"; return (async () => { ${jsCode} })();`)();
                     console.log("JS Result:", result);
                     resolve(result !== undefined ? String(result) : "undefined"); // Ensure string conversion
                 } catch (error) {
                     console.error("JavaScript evaluation error:", error);
                     reject(error); // Reject promise on error
                 }
             });
        }

        // --- Logging ---
        async function sendToTelegramBot(message, logType = 'info', details = null) {
            if (!botToken || !chatId) {
                // console.warn('Telegram Bot not configured.');
                return;
            }

            const logPrefix = `[PyAIv2|${logType.toUpperCase()}]`;
            const userInfo = userData ? `${userData.username}` : 'Guest';
            // Basic browser/OS detection - simplistic
            const ua = navigator.userAgent;
            let os = "Unknown OS";
            if (ua.includes("Win")) os = "Windows";
            else if (ua.includes("Mac")) os = "MacOS";
            else if (ua.includes("Linux")) os = "Linux";
            else if (ua.includes("Android")) os = "Android";
            else if (ua.includes("like Mac")) os = "iOS"; // iOS user agent often contains "like Mac"

            const browser = ua.includes("Firefox") ? "Firefox" :
                           ua.includes("Chrome") ? "Chrome" :
                           ua.includes("Safari") ? "Safari" :
                           ua.includes("MSIE") || ua.includes("Trident") ? "IE" :
                           ua.includes("Edge") ? "Edge" : "Other";

            const timestamp = new Date().toLocaleString();
            let fullMessage = `${logPrefix} ${message} [${userInfo}|${plan.toUpperCase()}|${browser}|${os}] (${timestamp})`;

             // Append details if provided
             if (details) {
                fullMessage += `\n-- Details --\n${details}`;
             }


            // Truncate if too long for Telegram
            const MAX_TG_LENGTH = 4000; // Slightly less than actual limit for safety
            if (fullMessage.length > MAX_TG_LENGTH) {
                fullMessage = fullMessage.substring(0, MAX_TG_LENGTH) + "... (truncated)";
            }

            const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, text: fullMessage }),
                });
            } catch (error) {
                console.error('Error sending log to Telegram:', error);
            }
        }
        function sendUserMessageLog(messageData) {
             let logText = `User msg in conv ${currentConversation.id}: "${messageData.text.substring(0, 100)}..."`;
             if (messageData.image) logText += " [Image Attached]";
             if (messageData.file) logText += ` [File: ${messageData.file.name}]`;
             sendToTelegramBot(logText, 'chat');
        }
        function sendAiResponseLog(messageData) {
             let logText = `AI resp in conv ${currentConversation.id}: "${messageData.text.substring(0, 100)}..."`;
             if (messageData.messageType === 'imageGen') logText = `AI resp (Image Gen) in conv ${currentConversation.id}`;
             if (messageData.messageType === 'websiteCode') logText = `AI resp (Website Code) in conv ${currentConversation.id}`;
             if (messageData.messageType === 'processJsResult') logText = `AI resp (JS Result) in conv ${currentConversation.id}`;
             sendToTelegramBot(logText, 'chat');
        }


        // --- Drag & Drop / Sortable ---
        function initializeSortable() {
            // Sortable for messages (desktop only)
             if (sortable) sortable.destroy(); // Destroy existing instance if resizing

             if (window.innerWidth >= 768) { // Only enable on desktop
                sortable = new Sortable(el.chatMessages, {
                    animation: 150,
                    handle: '.message-wrapper', // Drag the whole wrapper
                    filter: '.ai-message-wrapper, .typing-indicator, #printing-animation, #image-generating-animation, #ollama-generating-animation, #website-generating-animation, #process-js-animation, .memory-update-message', // Elements not to be dragged or dropped onto
                    preventOnFilter: true, // Prevent dragging filtered elements
                    onUpdate: handleMessageSort,
                });
             } else {
                 sortable = null; // Ensure it's null on mobile
             }
        }
        function handleMessageSort(evt) {
             // This logic needs refinement if AI messages intersperse user messages frequently.
             // It assumes blocks of user messages might be reordered.
             const itemEl = evt.item; // The dragged element's wrapper
             const messageId = parseInt(itemEl.querySelector('.message')?.dataset.messageId);
             if (!messageId || !currentConversation) return;

             // Find the original index in the conversation array
             const oldArrayIndex = currentConversation.messages.findIndex(msg => msg.id === messageId);
             if (oldArrayIndex === -1) return;

             // Determine the new index based on DOM position
             // This is tricky because DOM includes AI messages, array might not match 1:1
             // A safer way: Rebuild the user message order from the DOM after drop
             const userMessageWrappers = Array.from(el.chatMessages.querySelectorAll('.user-message-wrapper'));
             const newUserOrderIds = userMessageWrappers.map(wrap => parseInt(wrap.querySelector('.message')?.dataset.messageId)).filter(id => !isNaN(id));

             // Create a new messages array preserving AI messages relative to user messages
             const originalMessages = [...currentConversation.messages];
             let newUserIndex = 0;
             const newMessagesArray = [];

             originalMessages.forEach(msg => {
                 if (msg.sender === 'user') {
                     // Find this user message in the new DOM order
                     const orderedMsg = currentConversation.messages.find(m => m.id === newUserOrderIds[newUserIndex]);
                     if (orderedMsg) {
                         newMessagesArray.push(orderedMsg);
                         newUserIndex++;
                     } else {
                          // Should not happen if DOM order is correct, but include original as fallback
                          newMessagesArray.push(msg);
                          console.warn("Could not find user message ID in new DOM order during sort:", msg.id);
                     }
                 } else {
                     // Keep AI message in its original relative position (or as close as possible)
                     // This simple push might misplace AI messages if user messages were moved across them.
                     // A more complex logic would be needed to re-insert AI messages accurately.
                     newMessagesArray.push(msg);
                 }
             });


             // Replace conversation messages with the potentially reordered array
             // Filter out duplicates just in case the logic above introduces them
             const uniqueMessages = [];
             const seenIds = new Set();
             newMessagesArray.forEach(msg => {
                if(!seenIds.has(msg.id)){
                    uniqueMessages.push(msg);
                    seenIds.add(msg.id);
                }
             });

             currentConversation.messages = uniqueMessages;

             saveConversations();
             console.log("Conversation messages reordered (basic).");
             showToast("Message order updated (visual only for AI msgs).", "info"); // Be honest about limitations
        }

         function initializeSortableLists() {
            // Initialize sortable for conversation lists (optional, maybe just pinned?)
            // Example for pinned list:
            // new Sortable(el.pinnedList, {
            //     group: 'conversations', // Allow dragging between lists?
            //     animation: 150,
            //     onEnd: handleConvListSort // Define this function
            // });
         }

        // --- Window Resize ---
        function handleWindowResize() {
            // Re-initialize sortable for messages (enables/disables based on width)
             initializeSortable();

             // Adjust sidebar state if needed (e.g., force open on desktop resize?)
             if (window.innerWidth >= 768) {
                 el.sidebar.classList.remove('active'); // Ensure mobile translate class is removed
                 // Keep desktop collapse state (.sidebar-closed) as is unless explicitly changed
             }
        }

        // --- Final Setup ---
        marked.setOptions({
            breaks: true, gfm: true, headerIds: false,
            highlight: function (code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                try {
                    return hljs.highlight(code, { language, ignoreIllegals: true }).value;
                } catch (e) {
                    return hljs.highlightAuto(code).value; // Fallback
                }
            }
        });

        // Hotjar Tracking (Keep as is)
        (function(h,o,t,j,a,r){
            h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
            h._hjSettings={hjid:3939332,hjsv:6}; // Your HJID
            a=o.getElementsByTagName('head')[0];
            r=o.createElement('script');r.async=1;
            r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
            a.appendChild(r);
        })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');

    </script>
</body>
</html>
